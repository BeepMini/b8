<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Spaceship Game</title>
	<meta name="description" content="Demo of a space invaders style game with real time updates.">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="stylesheet" href="example.css">
	<script src="../dist/b8.js"></script>

	<script>

		const CH_SPACESHIP = 22;
		const CH_LASER = 72;

		const MIN_Y = 24;
		const MAX_Y = 168;
		const MIN_X = 16;
		const MAX_X = ( b8.CONFIG.SCREEN_COLS * b8.CONFIG.CHR_WIDTH ) - MIN_X;

		const ACCEL = 4;
		const FRICTION = 0.99;

		// Ship's collision rectangle
		const PLAYER_COLL_RECT = { x: 1, y: 1, w: 6, h: 6 };
		// Enemy's collision rectangle
		const ENEMY_COLL_RECT = { x: 1, y: 1, w: 6, h: 6 };
		// Laser's collision rectangle.
		const LASER_COLL_RECT = { x: 2, y: 0, w: 4, h: 16 };

		// Difficulty parameters are specified per score slice of 500, so the first value
		// is used when the player has 0-499 points, the second value is for 500-999, etc.
		const MIN_ENEMIES = [ 3, 3, 4, 4, 5, 5, 6, 6, 7, 7 ];
		const MAX_ENEMIES = [ 5, 5, 6, 6, 7, 7, 8, 8, 9, 9 ];
		const SPAWN_INTERVAL = [ 100, 90, 80, 70, 60, 50, 40, 30, 30, 30 ];
		const ENEMY_SPEED = [ 1, 2, 2, 3, 3, 4, 4, 5, 5, 6 ];
		const ENEMY_COLOR = [ 12, 14, 13, 15, 11, 10, 12, 14, 13, 15 ];

		// Player's coordinates (Y is fixed).
		let playerX = 124, playerY = MAX_Y;
		// Player's speed
		let playerSpeed = 0;
		// If a laser exists, laser.x, laser.y are its coordinates. Otherwise this is null.
		let laser = null;
		const laserDelay = 150; // milliseconds
		// Variable to track the last time the laser was fired.
		let lastLaserTime = 0;
		// Array of enemies.
		const enemies = [];
		// Countdown to spawn next enemy.
		let spawnCountdown = 0;
		let score = 0;
		let gameOver = false;
		let backgroundImg = null;


		async function main() {

			b8.cls();
			b8.print( "Loading..." );
			backgroundImg = await b8.Async.loadImage( "assets/city.png" );

			b8.drawImage( 0, 0, backgroundImg );

			b8.locate( 3, 6 );
			b8.color( 14, -1 );
			b8.print( "SPACESHIP EXAMPLE" );
			b8.locate( 3, 12 );
			b8.color( 7, 0 );
			b8.print( "Press any button to start.\n\n" );
			b8.print( "Controls:\nSPACE or 'A' button to shoot." );
			await b8.Async.key();
			b8.cls();
			b8.frame( render, doFrame );

		}


		/**
		 * Game update function, called once per frame.
		 *
		 * @param {number} dt Delta time since last frame in milliseconds.
		 */
		async function doFrame( dt ) {

			spawnCountdown -= dt;

			// Spawn enemy, if it's time. Or if we are below the minimum number of enemies.
			if ( spawnCountdown < 0 || b8.ECS.countByType( 'enemy' ) < calcParam( MIN_ENEMIES ) ) spawnEnemy();

			updateEnemies( dt );
			updatePlayer( dt );
			updateLaser( dt );
			updateVfx( dt );
			checkCollisions();

			// Game over?
			if ( gameOver ) {
				b8.frame( null );
				showGameOver();
			}

		}



		function render( dt ) {

			b8.cls();

			// Background
			b8.drawImage( 0, 0, backgroundImg );

			// Draw score
			b8.color( 7 );
			b8.locate( 1, 1 );
			b8.print( `${score}` );

			// Sprites (enemies, lasers, VFX etc)
			const sprites = b8.ECS.query( 'Sprite' );
			for ( const id of sprites ) {
				const sprite = b8.ECS.getComponent( id, 'Sprite' );
				b8.color( sprite.color );

				if ( sprite.animation ) {
					b8.sprActor( sprite.chr, sprite.animation, sprite.x, sprite.y );
				} else if ( sprite.fx ) {
					b8.Vfx.spr( sprite.fx, sprite.startTime, sprite.x, sprite.y );
				} else {
					b8.spr( sprite.chr, sprite.x, sprite.y );
				}
			}

			// Draw the spaceship.
			b8.color( 15, -1 );
			b8.sprActor( CH_SPACESHIP, 'idle', playerX, playerY );

		}

		function updatePlayer( dt ) {

			// Control ship with left/right arrows or D-pad.
			playerSpeed += ( b8.key( "ArrowRight" ) ? 1 : b8.key( "ArrowLeft" ) ? -1 : 0 ) * ACCEL;
			// Shoot laser with space or A button.
			if ( ( b8.key( " " ) || b8.key( "ButtonA" ) ) ) shootLaser();

			// Apply friction (reduce speed).
			playerSpeed = playerSpeed * FRICTION * dt * 20;
			// Apply speed to position.
			playerX = b8.Utilities.clamp( playerX + playerSpeed, MIN_X, MAX_X );

		}

		function updateLaser( dt ) {

			const ids = b8.ECS.query( 'Laser' );
			for ( const id of ids ) {

				const sprite = b8.ECS.getComponent( id, 'Sprite' );
				sprite.y -= 125 * dt;
				// Off screen?
				if ( sprite.y < 0 - 16 ) b8.ECS.removeEntity( id );

			}

		}


		function updateVfx( dt ) {

			const vfxIds = b8.ECS.query( 'VFX' );
			for ( const id of vfxIds ) {

				const sprite = b8.ECS.getComponent( id, 'Sprite' );
				const animating = b8.Vfx.shouldLoop( sprite.fx, sprite.startTime, sprite.x, sprite.y );
				if ( !animating ) b8.ECS.removeEntity( id );

			}

		}


		function shootLaser() {

			// Get the current time in milliseconds.
			const now = b8.Core.getNow();
			// Check if enough time has passed since the last laser shot.
			if ( now - lastLaserTime < laserDelay ) return;

			// Create the laser entity.
			b8.ECS.create(
				{
					Sprite: {
						chr: CH_LASER,
						color: 11,
						x: playerX,
						y: playerY - 6,
					},
					Type: { name: 'laser' },
					Laser: {},
				}
			);

			// Play the laser sound.
			b8.playSfx( 'weapon/lazer/005' );

			// Update the last laser time.
			lastLaserTime = now;

		}

		function spawnEnemy() {

			const maxEnemies = calcParam( MAX_ENEMIES );
			if ( enemies.length >= maxEnemies ) return;

			const dir = b8.Random.pick( [ -1, 1 ] );
			const animation = dir === 1 ? 'move-right' : 'move-left';

			b8.ECS.create(
				{
					Sprite: {
						chr: 21,
						animation,
						color: calcParam( ENEMY_COLOR ),
						x: b8.Random.int( MIN_X, MAX_X ),
						y: MIN_Y,
					},
					Type: { name: 'enemy' },
					Enemy: {
						speed: calcParam( ENEMY_SPEED ),
						dir,
					},
				}
			);

			spawnCountdown = calcParam( SPAWN_INTERVAL );

		}

		function updateEnemies( dt ) {

			const enemies = b8.ECS.query( 'Enemy' );

			for ( const id of enemies ) {

				const sprite = b8.ECS.getComponent( id, 'Sprite' );
				const enemy = b8.ECS.getComponent( id, 'Enemy' );

				// Update enemy position
				sprite.x += ( enemy.dir * enemy.speed * dt * 20 );

				// Bounce off sides
				const ENEMY_ROW_HEIGHT = 16;
				if ( sprite.x <= MIN_X ) { sprite.x = MIN_X; enemy.dir = 1; sprite.y += ENEMY_ROW_HEIGHT; sprite.animation = 'move-right'; }
				if ( sprite.x >= MAX_X ) { sprite.x = MAX_X; enemy.dir = -1; sprite.y += ENEMY_ROW_HEIGHT; sprite.animation = 'move-left'; }

				// Don't go past player
				sprite.y = Math.min( sprite.y, playerY );

			}

		}


		function showGameOver() {

			b8.color( 15, 2 );
			b8.locate( 2, 10 );
			b8.printBox( b8.CONFIG.SCREEN_COLS - 4, 3 );
			b8.locate( 0, 11 );
			b8.printCentered( "GAME OVER", b8.CONFIG.SCREEN_COLS );

		}

		function calcParam( paramSpec ) {

			// This function calculates a parameter value based on the player's score.
			// The parameter is chosen from an array (paramSpec) where each index corresponds to a score range.
			// The score is divided by 500 to determine the range index.
			// Math.floor ensures the index is an integer, and Math.min/Math.max clamp it within valid bounds.
			const value = paramSpec[ Math.min( Math.max( Math.floor( score / 500 ), 0 ), paramSpec.length - 1 ) ];
			// console.log( 'calcParam', value );
			return value;

		}

		function checkCollisions() {

			// Query all enemies and lasers.
			const enemies = b8.ECS.query( 'Sprite', 'Enemy' );
			const lasers = b8.ECS.query( 'Sprite', 'Laser' );

			// Check each enemy against each laser.
			enemies.forEach( ( enemyId ) => {
				const enemyPos = b8.ECS.getComponent( enemyId, 'Sprite' );

				// Check collision with player.
				if ( b8.Utilities.intersectRects( ENEMY_COLL_RECT, PLAYER_COLL_RECT, enemyPos.x, enemyPos.y, playerX, playerY ) ) {
					if ( !gameOver ) b8.playSfx( 'tone/jingle/015' );
					gameOver = true;
				}

				// Check collision with lasers.
				lasers.forEach( ( laserId ) => {
					const laserPos = b8.ECS.getComponent( laserId, 'Sprite' );

					if ( b8.Utilities.intersectRects( LASER_COLL_RECT, ENEMY_COLL_RECT, laserPos.x, laserPos.y, enemyPos.x, enemyPos.y ) ) {
						// Remove both entities on collision.
						b8.ECS.removeEntity( laserId );
						b8.ECS.removeEntity( enemyId );

						// Remove ids.
						enemies.splice( enemies.indexOf( enemyId ), 1 );
						lasers.splice( lasers.indexOf( laserId ), 1 );

						// Add VFX.
						b8.ECS.create( {
							Sprite: {
								chr: 39,
								fx: 'explosion',
								color: 10,
								x: enemyPos.x,
								y: enemyPos.y,
								startTime: b8.Core.getNow(),
							},
							VFX: {},
						} );

						b8.Renderer.shakeScreen();

						// Update the score.
						score += 50;
						b8.playSfx( 'weapon/explode/003' );
					}
				} );
			} );
		}

		window.addEventListener(
			"load",
			() => b8.init(
				main,
				{ NAME: 'Spaceship Shooter' }
			)
		);
	</script>
</head>

<body>
</body>

</html>