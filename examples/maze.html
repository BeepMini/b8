<!DOCTYPE html>
<html>
<head>
  <title>Example - Maze</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">


  <!-- Replace with a separate style.css file if you want -->
  <style type="text/css">
  body {
    background: black;
    color: white;
  }
  </style>

  <script type="module">
    import * as beep8 from "./beep8/beep8.js";
    import * as beep8a from "./beep8/beep8a.js";
    import * as qut from "./beep8/beep8.Utilities.js";

    const MAZE = [
      "                                ".split(''),
      " ############################## ".split(''),
      " #......#............#........# ".split(''),
      " #......##+#######...#........# ".split(''),
      " #......#........#...+........# ".split(''),
      " ###+######...###....#........# ".split(''),
      " #......+.....########+######## ".split(''),
      " #......#######.........#.....# ".split(''),
      " ########....#......#####.....# ".split(''),
      " #..#...#....#......+...####..# ".split(''),
      " #..###+#....##.....#.........# ".split(''),
      " #...+........+.....#.........# ".split(''),
      " #######+###+################.# ".split(''),
      " #........##..#...+......#..#.# ".split(''),
      " #.........#..#...#......#..#.# ".split(''),
      " ##+###+####..#...#......#..### ".split(''),
      " #...#...######+#####....#....+ ".split(''),
      " #...#...+...#....#.####+#....# ".split(''),
      " #...#########....#......#....# ".split(''),
      " #...+.......+....#......+....# ".split(''),
      " ############################## ".split(''),
    ];
    const MAZE_HEIGHT = MAZE.length;
    const MAZE_WIDTH = MAZE[0].length;

    // Player position.
    let px = 2, py = 2;
    // If true, the player is facing left instead of right.
    let facingLeft = false;
    // Sound effects.
    let sfxStep, sfxWin, sfxDoor;

    async function main() {
      beep8.cls();
      beep8.print("Loading...");
      sfxStep = await beep8a.loadSound("assets/step.wav");
      sfxWin = await beep8a.loadSound("assets/levelup.wav");
      sfxDoor = await beep8a.loadSound("assets/hit.wav");
      beep8.cls();

      while (true) {
        drawMap();
        drawPlayer();
        // Did the player exit the maze? If so, win the game.
        if (px >= 30) { await youWon(); continue; }
        // Move the player based on what key they press.
        await movePlayer();
      }
    }

    function drawMap() {
      beep8.color(7, 0);
      beep8.cls();
      for (let y = 0; y < MAZE_HEIGHT; y++) {
        beep8.locate(0, y);
        for (let x = 0; x < MAZE_WIDTH; x++) {
          const cell = MAZE[y][x];

          // Choose the draw color based on the distance to the player.
          const distToPlayer = beep8.Utilities.dist2d(px, py, x, y);
          beep8.color(distToPlayer < 2 ? 15 :
            distToPlayer < 3 ? 7 : distToPlayer < 4 ? 8 : 0);

          // For decorative purposes, use some graphical characters instead of the ASCII ones.
          beep8.printChar(cell === "#" ? 0x87 : cell === "." ? 0xDB : cell === "+" ? 0xC8 : " ");
        }
      }
    }

    function drawPlayer() {
      beep8.locate(px, py);
      beep8.color(15, 0);
      beep8.printChar(facingLeft ? 193 : 192); // 0xc0 is the player facing right, 0xc1 is left.
    }

    async function movePlayer() {
      const keyName = await beep8a.key();
      if (keyName === "ArrowLeft") facingLeft = true;
      if (keyName === "ArrowRight") facingLeft = false;
      // Where does the player want to go?
      const candX = px + (keyName === "ArrowRight" ? 1 : 0) + (keyName === "ArrowLeft" ? -1 : 0);
      const candY = py + (keyName === "ArrowDown" ? 1 : 0) + (keyName === "ArrowUp" ? -1 : 0);
      if (candX === px && candY === py) return;
      switch (MAZE[candY][candX]) {
        case ".": // Regular floor: we can move there.
          px = candX; py = candY;
          beep8.playSound(sfxStep);
          break;
        case "+": // Door: we can open it. It becomes a regular floor tile.
          MAZE[candY][candX] = ".";
          beep8.playSound(sfxDoor);
          break;
        default: // Everything else is a wall and we can't move there.
          break;
      }
    }

    async function youWon() {
      beep8.playSound(sfxWin);
      await beep8a.dialog("Congratulations!");
      // As a reward, you get to play again.
      px = 2; py = 2;
    }

    window.addEventListener("load", () => beep8.init(main));
  </script>
</head>
<body>
</body>
</html>
