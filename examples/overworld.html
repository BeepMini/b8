<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Overworld Game Sample</title>
	<meta name="description" content="Wander around a retro Zelda style map.">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="stylesheet" href="example.css">
	<script src="../dist/b8.min.js"></script>

	<script>

		let mapArray = null;
		let map = null;

		const NPC_IDS = [ "0", "1", "2", "3" ];

		const MAPS = {
			"OVERWORLD": [
				"                    ",
				" ~~~~~ ^^^  ~~  ^^  ",
				" ~~~|, ^^   ~~ ^^|| ",
				" ~||   ^^   ~,^^||  ",
				" ||  ^^,    ~~  ||  ",
				" |, ||, ^^  ~~ ,    ",
				"    ||||^^   ~~||^^ ",
				" ^   ,||||^|  ~~||^ ",
				" ^^^|   ,   , ==  ^ ",
				" ^|| ,    |^^,~~,,^ ",
				"  ^^^^|   ^^^~~  ,^ ",
				"  ^^^^     ^^~~  ~  ",
				"    ^  ,     ~~  ~~ ",
				"         ,  ~~  |~~ ",
				"   ,    ,  ~~  ,|~~ ",
				"    |      ~~  ,,   ",
				" | ,|||T|^~~~ ,, ^^ ",
				" |||  ^^^~~~   ^^^^ ",
				" ^^^||  ~~~   ^^^^^ ",
				"                    ",
			],
			"TOWN": [
				"                    ",
				"          OO        ",
				" #########..####### ",
				" #  ,   ..   #  ] # ",
				" # ######  . #  ] # ",
				" # # ]  # .  +  ]2# ",
				" # # ]  # .  ###### ",
				" # #0]  + ., #  ] # ",
				" # # ]  # .. +  ]1# ",
				" # ###### .. #  ] # ",
				" #.. ..   ...###### ",
				" #.,.  .. . .. ,  # ",
				" ####    .    2   # ",
				" #  +    ......   # ",
				" #0 # ,..~~..., ..# ",
				" #### 1  ~~..     # ",
				" #   0   .. ,  1 |# ",
				" #||  2  ||| , |||# ",
				" #||| ,,  ||,|||||# ",
				" ################## ",
			],
		};

		const TILES = {
			"~": { fg: 3, bg: 5, t: 188, coll: true },	// water.
			"|": { fg: 12, t: 185, coll: true },			// tree.
			"^": { fg: 2, t: 187, coll: true },			// mountain.
			"=": { fg: 1, t: 248, coll: false },			// bridge.
			",": { fg: 13, t: 289, coll: false },		// grass.
			" ": { fg: 1, t: 0, coll: false },			// empty.
			"T": { fg: 15, t: 362, coll: false },		// town.
			"O": { fg: 0, t: 0, coll: false },		//
			"#": { fg: 7, t: 334, coll: true },			// wall.
			".": { fg: 1, t: 346, coll: false },			// stone path.
			"+": { fg: 6, t: 234, coll: false },			// doorway.
			"]": { fg: 10, t: 74, coll: true },			// force field.

			// // Villagers.
			"0": { fg: 15, t: 0xd0, coll: true, talk: true },
			"1": { fg: 15, t: 0xd3, coll: true, talk: true },
			"2": { fg: 15, t: 0xd5, coll: true, talk: true },
		}

		const MAP_WIDTH = MAPS.OVERWORLD[ 0 ].length;
		const MAP_HEIGHT = MAPS.OVERWORLD.length;

		const GREETINGS = [
			"Greetings, traveler!", "Welcome, adventurer!",
			"I'm a placeholder\ncharacter in an\nexample game.",
		];

		let curMap = "OVERWORLD";  // Initial map name
		let px = 7, py = 9;    // Initial player position.
		let facingLeft = 1;    // If true, player is looking to the left.

		async function main() {

			while ( true ) {
				drawMap();
				drawPlayer();
				await movePlayer();
			}

		}

		function drawPlayer() {

			b8.locate( px, py );
			b8.color( 15, 0 );
			let animation = 'move-right';

			if ( facingLeft ) {
				animation = 'move-left';
			}

			b8.drawActor( 14, animation );

		}

		function drawNPCs() {

			for ( let y = 0; y < mapArray.length; y++ ) {
				for ( let x = 0; x < mapArray[ y ].length; x++ ) {
					if ( NPC_IDS.includes( mapArray[ y ][ x ] ) ) {
						b8.color( 15, 0 );
						b8.locate( x, y + 1 );
						b8.drawActor( parseInt( mapArray[ y ][ x ] ), "idle" );
					}
				}
			}

		}

		function drawMap() {

			// Map.
			b8.cls();
			b8.locate( 0, 1 );
			b8.Tilemap.draw( map, 0, 0 );

			// Draw NPCs.
			drawNPCs();

			// UI.
			b8.locate( 1, 22 );
			b8.color( 8, 0 );
			b8.print(
				"ROBIN  HP 34/34  Gold:72\n" +
				"Paladin Lvl 6  XP:18,390" );
		}

		async function movePlayer() {

			const keyName = await b8.Async.key();

			if ( keyName.includes( "ArrowLeft" ) ) facingLeft = 1;
			if ( keyName.includes( "ArrowRight" ) ) facingLeft = 0;

			// Where does the player want to go?
			const candX = px + ( keyName.includes( "ArrowRight" ) ? 1 : 0 ) + ( keyName.includes( "ArrowLeft" ) ? -1 : 0 );
			const candY = py + ( keyName.includes( "ArrowDown" ) ? 1 : 0 ) + ( keyName.includes( "ArrowUp" ) ? -1 : 0 );

			// Don't let player go beyond edges.
			if ( candX <= 0 || candX >= MAP_WIDTH - 1 ) return;
			if ( candY <= 0 || candY >= MAP_HEIGHT - 1 ) return;

			// What tile is the player trying to enter?
			const tile = mapArray[ candY - 1 ][ candX ];
			if ( TILES[ tile ].talk ) await randomGreeting();
			if ( TILES[ tile ].coll ) return; // Can't walk over a solid tile.

			px = candX, py = candY;

			// Change maps?
			if ( tile === "T" ) goToMap( "TOWN", 10, 2 );
			if ( tile === "O" ) goToMap( "OVERWORLD", 7, 15 );

		}

		function loadMap( mapName ) {
			mapArray = b8.Tilemap.convertFromText( MAPS[ mapName ].join( "\n" ) );
			return b8.Tilemap.createFromArray( mapArray, TILES );
		}

		function goToMap( mapName, x, y ) {
			map = loadMap( mapName );
			curMap = mapName;
			px = x;
			py = y;
		}

		async function randomGreeting() {
			const greeting = GREETINGS[ Math.floor( Math.random() * GREETINGS.length ) ];
			await b8.Async.dialog( `VILLAGER:\n${greeting}` );
		}

		window.addEventListener(
			"load",
			() => b8.init(
				() => {
					goToMap( "OVERWORLD", 7, 9 );
					main();
				}
			)
		);
	</script>
</head>

<body>
</body>

</html>