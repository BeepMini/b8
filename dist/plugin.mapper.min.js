const mapper={maps:[],currentMapId:null,types:{},systems:{},actions:{},settings:{},bg:{},player:null,actionCooldown:0,play:function(t){b8.Utilities.checkObject("mapData",t),mapper.load(t),b8.Scene.add("menu",mapper.sceneMenu),b8.Scene.add("game",mapper.sceneGame),b8.Scene.set("menu")},update:function(t){b8.ECS.run(t),mapper.actionCooldown-=t,mapper.actionCooldown<0&&(mapper.actionCooldown=0)},drawActor:function(t){const o=mapper.camera.getScreenPosition(t.col,t.row),e=t.col-o.col,n=t.row-o.row;b8.locate(e+offsetX,n+offsetY),b8.color(t.fg,t.bg),b8.drawActor(t.id,t.animation)},delayKeyPress:function(){mapper.actionCooldown=mapper.CONFIG.keyPressDelay},setPlayerWalkAnimation:function(t,o,e){const n=b8.ECS.getComponent(t,"CharacterAnimation");e>0&&(n.name="move-down"),e<0&&(n.name="move-up"),o>0&&(n.name="move-right"),o<0&&(n.name="move-left"),n.duration=.3},render:function(t=0,o=0){const e=[];for(const n of b8.ECS.query("Sprite","Loc")){const s=b8.ECS.getComponent(n,"Sprite"),i=b8.ECS.getComponent(n,"Loc"),r=b8.ECS.getComponent(n,"CharacterAnimation");e.push({spr:s,loc:i,anim:r})}if(e.length!==0){e.sort((n,s)=>(n.spr.depth??0)-(s.spr.depth??0));for(const{spr:n,loc:s,anim:i}of e){const r=mapper.camera.getTilePosition(s.col,s.row),a=n.nudgeCol||0,c=n.nudgeRow||0;switch(b8.locate(r.col+t,r.row+o),b8.color(n.fg??15,n.bg??0),n.type){case"actor":b8.drawActor(parseInt(n.tile),i.name,a,c);break;case"vfx":b8.Vfx.draw(n.id,n.startTime,a,c);break;default:b8.printChar(parseInt(n.tile));break}}}},drawScreen:function(){if(!mapper.isValidMapId(mapper.currentMapId)){b8.Utilities.fatal("No current map set.");return}let t=b8.ECS.getComponent(mapper.player,"Loc");t||(t={col:0,row:0});const o=mapper.camera.getScreenPosition(t.col,t.row),e=mapper.getCurrentMap();b8.Tilemap.draw(e.mapData,o.col,o.row,o.w,o.h)},setTile:function(t,o,e){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}if(t<0||o<0||o>=mapper.currentMap.map.mapHeight||t>=mapper.currentMap.map.mapWidth){b8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[o][t]=e},getPropForEntity:(t,o=null)=>{const e=b8.ECS.getComponent(t,"Action");return!e||!o||!(o in e)?"":e[o]??""},getCurrentMap:()=>mapper.maps[mapper.currentMapId],promptAhead:(t,o=null)=>{if(!o)return"";const e=mapper.entitiesAhead(t);for(const n of e){const s=mapper.getPropForEntity(n,o);if(s)return s}return""},ahead:t=>{const o=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Direction");if(!o||!e)return{x:0,y:0};const n=o.col+(e.dx||0),s=o.row+(e.dy||0);return{x:n,y:s}},entitiesAhead:t=>{const{x:o,y:e}=mapper.ahead(t);return b8.ECS.entitiesAt(o,e)??[]},entitiesNextTo:t=>{const o=b8.ECS.getComponent(t,"Loc");if(!o)return[];const e=new Set,n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const s of n){const i=o.col+s.dx,r=o.row+s.dy,a=b8.ECS.entitiesAt(i,r);a&&a.forEach(c=>e.add(c))}return Array.from(e)},doCollision:function(t,o,e,n,s,i){if(mapper.systems.tryPushing(t,o,s,i))return!0;for(const r of b8.ECS.entitiesAt(e,n)){const a=b8.ECS.getComponent(r,"Type"),c=a?mapper.types[a.name]:null;if(c?.onCharacterCollision&&c.onCharacterCollision(r,e,n,s,i)||b8.ECS.hasComponent(r,"Solid"))return!0}return!1},doAction:(t,o)=>{if(!o||mapper.actionCooldown>0)return;const e=mapper.promptAhead(t,o);e&&mapper.actions[e]&&mapper.actions[e](t)},doAttack:(t,o)=>{const e=mapper.ahead(t);mapper.types.vfx.spawn(e.x,e.y,{id:"swipe",fg:15,bg:0}),mapper.doAction(t,o)},updateMoveDelay:function(t=mapper.CONFIG.moveDelay){mapper.sceneGame.moveDelay=Math.max(t,mapper.sceneGame.moveDelay)},isValidMapId:t=>typeof t=="number"&&t>=0,removeObjectAt:function(t,o,e){const n=mapper.getCurrentMap();n.objects=n.objects.filter(s=>!(s.x===t&&s.y===o&&s.type.startsWith(e)))},changeObjectTypeAt:function(t,o,e,n){console.log("changeObjectTypeAt",t,o,e,n);const s=mapper.getCurrentMap();for(const i of s.objects)if(i.x===t&&i.y===o&&i.type.startsWith(e)){i.type=n;return}},giveRewards:function(t,o=[]){!o||o.length===0||o.forEach(e=>{if(!e.type)return;e.props||(e.props={});const n=mapper.types[e.type]?.pickupHandler;n&&n(t,e)})}};mapper.CONFIG={moveDelay:.2,keyPressDelay:.25,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.attack=t=>{const o=mapper.entitiesAhead(t);for(const e of o){if(e===t||!b8.ECS.hasComponent(e,"AttackTarget"))continue;const n=b8.ECS.getComponent(e,"Health"),s=b8.ECS.getComponent(t,"Attack")||{value:1};n.value-=s.value}},mapper.actions.ignite=function(t){const o=mapper.entitiesAhead(t);for(const e of o){if(e===t)continue;const n=b8.ECS.getComponent(e,"Bomb");n&&(n.fuseTime=5)}},mapper.actions.open=async function(t){const o=mapper.entitiesAhead(t);for(const e of o){const n=b8.ECS.getComponent(e,"Openable"),s=b8.ECS.getComponent(e,"Sprite");if(!n||!s)continue;if(n.openedTile&&(s.tile=n.openedTile),n.newType){const a=b8.ECS.getComponent(e,"Loc"),c=b8.ECS.getComponent(e,"Type");mapper.changeObjectTypeAt(a.col,a.row,c.name,n.newType)}b8.Sfx.play("tone/jingle/017");const i=b8.ECS.getComponent(e,"Reward");mapper.giveRewards(t,i?.items||[]),b8.ECS.removeComponent(e,"Reward"),b8.ECS.removeComponent(e,"Action"),b8.ECS.removeComponent(e,"Openable"),b8.ECS.getComponent(e,"Message")?.message?.length>0&&b8.ECS.addComponent(e,"Action",{ButtonB:"read"}),mapper.delayKeyPress();return}},mapper.actions.pull=function(t){const o=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Direction");mapper.systems.tryPulling(o.col,o.row,e.dx,e.dy,t)},mapper.actions.read=async function(t){const o=mapper.entitiesAhead(t);for(const e of o){const n=b8.ECS.getComponent(e,"Message"),s=b8.ECS.getComponent(e,"Sprite");if(!n||!s)continue;b8.color(s.fg??15,s.bg??5);const i=mapper.helpers.processChatText(n.message||"");await b8.Async.dialogTypewriter(i,["OK"],20),mapper.delayKeyPress();return}},mapper.actions.trigger=function(t){const o=mapper.entitiesAhead(t);for(const e of o){const n=b8.ECS.getComponent(e,"Type");console.log(`Trigger action by player on type: ${n.name}`),mapper.types[n.name]?.handleTrigger&&mapper.types[n.name].handleTrigger(t,e)}},mapper.camera={getScreenPosition:function(t,o){if(!mapper.isValidMapId(mapper.currentMapId))return b8.Utilities.error("No current map set."),{col:0,row:0};const e=mapper.getCurrentMap(),n=e.screenWidth,s=e.screenHeight,i=Math.floor(t/n)*n,r=Math.floor(o/s)*s;return{col:i,row:r,w:n,h:s}},getTilePosition:function(t,o){const e=b8.ECS.getComponent(mapper.player,"Loc"),n=mapper.camera.getScreenPosition(e.col,e.row);let s=t-n.col,i=o-n.row;return s<0&&(s=-100),i<0&&(i=-100),s>=n.w&&(s=-100),i>=n.h&&(i=-100),{col:s,row:i}}},mapper.collision={isSolidAt:(t,o)=>b8.ECS.entitiesAt(t,o).some(e=>b8.ECS.hasComponent(e,"Solid")),isFree:(t,o)=>mapper.collision.isWalkable(t,o)&&!mapper.collision.isSolidAt(t,o),isWalkable:function(t,o){const e=mapper.getCurrentMap();return!(t<0||o<0||t>=e.mapWidth||o>=e.mapHeight||e.mapData[o][t][3]===!0)}},mapper.helpers={capitalizeWords:t=>t.replace(/\b\p{L}/gu,o=>o.toUpperCase()),processChatText:t=>(t=t.replace(/\[levelName\]/g,b8.data.levelName??"Unknown"),t=t.replace(/\[playerName\]/g,b8.data.playerName??"Player"),t=t.replace(/\[totalCoins\]/g,b8.data.totalCoins??"0"),t),getObjectsByType:t=>{const o=[];for(let e=0;e<mapper.maps.length;e++){const n=mapper.maps[e];for(const s of n.objects)s.type.startsWith(t)&&o.push(s)}return o}},mapper.load=function(t){b8.ECS.reset(),mapper.maps=[],mapper.settings={},mapper.currentMapId=null,b8.Utilities.checkObject("mapData",t),t.version===1&&(t=mapper.upgradeMapDataV1toV2(t)),mapper.settings={...t.settings},b8.Utilities.checkObject("mapper.settings",mapper.settings),t.levels.forEach((e,n)=>{const s=e.mapData.join(`
`);b8.Utilities.checkString(`mapDataString for level ${n}`,s);const i=b8.Tilemap.convertFromText(s),r=b8.Tilemap.createFromArray(i,t.tiles),a=(e.objects||[]).map(c=>({...c,mapId:n}));mapper.maps.push({screenWidth:t.screenWidth,screenHeight:t.screenHeight,screenCountX:e.screenCountX,screenCountY:e.screenCountY,objects:a,mapWidth:r[0].length,mapHeight:r.length,mapData:r})}),mapper.settings.gameName&&(b8.CONFIG.NAME=mapper.settings.gameName),mapper.player=b8.ECS.create({Type:{name:"player"},Loc:{row:0,col:0},Direction:{dx:0,dy:1},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{value:2,max:12},Attack:{value:1}}),mapper.setCurrentMap(0);let o=0;for(const e of mapper.maps)o+=e.objects.filter(n=>n.type==="coin").length;b8.data.totalCoins=o,b8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),b8.ECS.addSystem("pathFollower",mapper.systems.pathFollower),b8.ECS.addSystem("sprite",mapper.systems.sprite),b8.ECS.addSystem("pickup",mapper.systems.pickup),b8.ECS.addSystem("vfx",mapper.systems.vfx),b8.ECS.addSystem("health",mapper.systems.health),b8.ECS.addSystem("bomb",mapper.systems.bomb),b8.ECS.addSystem("fire",mapper.systems.fire),b8.ECS.addSystem("fireSmall",mapper.systems.fireSmall),b8.ECS.addSystem("flammable",mapper.systems.flammable),mapper.settings.bgm&&b8.Music.play(mapper.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&b8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=b8.Tilemap.load(mapper.settings.splash))},mapper.upgradeMapDataV1toV2=function(t){const o={mapData:[...t.map],objects:[...t.objects],screenCountX:t.screenCountX,screenCountY:t.screenCountY};return t.levels=[o],t.version=2,delete t.map,delete t.objects,delete t.screenCountX,delete t.screenCountY,t},mapper.setCurrentMap=function(t){if(b8.Utilities.checkInt("mapId",t),t<0||t>=mapper.maps.length){b8.Utilities.fatal(`Map ID "${t}" is out of bounds.`);return}if(t===mapper.currentMapId)return;let o=mapper.maps[t];o.objects||(o.objects=[]);const e=b8.ECS.getAllEntities();for(const n of e)b8.ECS.getComponent(n,"Type")?.name!=="player"&&b8.ECS.removeEntity(n);for(const n of o.objects){const s=mapper.types[n.type];s?.spawn&&s.spawn(n.x,n.y,n.props)}mapper.currentMapId=t,mapper.maps[mapper.currentMapId].objects=mapper.maps[mapper.currentMapId].objects.filter(n=>n.type!=="start")},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(b8.Tilemap.draw(mapper.bg.splash),b8.locate(b8.CONFIG.SCREEN_COLS-1,b8.CONFIG.SCREEN_ROWS-1),b8.color(15,0),b8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.sceneGame={UI:null,moveDelay:.15,init:function(){mapper.sceneGame.UI=b8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(t){if(mapper.update(t),mapper.sceneGame.moveDelay-=t,mapper.sceneGame.moveDelay>0)return;const o=b8.ECS.getComponent(mapper.player,"Loc");let e=0,n=0,s=!1;if(b8.key("ArrowUp")?(n=-1,s=!0):b8.key("ArrowDown")?(n=1,s=!0):b8.key("ArrowLeft")?(e=-1,s=!0):b8.key("ArrowRight")&&(e=1,s=!0),b8.key("ButtonA")&&(mapper.doAttack(mapper.player,"ButtonA"),s=!0),b8.key("ButtonB")&&(mapper.doAction(mapper.player,"ButtonB"),s=!0),s&&mapper.updateMoveDelay(),e!==0||n!==0){let i=o.col+e,r=o.row+n;mapper.setPlayerWalkAnimation(mapper.player,e,n),(!mapper.collision.isWalkable(i,r)||mapper.doCollision(o.col,o.row,i,r,e,n))&&(i=o.col,r=o.row),b8.ECS.setComponent(mapper.player,"Direction",{dx:e,dy:n}),b8.ECS.setLoc(mapper.player,i,r)}},render:function(){b8.cls(0),b8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),b8.locate(0,b8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),b8.Tilemap.draw(mapper.sceneGame.UI),b8.locate(2,b8.CONFIG.SCREEN_ROWS-2),b8.color(parseInt(mapper.settings.coinColor)||10,0),b8.printChar(parseInt(mapper.settings.coin)||266),b8.color(15,0),b8.print(" "+parseInt(b8.Inventory.getCount("coin")).toString().padStart(4,"0"));const t=b8.ECS.getComponent(mapper.player,"Health"),o=t.max,e=t.value;for(let s=0;s<Math.floor(o/2);s++){const i=2+s,r=b8.CONFIG.SCREEN_ROWS-3;b8.locate(i,r),e>=s*2+2?(b8.color(8,0),b8.printChar(415)):e===s*2+1?(b8.color(8,0),b8.printChar(416)):(b8.color(6,0),b8.printChar(417))}b8.Inventory.filter(/^key/).forEach((s,i)=>{const r=parseInt(s.id.split("-")[1])||15;b8.locate(10+i,b8.CONFIG.SCREEN_ROWS-2),b8.color(r,-1),b8.printChar(255)}),b8.color(15,-1),b8.locate(11,b8.CONFIG.SCREEN_ROWS-4),b8.print(" Hit"),b8.locate(15,b8.CONFIG.SCREEN_ROWS-4),b8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player,"ButtonB")))}},mapper.sceneMenu={init:function(){if(!mapper.menu.hasSplash()){b8.Scene.set("game");return}mapper.sceneMenu.main()},main:async()=>{b8.locate(0,0),mapper.menu.drawSplash(),b8.locate(5,18),b8.color(0,10);let t=["Start Game"];mapper.menu.hasInstructions()&&t.push("Instructions"),mapper.menu.hasCredits()&&t.push("Credits");let o=await b8.Async.menu(t,{border:!1,padding:0,centerH:!0});const e=t[o];if(e==="Start Game"){b8.Scene.set("game");return}if(e==="Instructions"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getInstructions(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}if(e==="Credits"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getCredits(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.bomb=async function(t){const o=b8.ECS.query("Bomb"),e=mapper.types.bomb.color,n=mapper.types.bomb.flickerColor;for(const s of o){const i=b8.ECS.getComponent(s,"Bomb");if(i.fuseTime===!1)continue;i.fuseTime-=t;const r=b8.ECS.getComponent(s,"Sprite");if(i.fuseTime>5?r.fg=e:i.fuseTime>2.5?r.fg=Math.floor(i.fuseTime*2)%2===0?e:n:i.fuseTime>1?r.fg=Math.floor(i.fuseTime*4)%2===0?e:n:i.fuseTime>0&&(r.fg=Math.floor(i.fuseTime*10)%2===0?e:n),i.fuseTime<=0){const a=b8.ECS.getComponent(s,"Loc");mapper.types.vfx.spawn(a.col,a.row,{id:"explosion",fg:9}),await mapper.types.bomb.explode(s),b8.ECS.removeEntity(s)}}},mapper.systems.characterAnimation=function(t){const o=b8.ECS.query("CharacterAnimation");if(o)for(const e of o){const n=b8.ECS.getComponent(e,"CharacterAnimation");if(n&&n.duration>0&&(n.duration-=t,n.duration<=0)){let s=n.default||"";const i=b8.ECS.getComponent(e,"Direction");if(i){const a={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${i.dx},${i.dy}`]||"";s=s+a}n.name=s}}},mapper.systems.fireSmall=async function(t){const o=mapper.types.fireSmall.damagePerSecond;b8.ECS.query("FireSmall").forEach(n=>{const s=b8.ECS.getComponent(n,"FireSmall"),i=b8.ECS.getComponent(n,"Loc"),r=b8.ECS.getComponent(s.parent,"Loc");r&&(i.col=r.col,i.row=r.row);const a=b8.ECS.getComponent(s.parent,"Health");a&&(a.value-=o*t,a.value<0&&(s.duration=0)),s.duration-=t,s.duration<=0&&(b8.ECS.removeEntity(n),b8.ECS.removeComponent(s.parent,"OnFire"),a&&(a.value=Math.floor(a.value)))})},mapper.systems.fire=async function(t){b8.ECS.query("Fire","Loc").forEach(e=>{const n=b8.ECS.getComponent(e,"Fire"),s=b8.ECS.getComponent(e,"Loc");if(n.duration!==1/0&&(n.duration-=t,n.duration<=0)){b8.ECS.removeEntity(e),mapper.types.vfx.spawn(s.col,s.row,{id:"shrink",fg:9});return}b8.ECS.entitiesAt(s.col,s.row).forEach(a=>{if(a!==e&&(b8.ECS.hasComponent(a,"Health")&&(b8.ECS.hasComponent(a,"OnFire")||mapper.types.fireSmall.spawn(s.col,s.row,{parent:a,duration:3}),b8.ECS.addComponent(a,"OnFire")),b8.ECS.hasComponent(a,"Bomb"))){const c=b8.ECS.getComponent(a,"Bomb");c.fuseTime=2}}),mapper.entitiesNextTo(e).forEach(a=>{if(a===e)return;const c=b8.ECS.getComponent(a,"Flammable");c&&(c.temperature=(c.temperature||0)+70*t)})})},mapper.systems.flammable=async function(t){b8.ECS.query("Flammable").forEach(e=>{const n=b8.ECS.getComponent(e,"Flammable");if(n.temperature>=100){const s=b8.ECS.getComponent(e,"Loc");b8.ECS.removeEntity(e),mapper.types.fire.spawn(s.col,s.row);return}n.temperature=Math.max(0,(n.temperature||0)-10*t)})},mapper.systems.health=async function(t){b8.ECS.query("Health").forEach(e=>{if(b8.ECS.getComponent(e,"Health").value<=0){const s=b8.ECS.getComponent(e,"Loc");if(s&&mapper.types.vfx.spawn(s.col,s.row,{id:"skull",fg:2,bg:0,offsetTime:200}),mapper.updateMoveDelay(.6),b8.ECS.removeEntity(e),e===mapper.player.id)return}})},mapper.systems.pathFollower=async function(t){const o={U:"move-up",D:"move-down",L:"move-left",R:"move-right",FU:"idle-up",FD:"idle-down",FL:"idle-left",FR:"idle-right"},e={U:"D",D:"U",L:"R",R:"L",FU:"FD",FD:"FU",FL:"FR",FR:"FL"},n=b8.ECS.query("Loc","PathFollower");for(const i of n){const r=b8.ECS.getComponent(i,"PathFollower");if(!r||!r.steps.length||(r.timer-=t,r.timer>0))continue;r.timer=mapper.CONFIG.moveDelay*2;const a=r.steps[r.index];let c=!1;if(a.dir&&a.dir[0]==="F"&&(c=!0),mapper.collision.isWalkable(a.x,a.y)&&!mapper.collision.isSolidAt(a.x,a.y)&&(c=!0),!c)continue;b8.ECS.setLoc(i,a.x,a.y),s(r);const l=b8.ECS.getComponent(i,"CharacterAnimation");if(l.duration=.5,o[a.dir]){let p=a.dir;r.dirStep===-1&&(p=e[a.dir]||a.dir),l.name=o[p]}}function s(i){const r=i.steps.length-1;switch(i.mode){case"once":i.index<r&&i.index++;break;case"loop":i.index=(i.index+1)%i.steps.length;break;case"pingpong":default:i.index===0?i.dirStep=1:i.index===r&&(i.dirStep=-1),i.index+=i.dirStep;break}}},mapper.systems.pickup=function(){const t=mapper.player,o=b8.ECS.getComponent(t,"Loc");b8.ECS.query("Pickup","Loc").forEach(n=>{const s=b8.ECS.getComponent(n,"Loc");if(s.col!==o.col||s.row!==o.row)return;const i=b8.ECS.getComponent(n,"Pickup");mapper.giveRewards(t,[{type:i.type,props:i.props}]),i.consume&&(b8.ECS.removeEntity(n),mapper.removeObjectAt(s.col,s.row,i.type))})},mapper.systems.tryPortal=async function(t,o){const e=b8.ECS.entitiesAt(t,o);if(!e)return!1;for(const n of e){const s=b8.ECS.getComponent(n,"Portal");return mapper.systems.handlePortal(s)}return!1},mapper.systems.handlePortal=async function(t){if(!t||t.target==="")return!1;const e=mapper.helpers.getObjectsByType("door").find(n=>n.props.name===t.target);return e&&(await b8.Async.wait(.1),mapper.setCurrentMap(e.mapId),b8.ECS.setLoc(mapper.player,e.x,e.y)),!1},mapper.systems.tryPushing=(t,o,e,n)=>{const s=t+e,i=o+n;for(const r of b8.ECS.entitiesAt(s,i)){if(!b8.ECS.hasComponent(r,"Solid")||!b8.ECS.hasComponent(r,"Pushable"))continue;const a=b8.ECS.getComponent(r,"Loc"),c=a.col+e,l=a.row+n;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(u=>b8.ECS.hasComponent(u,"Solid"))?!0:(b8.ECS.setLoc(r,c,l),b8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(t,o,e,n,s)=>{const i=t+e,r=o+n;for(const a of b8.ECS.entitiesAt(i,r)){if(!b8.ECS.hasComponent(a,"Solid")||!b8.ECS.hasComponent(a,"Pushable"))continue;const c=t-e,l=o-n;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(p=>b8.ECS.hasComponent(p,"Solid"))?!1:(b8.ECS.setLoc(a,t,o),b8.ECS.setLoc(s,c,l),mapper.setPlayerWalkAnimation(s,e,n),b8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.sprite=function(t){const o=b8.ECS.query("Sprite");for(const e of o){const n=b8.ECS.getComponent(e,"Sprite");n.nudgeCol&&(n.nudgeCol=n.nudgeCol*.75),n.nudgeRow&&(n.nudgeRow=n.nudgeRow*.75)}},mapper.systems.teleportSystem=async function(t){const o=b8.ECS.query("Teleport");for(const[e,n]of o){const i=b8.ECS.query("Portal").find(([r])=>b8.ECS.getComponent(r,"Portal")?.name===n.target);if(i){const r=b8.ECS.getComponent(i[0],"Loc");r&&(await b8.Async.wait(.1),b8.ECS.setLoc(e,r.col,r.row))}b8.ECS.removeComponent(e,"Teleport")}},mapper.systems.vfx=async function(t){const o=b8.ECS.query("Vfx","Sprite");for(const e of o){const n=b8.ECS.getComponent(e,"Sprite");b8.Vfx.shouldLoop(n.id,n.startTime)||b8.ECS.removeEntity(e)}},mapper.types.skeleton={},mapper.types.bomb={color:8,flickerColor:15,spawn:function(t,o,e={}){return b8.ECS.create({Type:{name:"bomb"},Loc:{col:t,row:o},Sprite:{tile:283,fg:mapper.types.bomb.color,bg:0,depth:10},Solid:{},Pushable:{},Action:{ButtonB:"pull",ButtonA:"ignite"},Bomb:{fuseTime:!1,radius:parseInt(e.radius)||1,damage:2},Flammable:{temperature:20}})},explode:async function(t){const o=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Bomb");for(let n=-e.radius;n<=e.radius;n++)for(let s=-e.radius;s<=e.radius;s++){console.log("Spawn fire",n,s);const i=o.row+s,r=o.col+n;mapper.collision.isWalkable(r,i)&&mapper.types.fire.spawn(r,i)}}},mapper.types.chestOpen={spawn:function(t,o,e={}){const n={Type:{name:"chest"},Loc:{col:t,row:o},Sprite:{tile:271,fg:e.fg||15,bg:e.bg||0,depth:10},Solid:{}};return console.log("chest open props",e),e.message&&(n.Message={message:e.message},n.Action={ButtonB:"read"}),b8.ECS.create(n)}},mapper.types.chest={items:{0:"Empty",1:"Key",2:"Coin",3:"10 Coins",4:"50 Coins",5:"Half Heart",6:"Heart",7:"Full Heart"},spawn:function(t,o,e={}){let n=[],s=e.fg||15,i="";return mapper.types.chest.items[e.contains]&&(i=mapper.types.chest.items[e.contains]),i==="Key"&&n.push({type:"key",props:{name:`key-${s}`}}),i.endsWith("Coins")&&n.push({type:"coin",props:{amount:parseInt(i.split(" ")[0],10)}}),i==="Coin"&&n.push({type:"coin",props:{amount:1}}),i==="Half Heart"&&n.push({type:"health",props:{amount:1}}),i==="Heart"&&n.push({type:"health",props:{amount:2}}),i==="Full Heart"&&n.push({type:"health",props:{amount:9999}}),b8.ECS.create({Type:{name:"chest"},Loc:{col:t,row:o},Sprite:{tile:253,fg:s,bg:e.bg||0,depth:10},Solid:{},Openable:{closedTile:253,openedTile:271,newType:"chestOpen"},Message:{message:e.message||""},Reward:{items:n},Action:{ButtonA:"open",ButtonB:"open"}})}},mapper.types.coin={spawn:function(t,o,e={}){return mapper.types.pickup.spawn(t,o,{type:"coin",Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:mapper.settings.coinColor||14,bg:e.bg||0}})},pickupHandler:function(t,o){b8.Inventory.add("coin",o?.props?.amount||1),b8.Sfx.play("game/coin/002")}},mapper.types.crate={spawn:function(t,o,e={}){return b8.ECS.create({Type:{name:"crate"},Loc:{col:t,row:o},Sprite:{tile:352,fg:e.fg||15,bg:e.bg||0,depth:10},Solid:{},Pushable:{},Action:{ButtonB:"pull"},Flammable:{temperature:20}})}},mapper.types.doorOpen={spawn:function(t,o,e={}){const n={Type:{name:"door"},Loc:{col:t,row:o},Sprite:{tile:216,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return b8.ECS.create(n)},onCharacterCollision:function(t,o,e,n,s){return mapper.systems.tryPortal(o,e),!1}},mapper.types.doorStairs={spawn:function(t,o,e={}){const n=e.icon||197,s={Type:{name:"doorStairs"},Loc:{col:t,row:o},Sprite:{tile:n,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return b8.ECS.create(s)},onCharacterCollision:function(t,o,e,n,s){return mapper.systems.tryPortal(o,e),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,spawn:function(t,o,e={}){const n=e.icon||mapper.types.door.TILE_DOOR_DEFAULT,s={Type:{name:"door"},Loc:{col:t,row:o},Sprite:{tile:n,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return n!==mapper.types.door.TILE_DOOR_OPEN&&(s.Solid={}),b8.ECS.create(s)},onCharacterCollision:function(t,o,e,n,s){if(!b8.ECS.hasComponent(t,"Solid"))return mapper.systems.tryPortal(o,e),!1;const i=b8.ECS.getComponent(t,"Sprite"),r=`key-${i.fg??"default"}`;return b8.Inventory.has(r)&&(b8.ECS.removeComponent(t,"Solid"),i.tile=mapper.types.door.TILE_DOOR_OPEN,b8.Sfx.play("ui/click/004")),!0}},mapper.types.enemy={difficulties:{Easy:[3,1,11],Medium:[5,2,9],Hard:[8,3,8]},spawn:function(t,o,e={}){const s=e.health||"Easy",[i,r,a]=mapper.types.enemy.difficulties[s]||mapper.types.enemy.difficulties.Easy,c={Type:{name:"enemy"},Loc:{col:t,row:o},Sprite:{type:"actor",tile:parseInt(e.actor)||6,fg:a||15,bg:0,depth:50},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{value:i||3,max:i||3},Attack:{value:r||1},AttackTarget:{},Action:{ButtonA:"attack"}};if(e.path&&b8.Path.validPathSyntax(e.path)){let l=e.mode||"pingpong";const p=b8.Path.parseCode(e.path,t,o,"D"),u=p.length-1;p[u].x===t&&p[u].y===o&&(l="loop"),c.PathFollower={steps:p,index:0,mode:l,dirStep:1,timer:0,startDir:e.startDir||"D"}}return b8.ECS.create(c)}},mapper.types.fireSmall={damagePerSecond:1,spawn:function(t,o,e={}){if(e.parent)return b8.ECS.create({Type:{name:"fire-small"},Loc:{col:t,row:o},Sprite:{type:"vfx",id:"fire-small",offsetY:-4,startTime:b8.Core.getNow(),fg:9,bg:-1,depth:100},FireSmall:{duration:e.duration||3,parent:e.parent}})}},mapper.types.fire={damagePerSecond:2,spawn:function(t,o,e={}){let n=parseInt(e.duration)||5;return n+=b8.Random.range(0,2),b8.ECS.create({Type:{name:"fire"},Loc:{col:t,row:o},Sprite:{type:"vfx",id:"fire",startTime:b8.Core.getNow()+b8.Random.int(0,400),fg:10,bg:0},Fire:{duration:n}})}},mapper.types.healthFull={spawn:function(t,o,e={}){return mapper.types.pickup.spawn(t,o,{type:"health",props:{amount:1e3},Sprite:{tile:414,fg:10,bg:0}})}},mapper.types.healthHalf={spawn:function(t,o,e={}){return mapper.types.pickup.spawn(t,o,{type:"health",props:{amount:1},Sprite:{tile:416,fg:8,bg:0}})}},mapper.types.health={spawn:function(t,o,e={}){return mapper.types.pickup.spawn(t,o,{type:"health",props:{amount:2},Sprite:{tile:415,fg:8,bg:0}})},pickupHandler:function(t,o){const e=b8.ECS.getComponent(t,"Health");e.value=Math.min(e.max,e.value+(o.props.amount||1))}},mapper.types.key={spawn:function(t,o,e={}){const n=e.fg||14;return mapper.types.pickup.spawn(t,o,{type:"key",props:{name:`key-${n}`},Sprite:{tile:255,fg:e.fg||14,bg:e.bg||0}})},pickupHandler:function(t,o){b8.Inventory.add(o.props.name),b8.Sfx.play("tone/bloop/006")}},mapper.types.pickup={spawn:function(t,o,e={}){if(e.type)return b8.ECS.create({Type:{name:"pickup"},Loc:{col:t,row:o},Sprite:{tile:e.Sprite.tile??415,fg:e.Sprite.fg??8,bg:e.Sprite.bg??0},Pickup:{type:e.type,consume:e.consume??!0,props:e.props||{}}})}},mapper.types.signpost={spawn:function(t,o,e={}){return b8.ECS.create({Type:{name:"signpost"},Loc:{col:t,row:o},Sprite:{tile:e.icon||252,fg:e.fg||15,bg:e.bg||0},Solid:{},Message:{message:e.message||""},Action:{ButtonA:"trigger",ButtonB:"read"}})},handleTrigger:function(t,o){const e=b8.ECS.getComponent(o,"Sprite");if(e.tile!==252||(e.tile=270,!b8.ECS.hasComponent(o,"Message")))return;const n=b8.ECS.getComponent(o,"Message");n.message="... "+n.message.slice(Math.floor(n.message.length/2))}},mapper.types.start={spawn:function(t,o,e={}){b8.ECS.setLoc(mapper.player,t,o)}},mapper.types.vfx={spawn:function(t,o,e={}){return e.id?b8.ECS.create({Type:{name:"vfx"},Loc:{col:t,row:o},Vfx:{},Sprite:{type:"vfx",id:e.id,startTime:b8.Core.getNow()+(e.offsetTime||0),fg:parseInt(e.fg)||15,bg:parseInt(e.bg)||0,nudgeCol:parseInt(e.nudgeCol)||0,nudgeRow:parseInt(e.nudgeRow)||0,depth:50}}):{}}};
