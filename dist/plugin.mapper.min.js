const mapper={maps:[],currentMapId:null,types:{},systems:{},actions:{},settings:{},bg:{},lastPosition:null,player:null,play:function(e){b8.Utilities.checkObject("mapData",e),mapper.mapData=e,mapper.reset(),b8.Scene.add("menu",mapper.sceneMenu),b8.Scene.add("game",mapper.sceneGame),b8.Scene.add("gameover",mapper.sceneGameOver),b8.Scene.set("menu")},reset:function(){mapper.load(mapper.mapData)},continue:function(){b8.ECS.setComponent(mapper.player,"Health",{value:6,max:12}),mapper.setCurrentMap(mapper.lastPosition.map,!0),b8.ECS.setLoc(mapper.player,mapper.lastPosition.col,mapper.lastPosition.row)},update:function(e){b8.ECS.run(e)},drawActor:function(e){const o=mapper.camera.getScreenPosition(e.col,e.row),t=e.col-o.col,n=e.row-o.row;b8.locate(t+offsetX,n+offsetY),b8.color(e.fg,e.bg),b8.drawActor(e.id,e.animation)},delayKeyPress:function(e){console.log(`Key press delay for entity ${e}`),b8.ECS.setComponent(e,"ActionCooldown",{time:mapper.CONFIG.keyPressDelay})},setPlayerWalkAnimation:function(e,o,t){const n=b8.ECS.getComponent(e,"CharacterAnimation");t>0&&(n.name="move-down"),t<0&&(n.name="move-up"),o>0&&(n.name="move-right"),o<0&&(n.name="move-left"),n.duration=.3},render:function(e=0,o=0){const t=[];for(const n of b8.ECS.query("Sprite","Loc")){const i=b8.ECS.getComponent(n,"Sprite"),s=b8.ECS.getComponent(n,"Loc"),a=b8.ECS.getComponent(n,"CharacterAnimation");t.push({spr:i,loc:s,anim:a})}if(t.length!==0){t.sort((n,i)=>(n.spr.depth??0)-(i.spr.depth??0));for(const{spr:n,loc:i,anim:s}of t){const a=mapper.camera.getTilePosition(i.col,i.row),r=n.nudgeCol||0,c=n.nudgeRow||0;switch(b8.locate(a.col+e,a.row+o),b8.color(n.fg??15,n.bg??0),n.type){case"actor":b8.drawActor(parseInt(n.tile),s.name,r,c);break;case"vfx":b8.Vfx.draw(n.id,n.startTime,r,c);break;case"vfx-outline":b8.Vfx.drawOutline(n.id,n.startTime,r,c);break;default:b8.printChar(parseInt(n.tile));break}}}},drawScreen:function(){if(!mapper.isValidMapId(mapper.currentMapId)){b8.Utilities.fatal("No current map set.");return}let e=b8.ECS.getComponent(mapper.player,"Loc");e||(e={col:0,row:0});const o=mapper.camera.getScreenPosition(e.col,e.row),t=mapper.getCurrentMap();b8.Tilemap.draw(t.mapData,o.col,o.row,o.w,o.h)},setTile:function(e,o,t){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}if(e<0||o<0||o>=mapper.currentMap.map.mapHeight||e>=mapper.currentMap.map.mapWidth){b8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[o][e]=t},getPropForEntity:(e,o=null)=>{const t=b8.ECS.getComponent(e,"Action");return!t||!o||!(o in t)?"":t[o]??""},getCurrentMap:()=>mapper.maps[mapper.currentMapId],getMapWidth:()=>mapper.getCurrentMap().mapWidth,getMapHeight:()=>mapper.getCurrentMap().mapHeight,promptAhead:(e,o=null)=>{if(!o)return"";const t=mapper.entitiesAhead(e);for(const n of t){const i=mapper.getPropForEntity(n,o);if(i)return i}return""},ahead:e=>{const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Direction");if(!o||!t)return{x:0,y:0};const n=o.col+(t.dx||0),i=o.row+(t.dy||0);return{x:n,y:i}},entitiesAhead:e=>{const{x:o,y:t}=mapper.ahead(e);return b8.ECS.entitiesAt(o,t)??[]},entitiesNextTo:e=>{const o=b8.ECS.getComponent(e,"Loc");if(!o)return[];const t=new Set,n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const i of n){const s=o.col+i.dx,a=o.row+i.dy,r=b8.ECS.entitiesAt(s,a);r&&r.forEach(c=>t.add(c))}return Array.from(t)},doCollision:function(e,o,t,n,i,s){if(mapper.systems.tryPushing(e,o,i,s))return!0;for(const a of b8.ECS.entitiesAt(t,n)){const r=b8.ECS.getComponent(a,"Type"),c=r?mapper.types[r.name]:null;if(c?.onCharacterCollision&&c.onCharacterCollision(a,t,n,i,s)||b8.ECS.hasComponent(a,"Solid"))return!0}return!1},doAction:(e,o)=>{if(!o)return!1;const t=b8.ECS.getComponent(e,"ActionCooldown");if(!t)mapper.delayKeyPress(e);else if(t.time>0)return!1;const n=mapper.promptAhead(e,o);return n&&mapper.actions[n]&&mapper.actions[n](e),mapper.delayKeyPress(e),!0},doAttack:(e,o)=>{if(!mapper.doAction(e,o))return;const t=mapper.ahead(e);mapper.types.vfx.spawn(t.x,t.y,{id:"swipe",fg:15,bg:0,type:"vfx-outline"})},updateMoveDelay:function(e=mapper.CONFIG.moveDelay){mapper.sceneGame.moveDelay=Math.max(e,mapper.sceneGame.moveDelay)},isValidMapId:e=>typeof e=="number"&&e>=0,hasEntityAt:function(e,o,t){const n=b8.ECS.entitiesAt(e,o);for(const i of n)if(b8.ECS.getComponent(i,"Type")?.name===t)return!0;return!1},removeObjectAt:function(e,o,t){const n=mapper.getCurrentMap();n.objects=n.objects.filter(i=>!(i.x===e&&i.y===o&&i.type.startsWith(t)))},changeObjectPropertiesAt:function(e,o,t,n={}){const i=mapper.getCurrentMap();for(const s of i.objects)if(s.x===e&&s.y===o&&s.type.startsWith(t)){Object.assign(s,n);return}},changeObjectTypeAt:function(e,o,t,n){const i=mapper.getCurrentMap();for(const s of i.objects)if(s.x===e&&s.y===o&&s.type.startsWith(t)){s.type=n;return}},giveRewards:function(e,o=[]){!o||o.length===0||o.forEach(t=>{if(!t.type)return;t.props||(t.props={});const n=mapper.types[t.type]?.pickupHandler;n&&n(e,t)})},doHandler:function(e,o){const t=b8.ECS.getComponent(e,"Type"),n=t&&mapper.types[t.name];return n?.[o]?n[o](e):!1},repeatLastValue:function(e,o){const t=e.at(-1);e.push(...Array(o).fill(t))}};mapper.CONFIG={moveDelay:.2,actionDelay:.5,healthCooldown:1.2,keyPressDelay:.25,aiUpdateDelay:.5,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.attack=e=>{const o=mapper.entitiesAhead(e);for(const t of o){if(t===e||!b8.ECS.hasComponent(t,"AttackTarget"))continue;const n=b8.ECS.getComponent(t,"Health"),i=b8.ECS.getComponent(e,"Attack")||{value:1};n.value-=i.value}},mapper.actions.ignite=function(e){const o=mapper.entitiesAhead(e);for(const t of o){if(t===e)continue;const n=b8.ECS.getComponent(t,"Bomb");n&&(n.fuseTime=5)}},mapper.actions.open=async function(e){const o=mapper.entitiesAhead(e);for(const t of o){const n=b8.ECS.getComponent(t,"Openable"),i=b8.ECS.getComponent(t,"Sprite");if(!n||!i)continue;if(n.openedTile&&(i.tile=n.openedTile),n.newType){const r=b8.ECS.getComponent(t,"Loc"),c=b8.ECS.getComponent(t,"Type");mapper.changeObjectTypeAt(r.col,r.row,c.name,n.newType)}if(b8.Sfx.play("tone/jingle/017"),n.message){b8.color(i.fg??15,i.bg??5);const r=mapper.helpers.processChatText(n.message||"");await b8.Async.dialogTypewriter(r,["OK"],20)}const s=b8.ECS.getComponent(t,"Reward");mapper.giveRewards(e,s?.items||[]),b8.ECS.removeComponent(t,"Reward"),b8.ECS.removeComponent(t,"Action"),b8.ECS.removeComponent(t,"Openable"),b8.ECS.getComponent(t,"Message")?.message?.length>0&&b8.ECS.addComponent(t,"Action",{ButtonA:"read",ButtonB:"read"}),mapper.delayKeyPress(t);return}},mapper.actions.pull=function(e){const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Direction");mapper.systems.tryPulling(o.col,o.row,t.dx,t.dy,e)},mapper.actions.read=async function(e){const o=mapper.entitiesAhead(e);for(const t of o){const n=b8.ECS.getComponent(t,"Message"),i=b8.ECS.getComponent(t,"Sprite");if(!n||!i)continue;b8.color(i.fg??15,i.bg??5);const s=mapper.helpers.processChatText(n.message||"");await b8.Async.dialogTypewriter(s,["OK"],20),mapper.delayKeyPress(t);return}},mapper.actions.trigger=function(e){const o=mapper.entitiesAhead(e);for(const t of o){const n=b8.ECS.getComponent(t,"Type");mapper.types[n.name]?.triggerHandler&&mapper.types[n.name].triggerHandler(e,t)}},mapper.ai={MODE:{NONE:"none",RETURN:"return",CHASE:"chase",ATTACK:"attack",FLEE:"flee",LOOT:"loot",WANDER:"wander",PATROL:"patrol",CHASE_LAST_SEEN:"chase_last_seen"},isAdjacent:(e,o)=>b8.Math.distManhattan(e,o)===1,dirTo:(e,o)=>o.col>e.col?{dx:1,dy:0}:o.col<e.col?{dx:-1,dy:0}:o.row>e.row?{dx:0,dy:1}:o.row<e.row?{dx:0,dy:-1}:{dx:0,dy:0},isFacing:(e,o)=>{b8.Utilities.checkInt("from",e),b8.Utilities.checkInt("to",o);const t=b8.ECS.getComponent(e,"Direction"),n=b8.ECS.getComponent(e,"Loc"),i=b8.ECS.getComponent(o,"Loc"),s=mapper.ai.dirTo(n,i);return t.dx===s.dx&&t.dy===s.dy},face:(e,o)=>{const t=mapper.ai.dirTo(e,o);b8.ECS.setComponent(e,"Direction",t)},isBehind:(e,o,t)=>{const n=mapper.ai.dirTo(o,t);return e.dx===-n.dx&&e.dy===-n.dy},hasLineOfSight:(e,o,t=5,n=mapper.collision.isFree)=>{const i=b8.ECS.getComponent(e,"Loc"),s=b8.ECS.getComponent(o,"Loc"),a=b8.Math.dist2d(i.col,i.row,s.col,s.row);return a>t?!1:(a<=1,!0)},canAttack:(e,o)=>{const t=b8.ECS.getComponent(e,"Loc"),n=b8.ECS.getComponent(o,"Loc");return!(!t||!n||!mapper.ai.isAdjacent(t,n))},doAstar:(e,o)=>b8.AStar.pathfind(e,o,mapper.collision.isFree,mapper.getMapWidth(),mapper.getMapHeight()),findNearestLoot:(e,o,t)=>{let n=null,i=1/0;return o.forEach(s=>{const a=b8.Math.distManhattan(e,s.Loc);a<=t&&a<i&&(n=s,i=a)}),n},randomNearbyTile:(e,o)=>{for(let n=0;n<10;n++){const i=e.col+b8.Random.int(-o,o),s=e.row+b8.Random.int(-o,o);if(mapper.collision.isWalkable(i,s)&&mapper.collision.isSafe(i,s))return{col:i,row:s}}for(let n=0;n<10;n++){const i=e.col+b8.Random.int(-o,o),s=e.row+b8.Random.int(-o,o);if(mapper.collision.isWalkable(i,s))return{col:i,row:s}}return!1},nearestPathIndex:(e,o)=>{let t=0,n=1/0;for(let i=0;i<o.length;i++){const s=b8.Math.distManhattan(e,{col:o[i].col,row:o[i].row});s<n&&(n=s,t=i)}return t},isOnPath:(e,o,t=0)=>{for(let n=0;n<o.length;n++)if(b8.Math.distManhattan(e,{col:o[n].x,row:o[n].y})<=t)return{near:!0,index:n,onPath:!0};return{onPath:!1,index:-1}},think:e=>{const o=b8.ECS.getComponent(e,"AI");return b8.ECS.hasComponent(e,"OnFire")?mapper.ai.MODE.FLEE:mapper.ai.canAttack(e,mapper.player)?mapper.ai.MODE.ATTACK:mapper.ai.hasLineOfSight(e,mapper.player)?mapper.ai.MODE.CHASE:o.path&&o.path.length>0?mapper.ai.MODE.PATROL:mapper.ai.MODE.WANDER},toXY:e=>({x:e.col,y:e.row}),toLoc:e=>({col:e.x,row:e.y})},mapper.camera={getScreenPosition:function(e,o){if(!mapper.isValidMapId(mapper.currentMapId))return b8.Utilities.error("No current map set."),{col:0,row:0};const t=mapper.getCurrentMap(),n=t.screenWidth,i=t.screenHeight,s=Math.floor(e/n)*n,a=Math.floor(o/i)*i;return{col:s,row:a,w:n,h:i}},getTilePosition:function(e,o){const t=b8.ECS.getComponent(mapper.player,"Loc");if(!t)return{col:0,row:0};const n=mapper.camera.getScreenPosition(t.col,t.row);let i=e-n.col,s=o-n.row;return i<0&&(i=-100),s<0&&(s=-100),i>=n.w&&(i=-100),s>=n.h&&(s=-100),{col:i,row:s}}},mapper.collision={isSolid:(e,o)=>b8.ECS.entitiesAt(e,o).some(t=>b8.ECS.hasComponent(t,"Solid")),isSafe:(e,o)=>!b8.ECS.entitiesAt(e,o).some(t=>b8.ECS.hasComponent(t,"Fire")),isFree:(e,o)=>mapper.collision.isWalkable(e,o)&&!mapper.collision.isSolid(e,o),isWalkable:function(e,o){const t=mapper.getCurrentMap();return!(e<0||o<0||e>=t.mapWidth||o>=t.mapHeight||t.mapData[o][e][3]===!0)}},mapper.helpers={capitalizeWords:e=>e.replace(/\b\p{L}/gu,o=>o.toUpperCase()),processChatText:e=>(e=e.replace(/\[levelName\]/g,b8.data.levelName??"Unknown"),e=e.replace(/\[playerName\]/g,b8.data.playerName??"Player"),e=e.replace(/\[totalCoins\]/g,b8.data.totalCoins??"0"),e),getObjectsByType:e=>{const o=[];for(let t=0;t<mapper.maps.length;t++){const n=mapper.maps[t];for(const i of n.objects)i.type.startsWith(e)&&o.push(i)}return o}},mapper.load=function(e){b8.ECS.reset(),mapper.maps=[],mapper.settings={},mapper.currentMapId=null,b8.Utilities.checkObject("mapData",e),e.version===1&&(e=mapper.upgradeMapDataV1toV2(e)),mapper.settings={...e.settings},b8.Utilities.checkObject("mapper.settings",mapper.settings),e.levels.forEach((t,n)=>{const i=t.mapData.join(`
`);b8.Utilities.checkString(`mapDataString for level ${n}`,i);const s=b8.Tilemap.convertFromText(i),a=b8.Tilemap.createFromArray(s,e.tiles),r=(t.objects||[]).map(c=>({...c,mapId:n}));mapper.maps.push({screenWidth:e.screenWidth,screenHeight:e.screenHeight,screenCountX:t.screenCountX,screenCountY:t.screenCountY,objects:r,mapWidth:a[0].length,mapHeight:a.length,mapData:a})}),mapper.settings.gameName&&(b8.CONFIG.NAME=mapper.settings.gameName),mapper.player=mapper.types.player.spawn(),mapper.lastPosition={col:0,row:0,map:0},mapper.setCurrentMap(0);let o=0;for(const t of mapper.maps)o+=t.objects.filter(n=>n.type==="coin").length;b8.data.totalCoins=o,b8.ECS.addSystem("ai",mapper.systems.ai),b8.ECS.addSystem("action-cooldown",mapper.systems.actionCooldown),b8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),b8.ECS.addSystem("pathFollower",mapper.systems.pathFollower),b8.ECS.addSystem("sprite",mapper.systems.sprite),b8.ECS.addSystem("pickup",mapper.systems.pickup),b8.ECS.addSystem("vfx",mapper.systems.vfx),b8.ECS.addSystem("health",mapper.systems.health),b8.ECS.addSystem("bomb",mapper.systems.bomb),b8.ECS.addSystem("fire",mapper.systems.fire),b8.ECS.addSystem("fireSmall",mapper.systems.fireSmall),b8.ECS.addSystem("flammable",mapper.systems.flammable),mapper.settings.bgm&&b8.Music.play(mapper.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&b8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=b8.Tilemap.load(mapper.settings.splash))},mapper.upgradeMapDataV1toV2=function(e){const o={mapData:[...e.map],objects:[...e.objects],screenCountX:e.screenCountX,screenCountY:e.screenCountY};return e.levels=[o],e.version=2,delete e.map,delete e.objects,delete e.screenCountX,delete e.screenCountY,e},mapper.setCurrentMap=function(e,o=!1){if(b8.Utilities.checkInt("mapId",e),e<0||e>=mapper.maps.length){b8.Utilities.fatal(`Map ID "${e}" is out of bounds.`);return}if(e===mapper.currentMapId&&!o)return;mapper.currentMapId=e;let t=mapper.maps[e];t.objects||(t.objects=[]);const n=b8.ECS.getAllEntities();for(const i of n)b8.ECS.getComponent(i,"Type")?.name!=="player"&&b8.ECS.removeEntity(i);for(const i of t.objects){const s=mapper.types[i.type];s?.spawn&&s.spawn(i.x,i.y,i.props)}mapper.maps[mapper.currentMapId].objects=mapper.maps[mapper.currentMapId].objects.filter(i=>i.type!=="start")},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(b8.Tilemap.draw(mapper.bg.splash),b8.locate(b8.CONFIG.SCREEN_COLS-1,b8.CONFIG.SCREEN_ROWS-1),b8.color(15,0),b8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.pathFollower={DIRS:{U:{dx:0,dy:-1},D:{dx:0,dy:1},L:{dx:-1,dy:0},R:{dx:1,dy:0},FU:{dx:0,dy:-1},FD:{dx:0,dy:1},FL:{dx:-1,dy:0},FR:{dx:1,dy:0}},VEC_TO_DIR:null,animationMap:{U:"move-up",D:"move-down",L:"move-left",R:"move-right",FU:"idle-up",FD:"idle-down",FL:"idle-left",FR:"idle-right"},animationInverse:{U:"D",D:"U",L:"R",R:"L",FU:"FD",FD:"FU",FL:"FR",FR:"FL"},init:function(){mapper.pathFollower.VEC_TO_DIR=Object.fromEntries(Object.entries(mapper.pathFollower.DIRS).map(([e,o])=>[`${o.dx},${o.dy}`,e])),console.log(mapper.pathFollower.VEC_TO_DIR)},advancePathIndex:function(e){const o=e.steps.length-1;switch(e.mode){case b8.Path.AnimationMode.ONCE:e.index<o&&e.index++;break;case b8.Path.AnimationMode.LOOP:e.index=(e.index+1)%e.steps.length;break;case b8.Path.AnimationMode.PINGPONG:default:e.index===0?e.dirStep=1:e.index===o&&(e.dirStep=-1),e.index+=e.dirStep;break}},getFaceDirection:function(e){return mapper.pathFollower.VEC_TO_DIR[`${e.dx},${e.dy}`]}},mapper.pathFollower.init(),mapper.sceneGame={UI:null,moveDelay:.15,init:function(){mapper.sceneGame.UI=b8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(e){if(mapper.update(e),mapper.sceneGame.moveDelay-=e,mapper.sceneGame.moveDelay>0)return;const o=b8.ECS.getComponent(mapper.player,"Loc");let t=0,n=0,i=!1;if(b8.key("ArrowUp")?(n=-1,i=!0):b8.key("ArrowDown")?(n=1,i=!0):b8.key("ArrowLeft")?(t=-1,i=!0):b8.key("ArrowRight")&&(t=1,i=!0),b8.key("ButtonA")&&(mapper.doAttack(mapper.player,"ButtonA"),i=!0),b8.key("ButtonB")&&(mapper.doAction(mapper.player,"ButtonB"),i=!0),i&&mapper.updateMoveDelay(),t!==0||n!==0){let s=o.col+t,a=o.row+n;mapper.setPlayerWalkAnimation(mapper.player,t,n),(!mapper.collision.isWalkable(s,a)||mapper.doCollision(o.col,o.row,s,a,t,n))&&(s=o.col,a=o.row),b8.ECS.setComponent(mapper.player,"Direction",{dx:t,dy:n}),b8.ECS.setLoc(mapper.player,s,a)}},render:function(){b8.cls(0),b8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),b8.locate(0,b8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),b8.Tilemap.draw(mapper.sceneGame.UI),b8.locate(2,b8.CONFIG.SCREEN_ROWS-2),b8.color(parseInt(mapper.settings.coinColor)||10,0),b8.printChar(parseInt(mapper.settings.coin)||266),b8.color(15,0),b8.print(" "+parseInt(b8.Inventory.getCount("coin")).toString().padStart(4,"0"));const e=b8.ECS.getComponent(mapper.player,"Health"),o=e.max,t=Math.floor(e.value);for(let i=0;i<Math.floor(o/2);i++){const s=2+i,a=b8.CONFIG.SCREEN_ROWS-3;b8.locate(s,a),t>=i*2+2?(b8.color(8,0),b8.printChar(415)):t===i*2+1?(b8.color(8,0),b8.printChar(416)):(b8.color(6,0),b8.printChar(417))}b8.Inventory.filter(/^key/).forEach((i,s)=>{const a=parseInt(i.id.split("-")[1])||15;b8.locate(10+s,b8.CONFIG.SCREEN_ROWS-2),b8.color(a,-1),b8.printChar(255)}),b8.color(15,-1),b8.locate(11,b8.CONFIG.SCREEN_ROWS-4),b8.print(" Hit"),b8.locate(15,b8.CONFIG.SCREEN_ROWS-4),b8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player,"ButtonB")))}},mapper.sceneGameOver={init:function(){mapper.sceneGameOver.main()},main:async()=>{b8.cls(6),b8.locate(0,5),b8.color(10,6),b8.printCentered(`GAME OVER

`);let e=["Continue","Main Menu"],o=await b8.Async.menu(e,{border:!1,padding:0,centerH:!0});const t=e[o];if(t==="Continue"){mapper.continue(),b8.Scene.set("game");return}if(t==="Main Menu"){b8.Scene.set("menu");return}setTimeout(mapper.sceneGameOver.main,10)}},mapper.sceneMenu={init:function(){if(!mapper.menu.hasSplash()){b8.Scene.set("game");return}mapper.sceneMenu.main()},main:async()=>{b8.locate(0,0),mapper.menu.drawSplash(),b8.locate(5,18),b8.color(0,10);let e=["Start Game"];mapper.menu.hasInstructions()&&e.push("Instructions"),mapper.menu.hasCredits()&&e.push("Credits");let o=await b8.Async.menu(e,{border:!1,padding:0,centerH:!0});const t=e[o];if(t==="Start Game"){mapper.reset(),b8.Scene.set("game");return}if(t==="Instructions"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getInstructions(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}if(t==="Credits"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getCredits(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.actionCooldown=function(e){const o=b8.ECS.query("ActionCooldown");for(const t of o){const n=b8.ECS.getComponent(t,"ActionCooldown");n.time-=e,n.time<0&&(n.time=0)}},mapper.ai.updateTimer=0,mapper.systems.ai=function(e){if(mapper.ai.updateTimer+=e,mapper.ai.updateTimer<mapper.CONFIG.aiUpdateDelay)return;mapper.ai.updateTimer=0;const o=b8.ECS.query("AI","Loc");for(const t of o){const n=mapper.ai.think(t),i=b8.ECS.getComponent(t,"AI");n!==i.mode&&(i.mode=n,b8.ECS.setComponent(t,"AI",i));const s=["U","D","L","R"],a=b8.ECS.getComponent(t,"Loc");if(mapper.ai.MODE.WANDER===n){const r=b8.Random.pick(s),c=b8.Random.int(2,8),l=b8.Random.int(8,24),p=`${r}${c}P${l}`,u=b8.Path.parseCode(p,a.col,a.row,r);mapper.types.enemy.setPath(t,u,b8.Path.AnimationMode.ONCE)}if(mapper.ai.MODE.PATROL===n){const r=b8.ECS.getComponent(t,"PathFollower");if(r?.steps&&r.steps.length>0)continue;const c=b8.ECS.getComponent(t,"AI");if(c.path&&c.path.length>0){const l=b8.ECS.getComponent(t,"Loc"),p=mapper.ai.nearestPathIndex(l,c.path),u=c.path[p];if(u.col===l.col&&u.row===l.row)mapper.types.enemy.setPath(t,c.path,null,p);else{const f=mapper.ai.doAstar(l,u);f&&mapper.types.enemy.setPath(t,f,b8.Path.AnimationMode.ONCE)}}}if(mapper.ai.MODE.CHASE===n){const r=b8.ECS.getComponent(mapper.player,"Loc");if(r){const c=mapper.ai.doAstar(a,r);c&&(mapper.repeatLastValue(c,12),mapper.types.enemy.setPath(t,c,b8.Path.AnimationMode.ONCE))}}if(mapper.ai.MODE.ATTACK===n&&(console.log(`Think ATTACK mode (${t})`),mapper.doAttack(t,"ButtonA")),mapper.ai.MODE.FLEE===n){const r=mapper.ai.randomNearbyTile(a,4);if(r){const c=mapper.ai.doAstar(a,r);c&&mapper.types.enemy.setPath(t,c,b8.Path.AnimationMode.ONCE)}}mapper.ai.MODE.LOOT===n&&console.log(`Think LOOT mode (${t})`),mapper.ai.MODE.IDLE===n&&console.log(`Think IDLE mode (${t})`)}},mapper.systems.bomb=async function(e){const o=b8.ECS.query("Bomb"),t=mapper.types.bomb.color,n=mapper.types.bomb.flickerColor;for(const i of o){const s=b8.ECS.getComponent(i,"Bomb");if(s.fuseTime===!1)continue;s.fuseTime-=e;const a=b8.ECS.getComponent(i,"Sprite");if(s.fuseTime>5?a.fg=t:s.fuseTime>2.5?a.fg=Math.floor(s.fuseTime*2)%2===0?t:n:s.fuseTime>1?a.fg=Math.floor(s.fuseTime*4)%2===0?t:n:s.fuseTime>0&&(a.fg=Math.floor(s.fuseTime*10)%2===0?t:n),s.fuseTime<=0){const r=b8.ECS.getComponent(i,"Loc");mapper.types.vfx.spawn(r.col,r.row,{id:"explosion",fg:9}),await mapper.types.bomb.explode(i),b8.ECS.removeEntity(i),b8.Renderer.shakeScreen(),b8.Sfx.play("weapon/explode/013")}}},mapper.systems.characterAnimation=function(e){const o=b8.ECS.query("CharacterAnimation");if(o)for(const t of o){const n=b8.ECS.getComponent(t,"CharacterAnimation");if(n&&n.duration>0&&(n.duration-=e,n.duration<=0)){let i=n.default||"";const s=b8.ECS.getComponent(t,"Direction");if(s){const r={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${s.dx},${s.dy}`]||"";i=i+r}n.name=i}}},mapper.systems.fireSmall=async function(e){const o=mapper.types.fireSmall.damagePerSecond;b8.ECS.query("FireSmall").forEach(n=>{const i=b8.ECS.getComponent(n,"FireSmall"),s=b8.ECS.getComponent(n,"Loc"),a=b8.ECS.getComponent(i.parent,"Loc");a&&(s.col=a.col,s.row=a.row);const r=b8.ECS.getComponent(i.parent,"Health");r&&(r.value-=o*e,r.value<0&&(i.duration=0)),i.duration-=e,i.duration<=0&&(b8.ECS.removeEntity(n),b8.ECS.removeComponent(i.parent,"OnFire"),r&&(r.value=Math.floor(r.value)))})},mapper.systems.fire=async function(e){b8.ECS.query("Fire","Loc").forEach(t=>{const n=b8.ECS.getComponent(t,"Fire"),i=b8.ECS.getComponent(t,"Loc");if(n.duration!==1/0&&(n.duration-=e,n.duration<=0)){b8.ECS.removeEntity(t),mapper.types.vfx.spawn(i.col,i.row,{id:"shrink",fg:9});return}b8.ECS.entitiesAt(i.col,i.row).forEach(r=>{r!==t&&(b8.ECS.hasComponent(r,"Health")&&(b8.ECS.hasComponent(r,"OnFire")||(mapper.types.fireSmall.spawn(i.col,i.row,{parent:r,duration:3}),b8.ECS.addComponent(r,"OnFire"))),mapper.doHandler(r,"burnHandler"))}),mapper.entitiesNextTo(t).forEach(r=>{if(r===t)return;const c=b8.ECS.getComponent(r,"Flammable");c&&(c.temperature=(c.temperature||0)+70*e),mapper.doHandler(r,"burnHandler")})})},mapper.systems.flammable=async function(e){b8.ECS.query("Flammable").forEach(t=>{const n=b8.ECS.getComponent(t,"Flammable");if(n.temperature>=100){const i=b8.ECS.getComponent(t,"Loc");mapper.types.fire.spawn(i.col,i.row),b8.ECS.removeEntity(t);return}n.temperature=Math.max(0,(n.temperature||0)-10*e)})},mapper.systems.health=async function(e){b8.ECS.query("Health").forEach(async t=>{const n=b8.ECS.getComponent(t,"Health");if(n.cooldownTimer=Math.max(0,(n.cooldownTimer||0)-e),!(n.cooldownTimer>0)&&n.value<=0){const i=b8.ECS.getComponent(t,"Loc");i&&mapper.types.vfx.spawn(i.col,i.row,{id:"skull",fg:2,bg:0,offsetTime:200}),t!==mapper.player?b8.ECS.removeEntity(t):(await b8.Async.wait(1),b8.Scene.set("gameover"))}})},mapper.systems.pathFollower=async function(e){const o=b8.ECS.query("Loc","PathFollower");for(const t of o){const n=b8.ECS.getComponent(t,"PathFollower"),i=b8.ECS.getComponent(t,"Loc");if(!n||!n.steps.length||(n.timer-=e,n.timer>0))continue;n.timer=mapper.CONFIG.moveDelay*2;const s=n.steps[n.index],a=i.col===s.col&&i.row===s.row;let r=a;if(s.dir&&s.dir[0]==="F"&&(r=!0),!a&&mapper.collision.isFree(s.col,s.row)&&(r=!0),!r)continue;const c={dx:s.col-i.col,dy:s.row-i.row};b8.ECS.setComponent(t,"Direction",c),b8.ECS.setLoc(t,s.col,s.row),s.dir||(s.dir=mapper.pathFollower.getFaceDirection(c)),mapper.pathFollower.advancePathIndex(n);const l=b8.ECS.getComponent(t,"CharacterAnimation");if(l.duration=.5,mapper.pathFollower.animationMap[s.dir]){let p=s.dir;n.dirStep===-1&&(p=mapper.pathFollower.animationInverse[s.dir]||s.dir),l.name=mapper.pathFollower.animationMap[p]}n.mode===b8.Path.AnimationMode.ONCE&&n.index>=n.steps.length-1&&b8.ECS.removeComponent(t,"PathFollower")}},mapper.systems.pickup=function(){const e=mapper.player,o=b8.ECS.getComponent(e,"Loc");b8.ECS.query("Pickup","Loc").forEach(n=>{const i=b8.ECS.getComponent(n,"Loc");if(i.col!==o.col||i.row!==o.row)return;const s=b8.ECS.getComponent(n,"Pickup");mapper.giveRewards(e,[{type:s.type,props:s.props}]),s.consume&&(b8.ECS.removeEntity(n),mapper.removeObjectAt(i.col,i.row,s.type))})},mapper.systems.tryPortal=async function(e,o){const t=b8.ECS.entitiesAt(e,o);if(!t)return!1;for(const n of t){const i=b8.ECS.getComponent(n,"Portal");return mapper.systems.handlePortal(i)}return!1},mapper.systems.handlePortal=async function(e){if(!e||e.target==="")return!1;const t=mapper.helpers.getObjectsByType("door").find(n=>n.props.name===e.target);return t&&(await b8.Async.wait(.1),mapper.setCurrentMap(t.mapId),mapper.lastPosition={col:t.x,row:t.y,map:t.mapId},b8.ECS.setLoc(mapper.player,t.x,t.y)),!1},mapper.systems.tryPushing=(e,o,t,n)=>{const i=e+t,s=o+n;for(const a of b8.ECS.entitiesAt(i,s)){if(!b8.ECS.hasComponent(a,"Solid")||!b8.ECS.hasComponent(a,"Pushable"))continue;const r=b8.ECS.getComponent(a,"Loc"),c=r.col+t,l=r.row+n;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(u=>b8.ECS.hasComponent(u,"Solid"))?!0:(b8.ECS.setLoc(a,c,l),b8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(e,o,t,n,i)=>{const s=e+t,a=o+n;for(const r of b8.ECS.entitiesAt(s,a)){if(!b8.ECS.hasComponent(r,"Solid")||!b8.ECS.hasComponent(r,"Pushable"))continue;const c=e-t,l=o-n;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(p=>b8.ECS.hasComponent(p,"Solid"))?!1:(b8.ECS.setLoc(r,e,o),b8.ECS.setLoc(i,c,l),mapper.setPlayerWalkAnimation(i,t,n),b8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.sprite=function(e){const o=b8.ECS.query("Sprite");for(const t of o){const n=b8.ECS.getComponent(t,"Sprite");n.nudgeCol&&(n.nudgeCol=n.nudgeCol*.75),n.nudgeRow&&(n.nudgeRow=n.nudgeRow*.75)}},mapper.systems.vfx=async function(e){const o=b8.ECS.query("Vfx","Sprite");for(const t of o){const n=b8.ECS.getComponent(t,"Sprite");b8.Vfx.shouldLoop(n.id,n.startTime)||b8.ECS.removeEntity(t)}},mapper.types.skeleton={spawn:function(e,o,t={}){return b8.ECS.create({})},pickupHandler:function(e,o){},triggerHandler:function(e,o){},onCharacterCollision:function(e,o,t,n,i){},burnHandler:function(e,o){}},mapper.types.bomb={color:8,flickerColor:15,spawn:function(e,o,t={}){return b8.ECS.create({Type:{name:"bomb"},Loc:{col:e,row:o},Sprite:{tile:283,fg:mapper.types.bomb.color,bg:0,depth:10},Solid:{},Pushable:{},Action:{ButtonB:"pull",ButtonA:"ignite"},Bomb:{fuseTime:!1,radius:parseInt(t.radius)||1,damage:2}})},explode:async function(e){const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Bomb");for(let n=-t.radius;n<=t.radius;n++)for(let i=-t.radius;i<=t.radius;i++){const s=o.row+i,a=o.col+n;mapper.collision.isWalkable(a,s)&&mapper.types.fire.spawn(a,s)}},burnHandler:function(e){const o=b8.ECS.getComponent(e,"Bomb");o.fuseTime===!1&&(o.fuseTime=2)}},mapper.types.chestOpen={spawn:function(e,o,t={}){const n={Type:{name:"chest"},Loc:{col:e,row:o},Sprite:{tile:271,fg:t.fg||15,bg:t.bg||0,depth:10},Solid:{}};return t.message&&(n.Message={message:t.message},n.Action={ButtonA:"read",ButtonB:"read"}),b8.ECS.create(n)}},mapper.types.chest={items:{0:"Empty",1:"Key",2:"Coin",3:"10 Coins",4:"50 Coins",5:"Half Heart",6:"Heart",7:"Full Heart"},messages:{0:"The chest is empty.",1:"You found a key!",2:"You found a coin!",3:"You found 10 coins!",4:"You found 50 coins!",5:"You found a half heart!",6:"You found a heart!",7:"You found a full heart!"},spawn:function(e,o,t={}){let n=[],i=t.fg||15,s="";return mapper.types.chest.items[t.contains]&&(s=mapper.types.chest.items[t.contains]),s==="Key"&&n.push({type:"key",props:{name:`key-${i}`}}),s.endsWith("Coins")&&n.push({type:"coin",props:{amount:parseInt(s.split(" ")[0],10)}}),s==="Coin"&&n.push({type:"coin",props:{amount:1}}),s==="Half Heart"&&n.push({type:"health",props:{amount:1}}),s==="Heart"&&n.push({type:"health",props:{amount:2}}),s==="Full Heart"&&n.push({type:"health",props:{amount:9999}}),b8.ECS.create({Type:{name:"chest"},Loc:{col:e,row:o},Sprite:{tile:253,fg:i,bg:t.bg||0,depth:10},Solid:{},Openable:{closedTile:253,openedTile:271,newType:"chestOpen",message:mapper.types.chest.messages[t.contains]||"The chest is empty."},Message:{message:t.message||""},Reward:{items:n},Action:{ButtonA:"open",ButtonB:"open"}})}},mapper.types.coin={spawn:function(e,o,t={}){return mapper.types.pickup.spawn(e,o,{type:"coin",Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:mapper.settings.coinColor||14,bg:t.bg||0}})},pickupHandler:function(e,o){b8.Inventory.add("coin",o?.props?.amount||1),b8.Sfx.play("game/coin/002")}},mapper.types.crate={spawn:function(e,o,t={}){return b8.ECS.create({Type:{name:"crate"},Loc:{col:e,row:o},Sprite:{tile:352,fg:t.fg||15,bg:t.bg||0,depth:10},Solid:{},Pushable:{},Action:{ButtonB:"pull"},Flammable:{temperature:20}})}},mapper.types.doorOpen={spawn:function(e,o,t={}){const n={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:216,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return b8.ECS.create(n)},onCharacterCollision:function(e,o,t,n,i){return mapper.systems.tryPortal(o,t),!1}},mapper.types.doorStairs={spawn:function(e,o,t={}){const n=t.icon||197,i={Type:{name:"doorStairs"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return b8.ECS.create(i)},onCharacterCollision:function(e,o,t,n,i){return mapper.systems.tryPortal(o,t),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,FLAMMABLE_DOOR_TILES:[221],spawn:function(e,o,t={}){const n=parseInt(t.icon)||mapper.types.door.TILE_DOOR_DEFAULT,i={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return n!==mapper.types.door.TILE_DOOR_OPEN&&(i.Solid={}),mapper.types.door.FLAMMABLE_DOOR_TILES.includes(n)&&(i.Flammable={temperature:0}),b8.ECS.create(i)},onCharacterCollision:function(e,o,t,n,i){if(!b8.ECS.hasComponent(e,"Solid"))return mapper.systems.tryPortal(o,t),!1;const s=b8.ECS.getComponent(e,"Sprite"),a=`key-${s.fg??"default"}`;return b8.Inventory.has(a)&&mapper.types.door.openDoor(e,s),!0},openDoor:function(e,o){o.tile=mapper.types.door.TILE_DOOR_OPEN,b8.ECS.removeComponent(e,"Solid"),b8.ECS.removeComponent(e,"Flammable"),b8.Sfx.play("ui/click/004");const t=b8.ECS.getComponent(e,"Loc");mapper.changeObjectTypeAt(t.col,t.row,"door","doorOpen")},burnHandler:function(e){const o=b8.ECS.getComponent(e,"Sprite");if(o.tile===mapper.types.door.TILE_DOOR_OPEN)return;mapper.types.door.openDoor(e,o);const t=b8.ECS.getComponent(e,"Loc");return mapper.types.fire.spawn(t.col,t.row),!1}},mapper.types.enemy={difficulties:{Easy:[3,1,11],Medium:[5,2,9],Hard:[8,3,8]},spawn:function(e,o,t={}){const i=t.health||"Easy",[s,a,r]=mapper.types.enemy.difficulties[i]||mapper.types.enemy.difficulties.Easy,c={Type:{name:"enemy"},Loc:{col:e,row:o},Direction:{dx:0,dy:1},Sprite:{type:"actor",tile:parseInt(t.actor)||6,fg:r||15,bg:0,depth:50},Solid:{},AI:{mode:mapper.ai.MODE.NONE,startLoc:{col:e,row:o},targetId:mapper.player,props:{canLoot:!1,canDrop:!1,viewRange:5}},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{value:s||3,max:s||3,cooldown:mapper.CONFIG.healthCooldown||1},Attack:{value:a||1},AttackTarget:{},Action:{ButtonA:"attack"}};let l=[];return t.path&&b8.Path.validPathSyntax(t.path)&&(l=b8.Path.parseCode(t.path,e,o,"D"),c.AI.path=l),b8.ECS.create(c)},setPath:function(e,o,t=null,n=0){if(!t||t===null){const i=b8.ECS.getComponent(e,"Loc");t=b8.Path.AnimationMode.PINGPONG;const s=o.length-1;o[s].col===i.col&&o[s].row===i.row&&(t=b8.Path.AnimationMode.LOOP)}b8.ECS.setComponent(e,"PathFollower",{steps:o,index:n,mode:t,dirStep:1,timer:0,startDir:"D"})}},mapper.types.fireSmall={damagePerSecond:.75,spawn:function(e,o,t={}){if(t.parent)return b8.ECS.create({Type:{name:"fire-small"},Loc:{col:e,row:o},Sprite:{type:"vfx-outline",id:"fire-small",offsetY:-4,startTime:b8.Core.getNow(),fg:mapper.types.fire.color,bg:0,depth:100},FireSmall:{duration:t.duration||3,parent:t.parent}})}},mapper.types.fire={damagePerSecond:3,color:10,spawn:function(e,o,t={}){if(mapper.hasEntityAt(e,o,"fire"))return null;let n=parseInt(t.duration);return n===0?n=1/0:(n=isNaN(n)?5:n,n+=b8.Random.range(0,2)),b8.ECS.create({Type:{name:"fire"},Loc:{col:e,row:o},Sprite:{type:"vfx",id:"fire",startTime:b8.Core.getNow()+b8.Random.int(0,400),fg:mapper.types.fire.color,bg:0},Fire:{duration:n}})}},mapper.types.healthFull={spawn:function(e,o,t={}){return mapper.types.pickup.spawn(e,o,{type:"health",props:{amount:1e3},Sprite:{tile:414,fg:10,bg:0}})}},mapper.types.healthHalf={spawn:function(e,o,t={}){return mapper.types.pickup.spawn(e,o,{type:"health",props:{amount:1},Sprite:{tile:416,fg:8,bg:0}})}},mapper.types.health={spawn:function(e,o,t={}){return mapper.types.pickup.spawn(e,o,{type:"health",props:{amount:2},Sprite:{tile:415,fg:8,bg:0}})},pickupHandler:function(e,o){const t=b8.ECS.getComponent(e,"Health");t.value=Math.min(t.max,t.value+(o.props.amount||1))}},mapper.types.key={spawn:function(e,o,t={}){const n=t.fg||14;return mapper.types.pickup.spawn(e,o,{type:"key",props:{name:`key-${n}`},Sprite:{tile:255,fg:t.fg||14,bg:t.bg||0}})},pickupHandler:function(e,o){b8.Inventory.add(o.props.name),b8.Sfx.play("tone/bloop/006")}},mapper.types.pickup={spawn:function(e,o,t={}){if(t.type)return b8.ECS.create({Type:{name:"pickup"},Loc:{col:e,row:o},Sprite:{tile:t.Sprite.tile??415,fg:t.Sprite.fg??8,bg:t.Sprite.bg??0},Pickup:{type:t.type,consume:t.consume??!0,props:t.props||{}}})}},mapper.types.player={spawn:function(e=0,o=0,t={}){return b8.ECS.create({Type:{name:"player"},Loc:{row:o||0,col:e||0},Direction:{dx:0,dy:1},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{cooldown:mapper.CONFIG.healthCooldown||1,value:6,max:12},Attack:{value:1},AttackTarget:{},Action:{ButtonA:"attack"}})}},mapper.types.signpost={spawn:function(e,o,t={}){return b8.ECS.create({Type:{name:"signpost"},Loc:{col:e,row:o},Sprite:{tile:t.icon||252,fg:t.fg||15,bg:t.bg||0},Solid:{},Message:{message:t.message||""},Action:{ButtonA:"trigger",ButtonB:"read"}})},triggerHandler:function(e,o){const t=b8.ECS.getComponent(o,"Sprite");if(t.tile!==252||(t.tile=270,!b8.ECS.hasComponent(o,"Message")))return;const n=b8.ECS.getComponent(o,"Message");b8.ECS.addComponent(o,"Action",{ButtonA:"read",ButtonB:"read"}),n.message="... "+n.message.slice(Math.floor(n.message.length/2))}},mapper.types.start={spawn:function(e,o,t={}){mapper.lastPosition={col:e,row:o,map:mapper.currentMapId},b8.ECS.setLoc(mapper.player,e,o)}},mapper.types.vfx={spawn:function(e,o,t={}){return t.id?b8.ECS.create({Type:{name:"vfx"},Loc:{col:e,row:o},Vfx:{},Sprite:{type:t.type||"vfx",id:t.id,startTime:b8.Core.getNow()+(t.offsetTime||0),fg:parseInt(t.fg)||15,bg:parseInt(t.bg)||0,nudgeCol:parseInt(t.nudgeCol)||0,nudgeRow:parseInt(t.nudgeRow)||0,depth:101}}):{}}};
