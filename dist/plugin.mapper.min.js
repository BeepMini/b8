const mapper={maps:[],currentMapId:null,types:{},systems:{},actions:{},settings:{},bg:{},lastDoorway:null,player:null,actionCooldown:0,play:function(t){b8.Utilities.checkObject("mapData",t),mapper.mapData=t,mapper.reset(),b8.Scene.add("menu",mapper.sceneMenu),b8.Scene.add("game",mapper.sceneGame),b8.Scene.add("gameover",mapper.sceneGameOver),b8.Scene.set("menu")},reset:function(){mapper.load(mapper.mapData)},continue:function(){b8.ECS.setComponent(mapper.player,"Health",{value:6,max:12}),b8.ECS.setLoc(mapper.player,mapper.lastDoorway.col,mapper.lastDoorway.row)},update:function(t){b8.ECS.run(t),mapper.actionCooldown-=t,mapper.actionCooldown<0&&(mapper.actionCooldown=0)},drawActor:function(t){const n=mapper.camera.getScreenPosition(t.col,t.row),e=t.col-n.col,o=t.row-n.row;b8.locate(e+offsetX,o+offsetY),b8.color(t.fg,t.bg),b8.drawActor(t.id,t.animation)},delayKeyPress:function(){mapper.actionCooldown=mapper.CONFIG.keyPressDelay},setPlayerWalkAnimation:function(t,n,e){const o=b8.ECS.getComponent(t,"CharacterAnimation");e>0&&(o.name="move-down"),e<0&&(o.name="move-up"),n>0&&(o.name="move-right"),n<0&&(o.name="move-left"),o.duration=.3},render:function(t=0,n=0){const e=[];for(const o of b8.ECS.query("Sprite","Loc")){const s=b8.ECS.getComponent(o,"Sprite"),i=b8.ECS.getComponent(o,"Loc"),r=b8.ECS.getComponent(o,"CharacterAnimation");e.push({spr:s,loc:i,anim:r})}if(e.length!==0){e.sort((o,s)=>(o.spr.depth??0)-(s.spr.depth??0));for(const{spr:o,loc:s,anim:i}of e){const r=mapper.camera.getTilePosition(s.col,s.row),a=o.nudgeCol||0,c=o.nudgeRow||0;switch(b8.locate(r.col+t,r.row+n),b8.color(o.fg??15,o.bg??0),o.type){case"actor":b8.drawActor(parseInt(o.tile),i.name,a,c);break;case"vfx":b8.Vfx.draw(o.id,o.startTime,a,c);break;case"vfx-outline":b8.Vfx.drawOutline(o.id,o.startTime,a,c);break;default:b8.printChar(parseInt(o.tile));break}}}},drawScreen:function(){if(!mapper.isValidMapId(mapper.currentMapId)){b8.Utilities.fatal("No current map set.");return}let t=b8.ECS.getComponent(mapper.player,"Loc");t||(t={col:0,row:0});const n=mapper.camera.getScreenPosition(t.col,t.row),e=mapper.getCurrentMap();b8.Tilemap.draw(e.mapData,n.col,n.row,n.w,n.h)},setTile:function(t,n,e){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}if(t<0||n<0||n>=mapper.currentMap.map.mapHeight||t>=mapper.currentMap.map.mapWidth){b8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[n][t]=e},getPropForEntity:(t,n=null)=>{const e=b8.ECS.getComponent(t,"Action");return!e||!n||!(n in e)?"":e[n]??""},getCurrentMap:()=>mapper.maps[mapper.currentMapId],promptAhead:(t,n=null)=>{if(!n)return"";const e=mapper.entitiesAhead(t);for(const o of e){const s=mapper.getPropForEntity(o,n);if(s)return s}return""},ahead:t=>{const n=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Direction");if(!n||!e)return{x:0,y:0};const o=n.col+(e.dx||0),s=n.row+(e.dy||0);return{x:o,y:s}},entitiesAhead:t=>{const{x:n,y:e}=mapper.ahead(t);return b8.ECS.entitiesAt(n,e)??[]},entitiesNextTo:t=>{const n=b8.ECS.getComponent(t,"Loc");if(!n)return[];const e=new Set,o=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const s of o){const i=n.col+s.dx,r=n.row+s.dy,a=b8.ECS.entitiesAt(i,r);a&&a.forEach(c=>e.add(c))}return Array.from(e)},doCollision:function(t,n,e,o,s,i){if(mapper.systems.tryPushing(t,n,s,i))return!0;for(const r of b8.ECS.entitiesAt(e,o)){const a=b8.ECS.getComponent(r,"Type"),c=a?mapper.types[a.name]:null;if(c?.onCharacterCollision&&c.onCharacterCollision(r,e,o,s,i)||b8.ECS.hasComponent(r,"Solid"))return!0}return!1},doAction:(t,n)=>{if(!n||mapper.actionCooldown>0)return;const e=mapper.promptAhead(t,n);e&&mapper.actions[e]&&mapper.actions[e](t)},doAttack:(t,n)=>{const e=mapper.ahead(t);mapper.types.vfx.spawn(e.x,e.y,{id:"swipe",fg:15,bg:0}),mapper.doAction(t,n)},updateMoveDelay:function(t=mapper.CONFIG.moveDelay){mapper.sceneGame.moveDelay=Math.max(t,mapper.sceneGame.moveDelay)},isValidMapId:t=>typeof t=="number"&&t>=0,hasEntityAt:function(t,n,e){const o=b8.ECS.entitiesAt(t,n);for(const s of o)if(b8.ECS.getComponent(s,"Type")?.name===e)return!0;return!1},removeObjectAt:function(t,n,e){const o=mapper.getCurrentMap();o.objects=o.objects.filter(s=>!(s.x===t&&s.y===n&&s.type.startsWith(e)))},changeObjectTypeAt:function(t,n,e,o){console.log("changeObjectTypeAt",t,n,e,o);const s=mapper.getCurrentMap();for(const i of s.objects)if(i.x===t&&i.y===n&&i.type.startsWith(e)){i.type=o;return}},giveRewards:function(t,n=[]){!n||n.length===0||n.forEach(e=>{if(!e.type)return;e.props||(e.props={});const o=mapper.types[e.type]?.pickupHandler;o&&o(t,e)})},doHandler:function(t,n){const e=b8.ECS.getComponent(t,"Type"),o=e&&mapper.types[e.name];return o?.[n]?o[n](t):!1}};mapper.CONFIG={moveDelay:.2,keyPressDelay:.25,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.attack=t=>{const n=mapper.entitiesAhead(t);for(const e of n){if(e===t||!b8.ECS.hasComponent(e,"AttackTarget"))continue;const o=b8.ECS.getComponent(e,"Health"),s=b8.ECS.getComponent(t,"Attack")||{value:1};o.value-=s.value}},mapper.actions.ignite=function(t){const n=mapper.entitiesAhead(t);for(const e of n){if(e===t)continue;const o=b8.ECS.getComponent(e,"Bomb");o&&(o.fuseTime=5)}},mapper.actions.open=async function(t){const n=mapper.entitiesAhead(t);for(const e of n){const o=b8.ECS.getComponent(e,"Openable"),s=b8.ECS.getComponent(e,"Sprite");if(!o||!s)continue;if(o.openedTile&&(s.tile=o.openedTile),o.newType){const a=b8.ECS.getComponent(e,"Loc"),c=b8.ECS.getComponent(e,"Type");mapper.changeObjectTypeAt(a.col,a.row,c.name,o.newType)}if(b8.Sfx.play("tone/jingle/017"),o.message){b8.color(s.fg??15,s.bg??5);const a=mapper.helpers.processChatText(o.message||"");await b8.Async.dialogTypewriter(a,["OK"],20)}const i=b8.ECS.getComponent(e,"Reward");mapper.giveRewards(t,i?.items||[]),b8.ECS.removeComponent(e,"Reward"),b8.ECS.removeComponent(e,"Action"),b8.ECS.removeComponent(e,"Openable"),b8.ECS.getComponent(e,"Message")?.message?.length>0&&b8.ECS.addComponent(e,"Action",{ButtonA:"read",ButtonB:"read"}),mapper.delayKeyPress();return}},mapper.actions.pull=function(t){const n=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Direction");mapper.systems.tryPulling(n.col,n.row,e.dx,e.dy,t)},mapper.actions.read=async function(t){const n=mapper.entitiesAhead(t);for(const e of n){const o=b8.ECS.getComponent(e,"Message"),s=b8.ECS.getComponent(e,"Sprite");if(!o||!s)continue;b8.color(s.fg??15,s.bg??5);const i=mapper.helpers.processChatText(o.message||"");await b8.Async.dialogTypewriter(i,["OK"],20),mapper.delayKeyPress();return}},mapper.actions.trigger=function(t){const n=mapper.entitiesAhead(t);for(const e of n){const o=b8.ECS.getComponent(e,"Type");console.log(`Trigger action by player on type: ${o.name}`),mapper.types[o.name]?.triggerHandler&&mapper.types[o.name].triggerHandler(t,e)}},mapper.camera={getScreenPosition:function(t,n){if(!mapper.isValidMapId(mapper.currentMapId))return b8.Utilities.error("No current map set."),{col:0,row:0};const e=mapper.getCurrentMap(),o=e.screenWidth,s=e.screenHeight,i=Math.floor(t/o)*o,r=Math.floor(n/s)*s;return{col:i,row:r,w:o,h:s}},getTilePosition:function(t,n){const e=b8.ECS.getComponent(mapper.player,"Loc");if(!e)return{col:0,row:0};const o=mapper.camera.getScreenPosition(e.col,e.row);let s=t-o.col,i=n-o.row;return s<0&&(s=-100),i<0&&(i=-100),s>=o.w&&(s=-100),i>=o.h&&(i=-100),{col:s,row:i}}},mapper.collision={isSolidAt:(t,n)=>b8.ECS.entitiesAt(t,n).some(e=>b8.ECS.hasComponent(e,"Solid")),isFree:(t,n)=>mapper.collision.isWalkable(t,n)&&!mapper.collision.isSolidAt(t,n),isWalkable:function(t,n){const e=mapper.getCurrentMap();return!(t<0||n<0||t>=e.mapWidth||n>=e.mapHeight||e.mapData[n][t][3]===!0)}},mapper.helpers={capitalizeWords:t=>t.replace(/\b\p{L}/gu,n=>n.toUpperCase()),processChatText:t=>(t=t.replace(/\[levelName\]/g,b8.data.levelName??"Unknown"),t=t.replace(/\[playerName\]/g,b8.data.playerName??"Player"),t=t.replace(/\[totalCoins\]/g,b8.data.totalCoins??"0"),t),getObjectsByType:t=>{const n=[];for(let e=0;e<mapper.maps.length;e++){const o=mapper.maps[e];for(const s of o.objects)s.type.startsWith(t)&&n.push(s)}return n}},mapper.load=function(t){b8.ECS.reset(),mapper.maps=[],mapper.settings={},mapper.currentMapId=null,b8.Utilities.checkObject("mapData",t),t.version===1&&(t=mapper.upgradeMapDataV1toV2(t)),mapper.settings={...t.settings},b8.Utilities.checkObject("mapper.settings",mapper.settings),t.levels.forEach((e,o)=>{const s=e.mapData.join(`
`);b8.Utilities.checkString(`mapDataString for level ${o}`,s);const i=b8.Tilemap.convertFromText(s),r=b8.Tilemap.createFromArray(i,t.tiles),a=(e.objects||[]).map(c=>({...c,mapId:o}));mapper.maps.push({screenWidth:t.screenWidth,screenHeight:t.screenHeight,screenCountX:e.screenCountX,screenCountY:e.screenCountY,objects:a,mapWidth:r[0].length,mapHeight:r.length,mapData:r})}),mapper.settings.gameName&&(b8.CONFIG.NAME=mapper.settings.gameName),mapper.player=b8.ECS.create({Type:{name:"player"},Loc:{row:0,col:0},Direction:{dx:0,dy:1},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{value:6,max:12},Attack:{value:1}}),mapper.setCurrentMap(0);let n=0;for(const e of mapper.maps)n+=e.objects.filter(o=>o.type==="coin").length;b8.data.totalCoins=n,b8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),b8.ECS.addSystem("pathFollower",mapper.systems.pathFollower),b8.ECS.addSystem("sprite",mapper.systems.sprite),b8.ECS.addSystem("pickup",mapper.systems.pickup),b8.ECS.addSystem("vfx",mapper.systems.vfx),b8.ECS.addSystem("health",mapper.systems.health),b8.ECS.addSystem("bomb",mapper.systems.bomb),b8.ECS.addSystem("fire",mapper.systems.fire),b8.ECS.addSystem("fireSmall",mapper.systems.fireSmall),b8.ECS.addSystem("flammable",mapper.systems.flammable),mapper.settings.bgm&&b8.Music.play(mapper.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&b8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=b8.Tilemap.load(mapper.settings.splash))},mapper.upgradeMapDataV1toV2=function(t){const n={mapData:[...t.map],objects:[...t.objects],screenCountX:t.screenCountX,screenCountY:t.screenCountY};return t.levels=[n],t.version=2,delete t.map,delete t.objects,delete t.screenCountX,delete t.screenCountY,t},mapper.setCurrentMap=function(t){if(b8.Utilities.checkInt("mapId",t),t<0||t>=mapper.maps.length){b8.Utilities.fatal(`Map ID "${t}" is out of bounds.`);return}if(t===mapper.currentMapId)return;let n=mapper.maps[t];n.objects||(n.objects=[]);const e=b8.ECS.getAllEntities();for(const o of e)b8.ECS.getComponent(o,"Type")?.name!=="player"&&b8.ECS.removeEntity(o);for(const o of n.objects){const s=mapper.types[o.type];s?.spawn&&s.spawn(o.x,o.y,o.props)}mapper.currentMapId=t,mapper.maps[mapper.currentMapId].objects=mapper.maps[mapper.currentMapId].objects.filter(o=>o.type!=="start")},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(b8.Tilemap.draw(mapper.bg.splash),b8.locate(b8.CONFIG.SCREEN_COLS-1,b8.CONFIG.SCREEN_ROWS-1),b8.color(15,0),b8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.sceneGame={UI:null,moveDelay:.15,init:function(){mapper.sceneGame.UI=b8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(t){if(mapper.update(t),mapper.sceneGame.moveDelay-=t,mapper.sceneGame.moveDelay>0)return;const n=b8.ECS.getComponent(mapper.player,"Loc");let e=0,o=0,s=!1;if(b8.key("ArrowUp")?(o=-1,s=!0):b8.key("ArrowDown")?(o=1,s=!0):b8.key("ArrowLeft")?(e=-1,s=!0):b8.key("ArrowRight")&&(e=1,s=!0),b8.key("ButtonA")&&(mapper.doAttack(mapper.player,"ButtonA"),s=!0),b8.key("ButtonB")&&(mapper.doAction(mapper.player,"ButtonB"),s=!0),s&&mapper.updateMoveDelay(),e!==0||o!==0){let i=n.col+e,r=n.row+o;mapper.setPlayerWalkAnimation(mapper.player,e,o),(!mapper.collision.isWalkable(i,r)||mapper.doCollision(n.col,n.row,i,r,e,o))&&(i=n.col,r=n.row),b8.ECS.setComponent(mapper.player,"Direction",{dx:e,dy:o}),b8.ECS.setLoc(mapper.player,i,r)}},render:function(){b8.cls(0),b8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),b8.locate(0,b8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),b8.Tilemap.draw(mapper.sceneGame.UI),b8.locate(2,b8.CONFIG.SCREEN_ROWS-2),b8.color(parseInt(mapper.settings.coinColor)||10,0),b8.printChar(parseInt(mapper.settings.coin)||266),b8.color(15,0),b8.print(" "+parseInt(b8.Inventory.getCount("coin")).toString().padStart(4,"0"));const t=b8.ECS.getComponent(mapper.player,"Health"),n=t.max,e=Math.floor(t.value);for(let s=0;s<Math.floor(n/2);s++){const i=2+s,r=b8.CONFIG.SCREEN_ROWS-3;b8.locate(i,r),e>=s*2+2?(b8.color(8,0),b8.printChar(415)):e===s*2+1?(b8.color(8,0),b8.printChar(416)):(b8.color(6,0),b8.printChar(417))}b8.Inventory.filter(/^key/).forEach((s,i)=>{const r=parseInt(s.id.split("-")[1])||15;b8.locate(10+i,b8.CONFIG.SCREEN_ROWS-2),b8.color(r,-1),b8.printChar(255)}),b8.color(15,-1),b8.locate(11,b8.CONFIG.SCREEN_ROWS-4),b8.print(" Hit"),b8.locate(15,b8.CONFIG.SCREEN_ROWS-4),b8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player,"ButtonB")))}},mapper.sceneGameOver={init:function(){mapper.sceneGameOver.main()},main:async()=>{b8.cls(6),b8.locate(0,5),b8.color(10,6),b8.printCentered(`GAME OVER

`);let t=["Continue","Main Menu"],n=await b8.Async.menu(t,{border:!1,padding:0,centerH:!0});const e=t[n];if(e==="Continue"){mapper.continue(),b8.Scene.set("game");return}if(e==="Main Menu"){b8.Scene.set("menu");return}setTimeout(mapper.sceneGameOver.main,10)}},mapper.sceneMenu={init:function(){if(!mapper.menu.hasSplash()){b8.Scene.set("game");return}mapper.sceneMenu.main()},main:async()=>{b8.locate(0,0),mapper.menu.drawSplash(),b8.locate(5,18),b8.color(0,10);let t=["Start Game"];mapper.menu.hasInstructions()&&t.push("Instructions"),mapper.menu.hasCredits()&&t.push("Credits");let n=await b8.Async.menu(t,{border:!1,padding:0,centerH:!0});const e=t[n];if(e==="Start Game"){mapper.reset(),b8.Scene.set("game");return}if(e==="Instructions"){b8.locate(2,2),b8.color(15,13);const o=b8.wrapText(mapper.menu.getInstructions(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(o,["OK"])}if(e==="Credits"){b8.locate(2,2),b8.color(15,13);const o=b8.wrapText(mapper.menu.getCredits(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(o,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.bomb=async function(t){const n=b8.ECS.query("Bomb"),e=mapper.types.bomb.color,o=mapper.types.bomb.flickerColor;for(const s of n){const i=b8.ECS.getComponent(s,"Bomb");if(i.fuseTime===!1)continue;i.fuseTime-=t;const r=b8.ECS.getComponent(s,"Sprite");if(i.fuseTime>5?r.fg=e:i.fuseTime>2.5?r.fg=Math.floor(i.fuseTime*2)%2===0?e:o:i.fuseTime>1?r.fg=Math.floor(i.fuseTime*4)%2===0?e:o:i.fuseTime>0&&(r.fg=Math.floor(i.fuseTime*10)%2===0?e:o),i.fuseTime<=0){const a=b8.ECS.getComponent(s,"Loc");mapper.types.vfx.spawn(a.col,a.row,{id:"explosion",fg:9}),await mapper.types.bomb.explode(s),b8.ECS.removeEntity(s),b8.Renderer.shakeScreen(),b8.Sfx.play("weapon/explode/013")}}},mapper.systems.characterAnimation=function(t){const n=b8.ECS.query("CharacterAnimation");if(n)for(const e of n){const o=b8.ECS.getComponent(e,"CharacterAnimation");if(o&&o.duration>0&&(o.duration-=t,o.duration<=0)){let s=o.default||"";const i=b8.ECS.getComponent(e,"Direction");if(i){const a={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${i.dx},${i.dy}`]||"";s=s+a}o.name=s}}},mapper.systems.fireSmall=async function(t){const n=mapper.types.fireSmall.damagePerSecond;b8.ECS.query("FireSmall").forEach(o=>{const s=b8.ECS.getComponent(o,"FireSmall"),i=b8.ECS.getComponent(o,"Loc"),r=b8.ECS.getComponent(s.parent,"Loc");r&&(i.col=r.col,i.row=r.row);const a=b8.ECS.getComponent(s.parent,"Health");a&&(a.value-=n*t,a.value<0&&(s.duration=0)),s.duration-=t,s.duration<=0&&(b8.ECS.removeEntity(o),b8.ECS.removeComponent(s.parent,"OnFire"),a&&(a.value=Math.floor(a.value)))})},mapper.systems.fire=async function(t){b8.ECS.query("Fire","Loc").forEach(e=>{const o=b8.ECS.getComponent(e,"Fire"),s=b8.ECS.getComponent(e,"Loc");if(o.duration!==1/0&&(o.duration-=t,o.duration<=0)){b8.ECS.removeEntity(e),mapper.types.vfx.spawn(s.col,s.row,{id:"shrink",fg:9});return}b8.ECS.entitiesAt(s.col,s.row).forEach(a=>{a!==e&&(b8.ECS.hasComponent(a,"Health")&&(b8.ECS.hasComponent(a,"OnFire")||(mapper.types.fireSmall.spawn(s.col,s.row,{parent:a,duration:3}),b8.ECS.addComponent(a,"OnFire"))),mapper.doHandler(a,"burnHandler"))}),mapper.entitiesNextTo(e).forEach(a=>{if(a===e)return;const c=b8.ECS.getComponent(a,"Flammable");c&&(c.temperature=(c.temperature||0)+70*t),mapper.doHandler(a,"burnHandler")})})},mapper.systems.flammable=async function(t){b8.ECS.query("Flammable").forEach(e=>{const o=b8.ECS.getComponent(e,"Flammable");if(o.temperature>=100){const s=b8.ECS.getComponent(e,"Loc");b8.ECS.removeEntity(e),mapper.types.fire.spawn(s.col,s.row);return}o.temperature=Math.max(0,(o.temperature||0)-10*t)})},mapper.systems.health=async function(t){b8.ECS.query("Health").forEach(async e=>{if(b8.ECS.getComponent(e,"Health").value<=0){const s=b8.ECS.getComponent(e,"Loc");s&&mapper.types.vfx.spawn(s.col,s.row,{id:"skull",fg:2,bg:0,offsetTime:200}),e!==mapper.player?b8.ECS.removeEntity(e):(await b8.Async.wait(.5),b8.Scene.set("gameover"))}})},mapper.systems.pathFollower=async function(t){const n={U:"move-up",D:"move-down",L:"move-left",R:"move-right",FU:"idle-up",FD:"idle-down",FL:"idle-left",FR:"idle-right"},e={U:"D",D:"U",L:"R",R:"L",FU:"FD",FD:"FU",FL:"FR",FR:"FL"},o=b8.ECS.query("Loc","PathFollower");for(const i of o){const r=b8.ECS.getComponent(i,"PathFollower");if(!r||!r.steps.length||(r.timer-=t,r.timer>0))continue;r.timer=mapper.CONFIG.moveDelay*2;const a=r.steps[r.index];let c=!1;if(a.dir&&a.dir[0]==="F"&&(c=!0),mapper.collision.isWalkable(a.x,a.y)&&!mapper.collision.isSolidAt(a.x,a.y)&&(c=!0),!c)continue;b8.ECS.setLoc(i,a.x,a.y),s(r);const l=b8.ECS.getComponent(i,"CharacterAnimation");if(l.duration=.5,n[a.dir]){let p=a.dir;r.dirStep===-1&&(p=e[a.dir]||a.dir),l.name=n[p]}}function s(i){const r=i.steps.length-1;switch(i.mode){case"once":i.index<r&&i.index++;break;case"loop":i.index=(i.index+1)%i.steps.length;break;case"pingpong":default:i.index===0?i.dirStep=1:i.index===r&&(i.dirStep=-1),i.index+=i.dirStep;break}}},mapper.systems.pickup=function(){const t=mapper.player,n=b8.ECS.getComponent(t,"Loc");b8.ECS.query("Pickup","Loc").forEach(o=>{const s=b8.ECS.getComponent(o,"Loc");if(s.col!==n.col||s.row!==n.row)return;const i=b8.ECS.getComponent(o,"Pickup");mapper.giveRewards(t,[{type:i.type,props:i.props}]),i.consume&&(b8.ECS.removeEntity(o),mapper.removeObjectAt(s.col,s.row,i.type))})},mapper.systems.tryPortal=async function(t,n){const e=b8.ECS.entitiesAt(t,n);if(!e)return!1;for(const o of e){const s=b8.ECS.getComponent(o,"Portal");return mapper.systems.handlePortal(s)}return!1},mapper.systems.handlePortal=async function(t){if(!t||t.target==="")return!1;const e=mapper.helpers.getObjectsByType("door").find(o=>o.props.name===t.target);return e&&(await b8.Async.wait(.1),mapper.setCurrentMap(e.mapId),mapper.lastDoorway={col:e.x,row:e.y},b8.ECS.setLoc(mapper.player,e.x,e.y)),!1},mapper.systems.tryPushing=(t,n,e,o)=>{const s=t+e,i=n+o;for(const r of b8.ECS.entitiesAt(s,i)){if(!b8.ECS.hasComponent(r,"Solid")||!b8.ECS.hasComponent(r,"Pushable"))continue;const a=b8.ECS.getComponent(r,"Loc"),c=a.col+e,l=a.row+o;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(u=>b8.ECS.hasComponent(u,"Solid"))?!0:(b8.ECS.setLoc(r,c,l),b8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(t,n,e,o,s)=>{const i=t+e,r=n+o;for(const a of b8.ECS.entitiesAt(i,r)){if(!b8.ECS.hasComponent(a,"Solid")||!b8.ECS.hasComponent(a,"Pushable"))continue;const c=t-e,l=n-o;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(p=>b8.ECS.hasComponent(p,"Solid"))?!1:(b8.ECS.setLoc(a,t,n),b8.ECS.setLoc(s,c,l),mapper.setPlayerWalkAnimation(s,e,o),b8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.sprite=function(t){const n=b8.ECS.query("Sprite");for(const e of n){const o=b8.ECS.getComponent(e,"Sprite");o.nudgeCol&&(o.nudgeCol=o.nudgeCol*.75),o.nudgeRow&&(o.nudgeRow=o.nudgeRow*.75)}},mapper.systems.vfx=async function(t){const n=b8.ECS.query("Vfx","Sprite");for(const e of n){const o=b8.ECS.getComponent(e,"Sprite");b8.Vfx.shouldLoop(o.id,o.startTime)||b8.ECS.removeEntity(e)}},mapper.types.skeleton={spawn:function(t,n,e={}){return b8.ECS.create({})},pickupHandler:function(t,n){},triggerHandler:function(t,n){},onCharacterCollision:function(t,n,e,o,s){},burnHandler:function(t,n){}},mapper.types.bomb={color:8,flickerColor:15,spawn:function(t,n,e={}){return b8.ECS.create({Type:{name:"bomb"},Loc:{col:t,row:n},Sprite:{tile:283,fg:mapper.types.bomb.color,bg:0,depth:10},Solid:{},Pushable:{},Action:{ButtonB:"pull",ButtonA:"ignite"},Bomb:{fuseTime:!1,radius:parseInt(e.radius)||1,damage:2}})},explode:async function(t){const n=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Bomb");for(let o=-e.radius;o<=e.radius;o++)for(let s=-e.radius;s<=e.radius;s++){const i=n.row+s,r=n.col+o;mapper.collision.isWalkable(r,i)&&mapper.types.fire.spawn(r,i)}},burnHandler:function(t){const n=b8.ECS.getComponent(t,"Bomb");n.fuseTime===!1&&(n.fuseTime=2)}},mapper.types.chestOpen={spawn:function(t,n,e={}){const o={Type:{name:"chest"},Loc:{col:t,row:n},Sprite:{tile:271,fg:e.fg||15,bg:e.bg||0,depth:10},Solid:{}};return console.log("chest open props",e),e.message&&(o.Message={message:e.message},o.Action={ButtonA:"read",ButtonB:"read"}),b8.ECS.create(o)}},mapper.types.chest={items:{0:"Empty",1:"Key",2:"Coin",3:"10 Coins",4:"50 Coins",5:"Half Heart",6:"Heart",7:"Full Heart"},messages:{0:"The chest is empty.",1:"You found a key!",2:"You found a coin!",3:"You found 10 coins!",4:"You found 50 coins!",5:"You found a half heart!",6:"You found a heart!",7:"You found a full heart!"},spawn:function(t,n,e={}){let o=[],s=e.fg||15,i="";return mapper.types.chest.items[e.contains]&&(i=mapper.types.chest.items[e.contains]),i==="Key"&&o.push({type:"key",props:{name:`key-${s}`}}),i.endsWith("Coins")&&o.push({type:"coin",props:{amount:parseInt(i.split(" ")[0],10)}}),i==="Coin"&&o.push({type:"coin",props:{amount:1}}),i==="Half Heart"&&o.push({type:"health",props:{amount:1}}),i==="Heart"&&o.push({type:"health",props:{amount:2}}),i==="Full Heart"&&o.push({type:"health",props:{amount:9999}}),b8.ECS.create({Type:{name:"chest"},Loc:{col:t,row:n},Sprite:{tile:253,fg:s,bg:e.bg||0,depth:10},Solid:{},Openable:{closedTile:253,openedTile:271,newType:"chestOpen",message:mapper.types.chest.messages[e.contains]||"The chest is empty."},Message:{message:e.message||""},Reward:{items:o},Action:{ButtonA:"open",ButtonB:"open"}})}},mapper.types.coin={spawn:function(t,n,e={}){return mapper.types.pickup.spawn(t,n,{type:"coin",Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:mapper.settings.coinColor||14,bg:e.bg||0}})},pickupHandler:function(t,n){b8.Inventory.add("coin",n?.props?.amount||1),b8.Sfx.play("game/coin/002")}},mapper.types.crate={spawn:function(t,n,e={}){return b8.ECS.create({Type:{name:"crate"},Loc:{col:t,row:n},Sprite:{tile:352,fg:e.fg||15,bg:e.bg||0,depth:10},Solid:{},Pushable:{},Action:{ButtonB:"pull"},Flammable:{temperature:20}})}},mapper.types.doorOpen={spawn:function(t,n,e={}){const o={Type:{name:"door"},Loc:{col:t,row:n},Sprite:{tile:216,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return b8.ECS.create(o)},onCharacterCollision:function(t,n,e,o,s){return mapper.systems.tryPortal(n,e),!1}},mapper.types.doorStairs={spawn:function(t,n,e={}){const o=e.icon||197,s={Type:{name:"doorStairs"},Loc:{col:t,row:n},Sprite:{tile:o,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return b8.ECS.create(s)},onCharacterCollision:function(t,n,e,o,s){return mapper.systems.tryPortal(n,e),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,FLAMMABLE_DOOR_TILES:[221],spawn:function(t,n,e={}){const o=parseInt(e.icon)||mapper.types.door.TILE_DOOR_DEFAULT,s={Type:{name:"door"},Loc:{col:t,row:n},Sprite:{tile:o,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return o!==mapper.types.door.TILE_DOOR_OPEN&&(s.Solid={}),mapper.types.door.FLAMMABLE_DOOR_TILES.includes(o)&&(s.Flammable={temperature:0}),b8.ECS.create(s)},onCharacterCollision:function(t,n,e,o,s){if(!b8.ECS.hasComponent(t,"Solid"))return mapper.systems.tryPortal(n,e),!1;const i=b8.ECS.getComponent(t,"Sprite"),r=`key-${i.fg??"default"}`;return b8.Inventory.has(r)&&(b8.ECS.removeComponent(t,"Solid"),i.tile=mapper.types.door.TILE_DOOR_OPEN,b8.Sfx.play("ui/click/004")),!0},burnHandler:function(t){console.log("Door burnHandler called");const n=b8.ECS.getComponent(t,"Sprite");if(n.tile===mapper.types.door.TILE_DOOR_OPEN)return;const e=b8.ECS.getComponent(t,"Loc");return n.tile=mapper.types.door.TILE_DOOR_OPEN,b8.ECS.removeComponent(t,"Solid"),b8.ECS.removeComponent(t,"Flammable"),mapper.types.fire.spawn(e.col,e.row),!1}},mapper.types.enemy={difficulties:{Easy:[3,1,11],Medium:[5,2,9],Hard:[8,3,8]},spawn:function(t,n,e={}){const s=e.health||"Easy",[i,r,a]=mapper.types.enemy.difficulties[s]||mapper.types.enemy.difficulties.Easy,c={Type:{name:"enemy"},Loc:{col:t,row:n},Sprite:{type:"actor",tile:parseInt(e.actor)||6,fg:a||15,bg:0,depth:50},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{value:i||3,max:i||3},Attack:{value:r||1},AttackTarget:{},Action:{ButtonA:"attack"}};if(e.path&&b8.Path.validPathSyntax(e.path)){let l=e.mode||"pingpong";const p=b8.Path.parseCode(e.path,t,n,"D"),u=p.length-1;p[u].x===t&&p[u].y===n&&(l="loop"),c.PathFollower={steps:p,index:0,mode:l,dirStep:1,timer:0,startDir:e.startDir||"D"}}return b8.ECS.create(c)}},mapper.types.fireSmall={damagePerSecond:.75,spawn:function(t,n,e={}){if(e.parent)return b8.ECS.create({Type:{name:"fire-small"},Loc:{col:t,row:n},Sprite:{type:"vfx-outline",id:"fire-small",offsetY:-4,startTime:b8.Core.getNow(),fg:mapper.types.fire.color,bg:0,depth:100},FireSmall:{duration:e.duration||3,parent:e.parent}})}},mapper.types.fire={damagePerSecond:3,color:10,spawn:function(t,n,e={}){if(mapper.hasEntityAt(t,n,"fire"))return null;let o=parseInt(e.duration);return o===0?o=1/0:(o=isNaN(o)?5:o,o+=b8.Random.range(0,2)),b8.ECS.create({Type:{name:"fire"},Loc:{col:t,row:n},Sprite:{type:"vfx",id:"fire",startTime:b8.Core.getNow()+b8.Random.int(0,400),fg:mapper.types.fire.color,bg:0},Fire:{duration:o}})}},mapper.types.healthFull={spawn:function(t,n,e={}){return mapper.types.pickup.spawn(t,n,{type:"health",props:{amount:1e3},Sprite:{tile:414,fg:10,bg:0}})}},mapper.types.healthHalf={spawn:function(t,n,e={}){return mapper.types.pickup.spawn(t,n,{type:"health",props:{amount:1},Sprite:{tile:416,fg:8,bg:0}})}},mapper.types.health={spawn:function(t,n,e={}){return mapper.types.pickup.spawn(t,n,{type:"health",props:{amount:2},Sprite:{tile:415,fg:8,bg:0}})},pickupHandler:function(t,n){const e=b8.ECS.getComponent(t,"Health");e.value=Math.min(e.max,e.value+(n.props.amount||1))}},mapper.types.key={spawn:function(t,n,e={}){const o=e.fg||14;return mapper.types.pickup.spawn(t,n,{type:"key",props:{name:`key-${o}`},Sprite:{tile:255,fg:e.fg||14,bg:e.bg||0}})},pickupHandler:function(t,n){b8.Inventory.add(n.props.name),b8.Sfx.play("tone/bloop/006")}},mapper.types.pickup={spawn:function(t,n,e={}){if(e.type)return b8.ECS.create({Type:{name:"pickup"},Loc:{col:t,row:n},Sprite:{tile:e.Sprite.tile??415,fg:e.Sprite.fg??8,bg:e.Sprite.bg??0},Pickup:{type:e.type,consume:e.consume??!0,props:e.props||{}}})}},mapper.types.signpost={spawn:function(t,n,e={}){return b8.ECS.create({Type:{name:"signpost"},Loc:{col:t,row:n},Sprite:{tile:e.icon||252,fg:e.fg||15,bg:e.bg||0},Solid:{},Message:{message:e.message||""},Action:{ButtonA:"trigger",ButtonB:"read"}})},triggerHandler:function(t,n){const e=b8.ECS.getComponent(n,"Sprite");if(e.tile!==252||(e.tile=270,!b8.ECS.hasComponent(n,"Message")))return;const o=b8.ECS.getComponent(n,"Message");b8.ECS.addComponent(n,"Action",{ButtonA:"read",ButtonB:"read"}),o.message="... "+o.message.slice(Math.floor(o.message.length/2))}},mapper.types.start={spawn:function(t,n,e={}){mapper.lastDoorway={col:t,row:n},b8.ECS.setLoc(mapper.player,t,n)}},mapper.types.vfx={spawn:function(t,n,e={}){return e.id?b8.ECS.create({Type:{name:"vfx"},Loc:{col:t,row:n},Vfx:{},Sprite:{type:e.type||"vfx",id:e.id,startTime:b8.Core.getNow()+(e.offsetTime||0),fg:parseInt(e.fg)||15,bg:parseInt(e.bg)||0,nudgeCol:parseInt(e.nudgeCol)||0,nudgeRow:parseInt(e.nudgeRow)||0,depth:50}}):{}}};
