const mapper={maps:[],currentMap:null,types:{},systems:{},actions:{},settings:{},bg:{},player:null,play:function(e){b8.Utilities.checkObject("mapData",e),mapper.load(e),b8.Scene.add("menu",mapper.sceneMenu),b8.Scene.add("game",mapper.sceneGame),b8.Scene.set("menu")},load:function(e,o="world",t=!0){b8.Utilities.checkObject("mapData",e),b8.ECS.reset(),mapper.maps=[],mapper.currentMap=null;const n=e.map.join(`
`);b8.Utilities.checkString("mapDataString",n),mapper.settings={...e.settings},b8.Utilities.checkObject("mapper.settings",mapper.settings),mapper.player=b8.ECS.create({Type:{name:"player"},Loc:{row:0,col:0},Direction:{dx:0,dy:0},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},CharacterAnimation:{name:"idle",default:"idle",duration:0}});const r=b8.Tilemap.convertFromText(n),i=b8.Tilemap.createFromArray(r,e.tiles);mapper.maps.push({name:o,screenWidth:e.screenWidth,screenHeight:e.screenHeight,screenCountX:e.screenCountX,screenCountY:e.screenCountY,mapWidth:i[0].length,mapHeight:i.length,map:i}),t&&mapper.setCurrentMap(o);for(const a of e.objects){const l=mapper.types[a.type];l?.spawn&&(shouldAdd=l.spawn(a.x,a.y,a.props))}e.objects.find(a=>a.type==="start")||b8.Utilities.fatal("Map data must include a 'start' object.");const c=e.objects.filter(a=>a.type==="coin").length;b8.data.totalCoins=c,b8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),mapper.settings.bgm&&b8.Music.play(world.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&b8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=b8.Tilemap.load(mapper.settings.splash))},update:function(e){b8.ECS.run(e)},drawActor:function(e){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}const o=mapper.camera.getScreenPosition(e.col,e.row),t=e.col-o.col,n=e.row-o.row;b8.locate(t+offsetX,n+offsetY),b8.color(e.fg,e.bg),b8.drawActor(e.id,e.animation)},render:function(e=0,o=0){const t=[];for(const n of b8.ECS.query("Sprite","Loc")){const r=b8.ECS.getComponent(n,"Sprite"),i=b8.ECS.getComponent(n,"Loc"),s=b8.ECS.getComponent(n,"CharacterAnimation");t.push({spr:r,loc:i,anim:s})}if(t.length!==0){t.sort((n,r)=>(n.spr.depth??0)-(r.spr.depth??0));for(const{spr:n,loc:r,anim:i}of t){const s=mapper.camera.getTilePosition(r.col,r.row);b8.locate(s.col+e,s.row+o),b8.color(n.fg??15,n.bg??0),n.type==="actor"?b8.drawActor(parseInt(n.tile),i.name):b8.printChar(parseInt(n.tile))}}},drawScreen:function(){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}const e=b8.ECS.getComponent(mapper.player,"Loc"),o=mapper.camera.getScreenPosition(e.col,e.row),t=mapper.currentMap;b8.Tilemap.draw(t.map,o.col,o.row,o.w,o.h)},setCurrentMap:function(e){let o=mapper.maps.find(t=>t.name===e);if(!o){console.error(`Map "${e}" not found.`);return}mapper.currentMap=o},setTile:function(e,o,t){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}if(e<0||o<0||o>=mapper.currentMap.map.mapHeight||e>=mapper.currentMap.map.mapWidth){b8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[o][e]=t},getVerbForEntity:e=>b8.ECS.getComponent(e,"Action")?.verb??"",promptAhead:e=>{const o=mapper.entitiesAhead(e);for(const t of o){const n=mapper.getVerbForEntity(t);if(n)return n}return""},ahead:e=>{const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Direction"),n=o.col+(t.dx||0),r=o.row+(t.dy||0);return{x:n,y:r}},entitiesAhead:e=>{const{x:o,y:t}=mapper.ahead(e);return b8.ECS.entitiesAt(o,t)??[]},doCollision:function(e,o,t,n,r,i){if(mapper.systems.tryPushing(e,o,r,i))return!0;for(const s of b8.ECS.entitiesAt(t,n)){const c=b8.ECS.getComponent(s,"Type"),a=c?mapper.types[c.name]:null;if(a?.onCharacterCollision&&a.onCharacterCollision(s,t,n,r,i)||b8.ECS.hasComponent(s,"Solid"))return!0}return!1},doAction:e=>{const o=mapper.promptAhead(e);console.log("do action ",o),o&&mapper.actions[o]&&mapper.actions[o](e)}};mapper.CONFIG={moveDelay:.15,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.pull=function(e){const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Direction");mapper.systems.tryPulling(o.col,o.row,t.dx,t.dy,e)},mapper.actions.read=async function(e){const o=mapper.entitiesAhead(e);for(const t of o){const n=b8.ECS.getComponent(t,"Message"),r=b8.ECS.getComponent(t,"Sprite");if(!n||!r)continue;b8.color(r.fg??15,r.bg??5);const i=mapper.helpers.processChatText(n.message||"");await b8.Async.dialogTypewriter(i,["OK"],20)}},mapper.camera={getScreenPosition:function(e,o){if(!mapper.currentMap)return b8.Utilities.error("No current map set."),{col:0,row:0};const t=mapper.currentMap,n=t.screenWidth,r=t.screenHeight,i=Math.floor(e/n)*n,s=Math.floor(o/r)*r;return{col:i,row:s,w:n,h:r}},getTilePosition:function(e,o){const t=b8.ECS.getComponent(mapper.player,"Loc"),n=mapper.camera.getScreenPosition(t.col,t.row);let r=e-n.col,i=o-n.row;return r<0&&(r=-100),i<0&&(i=-100),r>=n.w&&(r=-100),i>=n.h&&(i=-100),{col:r,row:i}}},mapper.collision={isSolidAt:(e,o)=>b8.ECS.entitiesAt(e,o).some(t=>b8.ECS.hasComponent(t,"Solid")),isFree:(e,o)=>mapper.collision.isWalkable(e,o)&&!mapper.collision.isSolidAt(e,o),isWalkable:function(e,o){return!(e<0||o<0||e>=mapper.currentMap.mapWidth||o>=mapper.currentMap.mapHeight||mapper.currentMap.map[o][e][3]===!0)}},mapper.helpers={capitalizeWords:e=>e.replace(/\b\p{L}/gu,o=>o.toUpperCase()),processChatText:e=>(e=e.replace(/\[levelName\]/g,b8.data.levelName??"Unknown"),e=e.replace(/\[playerName\]/g,b8.data.playerName??"Player"),e=e.replace(/\[totalCoins\]/g,b8.data.totalCoins??"0"),e)},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(b8.Tilemap.draw(mapper.bg.splash),console.log("Drawing b8 logo"),b8.locate(b8.CONFIG.SCREEN_COLS-1,b8.CONFIG.SCREEN_ROWS-1),b8.color(15,0),b8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.sceneGame={UI:null,init:function(){console.log(mapper.CONFIG),mapper.sceneGame.UI=b8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(e){if(mapper.CONFIG.moveDelay-=e,mapper.CONFIG.moveDelay>0)return;const o=b8.ECS.getComponent(mapper.player,"Loc"),t=b8.ECS.getComponent(mapper.player,"CharacterAnimation");if(mapper.CONFIG.moveDelay>0)return;let n=0,r=0;if(b8.keyp("ArrowUp")?r=-1:b8.keyp("ArrowDown")?r=1:b8.keyp("ArrowLeft")?n=-1:b8.keyp("ArrowRight")&&(n=1),b8.keyp("ButtonB")&&mapper.doAction(mapper.player),n!==0||r!==0){let i=o.col+n,s=o.row+r;r>0&&(t.name="move-down"),r<0&&(t.name="move-up"),n>0&&(t.name="move-right"),n<0&&(t.name="move-left"),t.duration=.3,(!mapper.collision.isWalkable(i,s)||mapper.doCollision(o.col,o.row,i,s,n,r))&&(i=o.col,s=o.row),b8.ECS.set(mapper.player,"Direction",{dx:n,dy:r}),b8.ECS.setLoc(mapper.player,i,s),mapper.CONFIG.moveDelay=.15}mapper.update(e)},render:function(){b8.cls(0),b8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),b8.locate(0,b8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),b8.Tilemap.draw(mapper.sceneGame.UI),b8.locate(2,b8.CONFIG.SCREEN_ROWS-2),b8.color(mapper.settings.coinColor,0),b8.printChar(mapper.settings.coin||266),b8.color(15,0),b8.print(" "+parseInt(b8.Inventory.getCount("coin")).toString().padStart(4,"0")),b8.Inventory.filter(/^key/).forEach((o,t)=>{const n=parseInt(o.id.split("-")[1])||15;b8.locate(10+t,b8.CONFIG.SCREEN_ROWS-2),b8.color(n,-1),b8.printChar(255)}),b8.color(15,-1),b8.locate(11,b8.CONFIG.SCREEN_ROWS-4),b8.print(" "),b8.locate(15,b8.CONFIG.SCREEN_ROWS-4),b8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player)))}},mapper.sceneMenu={init:function(){if(!mapper.menu.hasSplash()){b8.Scene.set("game");return}mapper.sceneMenu.main()},main:async()=>{b8.locate(0,0),mapper.menu.drawSplash(),b8.locate(5,18),b8.color(0,10);let e=["Start Game"];mapper.menu.hasInstructions()&&e.push("Instructions"),mapper.menu.hasCredits()&&e.push("Credits");let o=await b8.Async.menu(e,{border:!1,padding:0,centerH:!0});const t=e[o];if(t==="Start Game"){b8.Scene.set("game");return}if(t==="Instructions"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getInstructions(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}if(t==="Credits"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getCredits(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.characterAnimation=function(e){const o=b8.ECS.query("CharacterAnimation");if(o)for(const t of o){const n=b8.ECS.getComponent(t,"CharacterAnimation");if(n&&n.duration>0&&(n.duration-=e,n.duration<=0)){let r=n.default||"";const i=b8.ECS.getComponent(t,"Direction");if(i){const c={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${i.dx},${i.dy}`]||"";r=r+c}n.name=r}}},mapper.systems.tryPortal=async function(e,o){const t=b8.ECS.entitiesAt(e,o);if(console.log("Checking for portal at",e,o,t),!t)return!1;for(const n of t){const r=b8.ECS.getComponent(n,"Portal");return mapper.systems.handlePortal(r)}},mapper.systems.handlePortal=async function(e){if(!e||e.target==="")return!1;const t=b8.ECS.query("Portal").find(n=>b8.ECS.getComponent(n,"Portal").name===e.target);if(t){const n=b8.ECS.getComponent(t,"Loc");n&&(await b8.Async.wait(.1),b8.ECS.setLoc(mapper.player,n.col,n.row))}return!1},mapper.systems.tryPushing=(e,o,t,n)=>{const r=e+t,i=o+n;for(const s of b8.ECS.entitiesAt(r,i)){if(!b8.ECS.hasComponent(s,"Solid")||!b8.ECS.hasComponent(s,"Pushable"))continue;const c=b8.ECS.getComponent(s,"Loc"),a=c.col+t,l=c.row+n;return!mapper.collision.isWalkable(a,l)||b8.ECS.entitiesAt(a,l).some(C=>b8.ECS.hasComponent(C,"Solid"))?!0:(b8.ECS.setLoc(s,a,l),b8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(e,o,t,n,r)=>{const i=e+t,s=o+n;for(const c of b8.ECS.entitiesAt(i,s)){if(!b8.ECS.hasComponent(c,"Solid")||!b8.ECS.hasComponent(c,"Pushable"))continue;const a=e-t,l=o-n;return!mapper.collision.isWalkable(a,l)||b8.ECS.entitiesAt(a,l).some(A=>b8.ECS.hasComponent(A,"Solid"))?!1:(b8.ECS.setLoc(c,e,o),b8.ECS.setLoc(r,a,l),b8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.teleportSystem=async function(e){const o=b8.ECS.query("Teleport");for(const[t,n]of o){const i=b8.ECS.query("Portal").find(([s])=>b8.ECS.getComponent(s,"Portal")?.name===n.target);if(i){const s=b8.ECS.getComponent(i[0],"Loc");s&&(await b8.Async.wait(.1),b8.ECS.setLoc(t,s.col,s.row))}b8.ECS.removeComponent(t,"Teleport")}},mapper.types.skeleton={init:function(e){},onCharacterCollision:async function(e,o,t,n,r){},update:function(e){},render:function(e,o=0,t=0){}},mapper.types.coin={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"coin"},Loc:{col:e,row:o},Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:t.fg||14,bg:t.bg||0}})},onCharacterCollision:function(e){return b8.ECS.removeEntity(e),b8.Inventory.add("coin"),b8.Sfx.play("game/coin/002"),!1}},mapper.types.crate={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"crate"},Loc:{col:e,row:o},Sprite:{tile:352,fg:t.fg||15,bg:t.bg||0,depth:10},Solid:{},Pushable:{},Action:{verb:"pull"}})}},mapper.types.doorOpen={spawn:function(e,o,t){const n={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:216,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return b8.ECS.create(n)},onCharacterCollision:function(e,o,t,n,r){return mapper.systems.tryPortal(o,t),!1}},mapper.types.doorStairs={spawn:function(e,o,t){const n=t.icon||197,r={Type:{name:"doorStairs"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return b8.ECS.create(r)},onCharacterCollision:function(e,o,t,n,r){return mapper.systems.tryPortal(o,t),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,spawn:function(e,o,t){const n=t.icon||mapper.types.door.TILE_DOOR_DEFAULT,r={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return n!==mapper.types.door.TILE_DOOR_OPEN&&(r.Solid={}),b8.ECS.create(r)},onCharacterCollision:function(e,o,t,n,r){if(!b8.ECS.hasComponent(e,"Solid"))return mapper.systems.tryPortal(o,t),!1;const i=b8.ECS.getComponent(e,"Sprite"),s=`key-${i.fg??"default"}`;return b8.Inventory.has(s)&&(b8.ECS.removeComponent(e,"Solid"),i.tile=mapper.types.door.TILE_DOOR_OPEN,b8.Sfx.play("ui/click/004")),!0}},mapper.types.key={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"key"},Loc:{col:e,row:o},Sprite:{tile:255,fg:t.fg||14,bg:t.bg||0}})},onCharacterCollision:function(e,o,t,n,r){const i=`key-${b8.ECS.getComponent(e,"Sprite").fg??"default"}`;return b8.Inventory.add(i),b8.ECS.removeEntity(e),b8.Sfx.play("tone/bloop/006"),!1}},mapper.types.signpost={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"signpost"},Loc:{col:e,row:o},Sprite:{tile:t.icon||252,fg:t.fg||15,bg:t.bg||0},Solid:{},Message:{message:t.message||""},Action:{verb:"read"}})}},mapper.types.start={spawn:function(e,o,t){b8.ECS.setLoc(mapper.player,e,o)}};
