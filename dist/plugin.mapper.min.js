const mapper={maps:[],currentMapId:null,types:{},systems:{},actions:{},settings:{},bg:{},player:null,actionCooldown:0,play:function(t){b8.Utilities.checkObject("mapData",t),mapper.load(t),b8.Scene.add("menu",mapper.sceneMenu),b8.Scene.add("game",mapper.sceneGame),b8.Scene.set("menu")},update:function(t){b8.ECS.run(t),mapper.actionCooldown-=t,mapper.actionCooldown<0&&(mapper.actionCooldown=0)},drawActor:function(t){const n=mapper.camera.getScreenPosition(t.col,t.row),e=t.col-n.col,o=t.row-n.row;b8.locate(e+offsetX,o+offsetY),b8.color(t.fg,t.bg),b8.drawActor(t.id,t.animation)},delayKeyPress:function(){mapper.actionCooldown=mapper.CONFIG.keyPressDelay},setPlayerWalkAnimation:function(t,n,e){const o=b8.ECS.getComponent(t,"CharacterAnimation");e>0&&(o.name="move-down"),e<0&&(o.name="move-up"),n>0&&(o.name="move-right"),n<0&&(o.name="move-left"),o.duration=.3},render:function(t=0,n=0){const e=[];for(const o of b8.ECS.query("Sprite","Loc")){const i=b8.ECS.getComponent(o,"Sprite"),s=b8.ECS.getComponent(o,"Loc"),r=b8.ECS.getComponent(o,"CharacterAnimation");e.push({spr:i,loc:s,anim:r})}if(e.length!==0){e.sort((o,i)=>(o.spr.depth??0)-(i.spr.depth??0));for(const{spr:o,loc:i,anim:s}of e){const r=mapper.camera.getTilePosition(i.col,i.row);switch(b8.locate(r.col+t,r.row+n),b8.color(o.fg??15,o.bg??0),o.type){case"actor":let a=0,c=0;o.nudgeCol&&(a=o.nudgeCol),o.nudgeRow&&(c=o.nudgeRow),b8.drawActor(parseInt(o.tile),s.name,a,c);break;case"vfx":b8.Vfx.draw(o.id,o.startTime);break;default:b8.printChar(parseInt(o.tile));break}}}},drawScreen:function(){if(!mapper.isValidMapId(mapper.currentMapId)){b8.Utilities.fatal("No current map set.");return}let t=b8.ECS.getComponent(mapper.player,"Loc");t||(t={col:0,row:0});const n=mapper.camera.getScreenPosition(t.col,t.row),e=mapper.getCurrentMap();b8.Tilemap.draw(e.mapData,n.col,n.row,n.w,n.h)},setTile:function(t,n,e){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}if(t<0||n<0||n>=mapper.currentMap.map.mapHeight||t>=mapper.currentMap.map.mapWidth){b8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[n][t]=e},getVerbForEntity:t=>b8.ECS.getComponent(t,"Action")?.verb??"",getCurrentMap:()=>mapper.maps[mapper.currentMapId],promptAhead:t=>{const n=mapper.entitiesAhead(t);for(const e of n){const o=mapper.getVerbForEntity(e);if(o)return o}return""},ahead:t=>{const n=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Direction");if(!n||!e)return{x:0,y:0};const o=n.col+(e.dx||0),i=n.row+(e.dy||0);return{x:o,y:i}},entitiesAhead:t=>{const{x:n,y:e}=mapper.ahead(t);return b8.ECS.entitiesAt(n,e)??[]},doCollision:function(t,n,e,o,i,s){if(mapper.systems.tryPushing(t,n,i,s))return!0;for(const r of b8.ECS.entitiesAt(e,o)){const a=b8.ECS.getComponent(r,"Type"),c=a?mapper.types[a.name]:null;if(c?.onCharacterCollision&&c.onCharacterCollision(r,e,o,i,s)||b8.ECS.hasComponent(r,"Solid"))return!0}return!1},doAction:t=>{if(mapper.actionCooldown>0)return;const n=mapper.promptAhead(t);n&&mapper.actions[n]&&mapper.actions[n](t)},doAttack:t=>{const n=mapper.ahead(t),e=mapper.entitiesAhead(t);mapper.types.vfx.spawn(n.x,n.y,{id:"swipe",fg:15,bg:0});for(const o of e){if(o===t||!b8.ECS.hasComponent(o,"AttackTarget"))continue;const i=b8.ECS.getComponent(o,"Health"),s=b8.ECS.getComponent(t,"Attack")||{value:1};if(i.value-=s.value,i.value<=0){b8.ECS.removeEntity(o),mapper.types.vfx.spawn(n.x,n.y,{id:"skull",fg:2,bg:0,offsetTime:200}),mapper.updateMoveDelay(.6);return}break}},updateMoveDelay:function(t=mapper.CONFIG.moveDelay){mapper.sceneGame.moveDelay=Math.max(t,mapper.sceneGame.moveDelay)},isValidMapId:t=>typeof t=="number"&&t>=0,removeObjectAt:function(t,n,e){const o=mapper.getCurrentMap();o.objects=o.objects.filter(i=>!(i.x===t&&i.y===n&&i.type.startsWith(e)))},changeObjectTypeAt:function(t,n,e,o){console.log("changeObjectTypeAt",t,n,e,o);const i=mapper.getCurrentMap();for(const s of i.objects)if(s.x===t&&s.y===n&&s.type.startsWith(e)){s.type=o;return}},giveRewards:function(t,n=[]){!n||n.length===0||n.forEach(e=>{if(!e.type)return;e.props||(e.props={});const o=mapper.types[e.type]?.pickupHandler;o&&o(t,e)})}};mapper.CONFIG={moveDelay:.2,keyPressDelay:.25,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.open=async function(t){const n=mapper.entitiesAhead(t);for(const e of n){const o=b8.ECS.getComponent(e,"Openable"),i=b8.ECS.getComponent(e,"Sprite");if(!o||!i)continue;if(o.openedTile&&(i.tile=o.openedTile),o.newType){const a=b8.ECS.getComponent(e,"Loc"),c=b8.ECS.getComponent(e,"Type");mapper.changeObjectTypeAt(a.col,a.row,c.name,o.newType)}b8.Sfx.play("tone/jingle/017");const s=b8.ECS.getComponent(e,"Reward");mapper.giveRewards(t,s?.items||[]),b8.ECS.removeComponent(e,"Reward"),b8.ECS.removeComponent(e,"Action"),b8.ECS.removeComponent(e,"Openable"),b8.ECS.getComponent(e,"Message")?.message?.length>0&&b8.ECS.addComponent(e,"Action",{verb:"read"}),mapper.delayKeyPress();return}},mapper.actions.pull=function(t){const n=b8.ECS.getComponent(t,"Loc"),e=b8.ECS.getComponent(t,"Direction");mapper.systems.tryPulling(n.col,n.row,e.dx,e.dy,t)},mapper.actions.read=async function(t){const n=mapper.entitiesAhead(t);for(const e of n){const o=b8.ECS.getComponent(e,"Message"),i=b8.ECS.getComponent(e,"Sprite");if(!o||!i)continue;b8.color(i.fg??15,i.bg??5);const s=mapper.helpers.processChatText(o.message||"");await b8.Async.dialogTypewriter(s,["OK"],20),mapper.delayKeyPress();return}},mapper.camera={getScreenPosition:function(t,n){if(!mapper.isValidMapId(mapper.currentMapId))return b8.Utilities.error("No current map set."),{col:0,row:0};const e=mapper.getCurrentMap(),o=e.screenWidth,i=e.screenHeight,s=Math.floor(t/o)*o,r=Math.floor(n/i)*i;return{col:s,row:r,w:o,h:i}},getTilePosition:function(t,n){const e=b8.ECS.getComponent(mapper.player,"Loc"),o=mapper.camera.getScreenPosition(e.col,e.row);let i=t-o.col,s=n-o.row;return i<0&&(i=-100),s<0&&(s=-100),i>=o.w&&(i=-100),s>=o.h&&(s=-100),{col:i,row:s}}},mapper.collision={isSolidAt:(t,n)=>b8.ECS.entitiesAt(t,n).some(e=>b8.ECS.hasComponent(e,"Solid")),isFree:(t,n)=>mapper.collision.isWalkable(t,n)&&!mapper.collision.isSolidAt(t,n),isWalkable:function(t,n){const e=mapper.getCurrentMap();return!(t<0||n<0||t>=e.mapWidth||n>=e.mapHeight||e.mapData[n][t][3]===!0)}},mapper.helpers={capitalizeWords:t=>t.replace(/\b\p{L}/gu,n=>n.toUpperCase()),processChatText:t=>(t=t.replace(/\[levelName\]/g,b8.data.levelName??"Unknown"),t=t.replace(/\[playerName\]/g,b8.data.playerName??"Player"),t=t.replace(/\[totalCoins\]/g,b8.data.totalCoins??"0"),t),getObjectsByType:t=>{const n=[];for(let e=0;e<mapper.maps.length;e++){const o=mapper.maps[e];for(const i of o.objects)i.type.startsWith(t)&&n.push(i)}return n}},mapper.load=function(t){b8.ECS.reset(),mapper.maps=[],mapper.settings={},mapper.currentMapId=null,b8.Utilities.checkObject("mapData",t),t.version===1&&(t=mapper.upgradeMapDataV1toV2(t)),mapper.settings={...t.settings},b8.Utilities.checkObject("mapper.settings",mapper.settings),t.levels.forEach((e,o)=>{const i=e.mapData.join(`
`);b8.Utilities.checkString(`mapDataString for level ${o}`,i);const s=b8.Tilemap.convertFromText(i),r=b8.Tilemap.createFromArray(s,t.tiles),a=(e.objects||[]).map(c=>({...c,mapId:o}));mapper.maps.push({screenWidth:t.screenWidth,screenHeight:t.screenHeight,screenCountX:e.screenCountX,screenCountY:e.screenCountY,objects:a,mapWidth:r[0].length,mapHeight:r.length,mapData:r})}),mapper.settings.gameName&&(b8.CONFIG.NAME=mapper.settings.gameName),mapper.player=b8.ECS.create({Type:{name:"player"},Loc:{row:0,col:0},Direction:{dx:0,dy:1},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},Health:{value:2,max:12},Attack:{value:1}}),mapper.setCurrentMap(0);let n=0;for(const e of mapper.maps)n+=e.objects.filter(o=>o.type==="coin").length;b8.data.totalCoins=n,b8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),b8.ECS.addSystem("pathFollower",mapper.systems.pathFollower),b8.ECS.addSystem("sprite",mapper.systems.sprite),b8.ECS.addSystem("bumpAttack",mapper.systems.bumpAttack),b8.ECS.addSystem("pickup",mapper.systems.pickup),b8.ECS.addSystem("vfx",mapper.systems.vfx),mapper.settings.bgm&&b8.Music.play(mapper.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&b8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=b8.Tilemap.load(mapper.settings.splash))},mapper.upgradeMapDataV1toV2=function(t){const n={mapData:[...t.map],objects:[...t.objects],screenCountX:t.screenCountX,screenCountY:t.screenCountY};return t.levels=[n],t.version=2,delete t.map,delete t.objects,delete t.screenCountX,delete t.screenCountY,t},mapper.setCurrentMap=function(t){if(b8.Utilities.checkInt("mapId",t),t<0||t>=mapper.maps.length){b8.Utilities.fatal(`Map ID "${t}" is out of bounds.`);return}if(t===mapper.currentMapId)return;let n=mapper.maps[t];n.objects||(n.objects=[]);const e=b8.ECS.getAllEntities();for(const o of e)b8.ECS.getComponent(o,"Type")?.name!=="player"&&b8.ECS.removeEntity(o);for(const o of n.objects){const i=mapper.types[o.type];i?.spawn&&i.spawn(o.x,o.y,o.props)}mapper.currentMapId=t,mapper.maps[mapper.currentMapId].objects=mapper.maps[mapper.currentMapId].objects.filter(o=>o.type!=="start")},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(b8.Tilemap.draw(mapper.bg.splash),b8.locate(b8.CONFIG.SCREEN_COLS-1,b8.CONFIG.SCREEN_ROWS-1),b8.color(15,0),b8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.sceneGame={UI:null,moveDelay:.15,init:function(){mapper.sceneGame.UI=b8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(t){if(mapper.update(t),mapper.sceneGame.moveDelay-=t,mapper.sceneGame.moveDelay>0)return;const n=b8.ECS.getComponent(mapper.player,"Loc");let e=0,o=0,i=!1;if(b8.key("ArrowUp")?(o=-1,i=!0):b8.key("ArrowDown")?(o=1,i=!0):b8.key("ArrowLeft")?(e=-1,i=!0):b8.key("ArrowRight")&&(e=1,i=!0),b8.key("ButtonA")&&(mapper.doAttack(mapper.player),i=!0),b8.key("ButtonB")&&(mapper.doAction(mapper.player),i=!0),i&&mapper.updateMoveDelay(),e!==0||o!==0){let s=n.col+e,r=n.row+o;mapper.setPlayerWalkAnimation(mapper.player,e,o),(!mapper.collision.isWalkable(s,r)||mapper.doCollision(n.col,n.row,s,r,e,o))&&(s=n.col,r=n.row),b8.ECS.setComponent(mapper.player,"Direction",{dx:e,dy:o}),b8.ECS.setLoc(mapper.player,s,r)}},render:function(){b8.cls(0),b8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),b8.locate(0,b8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),b8.Tilemap.draw(mapper.sceneGame.UI),b8.locate(2,b8.CONFIG.SCREEN_ROWS-2),b8.color(parseInt(mapper.settings.coinColor)||10,0),b8.printChar(parseInt(mapper.settings.coin)||266),b8.color(15,0),b8.print(" "+parseInt(b8.Inventory.getCount("coin")).toString().padStart(4,"0"));const t=b8.ECS.getComponent(mapper.player,"Health"),n=t.max,e=t.value;for(let i=0;i<Math.floor(n/2);i++){const s=2+i,r=b8.CONFIG.SCREEN_ROWS-3;b8.locate(s,r),e>=i*2+2?(b8.color(8,0),b8.printChar(415)):e===i*2+1?(b8.color(8,0),b8.printChar(416)):(b8.color(6,0),b8.printChar(417))}b8.Inventory.filter(/^key/).forEach((i,s)=>{const r=parseInt(i.id.split("-")[1])||15;b8.locate(10+s,b8.CONFIG.SCREEN_ROWS-2),b8.color(r,-1),b8.printChar(255)}),b8.color(15,-1),b8.locate(11,b8.CONFIG.SCREEN_ROWS-4),b8.print(" Hit"),b8.locate(15,b8.CONFIG.SCREEN_ROWS-4),b8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player)))}},mapper.sceneMenu={init:function(){if(!mapper.menu.hasSplash()){b8.Scene.set("game");return}mapper.sceneMenu.main()},main:async()=>{b8.locate(0,0),mapper.menu.drawSplash(),b8.locate(5,18),b8.color(0,10);let t=["Start Game"];mapper.menu.hasInstructions()&&t.push("Instructions"),mapper.menu.hasCredits()&&t.push("Credits");let n=await b8.Async.menu(t,{border:!1,padding:0,centerH:!0});const e=t[n];if(e==="Start Game"){b8.Scene.set("game");return}if(e==="Instructions"){b8.locate(2,2),b8.color(15,13);const o=b8.wrapText(mapper.menu.getInstructions(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(o,["OK"])}if(e==="Credits"){b8.locate(2,2),b8.color(15,13);const o=b8.wrapText(mapper.menu.getCredits(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(o,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.bumpAttack=function(t){const n=b8.ECS.query("BumpAttack");for(const e of n){const i=b8.ECS.getComponent(e,"BumpAttack").targetId;if(!b8.ECS.hasComponent(i,"Health")){b8.ECS.removeComponent(e,"BumpAttack");continue}const s=b8.ECS.getComponent(i,"Health"),r=b8.ECS.getComponent(e,"Attack")||{value:1};s.value-=r.value,s.value<=0&&b8.ECS.removeEntity(i),b8.ECS.removeComponent(e,"BumpAttack")}},mapper.systems.characterAnimation=function(t){const n=b8.ECS.query("CharacterAnimation");if(n)for(const e of n){const o=b8.ECS.getComponent(e,"CharacterAnimation");if(o&&o.duration>0&&(o.duration-=t,o.duration<=0)){let i=o.default||"";const s=b8.ECS.getComponent(e,"Direction");if(s){const a={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${s.dx},${s.dy}`]||"";i=i+a}o.name=i}}},mapper.systems.pathFollower=async function(t){const n={U:"move-up",D:"move-down",L:"move-left",R:"move-right",FU:"idle-up",FD:"idle-down",FL:"idle-left",FR:"idle-right"},e={U:"D",D:"U",L:"R",R:"L",FU:"FD",FD:"FU",FL:"FR",FR:"FL"},o=b8.ECS.query("Loc","PathFollower");for(const s of o){const r=b8.ECS.getComponent(s,"PathFollower");if(!r||!r.steps.length||(r.timer-=t,r.timer>0))continue;r.timer=mapper.CONFIG.moveDelay*2;const a=r.steps[r.index];let c=!1;if(a.dir&&a.dir[0]==="F"&&(c=!0),mapper.collision.isWalkable(a.x,a.y)&&!mapper.collision.isSolidAt(a.x,a.y)&&(c=!0),!c)continue;b8.ECS.setLoc(s,a.x,a.y),i(r);const l=b8.ECS.getComponent(s,"CharacterAnimation");if(l.duration=.5,n[a.dir]){let p=a.dir;r.dirStep===-1&&(p=e[a.dir]||a.dir),l.name=n[p]}}function i(s){const r=s.steps.length-1;switch(s.mode){case"once":s.index<r&&s.index++;break;case"loop":s.index=(s.index+1)%s.steps.length;break;case"pingpong":default:s.index===0?s.dirStep=1:s.index===r&&(s.dirStep=-1),s.index+=s.dirStep;break}}},mapper.systems.pickup=function(){const t=mapper.player,n=b8.ECS.getComponent(t,"Loc");b8.ECS.query("Pickup","Loc").forEach(o=>{const i=b8.ECS.getComponent(o,"Loc");if(i.col!==n.col||i.row!==n.row)return;const s=b8.ECS.getComponent(o,"Pickup");mapper.giveRewards(t,[{type:s.type,props:s.props}]),s.consume&&(b8.ECS.removeEntity(o),mapper.removeObjectAt(i.col,i.row,s.type))})},mapper.systems.tryPortal=async function(t,n){const e=b8.ECS.entitiesAt(t,n);if(!e)return!1;for(const o of e){const i=b8.ECS.getComponent(o,"Portal");return mapper.systems.handlePortal(i)}return!1},mapper.systems.handlePortal=async function(t){if(!t||t.target==="")return!1;const e=mapper.helpers.getObjectsByType("door").find(o=>o.props.name===t.target);return e&&(await b8.Async.wait(.1),mapper.setCurrentMap(e.mapId),b8.ECS.setLoc(mapper.player,e.x,e.y)),!1},mapper.systems.tryPushing=(t,n,e,o)=>{const i=t+e,s=n+o;for(const r of b8.ECS.entitiesAt(i,s)){if(!b8.ECS.hasComponent(r,"Solid")||!b8.ECS.hasComponent(r,"Pushable"))continue;const a=b8.ECS.getComponent(r,"Loc"),c=a.col+e,l=a.row+o;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(u=>b8.ECS.hasComponent(u,"Solid"))?!0:(b8.ECS.setLoc(r,c,l),b8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(t,n,e,o,i)=>{const s=t+e,r=n+o;for(const a of b8.ECS.entitiesAt(s,r)){if(!b8.ECS.hasComponent(a,"Solid")||!b8.ECS.hasComponent(a,"Pushable"))continue;const c=t-e,l=n-o;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(p=>b8.ECS.hasComponent(p,"Solid"))?!1:(b8.ECS.setLoc(a,t,n),b8.ECS.setLoc(i,c,l),mapper.setPlayerWalkAnimation(i,e,o),b8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.sprite=function(t){const n=b8.ECS.query("Sprite");for(const e of n){const o=b8.ECS.getComponent(e,"Sprite");o.nudgeCol&&(o.nudgeCol=o.nudgeCol*.75),o.nudgeRow&&(o.nudgeRow=o.nudgeRow*.75)}},mapper.systems.teleportSystem=async function(t){const n=b8.ECS.query("Teleport");for(const[e,o]of n){const s=b8.ECS.query("Portal").find(([r])=>b8.ECS.getComponent(r,"Portal")?.name===o.target);if(s){const r=b8.ECS.getComponent(s[0],"Loc");r&&(await b8.Async.wait(.1),b8.ECS.setLoc(e,r.col,r.row))}b8.ECS.removeComponent(e,"Teleport")}},mapper.systems.vfx=async function(t){const n=b8.ECS.query("Vfx","Sprite");for(const e of n){const o=b8.ECS.getComponent(e,"Sprite"),i=b8.Vfx.get(o.id);i&&b8.Animation.shouldLoop(i,o.startTime)||b8.ECS.removeEntity(e)}},mapper.types.skeleton={},mapper.types.chestOpen={spawn:function(t,n,e){const o={Type:{name:"chest"},Loc:{col:t,row:n},Sprite:{tile:271,fg:e.fg||15,bg:e.bg||0,depth:10},Solid:{}};return console.log("chest open props",e),e.message&&(o.Message={message:e.message},o.Action={verb:"read"}),b8.ECS.create(o)}},mapper.types.chest={items:{0:"Empty",1:"Key",2:"Coin",3:"10 Coins",4:"50 Coins",5:"Half Heart",6:"Heart",7:"Full Heart"},spawn:function(t,n,e){let o=[],i=e.fg||15,s="";return mapper.types.chest.items[e.contains]&&(s=mapper.types.chest.items[e.contains]),s==="Key"&&o.push({type:"key",props:{name:`key-${i}`}}),s.endsWith("Coins")&&o.push({type:"coin",props:{amount:parseInt(s.split(" ")[0],10)}}),s==="Coin"&&o.push({type:"coin",props:{amount:1}}),s==="Half Heart"&&o.push({type:"health",props:{amount:1}}),s==="Heart"&&o.push({type:"health",props:{amount:2}}),s==="Full Heart"&&o.push({type:"health",props:{amount:9999}}),b8.ECS.create({Type:{name:"chest"},Loc:{col:t,row:n},Sprite:{tile:253,fg:i,bg:e.bg||0,depth:10},Solid:{},Openable:{closedTile:253,openedTile:271,newType:"chestOpen"},Message:{message:e.message||""},Reward:{items:o},Action:{verb:"open"}})}},mapper.types.coin={spawn:function(t,n,e){return mapper.types.pickup.spawn(t,n,{type:"coin",Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:mapper.settings.coinColor||14,bg:e.bg||0}})},pickupHandler:function(t,n){b8.Inventory.add("coin",n?.props?.amount||1),b8.Sfx.play("game/coin/002")}},mapper.types.crate={spawn:function(t,n,e){return b8.ECS.create({Type:{name:"crate"},Loc:{col:t,row:n},Sprite:{tile:352,fg:e.fg||15,bg:e.bg||0,depth:10},Solid:{},Pushable:{},Action:{verb:"pull"}})}},mapper.types.doorOpen={spawn:function(t,n,e){const o={Type:{name:"door"},Loc:{col:t,row:n},Sprite:{tile:216,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return b8.ECS.create(o)},onCharacterCollision:function(t,n,e,o,i){return mapper.systems.tryPortal(n,e),!1}},mapper.types.doorStairs={spawn:function(t,n,e){const o=e.icon||197,i={Type:{name:"doorStairs"},Loc:{col:t,row:n},Sprite:{tile:o,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return b8.ECS.create(i)},onCharacterCollision:function(t,n,e,o,i){return mapper.systems.tryPortal(n,e),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,spawn:function(t,n,e){const o=e.icon||mapper.types.door.TILE_DOOR_DEFAULT,i={Type:{name:"door"},Loc:{col:t,row:n},Sprite:{tile:o,fg:e.fg||14,bg:e.bg||0},Portal:{name:e.name||null,target:e.leadsTo||""}};return o!==mapper.types.door.TILE_DOOR_OPEN&&(i.Solid={}),b8.ECS.create(i)},onCharacterCollision:function(t,n,e,o,i){if(!b8.ECS.hasComponent(t,"Solid"))return mapper.systems.tryPortal(n,e),!1;const s=b8.ECS.getComponent(t,"Sprite"),r=`key-${s.fg??"default"}`;return b8.Inventory.has(r)&&(b8.ECS.removeComponent(t,"Solid"),s.tile=mapper.types.door.TILE_DOOR_OPEN,b8.Sfx.play("ui/click/004")),!0}},mapper.types.enemy={difficulties:{Easy:[3,1,11],Medium:[5,2,9],Hard:[8,3,8]},spawn:function(t,n,e){const i=e.health||"Easy",[s,r,a]=mapper.types.enemy.difficulties[i]||mapper.types.enemy.difficulties.Easy,c={Type:{name:"enemy"},Loc:{col:t,row:n},Sprite:{type:"actor",tile:parseInt(e.actor)||6,fg:a||15,bg:0,depth:50},Solid:{},CharacterAnimation:{name:"idle",default:"idle",duration:0},AttackTarget:{},Health:{value:s||3,max:s||3},Attack:{value:r||1}};if(e.path&&b8.Path.validPathSyntax(e.path)){let l=e.mode||"pingpong";const p=b8.Path.parseCode(e.path,t,n,"D"),u=p.length-1;p[u].x===t&&p[u].y===n&&(l="loop"),c.PathFollower={steps:p,index:0,mode:l,dirStep:1,timer:0,startDir:e.startDir||"D"}}return b8.ECS.create(c)}},mapper.types.healthFull={spawn:function(t,n,e){return mapper.types.pickup.spawn(t,n,{type:"health",props:{amount:1e3},Sprite:{tile:414,fg:10,bg:0}})}},mapper.types.healthHalf={spawn:function(t,n,e){return mapper.types.pickup.spawn(t,n,{type:"health",props:{amount:1},Sprite:{tile:416,fg:8,bg:0}})}},mapper.types.health={spawn:function(t,n,e){return mapper.types.pickup.spawn(t,n,{type:"health",props:{amount:2},Sprite:{tile:415,fg:8,bg:0}})},pickupHandler:function(t,n){const e=b8.ECS.getComponent(t,"Health");e.value=Math.min(e.max,e.value+(n.props.amount||1))}},mapper.types.key={spawn:function(t,n,e){const o=e.fg||14;return mapper.types.pickup.spawn(t,n,{type:"key",props:{name:`key-${o}`},Sprite:{tile:255,fg:e.fg||14,bg:e.bg||0}})},pickupHandler:function(t,n){b8.Inventory.add(n.props.name),b8.Sfx.play("tone/bloop/006")}},mapper.types.pickup={spawn:function(t,n,e={}){if(e.type)return b8.ECS.create({Type:{name:"pickup"},Loc:{col:t,row:n},Sprite:{tile:e.Sprite.tile??415,fg:e.Sprite.fg??8,bg:e.Sprite.bg??0},Pickup:{type:e.type,consume:e.consume??!0,props:e.props||{}}})}},mapper.types.signpost={spawn:function(t,n,e){return b8.ECS.create({Type:{name:"signpost"},Loc:{col:t,row:n},Sprite:{tile:e.icon||252,fg:e.fg||15,bg:e.bg||0},Solid:{},Message:{message:e.message||""},Action:{verb:"read"}})}},mapper.types.start={spawn:function(t,n,e){b8.ECS.setLoc(mapper.player,t,n)}},mapper.types.vfx={spawn:function(t,n,e){return e.id?b8.ECS.create({Type:{name:"vfx"},Loc:{col:t,row:n},Vfx:{},Sprite:{type:"vfx",id:e.id,startTime:b8.Core.getNow()+(e.offsetTime||0),fg:e.fg||15,bg:e.bg||0,depth:50}}):{}}};
