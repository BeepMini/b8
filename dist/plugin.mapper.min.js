const mapper={maps:[],currentMapId:null,types:{},systems:{},actions:{},settings:{},bg:{},player:null,actionCooldown:0,play:function(e){b8.Utilities.checkObject("mapData",e),mapper.load(e),b8.Scene.add("menu",mapper.sceneMenu),b8.Scene.add("game",mapper.sceneGame),b8.Scene.set("menu")},update:function(e){b8.ECS.run(e),mapper.actionCooldown-=e,mapper.actionCooldown<0&&(mapper.actionCooldown=0),console.log("mapper update dt",e)},drawActor:function(e){const o=mapper.camera.getScreenPosition(e.col,e.row),t=e.col-o.col,n=e.row-o.row;b8.locate(t+offsetX,n+offsetY),b8.color(e.fg,e.bg),b8.drawActor(e.id,e.animation)},delayKeyPress:function(){mapper.actionCooldown=mapper.CONFIG.keyPressDelay},render:function(e=0,o=0){const t=[];for(const n of b8.ECS.query("Sprite","Loc")){const r=b8.ECS.getComponent(n,"Sprite"),s=b8.ECS.getComponent(n,"Loc"),i=b8.ECS.getComponent(n,"CharacterAnimation");t.push({spr:r,loc:s,anim:i})}if(t.length!==0){t.sort((n,r)=>(n.spr.depth??0)-(r.spr.depth??0));for(const{spr:n,loc:r,anim:s}of t){const i=mapper.camera.getTilePosition(r.col,r.row);b8.locate(i.col+e,i.row+o),b8.color(n.fg??15,n.bg??0),n.type==="actor"?b8.drawActor(parseInt(n.tile),s.name):b8.printChar(parseInt(n.tile))}}},drawScreen:function(){if(!mapper.isValidMapId(mapper.currentMapId)){b8.Utilities.fatal("No current map set.");return}let e=b8.ECS.getComponent(mapper.player,"Loc");e||(e={col:0,row:0});const o=mapper.camera.getScreenPosition(e.col,e.row),t=mapper.getCurrentMap();b8.Tilemap.draw(t.mapData,o.col,o.row,o.w,o.h)},setTile:function(e,o,t){if(!mapper.currentMap){b8.Utilities.error("No current map set.");return}if(e<0||o<0||o>=mapper.currentMap.map.mapHeight||e>=mapper.currentMap.map.mapWidth){b8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[o][e]=t},getVerbForEntity:e=>b8.ECS.getComponent(e,"Action")?.verb??"",getCurrentMap:()=>mapper.maps[mapper.currentMapId],promptAhead:e=>{const o=mapper.entitiesAhead(e);for(const t of o){const n=mapper.getVerbForEntity(t);if(n)return n}return""},ahead:e=>{const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Direction");if(!o||!t)return{x:0,y:0};const n=o.col+(t.dx||0),r=o.row+(t.dy||0);return{x:n,y:r}},entitiesAhead:e=>{const{x:o,y:t}=mapper.ahead(e);return b8.ECS.entitiesAt(o,t)??[]},doCollision:function(e,o,t,n,r,s){if(mapper.systems.tryPushing(e,o,r,s))return!0;for(const i of b8.ECS.entitiesAt(t,n)){const a=b8.ECS.getComponent(i,"Type"),c=a?mapper.types[a.name]:null;if(c?.onCharacterCollision&&c.onCharacterCollision(i,t,n,r,s)||b8.ECS.hasComponent(i,"Solid"))return!0}return!1},doAction:e=>{const o=mapper.promptAhead(e);console.log("do action ",o),o&&mapper.actions[o]&&mapper.actions[o](e)},isValidMapId:e=>typeof e=="number"&&e>=0};mapper.CONFIG={moveDelay:.15,keyPressDelay:.15,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.pull=function(e){const o=b8.ECS.getComponent(e,"Loc"),t=b8.ECS.getComponent(e,"Direction");mapper.systems.tryPulling(o.col,o.row,t.dx,t.dy,e)},mapper.actions.read=async function(e){const o=mapper.entitiesAhead(e);for(const t of o){const n=b8.ECS.getComponent(t,"Message"),r=b8.ECS.getComponent(t,"Sprite");if(!n||!r)continue;b8.color(r.fg??15,r.bg??5);const s=mapper.helpers.processChatText(n.message||"");await b8.Async.dialogTypewriter(s,["OK"],20),mapper.delayKeyPress();return}},mapper.camera={getScreenPosition:function(e,o){if(!mapper.isValidMapId(mapper.currentMapId))return b8.Utilities.error("No current map set."),{col:0,row:0};const t=mapper.getCurrentMap(),n=t.screenWidth,r=t.screenHeight,s=Math.floor(e/n)*n,i=Math.floor(o/r)*r;return{col:s,row:i,w:n,h:r}},getTilePosition:function(e,o){const t=b8.ECS.getComponent(mapper.player,"Loc"),n=mapper.camera.getScreenPosition(t.col,t.row);let r=e-n.col,s=o-n.row;return r<0&&(r=-100),s<0&&(s=-100),r>=n.w&&(r=-100),s>=n.h&&(s=-100),{col:r,row:s}}},mapper.collision={isSolidAt:(e,o)=>b8.ECS.entitiesAt(e,o).some(t=>b8.ECS.hasComponent(t,"Solid")),isFree:(e,o)=>mapper.collision.isWalkable(e,o)&&!mapper.collision.isSolidAt(e,o),isWalkable:function(e,o){const t=mapper.getCurrentMap();return!(e<0||o<0||e>=t.mapWidth||o>=t.mapHeight||t.mapData[o][e][3]===!0)}},mapper.helpers={capitalizeWords:e=>e.replace(/\b\p{L}/gu,o=>o.toUpperCase()),processChatText:e=>(e=e.replace(/\[levelName\]/g,b8.data.levelName??"Unknown"),e=e.replace(/\[playerName\]/g,b8.data.playerName??"Player"),e=e.replace(/\[totalCoins\]/g,b8.data.totalCoins??"0"),e),getObjectsByType:e=>{const o=[];for(let t=0;t<mapper.maps.length;t++){const n=mapper.maps[t];for(const r of n.objects)r.type.startsWith(e)&&o.push(r)}return o}},mapper.load=function(e){b8.ECS.reset(),mapper.maps=[],mapper.settings={},mapper.currentMapId=null,b8.Utilities.checkObject("mapData",e),e.version===1&&(e=mapper.upgradeMapDataV1toV2(e)),console.log("map data",e),mapper.settings={...e.settings},b8.Utilities.checkObject("mapper.settings",mapper.settings),e.levels.forEach((t,n)=>{const r=t.mapData.join(`
`);b8.Utilities.checkString(`mapDataString for level ${n}`,r);const s=b8.Tilemap.convertFromText(r),i=b8.Tilemap.createFromArray(s,e.tiles),a=(t.objects||[]).map(c=>({...c,mapId:n}));mapper.maps.push({screenWidth:e.screenWidth,screenHeight:e.screenHeight,screenCountX:t.screenCountX,screenCountY:t.screenCountY,objects:a,mapWidth:i[0].length,mapHeight:i.length,mapData:i})}),mapper.settings.gameName&&(console.log(`Starting game: ${mapper.settings.gameName}`),b8.CONFIG.NAME=mapper.settings.gameName),mapper.player=b8.ECS.create({Type:{name:"player"},Loc:{row:0,col:0},Direction:{dx:0,dy:0},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},CharacterAnimation:{name:"idle",default:"idle",duration:0}}),mapper.setCurrentMap(0);let o=0;for(const t of mapper.maps)o+=t.objects.filter(n=>n.type==="coin").length;b8.data.totalCoins=o,b8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),mapper.settings.bgm&&b8.Music.play(mapper.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&b8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=b8.Tilemap.load(mapper.settings.splash))},mapper.upgradeMapDataV1toV2=function(e){console.log("Upgrading map data from v1 to v2");const o={mapData:[...e.map],objects:[...e.objects],screenCountX:e.screenCountX,screenCountY:e.screenCountY};return e.levels=[o],e.version=2,delete e.map,delete e.objects,delete e.screenCountX,delete e.screenCountY,e},mapper.setCurrentMap=function(e){if(b8.Utilities.checkInt("mapId",e),e<0||e>=mapper.maps.length){b8.Utilities.fatal(`Map ID "${e}" is out of bounds.`);return}if(e===mapper.currentMapId)return;let o=mapper.maps[e];console.log(o),o.objects||(o.objects=[]);const t=b8.ECS.getAllEntities();for(const n of t)b8.ECS.getComponent(n,"Type")?.name!=="player"&&b8.ECS.removeEntity(n);for(const n of o.objects){const r=mapper.types[n.type];r?.spawn&&r.spawn(n.x,n.y,n.props)}mapper.currentMapId=e,mapper.maps[mapper.currentMapId].objects=mapper.maps[mapper.currentMapId].objects.filter(n=>n.type!=="start")},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(b8.Tilemap.draw(mapper.bg.splash),console.log("Drawing b8 logo"),b8.locate(b8.CONFIG.SCREEN_COLS-1,b8.CONFIG.SCREEN_ROWS-1),b8.color(15,0),b8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.sceneGame={UI:null,init:function(){mapper.sceneGame.UI=b8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(e){if(mapper.CONFIG.moveDelay-=e,mapper.CONFIG.moveDelay>0)return;const o=b8.ECS.getComponent(mapper.player,"Loc"),t=b8.ECS.getComponent(mapper.player,"CharacterAnimation");if(mapper.CONFIG.moveDelay>0)return;let n=0,r=0;if(b8.keyp("ArrowUp")?r=-1:b8.keyp("ArrowDown")?r=1:b8.keyp("ArrowLeft")?n=-1:b8.keyp("ArrowRight")&&(n=1),b8.keyp("ButtonB")&&mapper.actionCooldown===0&&mapper.doAction(mapper.player),n!==0||r!==0){let s=o.col+n,i=o.row+r;r>0&&(t.name="move-down"),r<0&&(t.name="move-up"),n>0&&(t.name="move-right"),n<0&&(t.name="move-left"),t.duration=.3,(!mapper.collision.isWalkable(s,i)||mapper.doCollision(o.col,o.row,s,i,n,r))&&(s=o.col,i=o.row),b8.ECS.setComponent(mapper.player,"Direction",{dx:n,dy:r}),b8.ECS.setLoc(mapper.player,s,i),mapper.CONFIG.moveDelay=.15}mapper.update(e)},render:function(){b8.cls(0),b8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),b8.locate(0,b8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),b8.Tilemap.draw(mapper.sceneGame.UI),b8.locate(2,b8.CONFIG.SCREEN_ROWS-2),b8.color(mapper.settings.coinColor,0),b8.printChar(mapper.settings.coin||266),b8.color(15,0),b8.print(" "+parseInt(b8.Inventory.getCount("coin")).toString().padStart(4,"0")),b8.Inventory.filter(/^key/).forEach((o,t)=>{const n=parseInt(o.id.split("-")[1])||15;b8.locate(10+t,b8.CONFIG.SCREEN_ROWS-2),b8.color(n,-1),b8.printChar(255)}),b8.color(15,-1),b8.locate(11,b8.CONFIG.SCREEN_ROWS-4),b8.print(" "),b8.locate(15,b8.CONFIG.SCREEN_ROWS-4),b8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player)))}},mapper.sceneMenu={init:function(){if(!mapper.menu.hasSplash()){b8.Scene.set("game");return}mapper.sceneMenu.main()},main:async()=>{b8.locate(0,0),mapper.menu.drawSplash(),b8.locate(5,18),b8.color(0,10);let e=["Start Game"];mapper.menu.hasInstructions()&&e.push("Instructions"),mapper.menu.hasCredits()&&e.push("Credits");let o=await b8.Async.menu(e,{border:!1,padding:0,centerH:!0});const t=e[o];if(t==="Start Game"){b8.Scene.set("game");return}if(t==="Instructions"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getInstructions(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}if(t==="Credits"){b8.locate(2,2),b8.color(15,13);const n=b8.wrapText(mapper.menu.getCredits(),b8.CONFIG.SCREEN_COLS-6);await b8.Async.dialog(n,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.characterAnimation=function(e){const o=b8.ECS.query("CharacterAnimation");if(o)for(const t of o){const n=b8.ECS.getComponent(t,"CharacterAnimation");if(n&&n.duration>0&&(n.duration-=e,n.duration<=0)){let r=n.default||"";const s=b8.ECS.getComponent(t,"Direction");if(s){const a={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${s.dx},${s.dy}`]||"";r=r+a}n.name=r}}},mapper.systems.tryPortal=async function(e,o){const t=b8.ECS.entitiesAt(e,o);if(console.log("Checking for portal at",e,o,t),!t)return!1;for(const n of t){const r=b8.ECS.getComponent(n,"Portal");return mapper.systems.handlePortal(r)}return!1},mapper.systems.handlePortal=async function(e){if(!e||e.target==="")return!1;const t=mapper.helpers.getObjectsByType("door").find(n=>n.props.name===e.target);return t&&(await b8.Async.wait(.1),mapper.setCurrentMap(t.mapId),b8.ECS.setLoc(mapper.player,t.x,t.y)),!1},mapper.systems.tryPushing=(e,o,t,n)=>{const r=e+t,s=o+n;for(const i of b8.ECS.entitiesAt(r,s)){if(!b8.ECS.hasComponent(i,"Solid")||!b8.ECS.hasComponent(i,"Pushable"))continue;const a=b8.ECS.getComponent(i,"Loc"),c=a.col+t,l=a.row+n;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(C=>b8.ECS.hasComponent(C,"Solid"))?!0:(b8.ECS.setLoc(i,c,l),b8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(e,o,t,n,r)=>{const s=e+t,i=o+n;for(const a of b8.ECS.entitiesAt(s,i)){if(!b8.ECS.hasComponent(a,"Solid")||!b8.ECS.hasComponent(a,"Pushable"))continue;const c=e-t,l=o-n;return!mapper.collision.isWalkable(c,l)||b8.ECS.entitiesAt(c,l).some(A=>b8.ECS.hasComponent(A,"Solid"))?!1:(b8.ECS.setLoc(a,e,o),b8.ECS.setLoc(r,c,l),b8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.teleportSystem=async function(e){const o=b8.ECS.query("Teleport");for(const[t,n]of o){const s=b8.ECS.query("Portal").find(([i])=>b8.ECS.getComponent(i,"Portal")?.name===n.target);if(s){const i=b8.ECS.getComponent(s[0],"Loc");i&&(await b8.Async.wait(.1),b8.ECS.setLoc(t,i.col,i.row))}b8.ECS.removeComponent(t,"Teleport")}},mapper.types.skeleton={init:function(e){},onCharacterCollision:async function(e,o,t,n,r){},update:function(e){},render:function(e,o=0,t=0){}},mapper.types.coin={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"coin"},Loc:{col:e,row:o},Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:t.fg||14,bg:t.bg||0}})},onCharacterCollision:function(e){const o=mapper.getCurrentMap();return o.objects=o.objects.filter(t=>t.id!==e),b8.ECS.removeEntity(e),b8.Inventory.add("coin"),b8.Sfx.play("game/coin/002"),!1}},mapper.types.crate={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"crate"},Loc:{col:e,row:o},Sprite:{tile:352,fg:t.fg||15,bg:t.bg||0,depth:10},Solid:{},Pushable:{},Action:{verb:"pull"}})}},mapper.types.doorOpen={spawn:function(e,o,t){const n={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:216,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return b8.ECS.create(n)},onCharacterCollision:function(e,o,t,n,r){return mapper.systems.tryPortal(o,t),!1}},mapper.types.doorStairs={spawn:function(e,o,t){const n=t.icon||197,r={Type:{name:"doorStairs"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return b8.ECS.create(r)},onCharacterCollision:function(e,o,t,n,r){return mapper.systems.tryPortal(o,t),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,spawn:function(e,o,t){const n=t.icon||mapper.types.door.TILE_DOOR_DEFAULT,r={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return n!==mapper.types.door.TILE_DOOR_OPEN&&(r.Solid={}),b8.ECS.create(r)},onCharacterCollision:function(e,o,t,n,r){if(!b8.ECS.hasComponent(e,"Solid"))return mapper.systems.tryPortal(o,t),!1;const s=b8.ECS.getComponent(e,"Sprite"),i=`key-${s.fg??"default"}`;return b8.Inventory.has(i)&&(b8.ECS.removeComponent(e,"Solid"),s.tile=mapper.types.door.TILE_DOOR_OPEN,b8.Sfx.play("ui/click/004")),!0}},mapper.types.key={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"key"},Loc:{col:e,row:o},Sprite:{tile:255,fg:t.fg||14,bg:t.bg||0}})},onCharacterCollision:function(e,o,t,n,r){const s=`key-${b8.ECS.getComponent(e,"Sprite").fg??"default"}`;b8.Inventory.add(s);const i=mapper.getCurrentMap();return i.objects=i.objects.filter(a=>a.id!==e),b8.ECS.removeEntity(e),b8.Sfx.play("tone/bloop/006"),!1}},mapper.types.signpost={spawn:function(e,o,t){return b8.ECS.create({Type:{name:"signpost"},Loc:{col:e,row:o},Sprite:{tile:t.icon||252,fg:t.fg||15,bg:t.bg||0},Solid:{},Message:{message:t.message||""},Action:{verb:"read"}})}},mapper.types.start={spawn:function(e,o,t){b8.ECS.setLoc(mapper.player,e,o)}};
