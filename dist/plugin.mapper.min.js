const mapper={maps:[],currentMap:null,types:{},systems:{},actions:{},settings:{},bg:{},player:null,play:function(e){beep8.Utilities.checkObject("mapData",e),mapper.load(e),beep8.Scene.add("menu",mapper.sceneMenu),beep8.Scene.add("game",mapper.sceneGame),beep8.Scene.set("menu")},load:function(e,o="world",t=!0){beep8.Utilities.checkObject("mapData",e);const n=e.map.join(`
`);beep8.Utilities.checkString("mapDataString",n),mapper.settings={...e.settings},beep8.Utilities.checkObject("mapper.settings",mapper.settings),console.log("settings",mapper.settings),mapper.player=beep8.ECS.create({Type:{name:"player"},Loc:{row:0,col:0},Direction:{dx:0,dy:0},Sprite:{type:"actor",tile:parseInt(mapper.settings.character)||6,fg:parseInt(mapper.settings.characterColor)||10,bg:0,depth:100},CharacterAnimation:{name:"idle",default:"idle",duration:0}});const r=beep8.Tilemap.convertFromText(n),i=beep8.Tilemap.createFromArray(r,e.tiles);console.log("map",i),console.log("maze",r),mapper.maps.push({name:o,screenWidth:e.screenWidth,screenHeight:e.screenHeight,screenCountX:e.screenCountX,screenCountY:e.screenCountY,mapWidth:i[0].length,mapHeight:i.length,map:i}),t&&mapper.setCurrentMap(o);for(const s of e.objects){const c=mapper.types[s.type];c?.spawn&&(shouldAdd=c.spawn(s.x,s.y,s.props))}beep8.ECS.addSystem("characterAnimation",mapper.systems.characterAnimation),mapper.settings.bgm&&beep8.Music.play(world.settings.bgm),mapper.settings.splash&&mapper.settings.splash.length>10&&beep8.Tilemap.validateTilemap(mapper.settings.splash)&&(mapper.bg.splash=beep8.Tilemap.load(mapper.settings.splash))},update:function(e){beep8.ECS.run(e)},drawActor:function(e){if(!mapper.currentMap){beep8.Utilities.error("No current map set.");return}const o=mapper.camera.getScreenPosition(e.col,e.row),t=e.col-o.col,n=e.row-o.row;beep8.locate(t+offsetX,n+offsetY),beep8.color(e.fg,e.bg),beep8.drawActor(e.id,e.animation)},render:function(e=0,o=0){const t=[];for(const n of beep8.ECS.query("Sprite","Loc")){const r=beep8.ECS.getComponent(n,"Sprite"),i=beep8.ECS.getComponent(n,"Loc"),s=beep8.ECS.getComponent(n,"CharacterAnimation");t.push({spr:r,loc:i,anim:s})}if(t.length!==0){t.sort((n,r)=>(n.spr.depth??0)-(r.spr.depth??0));for(const{spr:n,loc:r,anim:i}of t){const s=mapper.camera.getTilePosition(r.col,r.row);beep8.locate(s.col+e,s.row+o),beep8.color(n.fg??15,n.bg??0),n.type==="actor"?beep8.drawActor(parseInt(n.tile),i.name):beep8.printChar(parseInt(n.tile))}}},drawScreen:function(){if(!mapper.currentMap){beep8.Utilities.error("No current map set.");return}const e=beep8.ECS.getComponent(mapper.player,"Loc"),o=mapper.camera.getScreenPosition(e.col,e.row),t=mapper.currentMap;beep8.Tilemap.draw(t.map,o.col,o.row,o.w,o.h)},setCurrentMap:function(e){let o=mapper.maps.find(t=>t.name===e);if(!o){console.error(`Map "${e}" not found.`);return}mapper.currentMap=o},setTile:function(e,o,t){if(!mapper.currentMap){beep8.Utilities.error("No current map set.");return}if(e<0||o<0||o>=mapper.currentMap.map.mapHeight||e>=mapper.currentMap.map.mapWidth){beep8.Utilities.error("Mapper.setTile, coordinates out of bounds.");return}mapper.currentMap.map[o][e]=t},getVerbForEntity:e=>beep8.ECS.getComponent(e,"Action")?.verb??"",promptAhead:e=>{const o=mapper.entitiesAhead(e);for(const t of o){const n=mapper.getVerbForEntity(t);if(n)return n}return""},ahead:e=>{const o=beep8.ECS.getComponent(e,"Loc"),t=beep8.ECS.getComponent(e,"Direction"),n=o.col+(t.dx||0),r=o.row+(t.dy||0);return{x:n,y:r}},entitiesAhead:e=>{const{x:o,y:t}=mapper.ahead(e);return beep8.ECS.entitiesAt(o,t)??[]},doCollision:function(e,o,t,n,r,i){if(mapper.systems.tryPushing(e,o,r,i))return!0;for(const s of beep8.ECS.entitiesAt(t,n)){const c=beep8.ECS.getComponent(s,"Type"),a=c?mapper.types[c.name]:null;if(a?.onCharacterCollision&&a.onCharacterCollision(s,t,n,r,i)||beep8.ECS.hasComponent(s,"Solid"))return!0}return!1},doAction:e=>{const o=mapper.promptAhead(e);console.log("do action ",o),o&&mapper.actions[o]&&mapper.actions[o](e)}};mapper.CONFIG={spikeInterval:1,moveDelay:.15,mapOffsetX:1,mapOffsetY:1,gameUI:"hpgYhRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGGEIAACghRhhCAAAoIUYYQgAAKCFGJUHAACghRiVBwAAoIUYlQcAAKCFGJUKAACgmBiFGBwHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFDAYHAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGBkHBgCghRgZBwYAoIUYGQcGAKCFGB0HBgCghRgZBwgAoIUYIAgHAKCFGCsHBgCghRkBXAoAAKCYGIUYKwYHAKCFEgAHAKCFAAgAAKCFAAgAAKCFAAgAAKCFAwEAAKCFAAgAAKCFAA8AAKCFEwAHAKCFAQcGAKCFGQG0CgcAoIUBBwYAoIUBBwYAoIUBBwYAoIUZAbUKBwCghQEHBgCghQEHBgCghQEHBgCghQEHBgCghREGBwCghQAAAACghRMABwCghRgrBwYAoIUZAV4KAACgmBiFGCsGBwCghQEABwCghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghRkBnwgAAKCFGQGfCAAAoIUZAZ8IAACghQEABwCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD0AAQCghRg9AAEAoIUYPQABAKCFGD4AAQCghQEHBgCghRgrBwYAoIUAAAAAoIUAAAAAoIUYKwcGAKCFGQFdCgAAoJgYhRgrBgcAoIUBAAcAoIUBAAEAoIUADgAAoIUADwAAoIUADwAAoIUADwAAoIUADwAAoIUAAQAAoIUABQEAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUBAQcAoIUYUAABAKCFAAYHAKCFGCsHBgCghQAAAACghRglAAcAoIUYKwcGAKCFGQFeCgAAoJgYhRguBwYAoIUBAAEAoIUAAQAAoIUAAQAAoIUAAQAAoIUAAQAAoIURAQAAoIURAQAAoIUBAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIUYYQABAKCFGGEAAQCghRhhAAEAoIURBgEAoIURBgEAoIUYYgABAKCFEQYHAKCFGC8HBgCghRgZBgcAoIUYGQYHAKCFGDEHBgCghRkBXQoAAKA="},mapper.actions.pull=function(e){const o=beep8.ECS.getComponent(e,"Loc"),t=beep8.ECS.getComponent(e,"Direction");mapper.systems.tryPulling(o.col,o.row,t.dx,t.dy,e)},mapper.actions.read=async function(e){const o=mapper.entitiesAhead(e);for(const t of o){const n=beep8.ECS.getComponent(t,"Message"),r=beep8.ECS.getComponent(t,"Sprite");!n||!r||(beep8.color(r.fg??15,r.bg??5),await beep8.Async.dialogTypewriter(n.message,["OK"],20))}},mapper.camera={getScreenPosition:function(e,o){if(!mapper.currentMap)return beep8.Utilities.error("No current map set."),{col:0,row:0};const t=mapper.currentMap,n=t.screenWidth,r=t.screenHeight,i=Math.floor(e/n)*n,s=Math.floor(o/r)*r;return{col:i,row:s,w:n,h:r}},getTilePosition:function(e,o){const t=beep8.ECS.getComponent(mapper.player,"Loc"),n=mapper.camera.getScreenPosition(t.col,t.row);let r=e-n.col,i=o-n.row;return r<0&&(r=-100),i<0&&(i=-100),r>=n.w&&(r=-100),i>=n.h&&(i=-100),{col:r,row:i}}},mapper.collision={isSolidAt:(e,o)=>beep8.ECS.entitiesAt(e,o).some(t=>beep8.ECS.hasComponent(t,"Solid")),isFree:(e,o)=>mapper.collision.isWalkable(e,o)&&!mapper.collision.isSolidAt(e,o),isWalkable:function(e,o){return!(e<0||o<0||e>=mapper.currentMap.map.mapHeight||o>=mapper.currentMap.map.mapWidth||mapper.currentMap.map[o][e][3]===!0)}},mapper.helpers={capitalizeWords:e=>e.replace(/\b\p{L}/gu,o=>o.toUpperCase())},mapper.menu={getInstructions:function(){return mapper.hasInstructions()?mapper.settings.instructions:""},hasInstructions:function(){return!!mapper.settings.instructions},getCredits:function(){return mapper.hasCredits()?mapper.settings.credits:""},hasCredits:function(){return!!mapper.settings.credits},drawSplash:function(){mapper.bg.splash&&(beep8.Tilemap.draw(mapper.bg.splash),console.log("Drawing Beep8 logo"),beep8.locate(beep8.CONFIG.SCREEN_COLS-1,beep8.CONFIG.SCREEN_ROWS-1),beep8.color(15,0),beep8.printChar(88))},hasSplash:function(){return!!mapper.bg.splash}},mapper.sceneGame={UI:null,init:function(){console.log(mapper.CONFIG),mapper.sceneGame.UI=beep8.Tilemap.load(mapper.CONFIG.gameUI)},update:function(e){if(mapper.CONFIG.moveDelay-=e,mapper.CONFIG.moveDelay>0)return;const o=beep8.ECS.getComponent(mapper.player,"Loc"),t=beep8.ECS.getComponent(mapper.player,"CharacterAnimation");if(mapper.CONFIG.moveDelay>0)return;let n=0,r=0;if(beep8.keyp("ArrowUp")?r=-1:beep8.keyp("ArrowDown")?r=1:beep8.keyp("ArrowLeft")?n=-1:beep8.keyp("ArrowRight")&&(n=1),beep8.keyp("ButtonB")&&mapper.doAction(mapper.player),n!==0||r!==0){let i=o.col+n,s=o.row+r;r>0&&(t.name="move-down"),r<0&&(t.name="move-up"),n>0&&(t.name="move-right"),n<0&&(t.name="move-left"),t.duration=.3,(!mapper.collision.isWalkable(i,s)||mapper.doCollision(o.col,o.row,i,s,n,r))&&(i=o.col,s=o.row),beep8.ECS.set(mapper.player,"Direction",{dx:n,dy:r}),beep8.ECS.setLoc(mapper.player,i,s),mapper.CONFIG.moveDelay=.15}mapper.update(e)},render:function(){beep8.cls(),beep8.locate(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),mapper.drawScreen(),mapper.render(mapper.CONFIG.mapOffsetX,mapper.CONFIG.mapOffsetY),beep8.locate(0,beep8.CONFIG.SCREEN_ROWS-mapper.sceneGame.UI.length),beep8.Tilemap.draw(mapper.sceneGame.UI),beep8.locate(2,beep8.CONFIG.SCREEN_ROWS-2),beep8.color(mapper.settings.coinColor,0),beep8.printChar(mapper.settings.coin||266),beep8.color(15,0),beep8.print(" "+parseInt(beep8.Inventory.getCount("coin")).toString().padStart(4,"0")),beep8.Inventory.filter(/^key/).forEach((o,t)=>{const n=parseInt(o.id.split("-")[1])||15;beep8.locate(10+t,beep8.CONFIG.SCREEN_ROWS-2),beep8.color(n,-1),beep8.printChar(255)}),beep8.color(15,-1),beep8.locate(11,beep8.CONFIG.SCREEN_ROWS-4),beep8.print(" "),beep8.locate(15,beep8.CONFIG.SCREEN_ROWS-4),beep8.print(mapper.helpers.capitalizeWords(" "+mapper.promptAhead(mapper.player)))}},mapper.sceneMenu={init:function(){mapper.menu.hasSplash()&&mapper.sceneMenu.main()},main:async()=>{beep8.locate(0,0),mapper.menu.drawSplash(),beep8.locate(5,18),beep8.color(0,10);let e=["Start Game"];mapper.menu.hasInstructions()&&e.push("Instructions"),mapper.menu.hasCredits()&&e.push("Credits");let o=await beep8.Async.menu(e,{border:!1,padding:0,centerH:!0});const t=e[o];if(t==="Start Game"){beep8.Scene.set("game");return}if(t==="Instructions"){beep8.locate(2,2),beep8.color(15,13);const n=beep8.wrapText(mapper.menu.getInstructions(),beep8.CONFIG.SCREEN_COLS-6);await beep8.Async.dialog(n,["OK"])}if(t==="Credits"){beep8.locate(2,2),beep8.color(15,13);const n=beep8.wrapText(mapper.menu.getCredits(),beep8.CONFIG.SCREEN_COLS-6);await beep8.Async.dialog(n,["OK"])}setTimeout(mapper.sceneMenu.main,10)}},mapper.systems.characterAnimation=function(e){const o=beep8.ECS.query("CharacterAnimation");if(o)for(const t of o){const n=beep8.ECS.getComponent(t,"CharacterAnimation");if(n&&n.duration>0&&(n.duration-=e,n.duration<=0)){let r=n.default||"";const i=beep8.ECS.getComponent(t,"Direction");if(i){const c={"0,1":"","0,-1":"-up","1,0":"-right","-1,0":"-left"}[`${i.dx},${i.dy}`]||"";r=r+c}n.name=r}}},mapper.systems.tryPortal=async function(e,o){const t=beep8.ECS.entitiesAt(e,o);if(console.log("Checking for portal at",e,o,t),!t)return!1;for(const n of t){const r=beep8.ECS.getComponent(n,"Portal");return mapper.systems.handlePortal(r)}},mapper.systems.handlePortal=async function(e){if(!e||e.target==="")return!1;const t=beep8.ECS.query("Portal").find(n=>beep8.ECS.getComponent(n,"Portal").name===e.target);if(t){const n=beep8.ECS.getComponent(t,"Loc");n&&(await beep8.Async.wait(.1),beep8.ECS.setLoc(mapper.player,n.col,n.row))}return!1},mapper.systems.tryPushing=(e,o,t,n)=>{const r=e+t,i=o+n;for(const s of beep8.ECS.entitiesAt(r,i)){if(!beep8.ECS.hasComponent(s,"Solid")||!beep8.ECS.hasComponent(s,"Pushable"))continue;const c=beep8.ECS.getComponent(s,"Loc"),a=c.col+t,p=c.row+n;return!mapper.collision.isWalkable(a,p)||beep8.ECS.entitiesAt(a,p).some(A=>beep8.ECS.hasComponent(A,"Solid"))?!0:(beep8.ECS.setLoc(s,a,p),beep8.Sfx.play("fx/action/drag"),!1)}return!1},mapper.systems.tryPulling=(e,o,t,n,r)=>{const i=e+t,s=o+n;for(const c of beep8.ECS.entitiesAt(i,s)){if(!beep8.ECS.hasComponent(c,"Solid")||!beep8.ECS.hasComponent(c,"Pushable"))continue;const a=e-t,p=o-n;return!mapper.collision.isWalkable(a,p)||beep8.ECS.entitiesAt(a,p).some(l=>beep8.ECS.hasComponent(l,"Solid"))?!1:(beep8.ECS.setLoc(c,e,o),beep8.ECS.setLoc(r,a,p),beep8.Sfx.play("fx/action/drag"),!0)}return!1},mapper.systems.teleportSystem=async function(e){const o=beep8.ECS.query("Teleport");for(const[t,n]of o){const i=beep8.ECS.query("Portal").find(([s])=>beep8.ECS.getComponent(s,"Portal")?.name===n.target);if(i){const s=beep8.ECS.getComponent(i[0],"Loc");s&&(await beep8.Async.wait(.1),beep8.ECS.setLoc(t,s.col,s.row))}beep8.ECS.removeComponent(t,"Teleport")}},mapper.types.skeleton={init:function(e){},onCharacterCollision:async function(e,o,t,n,r){},update:function(e){},render:function(e,o=0,t=0){}},mapper.types.coin={spawn:function(e,o,t){return beep8.ECS.create({Type:{name:"coin"},Loc:{col:e,row:o},Sprite:{tile:parseInt(mapper.settings.coin)||266,fg:t.fg||14,bg:t.bg||0}})},onCharacterCollision:function(e){return beep8.ECS.removeEntity(e),beep8.Inventory.add("coin"),beep8.Sfx.play("game/coin/002"),!1}},mapper.types.crate={spawn:function(e,o,t){return beep8.ECS.create({Type:{name:"crate"},Loc:{col:e,row:o},Sprite:{tile:352,fg:t.fg||15,bg:t.bg||0,depth:10},Solid:{},Pushable:{},Action:{verb:"pull"}})}},mapper.types.doorOpen={spawn:function(e,o,t){const n={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:216,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return beep8.ECS.create(n)},onCharacterCollision:function(e,o,t,n,r){return mapper.systems.tryPortal(o,t),!1}},mapper.types.doorStairs={spawn:function(e,o,t){const n=t.icon||197,r={Type:{name:"doorStairs"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return beep8.ECS.create(r)},onCharacterCollision:function(e,o,t,n,r){return mapper.systems.tryPortal(o,t),!1}},mapper.types.door={TILE_DOOR_OPEN:216,TILE_DOOR_DEFAULT:219,spawn:function(e,o,t){const n=t.icon||mapper.types.door.TILE_DOOR_DEFAULT,r={Type:{name:"door"},Loc:{col:e,row:o},Sprite:{tile:n,fg:t.fg||14,bg:t.bg||0},Portal:{name:t.name||null,target:t.leadsTo||""}};return n!==mapper.types.door.TILE_DOOR_OPEN&&(r.Solid={}),beep8.ECS.create(r)},onCharacterCollision:function(e,o,t,n,r){if(!beep8.ECS.hasComponent(e,"Solid"))return mapper.systems.tryPortal(o,t),!1;const i=beep8.ECS.getComponent(e,"Sprite"),s=`key-${i.fg??"default"}`;return beep8.Inventory.has(s)&&(beep8.ECS.removeComponent(e,"Solid"),i.tile=mapper.types.door.TILE_DOOR_OPEN,beep8.Sfx.play("ui/click/004")),!0}},mapper.types.key={spawn:function(e,o,t){return beep8.ECS.create({Type:{name:"key"},Loc:{col:e,row:o},Sprite:{tile:255,fg:t.fg||14,bg:t.bg||0}})},onCharacterCollision:function(e,o,t,n,r){const i=`key-${beep8.ECS.getComponent(e,"Sprite").fg??"default"}`;return beep8.Inventory.add(i),beep8.ECS.removeEntity(e),beep8.Sfx.play("tone/bloop/006"),!1}},mapper.types.signpost={spawn:function(e,o,t){return beep8.ECS.create({Type:{name:"signpost"},Loc:{col:e,row:o},Sprite:{tile:t.icon||252,fg:t.fg||15,bg:t.bg||0},Solid:{},Message:{message:t.message||""},Action:{verb:"read"}})}},mapper.types.start={spawn:function(e,o,t){beep8.ECS.setLoc(mapper.player,e,o)}};
