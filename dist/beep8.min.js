/*!
 * beep8.js - A Retro Game Library
 *
 * ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
 * ░░░░       ░░        ░        ░       ░░░     ░░░░░        ░░      ░░░░░
 * ▒▒▒▒  ▒▒▒▒  ▒  ▒▒▒▒▒▒▒  ▒▒▒▒▒▒▒  ▒▒▒▒  ▒  ▒▒▒  ▒▒▒▒▒▒▒▒▒▒  ▒  ▒▒▒▒▒▒▒▒▒▒
 * ▓▓▓▓       ▓▓      ▓▓▓      ▓▓▓       ▓▓▓     ▓▓▓▓▓▓▓▓▓▓▓  ▓▓      ▓▓▓▓▓
 * ████  ████  █  ███████  ███████  ███████  ███  ████  ████  ███████  ████
 * ████       ██        █        █  ████████     ██  ██      ███      █████
 * ████████████████████████████████████████████████████████████████████████
 *
 * beep8.js is a retro game library designed to bring
 * the charm and simplicity of classic games to modern
 * web development. A fork of qx82, beep8.js retains
 * the original's elegance while enhancing its features
 * for today's developers.
 *
 * ---
 *
 * Website: https://beep8.com
 * Games: https://beepmini.com
 * Github: https://github.com/BinaryMoon/beep8
 * BlueSky: https://bsky.app/profile/binarymoon.bsky.social
 *
 * ---
 *
 * MIT License
 *
 * Copyright (c) 2024 - 2025 BinaryMoon
 *
 * Permission is hereby granted, free of charge, to any
 * person obtaining a copy of this software and associated
 * documentation files (the "Software"), to deal in the
 * Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall
 * be included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */const beep8={};(function(t){t.CONFIG={DEBUG:!0,NAME:"beep8 Project",VERSION:"1.0.0-dev",CANVAS_SETTINGS:{CANVAS_ID:"beep8-canvas",CANVAS_CLASSES:[],CONTAINER:null},SFX:{TYPING:"ui/click/003",MENU_UP:"tone/beep/002",MENU_DOWN:"tone/beep/001",MENU_SELECT:"tone/beep/003"},FONT_DEFAULT:"../assets/font-default-thin.png",FONT_TILES:"../assets/font-tiles.png",FONT_ACTORS:"../assets/font-actors.png",CHRS:`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*+=-<>_#&@%^~$\xA3\u20AC\xA5\xA2!?:;'"/\\()[]{}.,\xA9\xAE\u2122\u2022\u2026| `,CHR_WIDTH:12,CHR_HEIGHT:12,SCREEN_ROWS:25,SCREEN_COLS:20,SCREEN_COLORS:1,CRT_ENABLE:.3,CRT_VIGNETTE:!0,COLORS:["#0A0C1F","#263264","#A0ABB6","#B2EFEB","#3FB0F1","#3548A3","#420241","#6A3E49","#C22D44","#E08355","#FFC763","#A7D171","#30AB62","#1E7F82","#FF76D7","#F4F4F4"],PASSKEY:"beep8IsAwesome",TOUCH_VJOY:!0,CURSOR:{BLINK_INTERVAL:400},PRINT_ESCAPE_START:"{{",PRINT_ESCAPE_END:"}}",BORDER_CHAR:54}})(beep8),(function(t){t.init=function(o,s={}){return t.Utilities.checkFunction("callback",o),t.Utilities.checkObject("options",s),s!==null&&(t.CONFIG=t.Utilities.deepMerge(t.CONFIG,s)),t.Core.init(o)},t.frame=function(o=null,s=null,r=30){return t.Core.preflight("beep8.frame"),o!==null&&t.Utilities.checkFunction("render handler",o),s!==null&&t.Utilities.checkFunction("update handler",s),t.Utilities.checkNumber("fps",r),t.Core.setFrameHandlers(o,s,r)},t.render=function(){return t.Core.preflight("beep8.render"),t.Renderer.render()},t.color=function(o,s=void 0){t.Core.preflight("beep8.color"),t.Utilities.checkNumber("fg",o),s!==void 0&&t.Utilities.checkNumber("bg",s),t.Core.setColor(o,s)},t.getFgColor=function(){return t.Core.preflight("getFgColor"),t.Core.drawState.fgColor},t.getBgColor=function(){return t.Core.preflight("beep8.getBgColor"),t.Core.drawState.bgColor},t.cls=function(o=void 0){t.Core.preflight("beep8.Core.cls"),o!==void 0&&t.Utilities.checkNumber("bg",o),t.Core.cls(o)},t.locate=function(o,s){t.Core.preflight("beep8.locate"),t.Utilities.checkNumber("col",o),s!==void 0&&t.Utilities.checkNumber("row",s),t.Core.setCursorLocation(o,s)},t.col=function(){return t.Core.preflight("col"),t.Core.drawState.cursorCol},t.row=function(){return t.Core.preflight("row"),t.Core.drawState.cursorRow},t.cursor=function(o){t.Core.preflight("cursor"),t.Utilities.checkBoolean("visible",o),t.CursorRenderer.setCursorVisible(o)},t.print=function(o,s=-1,r=null){t.Core.preflight("beep8.text"),t.Utilities.checkString("text",o),t.Utilities.checkNumber("maxWidth",s);let n=r;n!==null&&(t.Utilities.checkString("fontName",r),n=t.TextRenderer.getFontByName(r)),t.TextRenderer.print(o,n,s)},t.printCentered=function(o,s=t.CONFIG.SCREEN_COLS,r=null){t.Core.preflight("beep8.printCentered"),t.Utilities.checkString("text",o),t.Utilities.checkNumber("width",s);let n=r;n!==null&&(t.Utilities.checkString("fontName",r),n=t.TextRenderer.getFontByName(r)),t.TextRenderer.printCentered(o,s,n)},t.printRight=function(o,s=t.CONFIG.SCREEN_COLS,r=null){t.Core.preflight("beep8.printRight"),t.Utilities.checkString("text",o),t.Utilities.checkNumber("width",s);let n=r;n!==null&&(t.Utilities.checkString("fontName",r),n=t.TextRenderer.getFontByName(r)),t.TextRenderer.printRight(o,s,n)},t.drawText=function(o,s,r,n=null){t.Core.preflight("beep8.drawText"),t.Utilities.checkNumber("x",o),t.Utilities.checkNumber("y",s),t.Utilities.checkString("text",r),n&&t.Utilities.checkString("fontName",n),t.TextRenderer.drawText(o,s,r,n)},t.measure=function(o){return t.Core.preflight("measure"),t.Utilities.checkString("text",o),t.TextRenderer.measure(o)},t.printChar=function(o,s=1,r=null){if(t.Core.preflight("beep8.printChar"),o=t.convChar(o),t.Utilities.checkInt("charCode",o),t.Utilities.checkInt("numTimes",s),s<0&&t.Utilities.fatal("[beep8.printChar] numTimes must be a positive integer"),s===0)return;let n=r;n!==null&&(t.Utilities.checkString("fontName",r),n=t.TextRenderer.getFontByName(r)),t.TextRenderer.printChar(o,s,n)},t.printRect=function(o,s,r=8){t.Core.preflight("beep8.printRect"),r=t.convChar(r),t.Utilities.checkNumber("widthCols",o),t.Utilities.checkNumber("heightRows",s),t.Utilities.checkNumber("charCode",r),t.TextRenderer.printRect(o,s,r)},t.printBox=function(o,s,r=!0,n=t.CONFIG.BORDER_CHAR){t.Core.preflight("beep8.printBox"),n=t.convChar(n),t.Utilities.checkNumber("widthCols",o),t.Utilities.checkNumber("heightRows",s),t.Utilities.checkBoolean("fill",r),t.Utilities.checkNumber("borderChar",n),t.TextRenderer.printBox(o,s,r,n)},t.drawImage=function(o,s,r){t.Utilities.checkInstanceOf("image",r,HTMLImageElement),t.Utilities.checkNumber("x",o),t.Utilities.checkNumber("y",s),t.Core.drawImage(r,o,s)},t.drawImageRect=function(o,s,r,n,e,i,a){t.Utilities.checkInstanceOf("image",r,HTMLImageElement),t.Utilities.checkNumber("x",o),t.Utilities.checkNumber("y",s),t.Utilities.checkNumber("srcX",n),t.Utilities.checkNumber("srcY",e),t.Utilities.checkNumber("width",i),t.Utilities.checkNumber("height",a),t.Core.drawImage(r,o,s,n,e,i,a)},t.drawRect=function(o,s,r,n,e=1){t.Utilities.checkNumber("x",o),t.Utilities.checkNumber("y",s),t.Utilities.checkNumber("width",r),t.Utilities.checkNumber("height",n),t.Utilities.checkNumber("lineWidth",e),t.Core.drawRect(o,s,r,n,e)},t.fillRect=function(o,s,r,n){t.Utilities.checkNumber("x",o),t.Utilities.checkNumber("y",s),t.Utilities.checkNumber("width",r),t.Utilities.checkNumber("height",n),t.Core.fillRect(o,s,r,n)},t.playSound=function(o,s=1,r=!1){t.Utilities.checkInstanceOf("sfx",o,HTMLAudioElement),o.currentTime=0,o.volume=s,o.loop=r,o.play()},t.spr=function(o,s,r){o=t.convChar(o),t.Utilities.checkNumber("ch",o),t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",r),t.TextRenderer.spr(o,s,r)},t.drawActor=function(o,s){o=t.convChar(o),t.Utilities.checkInt("ch",o),t.Utilities.checkString("animation",s),t.Actors.draw(o,s)},t.sprActor=function(o,s,r,n,e=null){return o=t.convChar(o),t.Utilities.checkInt("ch",o),t.Utilities.checkString("animation",s),t.Utilities.checkNumber("x",r),t.Utilities.checkNumber("y",n),e!==null&&t.Utilities.checkNumber("startTime",e),t.Actors.spr(o,s,r,n,e)},t.key=function(o){return t.Core.preflight("beep8.key"),t.Utilities.checkString("keyName",o),t.Input.keyHeld(o)},t.keyp=function(o){return t.Core.preflight("beep8.keyp"),t.Utilities.checkString("keyName",o),t.Input.keyJustPressed(o)},t.playSong=function(o){t.Utilities.checkString("song",o),t.Sound.playSong(o)},t.playSfx=function(o){t.Utilities.checkString("sfx",o),t.Sfx.play(o)},t.redefineColors=function(o){t.Core.preflight("beep8.redefineColors"),t.Utilities.checkArray("colors",o),t.Core.defineColors(o)},t.setFont=function(o){t.Core.preflight("beep8.setFont"),o=o||"default-thin",t.Utilities.checkString("fontName",o),t.TextRenderer.setFont(o)},t.getFont=function(){t.Core.preflight("beep8.getFont"),t.TextRenderer.getFont()},t.getFontByName=function(o){return t.Utilities.checkString("fontName",o),t.TextRenderer.getFontByName(o)},t.setTileFont=function(o){t.Core.preflight("beep8.setTileFont"),o=o||"tiles",t.Utilities.checkString("fontName",o),t.TextRenderer.setTileFont(o)},t.convChar=function(o){return typeof o=="string"&&o.length>0?o.charCodeAt(0):o},t.stopSound=function(o){t.Utilities.checkInstanceOf("sfx",o,HTMLAudioElement),o.currentTime=0,o.pause()},t.getContext=function(){return t.Core.getContext()},t.saveScreen=function(){return t.Core.saveScreen()},t.screenShake=function(o){return t.Utilities.checkNumber("duration",o),t.Renderer.shakeScreen(o)},t.restoreScreen=function(o){return t.Core.restoreScreen(o)},t.wrapText=function(o,s){return t.Utilities.checkString("text",o),t.Utilities.checkNumber("maxWidth",s),t.TextRenderer.wrapText(o,s)},t.addScene=function(o,s={}){t.Scene.add(o,s)},t.switchScene=function(o){t.Scene.set(o)},t.getScene=function(){return t.Scene.get()},t.speak=function(o,s={}){if(!window.speechSynthesis)return;t.Utilities.checkString("text",o),t.Utilities.checkObject("options",s);const r=new SpeechSynthesisUtterance(o);r.pitch=s.pitch??1,r.rate=s.rate??1,r.volume=s.volume??1,speechSynthesis.speak(r)}})(beep8),(function(t){t._asyncActive=!1,t.Async=t.Async||{},t.Async=new Proxy(t.Async,{get(o,s,r){const n=Reflect.get(o,s,r);return typeof n=="function"?async function(...e){let i=!t._asyncActive;i&&(t._asyncActive=!0,t.Scene.pause());try{return t.Core.preflight(`beep8.Async.${s}`),await n.apply(this,e)}finally{i&&(t.Scene.resume(),t._asyncActive=!1)}}:n}}),t.Async.key=async function(){return await t.Input.readKeyAsync()},t.Async.pointer=async function(){return await t.Input.readPointerAsync()},t.Async.readLine=async function(o="",s=-1,r=-1){return t.Utilities.checkString("initString",o),t.Utilities.checkNumber("maxLen",s),await t.Input.readLine(o,s,r)},t.Async.menu=async function(o,s={}){return t.Utilities.checkArray("choices",o),t.Utilities.checkObject("options",s),await t.Menu.display(o,s)},t.Async.dialog=async function(o,s=["OK"],r={}){return t.Utilities.checkString("prompt",o),t.Utilities.checkArray("choices",s),t.Async.menu(s,{prompt:o,center:!0,...r})},t.Async.dialogTypewriter=async function(o,s=["OK"],r=-1,n=.05,e={}){return t.Utilities.checkString("prompt",o),t.Utilities.checkArray("choices",s),t.Utilities.checkNumber("delay",n),r>0&&(o=t.TextRenderer.wrapText(o,r)),await t.Async.menu(s,{prompt:o,typewriter:!0,center:!0,...e})},t.Async.typewriter=async function(o,s=-1,r=.035,n=null){t.Utilities.checkString("text",o),t.Utilities.checkNumber("wrapWidth",s),t.Utilities.checkNumber("delay",r);let e=n;e!==null&&(t.Utilities.checkString("fontName",n),e=t.TextRenderer.getFontByName(n)),await t.TextRenderer.printTypewriter(o,s,r,e)},t.Async.loadImage=async function(o){return t.Utilities.checkString("url",o),await t.Core.loadImage(o)},t.Async.loadSound=async function(o){return new Promise(s=>{const r=new Audio;r.oncanplaythrough=()=>s(r),r.src=o,r.load()})},t.Async.loadFont=async function(o,s=1,r=1){t.Utilities.checkString("fontImageFile",o),t.Utilities.checkNumber("tileSizeWidthMultiplier",s),t.Utilities.checkNumber("tileSizeHeightMultiplier",r);const n="FONT@"+t.Utilities.makeUrlPretty(o);return await t.TextRenderer.loadFontAsync(n,o,s,r),n},t.Async.wait=async function(o){return t.Utilities.checkNumber("seconds",o),t.Renderer.render(),await new Promise(s=>setTimeout(s,Math.round(o*1e3)))},t.Async.waitForContinue=async function(){for(;;){const o=await t.Async.key();if(o.includes("Enter")||o.includes("ButtonA")||o.includes(" "))break}}})(beep8),(function(t){t.Joystick={};let o=null;const s=`
<div class="vjoy-options">
	<button id='vjoy-button-ter' class='vjoy-button'>Start</button>
	<button id='vjoy-button-screenshot' class='vjoy-button'>Snap</button>
</div>
<div class="vjoy-controls">
	<div class="vjoy-dpad">
	<button id='vjoy-button-up' class='vjoy-button'><span>U</span></button>
	<button id='vjoy-button-right' class='vjoy-button'><span>R</span></button>
	<button id='vjoy-button-left' class='vjoy-button'><span>L</span></button>
	<button id='vjoy-button-down' class='vjoy-button'><span>D</span></button>
	</div>
	<div class="vjoy-buttons">
	<button id='vjoy-button-pri' class='vjoy-button'><span>A</span></button>
	<button id='vjoy-button-sec' class='vjoy-button'><span>B</span></button>
	</div>
</div>`,r=`
:root {
	--b8-vjoy-button-color: #333;
	--b8-vjoy-button-size: 14vw;
	--b8-vjoy-button-dpad-size: calc(var(--b8-vjoy-button-size) * 2);
	--b8-console-radius: 2rem;
	--b8-border-radius: calc(var(--b8-vjoy-button-dpad-size) / 5);
}

.vjoy-container,
.vjoy-container * {
	box-sizing: border-box;
	user-select: none;
	-webkit-user-select: none;
	-webkit-touch-callout: none;
	touch-action: none;
}

.vjoy-container {
	position: relative;
	width: 100%;
	padding: 8vw 4vw 8vw 6vw;
	background: deeppink;
	border-radius: 0 0 var(--b8-console-radius) var(--b8-console-radius);
}

.vjoy-options {
	border-radius: 5rem;
	position: absolute;
	display: flex;
	gap: 2vw;
	align-items: center;
	padding: 2vw;
	border-radius: 2rem;
	background: inherit;
	top: -4vw;
	left: 50%;
	transform: translateX(-50%);
}

.vjoy-controls {
	display: flex;
	gap: 5vw;
	justify-content: space-between;
	align-items: center;
}

.vjoy-dpad {
	aspect-ratio: 1;
	max-width: 10rem;
	width: var(--b8-vjoy-button-dpad-size);
	display: grid;
	grid-template-columns: 1fr 1fr;
	grid-template-rows: 1fr 1fr;
	flex-wrap: wrap;
	transform: rotate(45deg);
	border-radius: var(--b8-border-radius);
	background:black;
	gap: 1px;
	border: 2px solid black;
}

.vjoy-dpad button {
	width: 100%;
	height: 100%;
	position: relative;
}
.vjoy-dpad button span {
	transform: rotate(-45deg);
}
.vjoy-dpad button:after {
	position: absolute;
	content: '';
	display: block;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0);
	transform: rotate(-45deg);
}

#vjoy-button-up {
	border-radius: var(--b8-border-radius) 0 0 0;
}
#vjoy-button-down {
	border-radius: 0 0 var(--b8-border-radius) 0;
}
#vjoy-button-left {
	border-radius: 0 0 0 var(--b8-border-radius);
}
#vjoy-button-right {
	border-radius: 0 var(--b8-border-radius) 0 0;
}

#vjoy-button-up:after {
	transform: rotate(-45deg) translateY(-30%) scale(1.1);
}
#vjoy-button-down:after {
	transform: rotate(-45deg) translateY(30%) scale(1.1);
}
#vjoy-button-left:after {
	transform: rotate(-45deg) translateX(-30%) scale(1.1);
}
#vjoy-button-right:after {
	transform: rotate(-45deg) translateX(30%) scale(1.1);
}

.vjoy-buttons {
	display: flex;
	gap: 2vw;
	transform: rotate(-45deg);
	border: 0.8vw solid rgba(0,0,0,0.2);
	border-radius: calc( var(--b8-border-radius) + 1vw );
	padding: 1vw;
}

.vjoy-buttons button {
	width: var(--b8-vjoy-button-size);
	max-width: 5rem;
	max-height: 5rem;
	height: var(--b8-vjoy-button-size);
	border-radius: var(--b8-border-radius);
	touch-action: none;
	border: 2px solid black;
	position: relative;
}

.vjoy-buttons button:after {
	position: absolute;
	content: '';
	display: block;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0);
	transform: scale(1.2);
}

.vjoy-buttons button span {
	transform: rotate(45deg);
}

.vjoy-button {
	background: var(--b8-vjoy-button-color) !important;
	border: none;
	font-family: arial, sans-serif;
	font-size: 12px;
	font-weight: 600;
	color: #aaa !important;
	user-select: none;
	touch-callout: none;
	-webkit-user-select: none;
	-webkit-touch-callout: none;
	text-shadow: 0 -2px 0 black;
	padding: 0;
	display: flex;
	justify-content: center;
	align-items: center;
	letter-spacing: 0.1em;
	text-transform: uppercase;
}

.vjoy-button:hover,
.vjoy-button:focus,
.vjoy-button:active {
	background: black;
	outline: none;
}

#vjoy-button-screenshot,
#vjoy-button-ter {
	width: calc(var(--b8-vjoy-button-size) * 1.4);
	padding: 1vw;
	border-radius: 1rem;
}
`;t.Joystick.setup=function(){t.Utilities.log("Setting up virtual joystick...");const n=document.createElement("style");n.setAttribute("type","text/css"),n.innerText=r,document.body.appendChild(n);const e=document.createElement("div");e.className="vjoy-container",e.innerHTML=s,t.Core.getBeepContainerEl().appendChild(e),setTimeout(t.Joystick.continueSetup,10)},t.Joystick.continueSetup=function(){t.Joystick.setUpButton("vjoy-button-up","ArrowUp"),t.Joystick.setUpButton("vjoy-button-down","ArrowDown"),t.Joystick.setUpButton("vjoy-button-left","ArrowLeft"),t.Joystick.setUpButton("vjoy-button-right","ArrowRight"),t.Joystick.setUpButton("vjoy-button-pri","ButtonA"),t.Joystick.setUpButton("vjoy-button-sec","ButtonB"),t.Joystick.setUpButton("vjoy-button-ter","Enter"),t.Joystick.setUpButton("vjoy-button-screenshot","0"),document.body.addEventListener("touchstart",n=>n.preventDefault())},t.Joystick.setUpButton=function(n,e){const i=t.Utilities.assert(document.getElementById(n),"Could not find button ID "+n);if(e===null){i.style.display="none";return}["pointerdown","pointerstart"].forEach(a=>{i.addEventListener(a,u=>{u.preventDefault(),t.Joystick.handleButtonEvent(e,!0,u)},{passive:!1})}),["pointerout","pointerup","pointerleave"].forEach(a=>{i.addEventListener(a,u=>t.Joystick.handleButtonEvent(e,!1,u))}),i.addEventListener("pointermove",a=>{a.preventDefault()},{passive:!1}),i.addEventListener("contextmenu",a=>a.preventDefault())},t.Joystick.handleButtonEvent=function(n,e,i){i.key=n,o||(o={}),e?(t.Input.onKeyDown(i),o[n]||(o[n]={},o[n].initialTimeout=setTimeout(function(){o[n].interval=setInterval(function(){t.Input.onKeyDown(i)},150)},150))):(o[n]&&(o[n].initialTimeout&&clearTimeout(o[n].initialTimeout),o[n].interval&&clearInterval(o[n].interval),delete o[n]),t.Input.onKeyUp(i)),i.preventDefault()}})(beep8),(function(t){t.Utilities={},t.Utilities.fatal=function(n){t.Utilities.error("Fatal error: "+n);try{t.Core.handleCrash(n)}catch(e){t.Utilities.error("Error in beep8.Core.handleCrash: "+e+" while handling error "+n)}throw new Error(n)},t.Utilities.assert=function(n,e){return n||t.Utilities.fatal(e||"Assertion Failed"),n},t.Utilities.assertDebug=function(n,e){return n||(t.CONFIG.DEBUG?warn("DEBUG ASSERT failed: "+e):t.Utilities.fatal(e)),n},t.Utilities.assertEquals=function(n,e,i){return n!==e&&t.Utilities.fatal(`${i}: expected ${n} but got ${e}`),e},t.Utilities.checkType=function(n,e,i){return t.Utilities.assert(n,"checkType: varName must be provided."),t.Utilities.assert(i,"checkType: varType must be provided."),t.Utilities.assert(typeof e===i,`${n} should be of type ${i} but was ${typeof e}: ${e}`),e},t.Utilities.checkNumber=function(n,e,i=void 0,a=void 0){return t.Utilities.checkType(n,e,"number"),isNaN(e)&&t.Utilities.fatal(`${n} should be a number but is NaN`),isFinite(e)||t.Utilities.fatal(`${n} should be a number but is infinite: ${e}`),i!==void 0&&t.Utilities.assert(e>=i,`${n} should be >= ${i} but is ${e}`),a!==void 0&&t.Utilities.assert(e<=a,`${n} should be <= ${a} but is ${e}`),e},t.Utilities.checkInt=function(n,e,i,a){return t.Utilities.checkNumber(n,e,i,a),e!==Math.round(e)&&t.Utilities.fatal(`${n} should be an integer but is ${e}`),e},t.Utilities.checkString=function(n,e){return t.Utilities.checkType(n,e,"string")},t.Utilities.checkBoolean=function(n,e){return t.Utilities.checkType(n,e,"boolean")},t.Utilities.checkFunction=function(n,e){return e===null&&t.Utilities.fatal(`${n} should be a function, but was null`),t.Utilities.checkType(n,e,"function")},t.Utilities.checkObject=function(n,e){return e===null&&t.Utilities.fatal(`${n} should be an object, but was null`),t.Utilities.checkType(n,e,"object")},t.Utilities.checkInstanceOf=function(n,e,i){return t.Utilities.assert(e instanceof i,`${n} should be an instance of ${i.name} but was not, it's: ${e}`),e},t.Utilities.checkIsSet=function(n,e){return t.Utilities.assert(e!=null,`${n} should be set but was: ${e}`),e},t.Utilities.checkArray=function(n,e){return t.Utilities.assert(Array.isArray(e),`${n} should be an array, but was: ${e}`),e},t.Utilities.log=function(n){t.CONFIG.DEBUG&&console.log(n)},t.Utilities.warn=function(n){console.warn(n)},t.Utilities.error=function(n){console.error(n)},t.Utilities.loadImageAsync=async function(n){return new Promise(e=>{const i=new Image;i.src=n,i.onload=()=>e(i)})},t.Utilities.makeColorTransparent=async function(n,e=[255,0,255],i=5){const a=document.createElement("canvas"),u=a.getContext("2d");a.width=n.width,a.height=n.height,u.drawImage(n,0,0);const l=u.getImageData(0,0,a.width,a.height),d=l.data;for(let C=0;C<d.length;C+=4){const h=d[C],S=d[C+1],f=d[C+2];Math.abs(h-e[0])<=i&&Math.abs(S-e[1])<=i&&Math.abs(f-e[2])<=i&&(d[C+3]=0)}return u.putImageData(l,0,0),a},t.Utilities.loadFileAsync=function(n){return new Promise((e,i)=>{const a=new XMLHttpRequest;a.addEventListener("load",()=>{a.status<200||a.status>299?i("HTTP request finished with status "+a.status):e(a.responseText)}),a.addEventListener("error",u=>i(u)),a.open("GET",n),a.send()})},t.Utilities.clamp=function(n,e,i){return Math.min(Math.max(n,e),i)},t.Utilities.dist2d=function(n,e,i,a){t.Utilities.checkNumber("x0",n),t.Utilities.checkNumber("y0",e),t.Utilities.checkNumber("x1",i),t.Utilities.checkNumber("y1",a);const u=n-i,l=e-a;return Math.sqrt(u*u+l*l)},t.Utilities.hexToRgb=function(n){n=n.replace("#","");const e=parseInt(n,16);return{r:e>>16&255,g:e>>8&255,b:e&255}},t.Utilities.intersectIntervals=function(n,e,i,a,u=null){t.Utilities.checkNumber("as",n),t.Utilities.checkNumber("ae",e),t.Utilities.checkNumber("bs",i),t.Utilities.checkNumber("be",a),u&&t.Utilities.checkObject("result",u);const l=Math.max(n,i),d=Math.min(e,a);return d>=l?(u&&(u.start=l,u.end=d),!0):!1},t.Utilities.intersectRects=function(n,e,i=0,a=0,u=0,l=0,d=null){t.Utilities.checkObject("r1",n),t.Utilities.checkObject("r2",e),t.Utilities.checkNumber("r1.x",n.x),t.Utilities.checkNumber("r1.y",n.y),t.Utilities.checkNumber("r1.w",n.w),t.Utilities.checkNumber("r1.h",n.h),t.Utilities.checkNumber("r2.x",e.x),t.Utilities.checkNumber("r2.y",e.y),t.Utilities.checkNumber("r2.w",e.w),t.Utilities.checkNumber("r2.h",e.h),t.Utilities.checkNumber("dx1",i),t.Utilities.checkNumber("dx2",u),t.Utilities.checkNumber("dy1",a),t.Utilities.checkNumber("dy2",l),d&&checkObject("result",d);const C=o,h=s;return!t.Utilities.intersectIntervals(n.x+i,n.x+i+n.w-1,e.x+u,e.x+u+e.w-1,C)||!t.Utilities.intersectIntervals(n.y+a,n.y+a+n.h-1,e.y+l,e.y+l+e.h-1,h)?!1:(d&&(d.x=C.start,d.w=C.end-C.start+1,d.y=h.start,d.h=h.end-h.start+1),!0)};const o={},s={};t.Utilities.makeUrlPretty=function(n){t.Utilities.checkString("uglyStr",n);let e=n;return e=e.toLowerCase(),e=e.replace(/[\s/]+/g,"-"),e=e.replace(/[^a-z0-9\-]+/g,""),e=e.replace(/-+/g,"-"),e=e.replace(/^-+|-+$/g,""),e},t.Utilities.deepMerge=function(...n){const e=i=>i&&typeof i=="object";return n.reduce((i,a)=>(Object.keys(a).forEach(u=>{const l=i[u],d=a[u];Array.isArray(l)&&Array.isArray(d)?i[u]=l.concat(...d):e(l)&&e(d)?i[u]=t.Utilities.deepMerge(l,d):i[u]=d}),i),{})},t.Utilities.deepMergeByIndex=function(...n){const e=i=>i&&typeof i=="object";return n.reduce((i,a)=>(Object.keys(a).forEach(u=>{const l=i[u],d=a[u];Array.isArray(l)&&Array.isArray(d)?i[u]=r(l,d):e(l)&&e(d)?i[u]=t.Utilities.deepMergeByIndex(l,d):i[u]=d}),i),{})},t.Utilities.padWithZeros=function(n,e){return t.Utilities.checkNumber("number",n),t.Utilities.checkInt("length",e),n<0&&t.Utilities.fatal("padWithZeros does not support negative numbers"),n.toString().padStart(e,"0")},t.Utilities.event=function(n,e={},i=document){t.Utilities.checkString("eventName",n),t.Utilities.checkObject("detail",e),t.Utilities.checkObject("target",i),n=`beep8.${n}`;const a=new CustomEvent(n,{detail:e});i.dispatchEvent(a)},t.Utilities.repeatArray=function(n,e){return t.Utilities.checkArray("array",n),t.Utilities.checkInt("times",e,0),Array(e).fill().flatMap(()=>n)},t.Utilities.downloadFile=function(n="",e=""){t.Utilities.checkString("filename",n),t.Utilities.checkString("src",e);const i=document.createElement("a");i.setAttribute("href",e),i.setAttribute("download",n),document.body.appendChild(i),i.click(),document.body.removeChild(i)},t.Utilities.encodeData=function(n){const e=CBOR.encode(n);return btoa(String.fromCharCode.apply(null,new Uint8Array(e)))},t.Utilities.decodeData=function(n){const e=atob(n),i=new Uint8Array(e.length);for(let u=0;u<e.length;u++)i[u]=e.charCodeAt(u);const a=i.buffer;return CBOR.decode(a)};function r(n,e){for(let i=0;i<e.length;i++)n[i]=e[i];return n}})(beep8),(function(t){t.Tilemap={},t.Tilemap.MAP_CHAR=0,t.Tilemap.MAP_FG=1,t.Tilemap.MAP_BG=2,t.Tilemap.MAP_COLLISION=3,t.Tilemap.MAP_DATA=4;const o={solid:{0:1,1:1,2:1,3:36,4:1,5:1,6:18,7:1,8:1,9:37,10:1,11:1,12:19,13:1,14:1,15:1},rounded:{0:1,1:42,2:23,3:36,4:41,5:1,6:18,7:1,8:24,9:37,10:1,11:1,12:19,13:1,14:1,15:1},half:{0:128,1:75,2:58,3:93,4:75,5:75,6:57,7:129,8:58,9:95,10:58,11:111,12:59,13:130,14:112,15:113},half_rounded:{0:128,1:148,2:166,3:93,4:149,5:75,6:57,7:129,8:167,9:95,10:58,11:111,12:59,13:130,14:112,15:113},pipe:{0:128,1:148,2:166,3:93,4:149,5:[75,77],6:57,7:129,8:167,9:95,10:[58,94],11:111,12:59,13:130,14:112,15:[113,131,76]},thin:{0:110,1:173,2:172,3:164,4:154,5:72,6:146,7:126,8:155,9:165,10:55,11:108,12:147,13:127,14:109,15:73}};t.Tilemap.save=function(r){return t.Utilities.checkArray("tilemap",r),t.Utilities.encodeData(r)},t.Tilemap.load=function(r){return t.Utilities.checkString("data",r),t.Utilities.decodeData(r)},t.Tilemap.draw=function(r,n=0,e=0,i=null,a=null){t.Utilities.checkArray("tilemap",r),i||(i=r[0].length),a||(a=r.length),t.Utilities.checkInt("width",i),t.Utilities.checkInt("height",a);const u=t.Core.drawState.cursorRow,l=t.Core.drawState.cursorCol;for(let d=e;d<e+a;d++){const C=0+l,h=d-e+u;t.locate(C,h);for(let S=n;S<n+i;S++){if(!r[d]||r[d][S]==null)continue;const f=r[d][S];f&&f.length>=3&&(t.color(f[t.Tilemap.MAP_FG],f[t.Tilemap.MAP_BG]),t.printChar(f[t.Tilemap.MAP_CHAR]))}}},t.Tilemap.createEmptyTilemap=function(r,n){let e=[];for(let i=0;i<n;i++){e[i]=[];for(let a=0;a<r;a++)e[i][a]=t.Tilemap.getDefaultTile()}return e},t.Tilemap.shift=function(r,n,e){t.Utilities.checkArray("tilemap",r),t.Utilities.checkNumber("dx",n),t.Utilities.checkNumber("dy",e);const i=r[0].length,a=r.length,u=t.Tilemap.createEmptyTilemap(i,a);for(let l=0;l<a;l++)for(let d=0;d<i;d++){const C=(d+n+i)%i,h=(l+e+a)%a;u[h][C]=[...r[l][d]]}return u},t.Tilemap.resize=function(r,n,e){t.Utilities.checkArray("tilemap",r),t.Utilities.checkNumber("width",n),t.Utilities.checkNumber("height",e);const i=t.Tilemap.createEmptyTilemap(n,e);for(let a=0;a<e;a++)for(let u=0;u<n;u++)r[a]&&r[a][u]&&(i[a][u]=[...r[a][u]]);return i},t.Tilemap.getDefaultTile=function(){return[0,15,0,0,{}]},t.Tilemap.convertFromText=function(r){t.Utilities.checkString("text",r);const e=r.split(`
`).filter(a=>a.trim()!=="");return e.length===0&&t.Utilities.fatal("No valid lines found in the map text."),e.map(a=>a.split(""))},t.Tilemap.validateTilemap=function(r){t.Utilities.checkString("text",r);const n=t.Tilemap.load(r);return!(!Array.isArray(n)||!Array.isArray(n[0])||!Array.isArray(n[0][0])||n[0][0].length<=3)},t.Tilemap.createFromArray=function(r,n,e=null){t.Utilities.checkArray("grid",r),t.Utilities.checkObject("tilePattern",n),e!==null&&t.Utilities.checkObject("defaultTilePattern",e),e===null&&(e=t.Tilemap.getDefaultTile());const i=[];for(let a=0;a<r.length;a++){i[a]=[];for(let u=0;u<r[a].length;u++){if(i[a][u]=[...e],!n[r[a][u]])continue;const l=n[r[a][u]];let d=l.t;typeof d=="string"&&d.startsWith("wall_")&&(d=t.Tilemap.wallTile(u,a,r,d)),Array.isArray(d)&&(d=t.Random.pickWeighted(d));let C=l.fg||15;Array.isArray(C)&&(C=t.Random.pickWeighted(C));let h=l.bg||0;Array.isArray(h)&&(h=t.Random.pickWeighted(h)),i[a][u]=[d,C,h,l.coll||0,l.data||{}]}}return i},t.Tilemap.wallTile=function(r,n,e,i=null){t.Utilities.checkNumber("col",r),t.Utilities.checkNumber("row",n),t.Utilities.checkArray("grid",e),t.Utilities.checkString("name",i),i===null&&t.Utilities.fatal("Wall tile name not given: "+i);const a=i.substring(5);o[a]||t.Utilities.fatal("Wall tile type not found: "+a);const u=s(e,r,n);return o[a][u]};function s(r,n,e){let i=0;const a=r[e][n];return e>0&&r[e-1][n]===a&&(i+=1),n<r[e].length-1&&r[e][n+1]===a&&(i+=2),e<r.length-1&&r[e+1][n]===a&&(i+=4),n>0&&r[e][n-1]===a&&(i+=8),i}})(beep8),(function(t){t.TextRenderer={};const o=[];t.TextRenderer.fonts_={},t.TextRenderer.curFont_=null,t.TextRenderer.curTiles_=null,t.TextRenderer.prepareCharMap=function(){let i=[...t.CONFIG.CHRS];for(let a=0;a<i.length;a++)o.push(i[a].charCodeAt(0))},t.TextRenderer.initAsync=async function(){t.Utilities.log("beep8.TextRenderer init."),t.TextRenderer.curFont_=await t.TextRenderer.loadFontAsync("default-thin",t.CONFIG.FONT_DEFAULT,.5,1),t.TextRenderer.curTiles_=await t.TextRenderer.loadFontAsync("tiles",t.CONFIG.FONT_TILES),t.TextRenderer.curActors_=await t.TextRenderer.loadFontAsync("actors",t.CONFIG.FONT_ACTORS),t.TextRenderer.prepareCharMap()},t.TextRenderer.loadFontAsync=async function(i,a,u=1,l=1){t.Utilities.checkString("fontName",i),t.Utilities.checkString("fontImageFile",a);const d=new t.TextRendererFont(i,a,u,l);return await d.initAsync(),t.TextRenderer.fonts_[i]=d,d},t.TextRenderer.setFont=function(i){const a=t.TextRenderer.getFontByName(i);a&&(t.TextRenderer.curFont_=a)},t.TextRenderer.getFont=function(){return t.TextRenderer.curFont_},t.TextRenderer.setTileFont=function(i){const a=t.TextRenderer.getFontByName(i);a&&(t.TextRenderer.curTiles_=a)},t.TextRenderer.getFontByName=function(i){t.Utilities.checkString("fontName",i);const a=t.TextRenderer.fonts_[i];if(!a){t.Utilities.fatal(`setFont(): font not found: ${i}`);return}return a},t.TextRenderer.print=function(i,a=null,u=-1){t.TextRenderer.printFont_=a||t.TextRenderer.curFont_,t.Utilities.checkString("text",i),t.Utilities.checkNumber("maxWidth",u),a!==null&&t.Utilities.checkObject("font",a),i=t.TextRenderer.wrapText(i,u,a);let l=t.Core.drawState.cursorCol,d=t.Core.drawState.cursorRow;t.TextRenderer.origFgColor_=t.Core.drawState.fgColor,t.TextRenderer.origBgColor_=t.Core.drawState.bgColor,t.TextRenderer.origFont_=t.TextRenderer.printFont_;const C=t.TextRenderer.printFont_.getCharColCount(),h=t.TextRenderer.printFont_.getCharRowCount(),S=l;for(let f=0;f<i.length;f++){f=n(i,f);const g=i.charCodeAt(f);if(g===10)l=S,d+=h;else{const E=o.indexOf(g);E>=0&&(s(E,l,d,t.Core.drawState.fgColor,t.Core.drawState.bgColor,t.TextRenderer.printFont_),l+=C)}}t.Core.drawState.cursorCol=l,t.Core.drawState.cursorRow=d,t.Core.drawState.fgColor=t.TextRenderer.origFgColor_,t.Core.drawState.bgColor=t.TextRenderer.origBgColor_,t.Renderer.markDirty()},t.TextRenderer.printTypewriter=async function(i,a=-1,u=.05,l=null){t.Utilities.checkString("text",i),t.Utilities.checkNumber("maxWidth",a),t.Utilities.checkNumber("delay",u);const d=t.col(),C=t.row();i=t.TextRenderer.wrapText(i,a);for(let h=0;h<=i.length;h++){if(t.CONFIG.PRINT_ESCAPE_START&&i.substring(h,h+t.CONFIG.PRINT_ESCAPE_START.length)===t.CONFIG.PRINT_ESCAPE_START){const f=i.indexOf(t.CONFIG.PRINT_ESCAPE_END,h+t.CONFIG.PRINT_ESCAPE_START.length);f>=0&&(h=f+t.CONFIG.PRINT_ESCAPE_END.length)}const S=i.charCodeAt(h);t.Core.setCursorLocation(d,C),t.TextRenderer.print(i.substring(0,h),l),S!==32&&await t.Async.wait(u)}},t.TextRenderer.printCentered=function(i,a,u=null){if(t.TextRenderer.printFont_=u||t.TextRenderer.curFont_,t.Utilities.checkString("text",i),t.Utilities.checkNumber("width",a),!i)return;const l=t.Core.drawState.cursorCol,d=t.TextRenderer.printFont_.getCharRowCount();i=i.split(`
`),i[i.length-1]===""&&i.pop();for(let C=0;C<i.length;C++){const h=t.TextRenderer.measure(i[C]).cols,S=l+(a-h)/2;t.Core.drawState.cursorCol=S,t.TextRenderer.print(i[C],u,a),t.Core.drawState.cursorRow+=d}t.Core.drawState.cursorCol=l},t.TextRenderer.printRight=function(i,a,u=null){if(t.TextRenderer.printFont_=u||t.TextRenderer.curFont_,t.Utilities.checkString("text",i),t.Utilities.checkNumber("width",a),!i)return;const l=t.Core.drawState.cursorCol,d=t.TextRenderer.printFont_.getCharRowCount();i=t.TextRenderer.wrapText(i,a),i=i.split(`
`),i[i.length-1]===""&&i.pop();for(let C=0;C<i.length;C++){let h=t.TextRenderer.measure(i[C]).cols;const S=l+a-h;t.Core.drawState.cursorCol=S,t.TextRenderer.print(i[C],u,a),t.Core.drawState.cursorRow+=d}t.Core.drawState.cursorCol=l},t.TextRenderer.printChar=function(i,a,u=null){if((a===void 0||isNaN(a))&&(a=1),t.Utilities.checkNumber("ch",i),t.Utilities.checkNumber("n",a),!(t.Core.drawState.cursorCol<0||t.Core.drawState.cursorRow<0||t.Core.drawState.cursorCol>=t.CONFIG.SCREEN_COLS||t.Core.drawState.cursorRow>=t.CONFIG.SCREEN_ROWS)){for(;a-- >0;)s(i,t.Core.drawState.cursorCol,t.Core.drawState.cursorRow,t.Core.drawState.fgColor,t.Core.drawState.bgColor,u),t.Core.drawState.cursorCol++;t.Renderer.markDirty()}},t.TextRenderer.spr=function(i,a,u,l=null,d=0){t.Utilities.checkNumber("ch",i),t.Utilities.checkNumber("x",a),t.Utilities.checkNumber("y",u),t.Utilities.checkInt("direction",d),l!==null&&t.Utilities.checkObject("font",l),r(i,a,u,t.Core.drawState.fgColor,t.Core.drawState.bgColor,l,d)},t.TextRenderer.drawText=function(i,a,u,l){t.Utilities.checkNumber("x",i),t.Utilities.checkNumber("y",a),t.Utilities.checkString("text",u),l&&t.Utilities.checkString("fontName",l);const d=i,C=l&&t.TextRenderer.fonts_[l]||t.TextRenderer.curFont_;if(!C){t.Utilities.warn(`Requested font '${l}' not found: not drawing text.`);return}for(let h=0;h<u.length;h++){const S=u.charCodeAt(h);S===10?(i=d,a+=C.getCharHeight()):(r(S,i,a,t.Core.drawState.fgColor,t.Core.drawState.bgColor,C),i+=C.getCharWidth())}},t.TextRenderer.measure=function(i,a=null){if(t.Utilities.checkString("text",i),a=a||t.TextRenderer.curFont_,i==="")return{cols:0,rows:0};let u=1,l=0,d=0;for(let C=0;C<i.length;C++)C=n(i,C,!0),i.charCodeAt(C)===10?(u++,l=0):(++l,d=Math.max(d,l));return d=d*a.getCharColCount(),u=u*a.getCharRowCount(),{cols:d,rows:u}},t.TextRenderer.printRect=function(i,a,u){t.Utilities.checkNumber("width",i),t.Utilities.checkNumber("height",a),t.Utilities.checkNumber("ch",u);const l=t.Core.drawState.cursorCol,d=t.Core.drawState.cursorRow;for(let C=0;C<a;C++)t.Core.drawState.cursorCol=l,t.Core.drawState.cursorRow=d+C,t.TextRenderer.printChar(u,i);t.Core.drawState.cursorCol=l,t.Core.drawState.cursorRow=d},t.TextRenderer.printBox=function(i,a,u=!0,l=t.CONFIG.BORDER_CHAR){t.Utilities.checkNumber("width",i),t.Utilities.checkNumber("height",a),t.Utilities.checkBoolean("fill",u),t.Utilities.checkNumber("borderChar",l);const d=t.TextRenderer.curTiles_.getColCount(),C={NW:l,NE:l+2,SW:l+d+d,SE:l+d+d+2,V:l+d,H:l+1};t.TextRenderer.drawBox(i,a,u,C)},t.TextRenderer.drawBox=function(i,a,u=!0,l={}){const d=t.Core.drawState.cursorCol,C=t.Core.drawState.cursorRow;for(let h=0;h<a;h++)t.Core.drawState.cursorCol=d,t.Core.drawState.cursorRow=C+h,h===0?(t.TextRenderer.printChar(l.NW),t.TextRenderer.printChar(l.H,i-2),t.TextRenderer.printChar(l.NE)):h===a-1?(t.TextRenderer.printChar(l.SW),t.TextRenderer.printChar(l.H,i-2),t.TextRenderer.printChar(l.SE)):(t.TextRenderer.printChar(l.V),t.Core.drawState.cursorCol=d+i-1,t.TextRenderer.printChar(l.V));u&&i>2&&a>2&&(t.Core.drawState.cursorCol=d+1,t.Core.drawState.cursorRow=C+1,t.TextRenderer.printRect(i-2,a-2,0)),t.Core.drawState.cursorCol=d,t.Core.drawState.cursorRow=C},t.TextRenderer.wrapText=function(i,a,u=null){if(u=u||t.TextRenderer.curFont_,a<=0)return i;const l=i.split(`
`),d=[];for(const C of l){const h=C.split(" ");let S="";for(const f of h)t.TextRenderer.measure((S+f).trim()).cols>a&&(d.push(S.trim()),S=""),S+=f+" ";d.push(S.trim())}return d.join(`
`)};const s=function(i,a,u,l,d,C=null,h=0){const S=Math.round(a*t.CONFIG.CHR_WIDTH),f=Math.round(u*t.CONFIG.CHR_HEIGHT);r(i,S,f,l,d,C,h)},r=function(i,a,u,l,d,C=null,h=0){C=C||t.TextRenderer.curTiles_;const S=C.getColCount(),f=C.getCharWidth(),g=C.getCharHeight(),E=Math.floor(i/S),x=i%S;if(a=Math.round(a),u=Math.round(u),d>=0&&(t.Core.ctx.fillStyle=t.Core.getColorHex(d),t.Core.ctx.fillRect(a,u,f,g)),t.CONFIG.SCREEN_COLORS===1&&d===l)return;if(h>0){t.Core.ctx.save();const N=(h&1)!==0,I=(h&2)!==0,R=N?f:0,y=I?g:0;t.Core.ctx.translate(a+R,u+y);const T=N?-1:1,D=I?-1:1;t.Core.ctx.scale(T,D),a=0,u=0}const B=t.Utilities.clamp(l,0,t.CONFIG.COLORS.length-1),v=C.getImageForColor(B);t.Core.ctx.drawImage(v,x*f,E*g,f,g,a,u,f,g),h>0&&t.Core.ctx.restore(),t.Renderer.markDirty()},n=function(i,a,u=!1){const l=t.CONFIG.PRINT_ESCAPE_START,d=t.CONFIG.PRINT_ESCAPE_END;if(!l||!d||i.substring(a,a+l.length)!=l)return a;const C=i.indexOf(d,a+l.length);if(!u){const h=i.substring(a+l.length,C);e(h)}return C+d.length},e=function(i){if(i.indexOf(",")>0){const d=i.split(",");for(const C of d)e(C);return}if(i=i.trim(),i==="")return;const a=i[0].toLowerCase(),u=i.substring(1),l=1*u;switch(a){case"f":case"c":t.Core.drawState.fgColor=u!==""?l:t.TextRenderer.origFgColor_;break;case"b":t.Core.drawState.bgColor=u!==""?l:t.TextRenderer.origBgColor_;break;case"t":t.TextRenderer.printFont_=t.TextRenderer.getFontByName(u);break;case"z":t.Core.drawState.fgColor=t.TextRenderer.origFgColor_,t.Core.drawState.bgColor=t.TextRenderer.origBgColor_,t.TextRenderer.printFont_=t.TextRenderer.origFont_||t.TextRenderer.fonts_.default;break;default:t.Utilities.warn("Unknown beep8 print escape command: "+i)}};t.TextRenderer.regenColors=function(){Object.values(t.TextRenderer.fonts_).forEach(i=>i.regenColors())}})(beep8),(function(t){t.Textmode={},t.Textmode.load=async function(o){return t.Tilemap.load(o)},t.Textmode.draw=async function(o,s=0,r=0,n=null,e=null){return t.Tilemap.draw(o,s,r,n,e)}})(beep8),(function(t){t.TextRendererFont=class{constructor(o,s,r=1,n=1){t.Utilities.checkString("fontName",o),t.Utilities.checkString("fontImageFile",s),this.fontName_=o,this.fontImageFile_=s,this.origImg_=null,this.chrImages_=[],this.imageWidth_=0,this.imageHeight_=0,this.colCount_=0,this.rowCount_=0,this.charWidth_=0,this.charHeight_=0,this.charColCount_=0,this.charRowCount_=0,this.tileWidthMultiplier_=r,this.tileHeightMultiplier_=n}async initAsync(){this.origImg_=await t.Utilities.loadImageAsync(this.fontImageFile_);const o=t.CONFIG.CHR_WIDTH*this.tileWidthMultiplier_,s=t.CONFIG.CHR_HEIGHT*this.tileHeightMultiplier_;t.Utilities.assert(this.origImg_.width%o===0&&this.origImg_.height%s===0,`Font ${this.fontName_}: image ${this.fontImageFile_} has dimensions ${this.origImg_.width}x${this.origImg_.height}.`),this.origImg_=await t.Utilities.makeColorTransparent(this.origImg_),this.charWidth_=o,this.charHeight_=s,this.imageWidth_=this.origImg_.width,this.imageHeight_=this.origImg_.height,this.colCount_=this.imageWidth_/this.charWidth_,this.rowCount_=this.imageHeight_/this.charHeight_,this.charColCount_=this.tileWidthMultiplier_,this.charRowCount_=this.tileHeightMultiplier_,await this.regenColors()}getCharWidth(){return this.charWidth_}getCharHeight(){return this.charHeight_}getCharColCount(){return this.charColCount_}getCharRowCount(){return this.charRowCount_}getRowCount(){return this.rowCount_}getColCount(){return this.colCount_}getImageForColor(o){return this.chrImages_[o]}async regenColors(){this.chrImages_=[];for(let o=0;o<t.CONFIG.COLORS.length;o++){const s=document.createElement("canvas");s.width=this.origImg_.width,s.height=this.origImg_.height;const r=s.getContext("2d");r.clearRect(0,0,this.origImg_.width,this.origImg_.height),r.globalCompositeOperation="source-over",r.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height),r.globalCompositeOperation="source-in",r.fillStyle=t.CONFIG.COLORS[o],r.fillRect(0,0,this.origImg_.width,this.origImg_.height),t.CONFIG.SCREEN_COLORS===2&&(r.globalCompositeOperation="multiply",r.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height)),this.chrImages_.push(s)}}}})(beep8),(function(t){t.State=t.State||{};let o="";document.addEventListener("beep8.initComplete",function(){o=`beep8.${t.Utilities.makeUrlPretty(t.CONFIG.NAME)}.state`},{once:!0});function s(r){return new Proxy(r,{get(n,e){const i=n[e];return typeof i=="object"&&i!==null?s(i):i},set(n,e,i){return n[e]=i,t.Utilities.event("stateChange",{prop:e,value:i}),!0}})}t.State.save=function(r=o){const n=t.Utilities.encodeData({time:Date.now(),data:t.data});localStorage.setItem(r,n),t.State.lastSave=Date.now()},t.State.load=function(r=o){const n=localStorage.getItem(r);if(!n){t.Utilities.log("No state found for the given key.");return}const e=t.Utilities.decodeData(n);e.data&&(t.data=s(e.data)),e.time&&(t.State.lastSave=e.time)},t.State.init=function(r){t.data||(t.data=s({})),localStorage.getItem(o)&&t.State.load(),t.data=t.Utilities.deepMergeByIndex(r,t.data),t.Utilities.log("State initialized:",t.data)},t.State.clear=function(r=o){t.Utilities.log("Clearing state..."),localStorage.removeItem(r),t.data=s({})},t.data=s({})})(beep8),(function(t){t.Sfx={},t.Sfx.library={"fx/action/drag":[,0,293.6648,.1,,,4,6,32,,,,,1,1.4,.1,,.7,.1],"fx/break/001":[2.1,,339,.02,.07,.09,4,.2,-7,,,,.05,1,,.1,.16,.45,.02,.03],"fx/break/002":[1.5,,157,.16,,0,,.35,-24,28,,,,.1,,.6,,.19,.01],"fx/break/003":[2,,180,.05,.03,.04,,2.42,.6,,,,,,,,.15,.39,.04],"fx/fight/dodge":[1.2,.3,150,.05,,.05,,,-1,,,,,4,,,,,.02],"fx/fight/hit":[5,,185,,,,3,1.6,-7,,,,,,,.2,.19,.1,,.38,985],"fx/robot/001":[1.13,,172,.04,.18,.09,,.06,-38,-2.6,-99,,,,35,,.08],"fx/robot/002":[1.42,,61,.01,.02,0,1,.21,,,816,.01,.05,,-40,,.05,.71,.11],"fx/robot/003":[.9,,164,.04,.03,.14,,.8,46,66,,,,,,,,.71,.08,,217],"fx/robot/004":[,.02,1638,,.05,.17,1,,,,490,.09,,,,.1,.05,.5,.03],"fx/sci-fi/radioactive":[1,0,130,.02,.9,.39,2,.8,,,,,.13,.2,,.1,,.93,.06,.28],"fx/sci-fi/robot":[1,0,847,.02,.3,.9,1,1.67,,,-294,.04,.13,,,,.1],"fx/sci-fi/teleport":[1,,85,.08,.1,.01,1,4,,-11,1,.07,,.1,101,,.05,.68,.4,.12,1],"fx/sci-fi/warp":[3,0,713,.16,.09,.24,,.6,-29,-16,,,.09,.5,,,.23,.75,.15,.48],"fx/sci-fi/beam":[1,0,662,.82,.11,.33,1,0,,-.2,,,,1.2,,.26,.01],"fx/sci-fi/hover":[2,0,262.63,.1,.12,.3,0,2.4,-.1,0,0,0,.24,0,0,.1,.05,.98,.07,.17,0],"fx/thud/001":[1.5,,90,,.01,.03,4,,,,,,,9,50,.2,,.2,.01],"fx/thud/002":[1,,129,.01,,.15,,,,,,,,5],"fx/machine/buzz":[1,0,130.8128,.1,.1,.34,3,1.88,,,,,,,,.1,,.5,.04],"fx/machine/hum":[1,0,63,,1,,1,1.5,,,,,,,,3.69,.08],"fx/machine/humm":[1,,110,.03,.25,.15,2,1.32,,,,,.07,,-.1,,.11,.77],"fx/machine/warp":[2,,128,,.12,.26,,4.7,,-1,-62,.06,.07,,52,,,.66,.08],"fx/noise/001":[1.27,,390,.01,.04,.02,4,.71,4.8,,,,,,,,.01,.6,.06],"fx/noise/002":[.4,,60,,.01,0,4,.55,62,89,-88,.06,,,173,.6,,,.05],"fx/noise/003":[.2,,523.2511,.1,3,3,4,0,,,2250,,.04,,10,.01,,.82,1,,30],"fx/random/tone":[2,.8,999,,,,1,2,,,,,1,,,.1,.2],"fx/swoosh/001":[1,,1500,.02,,.02,4,.68,5,,,,.01,.7,136,,,,,.11],"fx/swoosh/002":[1.2,,585,,.02,.16,4,.25,,,,,,,,,,.55,.03],"fx/swoosh/003":[.2,,836,.11,,0,4,.91,13,,,,.09,.1,-39,,,.06,.07],"fx/swoosh/004":[1.2,,9220,.01,,,,5,,,,,,9],"fx/swoosh/005":[1.5,0,150,.05,,.05,,1.3,,,,,,3],"fx/swoosh/006":[2,,12,,,.008,,1.2,23,-7,,,.05,.4,,,.15,.82,.03,.28],"fx/vehicle/engine":[1.2,0,25,.05,.3,.5,3,9,-.01,,,,,,13,.1,.2],"fx/vehicle/carhorn":[1.8,0,250,.02,.02,.2,2,2,,,,,.02,,,.02,.01,,,.1],"fx/vehicle/horn":[2,,688,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.03,.11,-818],"fx/vehicle/truckhorn":[1.5,,1376,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.8,.11,-818],"fx/vehicle/siren":[1.3,0,960,,1,.01,,.8,-.01,,-190,.5,,.05,,,1],"fx/vehicle/submarine":[1.2,0,1975,.08,.56,.02,,,-.4,,-322,.56,.41,,,,.25],"fx/vehicle/rocket":[1.5,0,941,.8,,.8,4,.74,-222,,,,,.8,,1],"game/coin/001":[1.2,0,1675,,.06,.24,1,1.82,,,837,.06],"game/coin/002":[1.2,0,523.2511,.01,.06,.3,1,1.82,,,837,.06],"game/coin/003":[.6,0,1874,,.01,.25,2,.76,,,622,.1],"game/coin/004":[1,0,277,.03,.04,.06,1,1.8,1,,140,.06,.04,,,.1,,.99,.03],"game/collect/001":[1.1,0,450,,.01,.13,,2.7,,-9.5,500,.08,,,,,,.89],"game/collect/002":[1.05,,10,.08,.07,.24,2,1.03,,,-374,.04,.09,,,,,.72,.15,.18],"game/die/001":[1.5,0,537,.02,.02,.22,1,1.59,-6.98,4.97],"game/die/002":[1,,321,.01,.06,.06,1,3.8,,-49,,,,.3,,,,.79,.09],"game/die/003":[1,0,344,.01,.02,.28,1,1.4,,,50,,,,.3,.2,.15,.6,.06],"game/die/004":[.5,0,43,.01,,1,2,,,,,,,,,.02,.01],"game/jump/001":[1,.1,75,.03,.08,.17,1,1.88,7.83,,,,,.4],"game/jump/002":[1.2,,311,.03,.05,.05,,2.2,,9,,,.02,,2.7,,,.97,.05,,101],"game/jump/003":[1.5,,65,.04,.1,.13,1,1.5,,-31,,,,.3,,,,.99,.03],"game/jump/004":[,0,500,,.01,.13,,.2,1.7,,-400],"game/jump/005":[1,,341,,.14,.23,1,1.01,.9,,-132,.03,,.1,,.1,,.52,.22],"game/jump/006":[.7,,1496,.09,.09,.01,3,.14,,,-870,,,,3.2,.2,,.31,.02],"game/powerup/001":[,,188,.03,.09,.12,1,2.4,,95,,,,,,,,.63,.08],"game/powerup/002":[.8,0,413,.03,.05,.05,,1.8,,19,177,.05,,,,,,.83,.02],"game/powerup/003":[.5,,643,,.1,.12,1,.1,,99,,,,,,,,.6,.02,,-732],"game/powerup/004":[1.18,,143,.05,.08,.06,,.09,25,4.1,,,,,,,.01,.52,.09],"game/powerup/005":[1,,18,.01,.01,.21,1,.49,9.9,,,,,,,,.04,.95,.02],"game/powerup/006":[.5,,426,.01,,.05,,2.54,49,,9,.1,,,,,,.46,.15],"game/powerup/007":[1,,158,.09,.18,.03,,2.53,11,-58,63,.02,.01,.5,,,,.16],"game/powerup/008":[1.2,0,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04],"instrument/bass/001":[2,0,65,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/002":[2,0,73,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/003":[2,0,82,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/004":[2,0,87,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/005":[2,0,97,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/006":[2,0,110,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/007":[2,0,123,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/008":[2,0,130,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/drum/001":[1.5,0,86,,,,,.7,,,,.5,,6.7,1,.05],"instrument/drum/002":[.7,0,270,,,.12,3,1.65,-2,,,,,4.5,,.02],"tone/beep/001":[2,0,130,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/002":[2,0,146,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/003":[2,0,164,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/004":[2,0,174,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/005":[2,0,195,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/006":[2,0,220,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/007":[2,0,246,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/008":[2,0,261,,.1,,1,1.5,,,,,,,,.1,.01],"tone/bell/001":[2,0,999,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22],"tone/bell/002":[,0,1600,.13,.52,.61,1,1.1,,,,,,.1,,.14],"tone/bell/random":[2,.1,999,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22],"tone/blip/001":[5,0,130,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/002":[3,0,146,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/003":[3,0,164,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/004":[3,0,174,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/005":[3,0,195,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/006":[3,0,220,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/007":[3,0,246,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/008":[3,0,261,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/bloop/001":[1,,110,.02,,.09,1,.61,,,556,.12,,,,.3,,,.02],"tone/bloop/002":[1,0,521.25,,.02,.03,2,0,,.1,700,.01,,,1,.1],"tone/bloop/003":[1.12,,73,,.02,.11,2,1.18,,-.1,,,,,,.3,,.55,.05,.23],"tone/bloop/004":[.5,,1368,.09,,0,,1.11,-76,9.1,-490,,,,,,,.56],"tone/bloop/005":[2.03,,413,,,.24,2,.12,,,,,.11,,317,.1,.13,,,.01],"tone/bloop/006":[,0,,.01,.02,.09,,.6,17,-3,,,.1,,,,,.76,.08],"tone/bloop/007":[.3,,10,.06,,0,2,2.3,,,621,,,,,,,,.21,.26],"tone/bloop/008":[1.5,.05,24,.01,.02,.01,1,3.9,-33,0,0,0,0,0,355,0,0,.65,0,0,0],"tone/bloop/009":[2,.05,226,0,.08,.13,0,3.1,0,0,0,0,0,0,0,.1,.02,.76,.04,0,105],"tone/bloop/010":[4,0,224,.02,.02,.08,1,1.7,-13.9,,,,,,6.7],"tone/bloop/011":[1,,283,.02,,.11,,.38,,,,,.07,,,.1,.08,.63,.02],"tone/bloop/012":[1,0,288,.05,.01,,,2,-10,,,,,,,,,.5,.1],"tone/bloop/013":[2,0,700,.01,,0,,,,,,,,,,,,.1,.01],"tone/bloop/014":[2.21,,107,.02,.04,.07,,2.22,2,.9,,,,.4,,.5,.15,.42,.04],"tone/bloop/015":[.6,0,2200,,,.04,3,2,,,800,.02,,4.8,,.01,.1],"tone/jingle/001":[1.4,,183,.07,.13,.34,,3.3,,,35,.06,.07,,,,.13,.95,.27,.11],"tone/jingle/002":[.8,,208,.02,.21,.13,3,.2,,,40,.06,.1,,,,,.91,.2,.27],"tone/jingle/003":[.9,,56,.15,.46,.08,,1.6,-2,,-137,.01,.06,,,,.09,.77,.37,.13],"tone/jingle/004":[.6,,269,.03,.17,.41,,.2,,1,239,.08,.04,,,,,.72,.19,.43,-720],"tone/jingle/005":[1.3,0,130.81,.32,.35,.5,3,5.2,0,1,50,0,.14,0,0,0,0,.37,.04,.24,0],"tone/jingle/006":[1,,525,.18,.28,.17,1,1.24,8.3,-9.7,-151,.03,.06,,,,,.93,.02,.14],"tone/jingle/007":[.6,,934,.12,.38,.93,1,.27,,.4,-434,.08,.2,.1,,.1,.17,.55,1,.46],"tone/jingle/008":[1.4,0,20,.04,,.6,,1.31,,,-990,.06,.17,,,.04,.07],"tone/jingle/009":[1.2,0,80,.3,.4,.7,2,.1,-.73,3.42,-430,.09,.17,,,,.19],"tone/jingle/010":[.5,,392,.06,.22,.5,1,1.85,-.1,-.9,61,.05,.07,,,.1,,.96,.12],"tone/jingle/011":[.5,,146,.04,.23,.46,,.56,,-3.7,658,.02,.15,.1,,,,.82,.13,.2],"tone/jingle/012":[1,,284,.08,.2,.25,1,3,,,50,.09,.06,,,,,.6,.28,.03,-1391],"tone/jingle/013":[1.5,,430,.02,.12,.5,,.89,,-3.6,-133,.07,.13,,,.1,,.83,.23,.26],"tone/jingle/014":[.4,,22,.08,.22,.02,1,.52,-4.2,-9.8,,,.14,,-18,.2,,,.05],"tone/jingle/015":[,,193,.04,.27,.42,1,1.71,2.8,4.9,,,.1,.2,,.1,,.55,.27,.47],"tone/jingle/016":[1.1,,250,.07,.24,.26,,2,,164,211,.07,.08,,,.1,,.75,.12,.09,115],"tone/jingle/017":[,,103,.04,.11,.43,1,.77,,,57,.19,.05,,,.1,,.68,.24],"ui/click/001":[1.5,0,900,,.01,0,1,,-10,,-31,.02,,,,,,1.2,,.16,-1448],"ui/click/002":[2.5,,783,,.03,.02,1,2,,,940,.03,,,,,.2,.6,,.06],"ui/click/003":[1.5,.01,300,,,.02,3,.22,,,-9,.2,,,,,,.5],"ui/click/004":[1,0,685,.01,.03,.17,1,1.4,,,,,,,,,,.63,.01,,420],"ui/click/005":[6,,205,,.02,0,,1.03,,,,,,,,,.12,.32],"weapon/explode/001":[1.5,0,333,.01,0,.9,4,1.9,,,,,,.5,,.6],"weapon/explode/002":[1.1,0,418,0,.02,.2,4,1.15,-8.5,,,,,.7,,.1],"weapon/explode/003":[1.2,0,82,.02,,.2,4,4,,,,,,.8,,.2,,.8,.09],"weapon/explode/004":[2,.2,72,.01,.01,.2,4,,,,,,,1,,.5,.1,.5,.02],"weapon/explode/005":[2,,1e3,.02,,.2,1,3,.1,,,,,1,-30,.5,,.5],"weapon/explode/006":[1,,485,.02,.2,.2,4,.11,-3,.1,,,.05,1.1,,.4,,.57,.5],"weapon/explode/007":[.8,,372,.02,.02,.5,4,2.29,.2,,,,,.6,,.6,,.7,.04,.19],"weapon/explode/008":[1.05,,591,.03,.13,.51,4,3.02,.6,.1,,,.04,1.6,,1,,.46,.13],"weapon/explode/009":[1.99,,770,.03,.19,.35,,.26,,,,,,2,-50,.1,.27,.48,.06],"weapon/explode/010":[1.5,,98,.08,.18,.02,2,2.47,36,.5,,,.04,.1,,.9,.44,,.04],"weapon/explode/011":[1,,400,,.03,.21,3,.85,.5,,,,,1.8,,.5,,.97,.05],"weapon/explode/012":[1,,485,.02,.07,.03,4,.11,-3,.1,,,.05,1.1,,.4,,.57,.09],"weapon/explode/013":[,,30,.09,.12,.35,4,3,4,,,,,1.3,,.6,,.36,.21],"weapon/lazer/001":[1.5,0,515,.05,.07,.09,1,2.8,,,302,.06,.1,,3.5,.1,.08,.75,.04],"weapon/lazer/002":[,0,925,.04,.3,.6,1,.3,,6.27,-184,.09,.17],"weapon/lazer/003":[1,,375,.01,.06,,2,2.3,18,-10,,,,,18,,,.56,.14],"weapon/lazer/004":[.5,,2e3,,.05,0,,1.11,-17,,197,.01,,.2,,,,,.16],"weapon/lazer/005":[.9,,752,.03,.01,.02,,1.4,,,-10,.01,,,3.4,,,.68,.03,,106],"weapon/lazer/006":[1.9,,221,.01,.05,.06,1,3.9,-2,,116,.05,,,,,,.65,.02,,452],"weapon/lazer/007":[1,,659,.01,.04,,1,.4,,-75,179,.06,,,.2,,,.57],"world/footstep/001":[1.1,.05,157,.03,.04,.04,4,4.9,78,-13,0,0,.07,0,0,0,0,.91,.02,.33,0],"world/footstep/002":[.1,1,300,.05,.1,.05,4,.2,-100,,-50,.07,,.5,,.4,,,,.05],"world/footstep/003":[3,,5,,.06,.01,2,2.25,-19,-79,409,.01,,,6.6,,.2,.57,,.8],"world/nature/frog":[.5,,160,.03,.03,.02,,1.52,-23,93,662,.02,,,,.1,,,.07,.01],"world/nature/dolphin":[.5,0,448,.01,.1,.3,3,.39,-.5,,,,,,.2,.1,.08],"world/nature/whale":[1.2,0,1306,.8,.08,.02,1,,,,,,.48,,-.1,.11,.25],"world/nature/mouse":[1.2,0,1e3,.02,,.01,2,,18,,475,.01,.01],"world/nature/small-dog":[1,,759,.01,,.01,1,.97,15,,,,,,3.1,,,.76,.04],"world/nature/tweet":[.7,,1305,,,.03,1,.75,,23,694,.01,,,3.9,,,,.01],"world/water/splash":[2,,94,.07,.1,.33,4,.6,1,,,,,.1,1,.1,.1,.45,.15],"world/water/wave":[1,0,40,.5,,1.5,,11,,,,,,199],"world/water/pop":[1,0,103,,.02,.06,,1.24,-18,4.4,,,,.7,,.1,,.95,.03],"world/weather/thunder":[1.2,0,471,,.09,.47,4,1.06,-6.7,,,,,.9,61,.1,,.82,.09,.13]},t.Sfx.play=function(o=""){o&&(t.Utilities.checkString("sfx",o),t.Sfx.library[o]||t.Utilities.fatal(`SFX ${o} not found.`),t.Sfx.playFromArray(t.Sfx.library[o]))},t.Sfx.playFromArray=function(o=[]){t.Utilities.checkArray("sfxArray",o),zzfx(...o)},t.Sfx.add=function(o,s){t.Utilities.checkString("sfxName",o),t.Utilities.checkArray("sfxArray",s),t.Sfx.library[o]=s},t.Sfx.get=function(){return Object.keys(t.Sfx.library)}})(beep8),(function(t){t.Scene={};let o=null;const s={};t.Scene.add=function(r,n=null,e=30){t.Utilities.checkString("name",r),n!==null&&t.Utilities.checkObject("gameObject",n),t.Utilities.checkInt("frameRate",e);const i=n.init||null,a=n.update||null,u=n.render||null;s[r]={init:i,update:a,render:u,frameRate:e}},t.Scene.set=function(r){t.Utilities.checkString("name",r),s[r]||t.Utilities.fatal(`Scene "${r}" does not exist.`),t.Core.stopFrame(),o=r,t.Input&&typeof t.Input.onEndFrame=="function"&&t.Input.onEndFrame();const n=s[r];n.init&&n.init(),(n.update||n.render)&&t.frame(n.render,n.update,n.frameRate)},t.Scene.pause=function(){t.frame(null)},t.Scene.resume=function(){if(!o)return;const r=s[o];(r.update||r.render)&&t.frame(r.render||(()=>{}),r.update||(()=>{}),r.frameRate||30)},t.Scene.get=function(){return o},t.Scene.getAll=function(){return s}})(beep8),(function(t){t.Renderer={};let o=!1;const s=[],r=1,n=.4;let e=null,i=0;const a=()=>{for(let f=0;f<256;f++)s[f]=n*(f/255)**(1/2.2)+r};t.Renderer.render=function(){if(t.Core.crashed)return;t.Core.realCtx.imageSmoothingEnabled=!1;let f=0,g=0;if(i>0){let E=i*t.CONFIG.CHR_WIDTH;f=Math.round(Math.random()*E-E/2),g=Math.round(Math.random()*E-E/2),f=t.Utilities.clamp(f,-6,6),g=t.Utilities.clamp(g,-6,6),i-=t.Core.deltaTime}t.Core.realCtx.clearRect(0,0,t.Core.realCanvas.width,t.Core.realCanvas.height),t.Core.realCtx.drawImage(t.Core.canvas,f,g,t.Core.realCanvas.width,t.Core.realCanvas.height),o=!1,t.CursorRenderer.draw(t.Core.realCtx),t.Renderer.applyCrtFilter()},t.Renderer.shakeScreen=function(f=.25){return t.Utilities.checkNumber("duration",f),f<=0?(t.Utilities.warn(`Screenshake duration must be positive. Currently: ${f}`),!1):(i=f,!0)},t.Renderer.markDirty=function(){o||(o=!0,setTimeout(t.Renderer.render,1))},t.Renderer.applyCrtFilter=function(){if(t.CONFIG.CRT_ENABLE<=0||!t.CONFIG.CRT_VIGNETTE)return;e=t.Core.realCtx.getImageData(0,0,t.CONFIG.SCREEN_WIDTH,t.CONFIG.SCREEN_HEIGHT);const f=e.data;u(f),l(f),t.Core.realCtx.putImageData(e,0,0)};const u=f=>{if(!t.CONFIG.CRT_VIGNETTE)return f;const g=t.CONFIG.SCREEN_WIDTH,E=t.CONFIG.SCREEN_HEIGHT,x=.8,B=.25,v=g/2,N=E/2,I=Math.sqrt(v**2+N**2),R=x*I,y=B/(I*(1-x));for(let T=0;T<f.length;T+=4){const D=T/4%g,m=Math.floor(T/4/g),A=Math.sqrt((D-v)**2+(m-N)**2),w=A<R?1:Math.max(0,1-(A-R)*y);f[T]*=w,f[T+1]*=w,f[T+2]*=w}},l=f=>{const g=t.CONFIG.SCREEN_WIDTH,E=t.CONFIG.SCREEN_HEIGHT;for(let x=0;x<E;x+=2)for(let B=0;B<g;B++){const v=S(B,x),N=C(f,v),I=B>0?C(f,S(B-1,x)):N,R=B<g-1?C(f,S(B+1,x)):N;h(f,v,d(N,I,R))}},d=(f,g,E)=>{const x=t.CONFIG.CRT_ENABLE,B=1-x;return{r:f[0]*B+(g[0]+E[0])/2*x*s[g[0]],g:f[1]*B+(g[1]+E[1])/2*x*s[g[1]],b:f[2]*B+(g[2]+E[2])/2*x*s[g[2]]}},C=(f,g)=>[f[g+1],f[g+2],f[g+3]],h=(f,g,E)=>{f[g+1]=E.r,f[g+2]=E.g,f[g+3]=E.b},S=(f,g)=>g*t.CONFIG.SCREEN_WIDTH*4+f*4;a()})(beep8),(function(t){t.Random={};let o=null;t.Random.setSeed=function(s=null){s===null&&(s=Date.now()),typeof s=="string"&&(s=s.split("").reduce((r,n)=>r+n.charCodeAt(0),0)),s^=s<<13,s^=s>>17,s^=s<<5,s>>>=0,o=s;for(let r=0;r<10;r++)t.Random.num()},t.Random.getSeed=function(){return o},t.Random.num=function(){return o=(o*1664525+1013904223)%4294967296,o/4294967296},t.Random.range=function(s,r){return t.Utilities.checkNumber("min",s),t.Utilities.checkNumber("max",r),s+t.Random.num()*(r-s)},t.Random.int=function(s,r){if(t.Utilities.checkInt("min",s),t.Utilities.checkInt("max",r),r<=s){const e=r;r=s,s=e}const n=t.Random.range(s,r);return Math.round(n)},t.Random.pick=function(s){t.Utilities.checkArray("array",s);const r=t.Random.int(0,s.length-1);return s[r]},t.Random.pickWeighted=function(s,r=.2){t.Utilities.checkArray("array",s);const n=t.Random.weightedArray(s,r);return t.Random.pick(n)},t.Random.shuffleArray=function(s){t.Utilities.checkArray("array",s),s=s.slice();for(let r=0;r<s.length;r++){const n=t.Random.int(0,s.length-1),e=s[r];s[r]=s[n],s[n]=e}return s},t.Random.chance=function(s){return t.Utilities.checkNumber("probability",s),t.Random.num()<s/100},t.Random.weightedArray=function(s,r=.2){t.Utilities.checkArray("array",s);const n=[];for(let e=0;e<s.length;e++){const i=Math.pow(r,e)*10;for(let a=0;a<i;a++)n.push(s[e])}return n},t.Random.setSeed()})(beep8),(function(t){t.Passcodes={},t.Passcodes.codeLength=4,t.Passcodes.getCode=function(s){t.Utilities.checkIsSet("id",s);const r=s+t.CONFIG.PASSKEY;let n=o(r);return n=n.replace(/[^a-zA-Z]/g,""),n=n.toUpperCase(),n.substring(0,t.Passcodes.codeLength)},t.Passcodes.checkCode=function(s,r){return t.Utilities.checkIsSet("id",s),t.Utilities.checkString("code",r),t.Passcodes.getCode(s)===r},t.Passcodes.getId=function(s){for(t.Utilities.checkString("code",s),s=s.toUpperCase(),c=1;c<999;c++)if(t.Passcodes.checkCode(c,s))return c;return null},t.Passcodes.input=async function(){const s="Enter code:",r=s.length+2+2,n=6;let e=Math.round((t.CONFIG.SCREEN_COLS-r)/2),i=Math.round((t.CONFIG.SCREEN_ROWS-n)/2);t.Core.setCursorLocation(e,i),t.TextRenderer.printBox(r,n),t.Core.setCursorLocation(e+2,i+2),t.TextRenderer.print(s+`
>`);const a=await t.Async.readLine("",t.Passcodes.codeLength);return t.Passcodes.getId(a)};function o(s){s=btoa(s);let r=0,n="";for(let e=0;e<s.length;e++)r=(r<<5)-r+s.charCodeAt(e),r=r&r;for(let e=0;e<5;e++)r=(r<<5)-r+t.CONFIG.PASSKEY.charCodeAt(e%t.CONFIG.PASSKEY.length),n+=Math.abs(r).toString(36);return n}})(beep8),(function(t){t.Particles={};let o=[];t.Particles.add=function(s,r,n){t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",r),t.Utilities.checkObject("props",n);const i=Object.assign({},{x:s,y:r,vx:0,vy:0,life:1,size:1,color:15,gravity:0},n);Array.isArray(i.color)&&(i.color=t.Random.pick(i.color)),Array.isArray(i.size)&&(i.size=t.Random.pick(i.size)),o.push(i)},t.Particles.createExplosion=function(s,r,n=10,e={}){t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",r),t.Utilities.checkNumber("count",n),t.Utilities.checkObject("props",e);const i={size:1,color:t.Core.drawState.fgColor,life:2,speed:25,gravity:0},a=Object.assign({},i,e);for(let u=0;u<n;u++){const l=t.Random.range(0,Math.PI*2),d=t.Random.range(a.speed/2,a.speed);t.Particles.add(s,r,{size:a.size,color:a.color,life:a.life,vx:Math.cos(l)*d,vy:Math.sin(l)*d,g:a.gravity})}},t.Particles.update=function(s){for(let r=o.length-1;r>=0;r--){const n=o[r];n.vy+=n.g*s,n.x+=n.vx*s,n.y+=n.vy*s,n.life-=s,n.life<=0&&o.splice(r,1)}},t.Particles.render=function(){for(let s=0;s<o.length;s++){const r=o[s],n=r.size/2;t.Core.ctx.fillStyle=t.Core.getColorHex(r.color),t.Core.ctx.fillRect(Math.round(r.x-n),Math.round(r.y-n),Math.round(r.size),Math.round(r.size))}},t.Particles.clearAll=function(){o=[]},t.Particles.getParticles=function(){return[...o]},t.Particles.setParticles=function(s){t.Utilities.checkArray("particles",s),o=s}})(beep8),(function(t){let o=0,s=!1;function r(){s||(s=!0,o=Date.now(),t.Utilities.event("pageVisibility.sleep"))}function n(){if(!s||(s=!1,o===0))return;const e=Date.now()-o;t.Utilities.log("Time asleep:",(e/1e3).toFixed(3)),t.Utilities.event("pageVisibility.wake",{time:e}),o=0}document.addEventListener("visibilitychange",function(){document.hidden?r():n()}),window.addEventListener("blur",()=>r()),window.addEventListener("focus",()=>n())})(beep8),(function(t){t.Music={};function o(I,R){for(var y=[],T=0;T<I;T++)y.push(R(T));return y}const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function r(I){var R=/^([A-Ga-g])([#b]?)(\d)$/,y=I.match(R);if(!y)return null;var T=y[1].toUpperCase(),D=y[2],m=parseInt(y[3],10),A={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[T];return D==="#"?A+=1:D==="b"&&(A-=1),(m+1)*12+A}function n(I){let R=r(I);return R===null?"?":(R=t.Utilities.clamp(R,36,87),s.charAt(R-36))}function e(I){if(I.length===0)return"";for(var R=I[0],y=1;y<I.length;y++)I[y]===I[y-1]&&I[y]!==" "&&I[y]!=="|"?R+="-":R+=I[y];return R}function i(I,R,y,T){for(var D=o(I,function(){return!1}),m=0;m<T&&!(y>I);m++)D=a(D,y,R),y*=2;return D}function a(I,R,y){for(var T=o(R,function(){return!1}),D=0;D<y;D++)T[t.Random.int(0,R-1)]=!0;return I.map(function(m,A){return T[A%R]?!m:m})}const u=[["I","IIIm","VIm"],["IV","IIm"],["V","VIIm"]],l=[[0,1,2],[1,2,0],[2,0]],d={I:["C4","E4","G4","B4"],IIIm:["E4","G4","B4","D5"],VIm:["A3","C4","E4","G4"],IV:["F4","A4","C5","E5"],IIm:["D4","F4","A4","C5"],V:["G3","B3","D4","F4"],VIIm:["B3","D4","F4","A4"]},C={C:0,D:2,Eb:3,F:5,G:7,A:9,Bb:10},h=[0,1,2,3,4,5],S=[6,7];function f(I,R){const y=d[R]||d.I,T=C[I]||0;return y.map(function(D){return g(D,T)})}function g(I,R){var y=r(I);if(y===null)return I;y+=R;var T=Math.floor(y/12)-1,D=y%12,m=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return m[D]+T}function E(I){for(var R=["C","D","Eb","F","G","A","Bb"],y=t.Random.pick(R),T=4,D=null,m=0,A=[],w=0;w<I;w++){if(w%T===0){w===0?(m=t.Random.int(0,u.length-1),D=t.Random.pick(u[m])):t.Random.num()<.8-w/T%2*.5&&(m=t.Random.pick(l[m]),D=t.Random.pick(u[m]));var k=f(y,D)}A.push(k)}return A}function x(I,R){for(var y=[t.Random.pick(h),"|"],T=i(I,4,8,3),D=t.Random.int(-1,1),m=0;m<I;m++){if(t.Random.chance(10)&&(D+=t.Random.int(-1,1)),!T[m]){y.push(" ");continue}var A=R[m],w=A[t.Random.int(0,A.length-1)],k=parseInt(w.slice(-1),10),F=t.Utilities.clamp(k+D,3,6),M=w.slice(0,-1).toUpperCase(),U=M+F,_=n(U);y.push(_)}return y.push("|"),e(y)}function B(I,R){const y=[t.Random.pick(h),"|"];for(var T=t.Random.chance(30),D=t.Random.pick([4,8,16]),m=o(D,function(){return t.Random.int(0,3)}),A=t.Random.pick([2,4,8]),w=T?o(I,function(){return!0}):i(I,t.Random.pick([1,1,A/2]),A,2),k=t.Random.int(-1,1),F=t.Random.chance(T?30:80),M=0,U=0;U<I;U++){if(F&&U%A===0&&(M=(M+1)%2),!w[U]){y.push(" ");continue}var _=R[U],Q=T?m[U%D]:0,P=_[Q],L=parseInt(P.slice(-1),10),G=t.Utilities.clamp(L+k+M,3,6),O=P.slice(0,-1).toUpperCase(),H=O+G,j=n(H);y.push(j)}return y.push("|"),e(y)}function v(I){const R=[t.Random.pick(S),"|"],y=i(I,t.Random.int(1,3),t.Random.pick([4,8]),3);for(var T=n("C4"),D=0;D<I;D++)R.push(y[D]?T:" ");return R.push("|"),e(R)}t.Music.generate=function(I){I&&I.seed&&t.Random.setSeed(I.seed);const R={seed:t.Random.int(1e4,99999),noteCount:t.Random.pick([16,32,48,64]),channelCount:t.Random.int(2,5),drumPartRatio:.3,tempo:t.Random.pick([70,100,140,170,200,240,280]),hold:t.Random.pick([40,50,60,60,70,70,70,80,80,80,80,90,90,90,100,110,120,130,140,150])},y=Object.assign({},R,I);t.Music.currentSongProperties=y,t.Random.setSeed(y.seed);var T=E(y.noteCount),D=o(y.channelCount,function(){var A=t.Random.num()<y.drumPartRatio;return A?v(y.noteCount):t.Random.num()<.5?x(y.noteCount,T):B(y.noteCount,T)});if(y.tempo!==null){var m=String(y.tempo);y.hold!==null&&(m+="."+String(y.hold)),D[0]=m+`
`+D[0]}return D.join(`
`)};let N=null;t.Music.play=function(I){p1(I),I&&(N=I)},t.Music.stop=function(I=!0){t.Utilities.checkBoolean("clearCurrentSong",I),I&&(N=null),t.Music.play("")},t.Music.pause=function(){t.Music.isPlaying()&&t.Music.stop(!1)},t.Music.resume=function(){N&&!t.Music.isPlaying()&&t.Music.play(N)},t.Music.setVolume=function(I){t.Utilities.checkNumber("volume",I),p1.setVolume(I)},t.Music.setTempo=function(I){t.Utilities.checkInt("tempo",I),I<50&&(I=50),p1.setTempo(I)},t.Music.isPlaying=function(){return p1.isPlaying()},document.addEventListener("beep8.pageVisibility.wake",t.Music.resume),document.addEventListener("beep8.pageVisibility.sleep",t.Music.pause)})(beep8),(function(t){t.Menu={},t.Menu.display=async function(s,r){r=r||{},t.Utilities.checkArray("choices",s),t.Utilities.checkObject("options",r),r=Object.assign({title:"",prompt:"",selBgColor:t.Core.drawState.fgColor,selFgColor:t.Core.drawState.bgColor,border:!0,borderChar:t.CONFIG.BORDER_CHAR,center:!1,centerH:!1,centerV:!1,padding:1,selIndex:0,typewriter:!1},r);let n=t.Core.drawState.cursorCol,e=t.Core.drawState.cursorRow;const i=t.TextRenderer.measure(r.prompt),a=r.prompt?1:0,u=r.borderChar?1:0;let l=0;const d=s.length;s.forEach(f=>{l=Math.ceil(Math.max(l,t.TextRenderer.measure(f).cols))});let C=Math.ceil(Math.max(i.cols,l))+2*r.padding+2*u;C=Math.min(C,t.CONFIG.SCREEN_COLS);const h=a*(i.rows+1)+d+2*r.padding+2*u;if((r.centerH||r.center)&&(n=Math.round((t.CONFIG.SCREEN_COLS-C)/2)),(r.centerV||r.center)&&(e=Math.round((t.CONFIG.SCREEN_ROWS-h)/2)),t.Core.drawState.cursorCol=n,t.Core.drawState.cursorRow=e,r.border&&(t.TextRenderer.printBox(C,h,!0,r.borderChar),r.title)){const f=" "+r.title+" ";t.Core.drawState.cursorCol=n+Math.round((C-f.length)/2),t.TextRenderer.print(f)}r.prompt&&(t.Core.drawState.cursorCol=i.cols<=C?n+u+r.padding:n+Math.round((C-i.cols)/2),t.Core.drawState.cursorRow=e+u+r.padding,r.typewriter?await t.Async.typewriter(r.prompt):t.TextRenderer.print(r.prompt));let S=r.selIndex;for(;;){t.Core.drawState.cursorRow=e+u+r.padding+a*(i.rows+1),t.Core.drawState.cursorCol=i.cols<=l?n+u+r.padding:n+Math.round((C-l)/2),o(s,S,r);const f=await t.Input.readKeyAsync();if(f.includes("ArrowUp"))S=S>0?S-1:s.length-1,s.length>1&&t.Sfx.play(t.CONFIG.SFX.MENU_UP);else if(f.includes("ArrowDown"))S=(S+1)%s.length,s.length>1&&t.Sfx.play(t.CONFIG.SFX.MENU_DOWN);else if(f.includes("Enter")||f.includes("ButtonA")||f.includes("ButtonB")||f.includes(" "))return t.Sfx.play(t.CONFIG.SFX.MENU_SELECT),S}};const o=function(s,r,n){const e=t.Core.drawState.bgColor,i=t.Core.drawState.fgColor;for(let a=0;a<s.length;a++){const u=a===r;t.Core.setColor(u?n.selFgColor:i,u?n.selBgColor:e),t.TextRenderer.print(s[a]+`
`)}t.Core.setColor(i,e)}})(beep8),(function(t){t.Inventory={},document.addEventListener("beep8.initComplete",()=>{t.Inventory.reset()},{once:!0}),t.Inventory.reset=function(){t.data.inventory={counts:{},flags:{}}},t.Inventory.getCount=function(o){return t.data.inventory.counts[o]??0},t.Inventory.add=function(o,s=1,r=1/0){const n=t.Inventory.getCount(o);t.data.inventory.counts[o]=Math.min(n+s,r)},t.Inventory.remove=function(o,s=1){const r=t.Inventory.getCount(o);t.data.inventory.counts[o]=Math.max(r-s,0)},t.Inventory.has=function(o,s=1){return t.Inventory.getCount(o)>=s},t.Inventory.setFlag=function(o,s=!0){t.data.inventory.flags[o]=s},t.Inventory.getFlag=function(o){return t.Utilities.checkString("flag",o),!!t.data.inventory.flags[o]},t.Inventory.filter=function(o){const s=[],r=t.data.inventory.counts,n=o instanceof RegExp;n||t.Utilities.checkString("match",o);for(const e in r){if(!Object.hasOwn(r,e))continue;const i=r[e];i<=0||(n&&o.test(e)||!n&&e.includes(o))&&s.push({id:e,count:i})}return s}})(beep8),(function(t){t.Intro={},t.Intro.loading=async function(){t.color(0,4),t.cls(),t.locate(1,1),t.print(`8> beep8 Loading...
`),await t.Async.wait(.4)},t.Intro.splash=async function(){const o=t.Tilemap.load("mBqYHoMBBACDAAMEgwADBIMBBACDAQQAgxh6AwSDGJkDBIMBBACDAQQAgwEEAIMDAwSDAwMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwADBIMAAwSDAAMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwMDBIMDAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAAQEgwAEBIMABAQADwAADwCYHoMBBACDGJIDBIMYNwMEgxhbAwSDGDcDBIMYNwMEgxg3AwSDGQEEAwSDGDcDBIMYNwMEgxg3AwSDGDcDBIMYNwMEgxg3AwSDGDcDBIMZARYDBIMYNwMEgxg4AwSDAQQAgwEEAIMBBACDAAQEgwMDBIMBBAAADwAADwCYHoMPBQSDGEgDBIMCDwSDAQ8AgxMPBIMBBACDGQGIDwSDGQGHDwSDGQGJDwSDGE4FBIMZAVMPBIMZAVQPBIMZAVUPBIMYTgUEgwEPBIMBDwCDEw8EgxhKAwSDAQQAgwEEAIMBBACDDwUEgwEEAIMBBAAADwAADwCYHoMBBACDGEgDBIMBDwCDGHIFBIMBDwCDGE4FBIMZAZkPBIMYcgUEgxg9BQSDGK8FBIMZAVMPBIMYcgUEgxg9BQSDGK8FBIMLDwSDGHIFBIMLDwSDGEgDBIMBBACDAQQAgwEEAIMABASDAQQAgw8FBAAPAAAPAJgegwEEAIMYSgMEgwEPAIMBDwCDFwQPgwEEAIMZAZ0PBIMBDwSDGE4FBIMBBACDGQFUDwSDGQFTDwSDGE4BBIMBBACDAQ8EgwEPAIMYJQ8FgxhuDwSDGG4PBIMYlw8EgwAPBIMABASDAQQAgwEEAAAPAAAPAJgegwEEAIMYSAMEgwkPBIMYcgUEgwEPAIMYTgEEgxkBnQ8EgxhyBQSDGK8FBIMBBACDGQFTDwSDGHIFBIMYrwUEgwEEAIMBDwSDGHIFBIMYPQUEgxhIAwSDAQQAgwEEAIMBBACDAAQEgwAEBIMABAQADwAADwCYHoMBBACDGEgDBIMYTw8EgwEPAIMYJQ8FgxhOBQSDGQGaDwSDEgoPgxgcBQqDGBkFCoMYHQUKgxMKD4MYHQUPgxhOBQSDBg8EgxhOBQSDDwMEgxhIAwSDDgUEgwEEAIMBBACDAQQAgwEEAIMBBAAADwAADwCYHoMBBACDGFoDBIMYNwMEgxg3AwSDGDcDBIMYNwMEgxg3AwSDAQoEgxgrCgWDGDcDBIMYKwQKgwEKBIMYKwUEgxg3AwSDGFsDBIMYNwMEgxg3AwSDGKUDBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMYJAoEgxguBQqDGBkKBIMYLwQKgxglCgWDGCsBBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgxgpAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMSCgSDGBwFCoMYGQEKgxgdBQqDEwoFgxgiBQSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegxiXDwODGJcPA4MYGAMEgwEEAIMBBACDAQQAgw0FBIMLBAqDGCsKBYMABASDGCsECoMBCgSDGDIFBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMDAwSDAwMEgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgxgkCgSDGC4FCoMYGQoEgxgvBAqDGCUKBYMYKwUEgwAFCoMYHQEEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAQQAgwEEAIMACgSDAAoEgwAKBIMYLgUEgxgZBAWDGBkEAYMYGQQFgxgvBQSDGC4FBIMYLwUEgwEEAIMBBACDAQQAgwEEAIMYrAMEgxg3AwSDGDcDBIMYWwMEgxg3AwQADwAADwCYHoMYNwMEgxg3AwSDGJsDBIMBBACDAQQAgwEEAIMBBACDAQQEgwEEBIMBBASDAQQEgwEEBIMBBACDAQQAgwEEAIMBBACDGQHlAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAQQAgwEEAIMYbgMEgxhuAwSDGG4DBIMYbgMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAA8EgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwADBIMYegMEgxiZAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMAAwSDAAMEgwADBAAPAAAPAJgegxgcCgSDGB0KBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgxgpAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DGC4KBIMYLwoEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgxgpAwSDGCkDBIMBBACDAQQAgwEEAIMBBACDAQQAgxcDBIMBAwSDGBgDBIMAAwSDAQQAgxh0AwSDGIYDBIMABQSDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAA8EgwEEAIMBBACDAQQAgxcDBIMCAwSDAQMEgxgYAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAAMEgwADBIMYdAMEgxkBbAUEgwEEAIMZAUYFBIMBBAAADwAADwCYHoMWAwSDGCgDBIMBBACDAQQAgxh0AwSDEAMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDFgMEgxgoAwSDGHQDBIMYhgMEgxkBbAUEgwAFBIMABQWDAQUEgwEFBIMBBQQADwAADwCYHoMYKAUDgwAFA4MYKAMEgxh0AwSDAQQAgwEEAIMNBQSDAQQAgwEEAIMYdAMEgxiGAwSDFgMEgxgoAwSDFgMEgwEDBIMBAwSDEAMEgxi0BQSDAAEFgwMBBYMABQWDAQUEgwEFBIMBBQQADwAADwCYHoMBBQSDGCgFA4MABQODGCgDBIMYuAUEgwEEAIMBBACDGIYDBIMYdAMEgxi4BQSDDwMEgwsDBIMBAwSDAQMEgxkBagUDgwEDBIMYnAUDgwADBYMAAQWDAQUEgwAFBYMPAQWDAQUEgwEFBAAPAAAPAJgegwMBBYMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgw8BBYMRAQWDDwEFgwMFAYMBBQSDAQUEAA8AAA8AloMRAQWDEQEFgwMBBYMDAQWDAwEFgwMBBYMADwWDAwEFgwMBBYMADwWDAA8FgwAPBYMDAQWDAA8FgwAPBYMADwWDDwEFgwsBBYMRAQWDCwEFgxhYBQGDAA8BloMADwGDEAEFgwAPBYMADwWDAA8FgwAPBYMADwWDAQEFgxABBYMADwWDAA8FgwAPBYMADwWDAA8FgwkBBYMADwWDAA8FgwQBBYMADwGDAA8BgwAPAYMABQE=");t.locate(0,0),t.Tilemap.draw(o);let s="Click to start";t.Core.isTouchDevice()&&(s="Tap to start"),t.color(4,5),t.locate(0,t.CONFIG.SCREEN_ROWS-2),t.printCentered(s,t.CONFIG.SCREEN_COLS),await t.Input.readPointerAsync(),t.color(15,0),t.cls()}})(beep8),(function(t){t.Input={};let o=null,s=null;t.Input.init=function(){o=new Set,s=new Set,window.addEventListener("keydown",r=>t.Input.onKeyDown(r)),window.addEventListener("keyup",r=>t.Input.onKeyUp(r)),window.addEventListener("pointerdown",r=>t.Input.onPointerDown(r))},t.Input.keyHeld=function(r){return o.has(r.toUpperCase())},t.Input.keyJustPressed=function(r){return s.has(r.toUpperCase())},t.Input.onEndFrame=function(){s.clear()},t.Input.onKeyDown=function(r){const n=r.key,e=t.Input.getKeys(n);["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(n)&&r.preventDefault();for(const i of e)s.add(i.toUpperCase()),o.add(i.toUpperCase());t.Core.hasPendingAsync("beep8.Async.key")&&t.Core.resolveAsync("beep8.Async.key",e)},t.Input.onPointerDown=function(r){t.Core.hasPendingAsync("beep8.Async.pointer")&&t.Core.resolveAsync("beep8.Async.pointer",{x:r.clientX,y:r.clientY})},t.Input.onKeyUp=function(r){if(!r.key)return;const n=r.key.toUpperCase(),e=t.Input.getKeys(n);for(const i of e)o.delete(i.toUpperCase())},t.Input.readKeyAsync=function(){return new Promise((r,n)=>{t.Core.startAsync("beep8.Async.key",r,n)})},t.Input.readPointerAsync=function(){return new Promise((r,n)=>{t.Core.startAsync("beep8.Async.pointer",r,n)})},t.Input.getKeys=function(r){let n=[r];switch(r.toUpperCase()){case"W":n.push("ArrowUp");break;case"A":n.push("ArrowLeft");break;case"S":n.push("ArrowDown");break;case"D":n.push("ArrowRight");break;case"Enter":n.push("Escape");break;case"Z":case"N":n.push("ButtonA");break;case"X":case"M":n.push("ButtonB");break}return n},t.Input.readLine=async function(r,n,e=-1){const i=t.Core.drawState.cursorCol,a=t.Core.drawState.cursorRow;let u=i,l=a,d=[r],C=0;const h=t.Core.drawState.cursorVisible;for(t.CursorRenderer.setCursorVisible(!0);;){t.Core.setCursorLocation(u,l),t.TextRenderer.print(d[C]||"");const S=await t.Input.readKeyAsync();for(const f of S)if(f==="Backspace"){if(d[C].length===0){if(C===0)continue;C--,l--}d[C]=d[C].length>0?d[C].substring(0,d[C].length-1):d[C],t.Core.setCursorLocation(u+t.TextRenderer.measure(d[C]).cols,l),t.TextRenderer.print(" "),t.Sfx.play(t.CONFIG.SFX.TYPING)}else{if(f==="Enter")return t.Core.setCursorLocation(1,l+1),t.CursorRenderer.setCursorVisible(h),t.Sfx.play(t.CONFIG.SFX.TYPING),d.join("");f.length===1&&((d.join("").length<n||n===-1)&&(d[C]+=f,e!==-1&&d[C].length>=e&&(t.TextRenderer.print(d[C].charAt(d[C].length-1)),u=i,C++,d[C]="",l++)),t.Sfx.play(t.CONFIG.SFX.TYPING))}}}})(beep8),(function(t){t.Hooks={};const o={},s={};function r(n,e,i,a=10){n[e]||(n[e]=[]),n[e].push({callback:i,priority:a}),n[e].sort((u,l)=>u.priority-l.priority)}t.Hooks.addAction=function(n,e,i=10){r(o,n,e,i)},t.Hooks.doAction=function(n,...e){if(o[n])for(const{callback:i}of o[n])i(...e)},t.Hooks.addFilter=function(n,e,i=10){r(s,n,e,i)},t.Hooks.applyFilters=function(n,e,...i){if(!s[n])return e;let a=e;for(const{callback:u}of s[n])a=u(a,...i);return a},t.Hooks.removeAction=function(n,e){o[n]=(o[n]||[]).filter(i=>i.callback!==e)},t.Hooks.removeFilter=function(n,e){s[n]=(s[n]||[]).filter(i=>i.callback!==e)}})(beep8),(function(t){"use strict";t.ECS={};let o=0,s=new Map,r=[],n=new Map;function e(){return o++}function i(a){return s.has(a)||s.set(a,new Map),s.get(a)}t.ECS.entitiesAt=function(a,u){return r[u]?.[a]??[]},t.ECS.addSystem=function(a,u,l=0){t.Utilities.checkFunction("fn",u),t.Utilities.checkString("name",a),t.Utilities.checkInt("order",l),n.has(a)&&t.Utilities.warn(`ECS: overwriting existing system "${a}"`),n.set(a,{fn:u,order:l})},t.ECS.addSystemOnce=function(a,u,l=0){t.Utilities.checkFunction("fn",a),t.Utilities.checkString("name",u),t.Utilities.checkInt("order",l),!n.has(u)&&t.ECS.addSystem(a,u,l)},t.ECS.removeSystem=function(a){n.delete(a)},t.ECS.run=function(a,u=()=>!0){[...n.entries()].sort((l,d)=>l[1].order-d[1].order).forEach(([l,{fn:d}])=>{u(l)&&d(a)})},t.ECS.add=function(a,u=null,l={}){t.Utilities.checkInt("id",a),t.Utilities.checkString("name",u),t.Utilities.checkObject("data",l),i(u).set(a,l),u==="Loc"&&t.ECS.setLoc(a,l.col,l.row)},t.ECS.set=function(a,u,l){t.ECS.add(a,u,l)},t.ECS.setLoc=function(a,u,l){t.Utilities.checkInt("id",a),t.Utilities.checkInt("col",u),t.Utilities.checkInt("row",l);const d=this.getComponent(a,"Loc"),C=r[d.row];if(C){const h=C[d.col];if(h){const S=h.indexOf(a);S!==-1&&h.splice(S,1)}}d.col=u,d.row=l,r[l]||(r[l]=[]),r[l][u]||(r[l][u]=[]),r[l][u].push(a)},t.ECS.get=function(a){return t.Utilities.checkString("name",a),s.get(a)??new Map},t.ECS.getEntity=function(a){t.Utilities.checkInt("id",a);const u=new Map;for(const[l,d]of s)d.has(a)&&u.set(l,d.get(a));return u},t.ECS.getComponent=function(a,u){return s.get(u)?.get(a)},t.ECS.hasComponent=function(a,u){return s.get(u)?.has(a)??!1},t.ECS.removeComponent=function(a,u){s.get(u)?.delete(a)},t.ECS.removeEntity=function(a){const u=this.getComponent(a,"Loc");if(u){const l=r[u.row]?.[u.col];l&&l.splice(l.indexOf(a),1)}for(const l of s.values())l.delete(a)},t.ECS.create=function(a){const u=e();for(const[l,d]of Object.entries(a))t.ECS.add(u,l,d);return u},t.ECS.query=function(...a){if(a.length===0)return[];const u=s.get(a[0]);return u?[...u.keys()].filter(l=>a.every(d=>s.get(d)?.has(l))):[]},t.ECS.countByType=function(a){const u=this.get("Type");if(!u)return 0;let l=0;for(const d of u.values())d.name===a&&l++;return l},t.ECS.reset=function(){s=new Map,n=new Map,r=[],o=0}})(beep8),(function(t){t.CursorRenderer={};let o=0,s=null;t.CursorRenderer.setCursorVisible=function(n){t.Utilities.checkBoolean("visible",n),t.Core.drawState.cursorVisible!==n&&(t.Core.drawState.cursorVisible=n,o=0,t.Renderer.render(),s!==null&&(clearInterval(s),s=null),n&&(s=setInterval(()=>r(),t.CONFIG.CURSOR.BLINK_INTERVAL)))},t.CursorRenderer.draw=function(n){if(t.Utilities.checkInstanceOf("targetCtx",n,CanvasRenderingContext2D),!t.Core.drawState.cursorVisible||o<=0)return;const e=t.TextRenderer.getFont(),i=t.Core.drawState.cursorCol*t.CONFIG.CHR_WIDTH,a=t.Core.drawState.cursorRow*t.CONFIG.CHR_HEIGHT;n.fillStyle=t.Core.getColorHex(t.Core.drawState.fgColor),n.fillRect(i+1,a+1,e.charWidth_-2,e.charHeight_-2)};function r(){o=(o+1)%2,t.Renderer.render()}})(beep8),(function(t){t.Core={},t.Core.realCanvas=null,t.Core.realCtx=null,t.Core.canvas=null,t.Core.ctx=null,t.Core.container=null,t.Core.startTime=0,t.Core.deltaTime=0,t.Core.crashed=!1,t.Core.crashing=!1,t.Core.drawState={fgColor:7,bgColor:0,cursorCol:0,cursorRow:0,cursorVisible:!1};let o=null,s=!1,r=null,n=null,e=0,i=0,a=null;t.Core.init=function(f,g={}){t.Utilities.checkFunction("callback",f),g&&t.Utilities.checkObject("options",g),t.CONFIG={...t.CONFIG,...g},t.Hooks.doAction("beforeInit"),t.Core.initScreenshot(),t.Core.asyncInit(f),t.Core.startTime=t.Core.getNow(),t.Hooks.doAction("afterInit"),t.Utilities.event("initComplete")},t.Core.initialized=function(){return s},t.Core.asyncInit=async function(f=null){if(t.Utilities.log("beep8 System initializing"),t.CONFIG.SCREEN_WIDTH=t.CONFIG.SCREEN_COLS*t.CONFIG.CHR_WIDTH,t.CONFIG.SCREEN_HEIGHT=t.CONFIG.SCREEN_ROWS*t.CONFIG.CHR_HEIGHT,t.Core.realCanvas=document.createElement("canvas"),t.CONFIG.CANVAS_SETTINGS&&t.CONFIG.CANVAS_SETTINGS.CANVAS_ID&&t.Core.realCanvas.setAttribute("id",t.CONFIG.CANVAS_SETTINGS.CANVAS_ID),t.CONFIG.CANVAS_SETTINGS&&t.CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES)for(const g of t.CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES)t.Core.realCanvas.classList.add(g);t.Core.realCanvas.style.touchAction="none",t.Core.realCanvas.style.userSelect="none",t.Core.realCanvas.style.imageRendering="pixelated",t.Core.realCanvas.addEventListener("touchstart",g=>g.preventDefault()),t.Core.container=document.createElement("div"),t.Core.container.setAttribute("style",""),t.Core.container.id="beep8",t.Core.container.style.display="block",t.Core.container.style.lineHeight="0",t.Core.container.style.position="relative",t.Core.container.appendChild(t.Core.realCanvas),t.Core.getBeepContainerEl().appendChild(t.Core.container),t.Core.canvas=document.createElement("canvas"),t.Core.canvas.width=t.CONFIG.SCREEN_WIDTH,t.Core.canvas.height=t.CONFIG.SCREEN_HEIGHT,t.Core.canvas.style.width=t.CONFIG.SCREEN_WIDTH+"px",t.Core.canvas.style.height=t.CONFIG.SCREEN_HEIGHT+"px",t.Core.ctx=t.Core.canvas.getContext("2d",{willReadFrequently:!0}),t.Core.ctx.imageSmoothingEnabled=!1,await t.TextRenderer.initAsync(),t.Input.init(),t.Core.updateLayout(!1),window.addEventListener("resize",()=>t.Core.updateLayout(!0)),t.Core.isMobile()&&t.Joystick.setup(),s=!0,t.Utilities.log("beep8 System initialized"),await t.Intro.loading(),await t.Intro.splash(),f&&await f()},t.Core.getBeepContainerEl=function(){let f=document.body;if(t.CONFIG.CANVAS_SETTINGS&&t.CONFIG.CANVAS_SETTINGS.CONTAINER){const g=t.CONFIG.CANVAS_SETTINGS.CONTAINER;typeof g=="string"?(f=document.getElementById(g.replace("#","")),f||t.Utilities.fatal("beep8: Could not find container element with ID: "+g)):g instanceof HTMLElement?f=g:(t.Utilities.error("beep8: beep8.CONFIG.CANVAS_SETTINGS.CONTAINER must be either an ID of an HTMLElement."),f=document.body)}return f},t.Core.preflight=function(f){if(t.Core.crashed)throw new Error(`Can't call API method ${f}() because the engine has crashed.`);s||t.Utilities.fatal(`Can't call API method ${f}(): API not initialized. Call initAsync() wait until it finishes before calling API methods.`),a&&t.Utilities.fatal(`Can't call API method ${f}() because there is a pending async call to ${a.name}() that hasn't finished running yet. Are you missing an 'await' keyword to wait for the async method? Use 'await ${a.name}()',not just '${a.name}()'`)},t.Core.startAsync=function(f,g,E){if(a)throw new Error("Internal bug: startAsync called while pendingAsync is not null. Missing preflight() call?");a={name:f,resolve:g,reject:E},t.Renderer.render()},t.Core.hasPendingAsync=function(f=null){return f===null?!!a:a&&a.name===f},t.Core.endAsyncImpl=function(f,g,E){if(!a)throw new Error(`Internal bug: endAsync(${f}) called with no pendingAsync`);if(a.name!==f)throw new Error(`Internal bug: endAsync(${f}) called but pendingAsync.name is ${a.name}`);const x=g?a.reject:a.resolve;a=null,x(E)},t.Core.resolveAsync=function(f,g){t.Core.endAsyncImpl(f,!1,g)},t.Core.failAsync=function(f,g){t.Core.endAsyncImpl(f,!0,g)};let u=!1,l=null;t.Core.setFrameHandlers=function(f=null,g=null,E=30){r=g||(()=>{}),n=f||(()=>{}),e=1/E,i=0,o=t.Core.getNow(),l&&(window.cancelAnimationFrame(l),l=null),u=!0,l=window.requestAnimationFrame(t.Core.doFrame)},t.Core.doFrame=async function(){if(!u)return;const f=t.Core.getNow();let g=(f-o)/1e3;o=f,t.Core.deltaTime=g,g=Math.min(g,.05),i+=g;let E=Math.floor(i/e);const x=10;E>x&&(E=x,i=0);for(let B=0;B<E;B++)r&&r(e),t.Input&&typeof t.Input.onEndFrame=="function"&&t.Input.onEndFrame(),t.Particles.update(e);i%=e,n&&n(),t.Renderer.render(),l=window.requestAnimationFrame(t.Core.doFrame)},t.Core.stopFrame=function(){u=!1,l&&(window.cancelAnimationFrame(l),l=null)},t.Core.cls=function(f=void 0){f=f||t.Core.drawState.bgColor,t.Utilities.checkNumber("bgColor",f),t.Core.ctx.fillStyle=t.Core.getColorHex(f),t.Core.ctx.fillRect(0,0,t.Core.canvas.width,t.Core.canvas.height),t.Core.setCursorLocation(0,0),t.Renderer.markDirty()},t.Core.defineColors=function(f){t.Utilities.checkArray("colors",f),t.CONFIG.COLORS=f.slice(),t.TextRenderer.regenColors()},t.Core.setColor=function(f,g=void 0){t.Utilities.checkNumber("fg",f),t.Core.drawState.fgColor=Math.round(f),g!==void 0&&(t.Utilities.checkNumber("bg",g),t.Core.drawState.bgColor=Math.round(g))},t.Core.setCursorLocation=function(f,g){t.Utilities.checkNumber("col",f),t.Core.drawState.cursorCol=Math.round(f*2)/2,g!==void 0&&(t.Utilities.checkNumber("row",g),t.Core.drawState.cursorRow=Math.round(g*2)/2)},t.Core.nextCursorLocation=function(){let f=t.Core.drawState.cursorCol,g=t.Core.drawState.cursorRow;t.Core.setCursorLocation(f+1,g)},t.Core.getColorHex=function(f){return typeof f!="number"?"#f0f":f<0?"#000":(f=t.Utilities.clamp(Math.round(f),0,t.CONFIG.COLORS.length-1),t.CONFIG.COLORS[f])},t.Core.getNow=function(){return window.performance&&window.performance.now?window.performance.now():new Date().getTime()},t.Core.drawImage=function(f,g,E,x,B,v,N){t.Utilities.checkInstanceOf("img",f,HTMLImageElement),t.Utilities.checkNumber("x",g),t.Utilities.checkNumber("y",E),x!==void 0&&t.Utilities.checkNumber("srcX",x),B!==void 0&&t.Utilities.checkNumber("srcY",B),v!==void 0&&t.Utilities.checkNumber("width",v),N!==void 0&&t.Utilities.checkNumber("height",N),x!==void 0&&B!==void 0&&v!==void 0&&N!==void 0?t.Core.ctx.drawImage(f,x,B,v,N,g,E,v,N):t.Core.ctx.drawImage(f,g,E)},t.Core.loadImage=async function(f){return t.Utilities.log("load image",f),new Promise(g=>{const E=new Image;E.crossOrigin="Anonymous",E.onload=()=>{const x=document.createElement("canvas"),B=x.getContext("2d");x.width=E.width,x.height=E.height,B.drawImage(E,0,0);const v=B.getImageData(0,0,x.width,x.height),N=v.data,I=h(t.CONFIG.COLORS);for(let y=0;y<N.length;y+=4){const T=N[y],D=N[y+1],m=N[y+2],A=d(T,D,m,I),{r:w,g:k,b:F}=A;N[y]=w,N[y+1]=k,N[y+2]=F}B.putImageData(v,0,0);const R=new Image;R.onload=()=>g(R),R.src=x.toDataURL()},E.src=f})},t.Core.drawRect=function(f,g,E,x,B=1){t.Utilities.checkNumber("x",f),t.Utilities.checkNumber("y",g),t.Utilities.checkNumber("width",E),t.Utilities.checkNumber("height",x),t.Utilities.checkNumber("lineWidth",B);const v=t.Core.ctx.strokeStyle,N=t.Core.ctx.lineWidth;t.Core.ctx.strokeStyle=t.Core.getColorHex(t.Core.drawState.fgColor),t.Core.ctx.lineWidth=B,t.Core.ctx.strokeRect(Math.round(f),Math.round(g),Math.round(E),Math.round(x)),t.Core.ctx.strokeStyle=v,t.Core.ctx.lineWidth=N},t.Core.fillRect=function(f,g,E,x){t.Utilities.checkNumber("x",f),t.Utilities.checkNumber("y",g),t.Utilities.checkNumber("width",E),t.Utilities.checkNumber("height",x),t.Core.ctx.fillStyle=t.Core.getColorHex(t.Core.drawState.fgColor),t.Core.ctx.fillRect(Math.round(f)+.5,Math.round(g)+.5,Math.round(E)-1,Math.round(x)-1)},t.Core.initScreenshot=function(){if(t.Core.initialized())return;const f=g=>{g.key==="0"&&t.Core.downloadScreenshot()};document.addEventListener("pointerup",f),document.addEventListener("keyup",f)},t.Core.saveScreen=function(){return t.Core.ctx.getImageData(0,0,t.Core.canvas.width,t.Core.canvas.height)},t.Core.downloadScreenshot=function(){const f=t.Core.getHighResDataURL(t.Core.realCanvas);t.Utilities.downloadFile("beep8-screenshot.png",f)},t.Core.getHighResDataURL=function(f,g=4,E="image/png",x=1){const B=document.createElement("canvas");B.width=f.width*g,B.height=f.height*g;const v=B.getContext("2d");return v.imageSmoothingEnabled=!1,v.scale(g,g),v.drawImage(f,0,0),B.toDataURL(E,x)},t.Core.restoreScreen=function(f){t.Utilities.checkInstanceOf("screenData",f,ImageData),t.Core.ctx.putImageData(f,0,0)},t.Core.updateLayout=function(f){t.Core.updateLayout2d(),f&&t.Renderer.render()},t.Core.updateLayout2d=function(){t.Core.realCtx=t.Core.realCanvas.getContext("2d",{willReadFrequently:!0}),t.Core.realCtx.imageSmoothingEnabled=!1,t.CONFIG.SCREEN_EL_WIDTH=t.CONFIG.SCREEN_WIDTH,t.CONFIG.SCREEN_EL_HEIGHT=t.CONFIG.SCREEN_HEIGHT,t.CONFIG.SCREEN_REAL_WIDTH=t.CONFIG.SCREEN_WIDTH,t.CONFIG.SCREEN_REAL_HEIGHT=t.CONFIG.SCREEN_HEIGHT,t.Core.realCanvas.style.width="100%",t.Core.realCanvas.style.height="100%",t.Core.realCanvas.style.filter="blur(0.5px)",t.Core.realCanvas.width=t.CONFIG.SCREEN_REAL_WIDTH,t.Core.realCanvas.height=t.CONFIG.SCREEN_REAL_HEIGHT,t.Core.container.style.aspectRatio=`${t.CONFIG.SCREEN_COLS} / ${t.CONFIG.SCREEN_ROWS}`},t.Core.handleCrash=function(f="Fatal error"){t.Core.crashed||t.Core.crashing||(t.Core.crashing=!0,t.Core.setColor(t.CONFIG.COLORS.length-1,0),t.Core.cls(),t.Core.setCursorLocation(1,1),t.TextRenderer.print(`*** CRASH ***:
`+f,null,t.CONFIG.SCREEN_COLS-2),t.Renderer.render(),t.Core.crashing=!1,t.Core.crashed=!0)},t.Core.isTouchDevice=function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},t.Core.isMobile=function(){return t.Core.isIOS()||t.Core.isAndroid()||t.Core.isTouchDevice()},t.Core.isIOS=function(){return/(ipad|ipod|iphone)/i.test(navigator.userAgent)},t.Core.isAndroid=function(){return/android/i.test(navigator.userAgent)};function d(f,g,E,x,B=4){const v=Math.floor(f/B)*B,N=Math.floor(g/B)*B,I=Math.floor(E/B)*B,R=`${v},${N},${I}`;return x[R]}const C={};function h(f,g=4){if(Object.keys(C).length!==0)return C;const E=f.map(x=>t.Utilities.hexToRgb(x));for(let x=0;x<256;x+=g)for(let B=0;B<256;B+=g)for(let v=0;v<256;v+=g){const N=`${x},${B},${v}`;C[N]=S(x,B,v,E)}return C}function S(f,g,E,x){let B=null,v=1/0;for(const N of x){const I=Math.pow(N.r-f,2)+Math.pow(N.g-g,2)+Math.pow(N.b-E,2);I<v&&(v=I,B=N)}return B}})(beep8),(function(t){t.Collision={},t.COLLISION={},t.COLLISION.NONE=0,t.COLLISION.N=1,t.COLLISION.E=2,t.COLLISION.S=4,t.COLLISION.W=8,t.COLLISION.NE=t.COLLISION.N+t.COLLISION.E,t.COLLISION.NS=t.COLLISION.N+t.COLLISION.S,t.COLLISION.NW=t.COLLISION.N+t.COLLISION.W,t.COLLISION.SE=t.COLLISION.S+t.COLLISION.E,t.COLLISION.SW=t.COLLISION.S+t.COLLISION.W,t.COLLISION.WE=t.COLLISION.W+t.COLLISION.E,t.COLLISION.WNE=t.COLLISION.W+t.COLLISION.N+t.COLLISION.E,t.COLLISION.WES=t.COLLISION.W+t.COLLISION.E+t.COLLISION.S,t.COLLISION.NES=t.COLLISION.N+t.COLLISION.E+t.COLLISION.S,t.COLLISION.ALL=t.COLLISION.N+t.COLLISION.E+t.COLLISION.S+t.COLLISION.W})(beep8),(function(t){t.Cart={};const o="BEEP8",s=new TextEncoder().encode(o),r=1;t.Cart.save=async function(l,d,C="cart.png"){t.Utilities.checkInstanceOf("canvas",l,HTMLCanvasElement),t.Utilities.checkString("data",d),t.Utilities.checkString("filename",C);const h=await new Promise(f=>l.toBlob(f,"image/png")),S=await n(h,d);saveAs(S,C)},t.Cart.load=async function(l){const d=await(typeof l=="string"?(await fetch(l)).arrayBuffer():l.arrayBuffer()),C=new Uint8Array(d),h=e(C,o);h<0&&t.Utilities.fatal("Error Loading Cart: No BEEP8 trailer found");const S=C[h+5];S!==r&&t.Utilities.fatal(`Error Loading Cart: Unsupported version ${S}`);const f=i(C,h+6),g=h+10,E=g+f;E+4>C.length&&t.Utilities.fatal("Error Loading Cart: Trailer length out of range");const x=C.subarray(g,E),B=i(C,E);return u(x)!==B&&t.Utilities.fatal("Error Loading Cart: Bad payload CRC"),JSON.parse(new TextDecoder().decode(x))};async function n(l,d){const C=new TextEncoder().encode(JSON.stringify(d)),h=s.length+1+4+C.length+4,S=new Uint8Array(h);let f=0;S.set(s,f),f+=s.length,S[f++]=r,a(S,f,C.length),f+=4,S.set(C,f),f+=C.length,a(S,f,u(C)),f+=4;const g=new Uint8Array(await l.arrayBuffer());return new Blob([g,S],{type:"image/png"})}function e(l,d){const C=new TextEncoder().encode(d);for(let h=l.length-C.length;h>=0;h--){let S=!0;for(let f=0;f<C.length;f++)if(l[h+f]!==C[f]){S=!1;break}if(S)return h}return-1}function i(l,d){const C=l[d],h=l[d+1],S=l[d+2],f=l[d+3];return(C<<24|h<<16|S<<8|f)>>>0}function a(l,d,C){l[d]=C>>>24&255,l[d+1]=C>>>16&255,l[d+2]=C>>>8&255,l[d+3]=C&255}function u(l){let d=4294967295;for(let C=0;C<l.length;C++){d^=l[C];for(let h=0;h<8;h++)d&1?d=d>>>1^3988292384:d>>>=1}return~d>>>0}})(beep8),(function(t){t.Actors={},t.Actors.animations={idle:{frames:[0],fps:1},"idle-right":{frames:[1],fps:1},"idle-left":{frames:[-1],fps:1},"idle-up":{frames:[4],fps:1},"move-right":{frames:[1,2],fps:4,loop:!0},"move-left":{frames:[-1,-2],fps:4,loop:!0},"move-up":{frames:[5,-5],fps:4,loop:!0},"move-down":{frames:[3,-3],fps:4,loop:!0},"jump-right":{frames:[5],fps:1,loop:!1},"jump-left":{frames:[-5],fps:1,loop:!1},"spin-left":{frames:[0,1,4,-1],fps:4,loop:!0},"spin-right":{frames:[0,-1,4,1],fps:4,loop:!0}};const o=function(n,e,i,a,u){const l=t.TextRenderer.curActors_,d=n*l.getColCount()+Math.abs(s(e));t.TextRenderer.spr(d,i,a,l,u||0)};t.Actors.draw=function(n,e){t.Utilities.checkInt("ch",n),t.Utilities.checkString("animation",e);const a=s(e)>=0?0:1;o(n,e,t.Core.drawState.cursorCol*t.CONFIG.CHR_WIDTH,t.Core.drawState.cursorRow*t.CONFIG.CHR_HEIGHT,a||0)},t.Actors.spr=function(n,e,i,a,u=null){t.Utilities.checkInt("ch",n),t.Utilities.checkString("animation",e),t.Utilities.checkNumber("x",i),t.Utilities.checkNumber("y",a),u!==null&&t.Utilities.checkNumber("startTime",u);const l=s(e,u),d=t.Actors.animations[e],C=l>=0?0:1;return r(d,u)?(o(n,e,i,a,C||0),!0):!1};const s=function(n,e=null){t.Actors.animations[n]===void 0&&t.Utilities.fatal("Invalid animation: "+n),e===null&&(e=t.Core.startTime);const i=t.Actors.animations[n];let a=0;if(i.frames.length===1&&(a=i.frames[0]),i.frames.length>1){const u=t.Core.getNow()-e,l=i.frames.length,d=1/i.fps,C=Math.floor(u/1e3/d%l);a=i.frames[C]}return a},r=function(n,e){if(e===null||n.loop===!0)return!0;const i=n.frames.length*(1e3/n.fps);return!(t.Core.getNow()-e>=i)}})(beep8);const zzfx=(...t)=>zzfxP(zzfxG(...t)),zzfxV=.3,zzfxR=44100,zzfxX=new AudioContext,zzfxP=(...t)=>{let o=zzfxX.createBuffer(t.length,t[0].length,zzfxR),s=zzfxX.createBufferSource();return t.map((r,n)=>o.getChannelData(n).set(r)),s.buffer=o,s.connect(zzfxX.destination),s.start(),s},zzfxG=(t=1,o=.05,s=220,r=0,n=0,e=.1,i=0,a=1,u=0,l=0,d=0,C=0,h=0,S=0,f=0,g=0,E=0,x=1,B=0,v=0,N=0)=>{let I=Math.PI*2,R=X=>X<0?-1:1,y=u*=500*I/zzfxR/zzfxR,T=s*=(1+o*2*Math.random()-o)*I/zzfxR,D=[],m=0,A=0,w=0,k=1,F=0,M=0,U=0,_,Q,P=2,L=I*Math.abs(N)*2/zzfxR,G=Math.cos(L),O=Math.sin(L)/2/P,H=1+O,j=-2*G/H,Y=(1-O)/H,W=(1+R(N)*G)/2/H,$=-(R(N)+G)/H,V=W,z=0,J=0,K=0,q=0;for(r=r*zzfxR+9,B*=zzfxR,n*=zzfxR,e*=zzfxR,E*=zzfxR,l*=500*I/zzfxR**3,f*=I/zzfxR,d*=I/zzfxR,C*=zzfxR,h=h*zzfxR|0,t*=zzfxV,Q=r+B+n+e+E|0;w<Q;D[w++]=U*t)++M%(g*100|0)||(U=i?i>1?i>2?i>3?Math.sin(m**3):Math.max(Math.min(Math.tan(m),1),-1):1-(2*m/I%2+2)%2:1-4*Math.abs(Math.round(m/I)-m/I):Math.sin(m),U=(h?1-v+v*Math.sin(I*w/h):1)*R(U)*Math.abs(U)**a*(w<r?w/r:w<r+B?1-(w-r)/B*(1-x):w<r+B+n?x:w<Q-E?(Q-w-E)/e*x:0),U=E?U/2+(E>w?0:(w<Q-E?1:(Q-w)/E)*D[w-E|0]/2/t):U,N&&(U=q=V*z+$*(z=J)+W*(J=U)-Y*K-j*(K=q))),_=(s+=u+=l)*Math.cos(f*A++),m+=_+_*S*Math.sin(w**5),k&&++k>C&&(s+=d,T+=d,k=0),h&&!(++F%h)&&(s=T,u=y,k=k||1);return D};(function(){const t=new AudioContext,o=t.createGain();o.gain.value=1,o.connect(t.destination);let s={},r=null,n=[],e=[],i=0,a=125;const u=.5,l=50,d=.1;let C=!1;const h=(A,w)=>Math.sin(A*6.28+w),I=[A=>h(A,Math.pow(h(A,0),2)+h(A,.25)*.75+h(A,.5)*.1)*d,A=>Math.sin(A*6.28)*Math.sin(A*3.14)*d,A=>Math.sin(2*Math.PI*A)*d,A=>(2*(A-Math.floor(A))-1)*d,A=>(Math.sin(2*Math.PI*A)>=0?1:-1)*d,A=>{let w=A-Math.floor(A);return(2*Math.abs(2*w-1)-1)*d},A=>(Math.random()*2-1)*Math.exp(-A/10)*d,A=>(Math.sin(A*2)+.3*(Math.random()-.5))*Math.exp(-A/15)*d*2];function R(A){if(Array.isArray(A)&&(A=A[0]),!A||A.trim()===""){R.stop();return}s.length>200&&(console.warn("Beep8.Music: Note buffers exceeded limit, clearing old buffers."),s={}),a=125;let w=.5;n=[];const k=A.split(`
`).map(U=>U.trim());let F=a/1e3;const M=/^([0-9])\|(.*)\|$/;k.forEach(U=>{if(!U)return;if(U.startsWith("[")&&U.endsWith("]")||/^\d+(\.\d+)?$/.test(U)){const O=U.replace(/[\[\]]/g,"").split(".");a=parseFloat(O[0])||a,w=(parseFloat(O[1])||50)/100,F=a/1e3;return}if(!M.test(U)){console.error("Track lines must be in the format 'instrument|track data|': "+U);return}const _=U.match(M),Q=parseInt(_[1],10),P=I[Q]||I[0],L=_[2].trim();let G=[];for(let O=0;O<L.length;O++){const H=L[O];let j=1;for(;O+j<L.length&&L[O+j]==="-";)j++;let Y=O*F;if(H===" "){G.push({startTime:Y,noteBuffer:null}),O+=j-1;continue}let W=H.charCodeAt(0);W-=W>90?71:65;let $=j*w*(a/125),V=T(W,$,44100,P);G.push({startTime:Y,noteBuffer:V}),O+=j-1}n.push(G)}),e=n.map(()=>0),i=t.currentTime+.1,R.stop(),r=setInterval(y,l)}function y(){const A=t.currentTime,w=a/1e3,k=Math.max(u,w);n.forEach((F,M)=>{let U=e[M];const _=F.length;if(_===0)return;const Q=U%_,P=Math.floor(U/_),L=i+Q*w+P*_*w;if(L<A+k){const G=F[Q];G.noteBuffer&&m(G.noteBuffer,t,L),e[M]++}}),R.loop||n.every((M,U)=>e[U]>=M.length)&&R.stop()}R.stop=function(){r!==null&&(clearInterval(r),r=null),D.forEach(A=>A.stop()),D=[]},R.isPlaying=function(){return r!==null},R.setTempo=function(A){A<50&&(A=50);const w=a/1e3,k=A/1e3,M=(t.currentTime-i)/w;i=t.currentTime-M*k,a=A},R.setVolume=function(A){o.gain.value=Math.min(1,Math.max(0,A))},R.clearCache=function(){s={}},R.loop=!0;const T=(A,w,k,F)=>{const M=A+"-"+w+"-"+F.name;let U=s[M];if(A>=0&&!U){const _=65.406*Math.pow(1.06,A)/k,Q=Math.floor(k*w),P=88,L=k*(w-.002);U=s[M]=t.createBuffer(1,Q,k);const G=U.getChannelData(0);for(let O=0;O<Q;O++){let H;O<P?H=O/(P+.2):H=Math.pow(1-(O-P)/L,Math.pow(Math.log(1e4*_)/2,2)),G[O]=H*F(O*_)}C||(m(U,t,t.currentTime,!0),C=!0)}return U};let D=[];const m=(A,w,k,F=!1)=>{const M=w.createBufferSource();M.buffer=A,M.connect(o),M.start(k),D.push(M),F&&M.stop(),M.onended=()=>{const U=D.indexOf(M);U!==-1&&D.splice(U,1)}};window.p1=R})(),(function(t,o){"use strict";var s=Math.pow(2,-24),r=Math.pow(2,32),n=Math.pow(2,53);function e(u){var l=new ArrayBuffer(256),d=new DataView(l),C,h=0;function S(m){for(var A=l.byteLength,w=h+m;A<w;)A*=2;if(A!==l.byteLength){var k=d;l=new ArrayBuffer(A),d=new DataView(l);for(var F=h+3>>2,M=0;M<F;++M)d.setUint32(M*4,k.getUint32(M*4))}return C=m,d}function f(){h+=C}function g(m){f(S(8).setFloat64(h,m))}function E(m){f(S(1).setUint8(h,m))}function x(m){for(var A=S(m.length),w=0;w<m.length;++w)A.setUint8(h+w,m[w]);f()}function B(m){f(S(2).setUint16(h,m))}function v(m){f(S(4).setUint32(h,m))}function N(m){var A=m%r,w=(m-A)/r,k=S(8);k.setUint32(h,w),k.setUint32(h+4,A),f()}function I(m,A){A<24?E(m<<5|A):A<256?(E(m<<5|24),E(A)):A<65536?(E(m<<5|25),B(A)):A<4294967296?(E(m<<5|26),v(A)):(E(m<<5|27),N(A))}function R(m){var A;if(m===!1)return E(244);if(m===!0)return E(245);if(m===null)return E(246);if(m===o)return E(247);switch(typeof m){case"number":if(Math.floor(m)===m){if(0<=m&&m<=n)return I(0,m);if(-n<=m&&m<0)return I(1,-(m+1))}return E(251),g(m);case"string":var w=[];for(A=0;A<m.length;++A){var k=m.charCodeAt(A);k<128?w.push(k):k<2048?(w.push(192|k>>6),w.push(128|k&63)):k<55296?(w.push(224|k>>12),w.push(128|k>>6&63),w.push(128|k&63)):(k=(k&1023)<<10,k|=m.charCodeAt(++A)&1023,k+=65536,w.push(240|k>>18),w.push(128|k>>12&63),w.push(128|k>>6&63),w.push(128|k&63))}return I(3,w.length),x(w);default:var F;if(Array.isArray(m))for(F=m.length,I(4,F),A=0;A<F;++A)R(m[A]);else if(m instanceof Uint8Array)I(2,m.length),x(m);else{var M=Object.keys(m);for(F=M.length,I(5,F),A=0;A<F;++A){var U=M[A];R(U),R(m[U])}}}}if(R(u),"slice"in l)return l.slice(0,h);for(var y=new ArrayBuffer(h),T=new DataView(y),D=0;D<h;++D)T.setUint8(D,d.getUint8(D));return y}function i(u,l,d){var C=new DataView(u),h=0;typeof l!="function"&&(l=function(w){return w}),typeof d!="function"&&(d=function(){return o});function S(w,k){return h+=k,w}function f(w){return S(new Uint8Array(u,h,w),w)}function g(){var w=new ArrayBuffer(4),k=new DataView(w),F=v(),M=F&32768,U=F&31744,_=F&1023;if(U===31744)U=261120;else if(U!==0)U+=114688;else if(_!==0)return _*s;return k.setUint32(0,M<<16|U<<13|_<<13),k.getFloat32(0)}function E(){return S(C.getFloat32(h),4)}function x(){return S(C.getFloat64(h),8)}function B(){return S(C.getUint8(h),1)}function v(){return S(C.getUint16(h),2)}function N(){return S(C.getUint32(h),4)}function I(){return N()*r+N()}function R(){return C.getUint8(h)!==255?!1:(h+=1,!0)}function y(w){if(w<24)return w;if(w===24)return B();if(w===25)return v();if(w===26)return N();if(w===27)return I();if(w===31)return-1;throw"Invalid length encoding"}function T(w){var k=B();if(k===255)return-1;var F=y(k&31);if(F<0||k>>5!==w)throw"Invalid indefinite length element";return F}function D(w,k){for(var F=0;F<k;++F){var M=B();M&128&&(M<224?(M=(M&31)<<6|B()&63,k-=1):M<240?(M=(M&15)<<12|(B()&63)<<6|B()&63,k-=2):(M=(M&15)<<18|(B()&63)<<12|(B()&63)<<6|B()&63,k-=3)),M<65536?w.push(M):(M-=65536,w.push(55296|M>>10),w.push(56320|M&1023))}}function m(){var w=B(),k=w>>5,F=w&31,M,U;if(k===7)switch(F){case 25:return g();case 26:return E();case 27:return x()}if(U=y(F),U<0&&(k<2||6<k))throw"Invalid length";switch(k){case 0:return U;case 1:return-1-U;case 2:if(U<0){for(var _=[],Q=0;(U=T(k))>=0;)Q+=U,_.push(f(U));var P=new Uint8Array(Q),L=0;for(M=0;M<_.length;++M)P.set(_[M],L),L+=_[M].length;return P}return f(U);case 3:var G=[];if(U<0)for(;(U=T(k))>=0;)D(G,U);else D(G,U);return String.fromCharCode.apply(null,G);case 4:var O;if(U<0)for(O=[];!R();)O.push(m());else for(O=new Array(U),M=0;M<U;++M)O[M]=m();return O;case 5:var H={};for(M=0;M<U||U<0&&!R();++M){var j=m();H[j]=m()}return H;case 6:return l(m(),U);case 7:switch(U){case 20:return!1;case 21:return!0;case 22:return null;case 23:return o;default:return d(U)}}}var A=m();if(h!==u.byteLength)throw"Remaining bytes";return A}var a={encode:e,decode:i};typeof define=="function"&&define.amd?define("cbor/cbor",a):t.CBOR||(t.CBOR=a)})(this);
