"use strict";function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==_typeof(i)?i:i+""}function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function _regeneratorRuntime(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{define({},"")}catch(t){define=function define(t,e,r){return t[e]=r}}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,function(){return this});var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach(function(e){define(t,e,function(t){return this._invoke(e,t)})})}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then(function(t){invoke("next",t,i,a)},function(t){invoke("throw",t,i,a)}):e.resolve(h).then(function(t){u.value=t,i(u)},function(t){return invoke("throw",t,i,a)})}a(c.arg)}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e(function(e,r){invoke(t,n,e,r)})}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done}}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg)}}}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator["return"]&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next};return i.next=i}}throw new TypeError(_typeof(e)+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t},e.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,function(){return this}),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then(function(t){return t.done?t.value:a.next()})},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,function(){return this}),define(g,"toString",function(){return"[object Generator]"}),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next}return next.done=!0,next}},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y}},catch:function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var _n=0,F=function F(){};return{s:F,n:function n(){return _n>=r.length?{done:!0}:{done:!1,value:r[_n++]}},e:function e(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function s(){t=t.call(r)},n:function n(){var r=t.next();return a=r.done,r},e:function e(r){u=!0,o=r},f:function f(){try{a||null==t["return"]||t["return"]()}finally{if(u)throw o}}}}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise(function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)})}}function _readOnlyError(r){throw new TypeError('"'+r+'" is read-only')}var beep8={};(function(beep8){beep8.core={};var _textRenderer=null;var _inputSys=null;var _cursorRenderer=null;var _realCanvas=null;var _realCtx=null;var _canvas=null;var _ctx=null;var _deltaTime=0;Object.defineProperty(beep8.core,"textRenderer",{get:function get(){return _textRenderer},set:function set(value){_textRenderer=value}});Object.defineProperty(beep8.core,"inputSys",{get:function get(){return _inputSys},set:function set(value){_inputSys=value}});Object.defineProperty(beep8.core,"cursorRenderer",{get:function get(){return _cursorRenderer},set:function set(value){_cursorRenderer=value}});Object.defineProperty(beep8.core,"realCanvas",{get:function get(){return _realCanvas},set:function set(value){_realCanvas=value}});Object.defineProperty(beep8.core,"realCtx",{get:function get(){return _realCtx},set:function set(value){_realCtx=value}});Object.defineProperty(beep8.core,"canvas",{get:function get(){return _canvas},set:function set(value){_canvas=value}});Object.defineProperty(beep8.core,"ctx",{get:function get(){return _ctx},set:function set(value){_ctx=value}});Object.defineProperty(beep8.core,"deltaTime",{get:function get(){return _deltaTime},set:function set(value){_deltaTime=value}});var lastFrameTime=null;var crashed=false;beep8.core.drawState={fgColor:7,bgColor:0,cursorCol:0,cursorRow:0,cursorVisible:false};var initDone=false;var frameHandler=null;var frameHandlerTargetInterval=null;var animFrameRequested=false;var timeToNextFrame=0;var scanLinesEl=null;var pendingAsync=null;var dirty=false;beep8.core.init=function(callback){beep8.utilities.checkFunction("callback",callback);asyncInit(callback)};function asyncInit(_x){return _asyncInit.apply(this,arguments)}function _asyncInit(){_asyncInit=_asyncToGenerator(_regeneratorRuntime().mark(function _callee(callback){var _iterator,_step,className,container,containerSpec;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:beep8.utilities.log("Sys init.");CONFIG.SCREEN_WIDTH=CONFIG.SCREEN_COLS*CONFIG.CHR_WIDTH;CONFIG.SCREEN_HEIGHT=CONFIG.SCREEN_ROWS*CONFIG.CHR_HEIGHT;_realCanvas=document.createElement("canvas");if(CONFIG.CANVAS_SETTINGS&&CONFIG.CANVAS_SETTINGS.CANVAS_ID){_realCanvas.setAttribute("id",CONFIG.CANVAS_SETTINGS.CANVAS_ID)}if(CONFIG.CANVAS_SETTINGS&&CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES){_iterator=_createForOfIteratorHelper(CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES);try{for(_iterator.s();!(_step=_iterator.n()).done;){className=_step.value;_realCanvas.classList.add(className)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}_realCanvas.addEventListener("touchstart",function(e){return e.preventDefault()});container=document.body;if(CONFIG.CANVAS_SETTINGS&&CONFIG.CANVAS_SETTINGS.CONTAINER){containerSpec=CONFIG.CANVAS_SETTINGS.CONTAINER;if(typeof containerSpec==="string"){container=document.getElementById(containerSpec);if(!container){console.error("beep8: Could not find container element with ID: "+containerSpec);container=document.body}}else if(containerSpec instanceof HTMLElement){container=containerSpec}else{console.error("beep8: CONFIG.CANVAS_SETTINGS.CONTAINER must be either an ID of an HTMLElement.");container=document.body}}container.appendChild(_realCanvas);_canvas=document.createElement("canvas");_canvas.width=CONFIG.SCREEN_WIDTH;_canvas.height=CONFIG.SCREEN_HEIGHT;_canvas.style.width=CONFIG.SCREEN_WIDTH+"px";_canvas.style.height=CONFIG.SCREEN_HEIGHT+"px";_ctx=_canvas.getContext("2d");_ctx.imageSmoothingEnabled=false;_textRenderer=new TextRenderer;_inputSys=new InputSys;_cursorRenderer=new CursorRenderer;_context.next=22;return _textRenderer.initAsync();case 22:updateLayout(false);window.addEventListener("resize",function(){return updateLayout(true)});if(isMobile()){vjoy.setup()}initDone=true;_context.next=28;return new Promise(function(resolve){return setTimeout(resolve,1)});case 28:_context.next=30;return callback();case 30:render();case 31:case"end":return _context.stop()}},_callee)}));return _asyncInit.apply(this,arguments)}beep8.core.getContext=function(){return _ctx};beep8.core.preflight=function(apiMethod){if(crashed){throw new Error("Can't call API method ".concat(apiMethod,"() because the engine has crashed."))}if(!initDone){beep8.utilities.fatal("Can't call API method ".concat(apiMethod,"(): API not initialized. ")+"Call initAsync() wait until it finishes before calling API methods.")}if(pendingAsync){beep8.utilities.fatal("Can't call API method ".concat(apiMethod,"() because there is a pending async ")+"call to ".concat(pendingAsync.name,"() that hasn't finished running yet. Are you missing ")+"an 'await' keyword to wait for the async method? Use 'await ".concat(pendingAsync.name,"()',")+"not just '".concat(pendingAsync.name,"()'"))}};beep8.core.startAsync=function(asyncMethodName,resolve,reject){if(pendingAsync){throw new Error("Internal bug: startAsync called while pendingAsync is not null. "+"Missing preflight() call?")}pendingAsync={name:asyncMethodName,resolve:resolve,reject:reject};this.render()};beep8.core.hasPendingAsync=function(asyncMethodName){return pendingAsync&&pendingAsync.name===asyncMethodName};beep8.core.endAsyncImpl=function(asyncMethodName,isError,result){if(!pendingAsync){throw new Error("Internal bug: endAsync(".concat(asyncMethodName,") called with no pendingAsync"))}if(pendingAsync.name!==asyncMethodName){throw new Error("Internal bug: endAsync(".concat(asyncMethodName,") called but pendingAsync.name ")+"is ".concat(pendingAsync.name))}var fun=isError?pendingAsync.reject:pendingAsync.resolve;pendingAsync=null;fun(result)};beep8.core.resolveAsync=function(asyncMethodName,result){endAsyncImpl(asyncMethodName,false,result)};beep8.core.failAsync=function(asyncMethodName,error){endAsyncImpl(asyncMethodName,true,error)};beep8.core.setFrameHandler=function(callback,targetFps){frameHandler=callback;frameHandlerTargetInterval=1/(targetFps||30);timeToNextFrame=0;if(!animFrameRequested){window.requestAnimationFrame(doFrame)}};beep8.core.render=function(){if(crashed)return;_realCtx.imageSmoothingEnabled=false;_realCtx.clearRect(0,0,_realCanvas.width,_realCanvas.height);_realCtx.drawImage(_canvas,0,0,_realCanvas.width,_realCanvas.height);dirty=false;_cursorRenderer.drawCursor(_realCtx,_realCanvas.width,_realCanvas.height)};beep8.core.markDirty=function(){if(dirty)return;dirty=true;setTimeout(render,1)};beep8.core.cls=function(){_ctx.fillStyle=getColorHex(beep8.core.drawState.bgColor);_ctx.fillRect(0,0,_canvas.width,_canvas.height);this.setCursorLocation(0,0);markDirty()};beep8.core.defineColors=function(colors){beep8.utilities.checkArray("colors",colors);CONFIG.COLORS=colors.slice();_textRenderer.regenColors()};beep8.core.setColor=function(fg,bg){beep8.utilities.checkNumber("fg",fg);drawState.fgColor=Math.round(fg);if(bg!==undefined){beep8.utilities.checkNumber("bg",bg);drawState.bgColor=Math.round(bg)}};beep8.core.setCursorLocation=function(col,row){beep8.utilities.checkNumber("col",col);if(row!==undefined)beep8.utilities.checkNumber("row",row);drawState.cursorCol=Math.round(col);if(row!==undefined)drawState.cursorRow=Math.round(row)};beep8.core.getColorHex=function(c){if(typeof c!=="number")return"#f0f";if(c<0)return"#000";c=beep8.utilities.clamp(Math.round(c),0,CONFIG.COLORS.length-1);return CONFIG.COLORS[c]};beep8.core.getNow=function(){if(window.performace.now){return window.performance.now()}return(new Date).getTime()};beep8.core.drawImage=function(img,x,y,srcX,srcY,width,height){beep8.utilities.checkInstanceOf("img",img,HTMLImageElement);beep8.utilities.checkNumber("x",x);beep8.utilities.checkNumber("y",y);if(srcX!==undefined)beep8.utilities.checkNumber("srcX",srcX);if(srcY!==undefined)beep8.utilities.checkNumber("srcY",srcY);if(width!==undefined)beep8.utilities.checkNumber("width",width);if(height!==undefined)beep8.utilities.checkNumber("height",height);if(srcX!==undefined&&srcY!==undefined&&width!==undefined&&height!==undefined){_ctx.drawImage(img,srcX,srcY,width,height,x,y,width,height)}else{_ctx.drawImage(img,x,y)}};beep8.core.drawRect=function(x,y,width,height){beep8.utilities.checkNumber("x",x);beep8.utilities.checkNumber("y",y);beep8.utilities.checkNumber("width",width);beep8.utilities.checkNumber("height",height);var oldStrokeStyle=_ctx.strokeStyle;_ctx.strokeStyle=getColorHex(drawState.fgColor);_ctx.strokeRect(Math.round(x)+.5,Math.round(y)+.5,Math.round(width)-1,Math.round(height)-1);_ctx.strokeStyle=oldStrokeStyle};beep8.core.fillRect=function(x,y,width,height){beep8.utilities.checkNumber("x",x);beep8.utilities.checkNumber("y",y);beep8.utilities.checkNumber("width",width);beep8.utilities.checkNumber("height",height);_ctx.fillStyle=getColorHex(drawState.fgColor);_ctx.fillRect(Math.round(x)+.5,Math.round(y)+.5,Math.round(width)-1,Math.round(height)-1)};beep8.core.saveScreen=function(){return _ctx.getImageData(0,0,_canvas.width,_canvas.height)};beep8.core.restoreScreen=function(screenData){beep8.utilities.checkInstanceOf("screenData",screenData,ImageData);_ctx.putImageData(screenData,0,0)};function doFrame(){return _doFrame.apply(this,arguments)}function _doFrame(){_doFrame=_asyncToGenerator(_regeneratorRuntime().mark(function _callee2(){var now,numFramesDone;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:animFrameRequested=false;now=getNow();_deltaTime=lastFrameTime!==null?.001*(now-lastFrameTime):1/60;_deltaTime=Math.min(_deltaTime,.05);lastFrameTime=now;timeToNextFrame+=_deltaTime;numFramesDone=0;case 7:if(!(frameHandler&&numFramesDone<4&&timeToNextFrame>frameHandlerTargetInterval)){_context2.next=15;break}_context2.next=10;return frameHandler();case 10:_inputSys.onEndFrame();timeToNextFrame-=frameHandlerTargetInterval;++numFramesDone;_context2.next=7;break;case 15:render();if(frameHandler){animFrameRequested=true;window.requestAnimationFrame(doFrame)}case 17:case"end":return _context2.stop()}},_callee2)}));return _doFrame.apply(this,arguments)}beep8.core.updateLayout=function(renderNow){updateLayout2d();if(renderNow)render()};beep8.core.updateLayout2d=function(){var autoSize=!CONFIG.CANVAS_SETTINGS||CONFIG.CANVAS_SETTINGS.AUTO_SIZE;var autoPos=!CONFIG.CANVAS_SETTINGS||CONFIG.CANVAS_SETTINGS.AUTO_POSITION;var useAutoScale=typeof CONFIG.SCREEN_SCALE!=="number";var scale;if(useAutoScale){var frac=CONFIG.MAX_SCREEN_FRACTION||.8;var availableSize=autoSize?{width:frac*window.innerWidth,height:frac*window.innerHeight}:_realCanvas.getBoundingClientRect();scale=Math.floor(Math.min(availableSize.width/CONFIG.SCREEN_WIDTH,availableSize.height/CONFIG.SCREEN_HEIGHT));scale=Math.min(Math.max(scale,1),5);beep8.utilities.log("Auto-scale: available size ".concat(availableSize.width," x ").concat(availableSize.height,", scale ").concat(scale,", dpr ").concat(window.devicePixelRatio))}else{scale=CONFIG.SCREEN_SCALE}CONFIG.SCREEN_EL_WIDTH=CONFIG.SCREEN_WIDTH*scale;CONFIG.SCREEN_EL_HEIGHT=CONFIG.SCREEN_HEIGHT*scale;CONFIG.SCREEN_REAL_WIDTH=CONFIG.SCREEN_WIDTH*scale;CONFIG.SCREEN_REAL_HEIGHT=CONFIG.SCREEN_HEIGHT*scale;if(autoSize){_realCanvas.style.width=CONFIG.SCREEN_EL_WIDTH+"px";_realCanvas.style.height=CONFIG.SCREEN_EL_HEIGHT+"px";_realCanvas.width=CONFIG.SCREEN_REAL_WIDTH;_realCanvas.height=CONFIG.SCREEN_REAL_HEIGHT}else{var actualSize=_realCanvas.getBoundingClientRect();_realCanvas.width=actualSize.width;_realCanvas.height=actualSize.height}_realCtx=_realCanvas.getContext("2d");_realCtx.imageSmoothingEnabled=false;if(autoPos){_realCanvas.style.position="absolute";_realCanvas.style.left=Math.round((window.innerWidth-_realCanvas.width)/2)+"px";_realCanvas.style.top=Math.round((window.innerHeight-_realCanvas.height)/2)+"px"}var scanLinesOp=CONFIG.SCAN_LINES_OPACITY||0;if(scanLinesOp>0){if(autoPos&&autoSize){if(!scanLinesEl){scanLinesEl=document.createElement("div");document.body.appendChild(scanLinesEl)}scanLinesEl.style.background="linear-gradient(rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 1) 50%), "+"linear-gradient(90deg, rgba(255, 0, 0, .6), rgba(0, 255, 0, .2), rgba(0, 0, 255, .6))";scanLinesEl.style.backgroundSize="100% 4px, 3px 100%";scanLinesEl.style.opacity=scanLinesOp;scanLinesEl.style.position="absolute";scanLinesEl.style.left=_realCanvas.style.left;scanLinesEl.style.top=_realCanvas.style.top;scanLinesEl.style.width=_realCanvas.style.width;scanLinesEl.style.height=_realCanvas.style.height;scanLinesEl.style.zIndex=1}else{console.error("beep8: 2D scanlines effect only works if CONFIG.CANVAS_SETTINGS.AUTO_POS and AUTO_SIZE are both on.")}}};var crashing=false;beep8.core.handleCrash=function(){var errorMessage=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"Fatal error";if(crashed||crashing)return;crashing=true;setColor(CONFIG.COLORS.length-1,0);cls();drawState.cursorCol=drawState.cursorRow=1;_textRenderer.print("*** CRASH ***:\n"+errorMessage);render();crashing=false;crashed=true};beep8.core.isMobile=function(){return isIOS()||isAndroid()};beep8.core.isIOS=function(){return/(ipad|ipod|iphone)/i.test(navigator.userAgent)};beep8.core.isAndroid=function(){return/android/i.test(navigator.userAgent)}})(beep8||({},_readOnlyError("beep8")));(function(beep8){beep8.CursorRenderer=function(){function _class(){_classCallCheck(this,_class);this.blinkCycle_=0;this.toggleBlinkHandle_=null}return _createClass(_class,[{key:"setCursorVisible",value:function setCursorVisible(visible){var _this=this;beep8.utilities.checkBoolean("visible",visible);if(beep8.core.drawState.cursorVisible===visible)return;beep8.core.drawState.cursorVisible=visible;this.blinkCycle_=0;beep8.core.render();if(this.toggleBlinkHandle_!==null){clearInterval(this.toggleBlinkHandle_);this.toggleBlinkHandle_=null}if(visible){this.toggleBlinkHandle_=setInterval(function(){return _this.advanceBlink_()},CONFIG.CURSOR.BLINK_INTERVAL)}}},{key:"advanceBlink_",value:function advanceBlink_(){this.blinkCycle_=(this.blinkCycle_+1)%2;beep8.core.render()}},{key:"drawCursor",value:function drawCursor(targetCtx,canvasWidth,canvasHeight){beep8.utilities.checkInstanceOf("targetCtx",targetCtx,CanvasRenderingContext2D);beep8.utilities.checkNumber("canvasWidth",canvasWidth);beep8.utilities.checkNumber("canvasHeight",canvasHeight);if(!beep8.core.drawState.cursorVisible||this.blinkCycle_<=0)return;var ratio=canvasWidth/beep8.core.canvas.width;var realX=Math.round((beep8.core.drawState.cursorCol+.5-CONFIG.CURSOR.WIDTH_F/2+CONFIG.CURSOR.OFFSET_H)*CONFIG.CHR_WIDTH*ratio);var realY=Math.round((beep8.core.drawState.cursorRow+1-CONFIG.CURSOR.HEIGHT_F-CONFIG.CURSOR.OFFSET_V)*CONFIG.CHR_HEIGHT*ratio);targetCtx.fillStyle=beep8.core.getColorHex(beep8.core.drawState.fgColor);targetCtx.fillRect(realX,realY,Math.round(CONFIG.CURSOR.WIDTH_F*CONFIG.CHR_WIDTH*ratio),Math.round(CONFIG.CURSOR.HEIGHT_F*CONFIG.CHR_HEIGHT*ratio))}}])}()})(beep8||({},_readOnlyError("beep8")));(function(beep8){beep8.Input=function(){function _class2(){var _this2=this;_classCallCheck(this,_class2);this.keysHeld_=new Set;this.keysJustPressed_=new Set;window.addEventListener("keydown",function(e){return _this2.onKeyDown(e)});window.addEventListener("keyup",function(e){return _this2.onKeyUp(e)})}return _createClass(_class2,[{key:"keyHeld",value:function keyHeld(keyName){return this.keysHeld_.has(keyName.toUpperCase())}},{key:"keyJustPressed",value:function keyJustPressed(keyName){return this.keysJustPressed_.has(keyName.toUpperCase())}},{key:"onEndFrame",value:function onEndFrame(){this.keysJustPressed_.clear()}},{key:"onKeyDown",value:function onKeyDown(e){this.keysJustPressed_.add(e.key.toUpperCase());this.keysHeld_.add(e.key.toUpperCase());if(beep8.core.hasPendingAsync("beep8a.key")){beep8.core.resolveAsync("beep8a.key",e.key)}}},{key:"onKeyUp",value:function onKeyUp(e){this.keysHeld_["delete"](e.key.toUpperCase())}},{key:"readKeyAsync",value:function readKeyAsync(){return new Promise(function(resolve,reject){beep8.core.startAsync("beep8a.key",resolve,reject)})}},{key:"readLine",value:function(){var _readLine=_asyncToGenerator(_regeneratorRuntime().mark(function _callee3(initString,maxLen){var maxWidth,startCol,startRow,curCol,curRow,curStrings,curPos,cursorWasVisible,key,_args3=arguments;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:maxWidth=_args3.length>2&&_args3[2]!==undefined?_args3[2]:-1;startCol=beep8.core.drawState.cursorCol;startRow=beep8.core.drawState.cursorRow;curCol=startCol;curRow=startRow;curStrings=[initString];curPos=0;cursorWasVisible=beep8.core.drawState.cursorVisible;beep8.core.cursorRenderer.setCursorVisible(true);case 9:if(!true){_context3.next=35;break}beep8.core.setCursorLocation(curCol,curRow);beep8.core.textRenderer.print(curStrings[curPos]||"");_context3.next=14;return this.readKeyAsync();case 14:key=_context3.sent;if(!(key==="Backspace")){_context3.next=26;break}if(!(curStrings[curPos].length===0)){_context3.next=21;break}if(!(curPos===0)){_context3.next=19;break}return _context3.abrupt("continue",9);case 19:curPos--;curRow--;case 21:curStrings[curPos]=curStrings[curPos].length>0?curStrings[curPos].substring(0,curStrings[curPos].length-1):curStrings[curPos];beep8.core.setCursorLocation(curCol+curStrings[curPos].length,curRow);beep8.core.textRenderer.print(" ");_context3.next=33;break;case 26:if(!(key==="Enter")){_context3.next=32;break}beep8.core.setCursorLocation(1,curRow+1);beep8.core.cursorRenderer.setCursorVisible(cursorWasVisible);return _context3.abrupt("return",curStrings.join(""));case 32:if(key.length===1){if(curStrings.join("").length<maxLen||maxLen===-1){curStrings[curPos]+=key;if(maxWidth!==-1&&curStrings[curPos].length>=maxWidth){beep8.core.textRenderer.print(curStrings[curPos].charAt(curStrings[curPos].length-1));curCol=startCol;curPos++;curStrings[curPos]="";curRow++}}}case 33:_context3.next=9;break;case 35:case"end":return _context3.stop()}},_callee3,this)}));function readLine(_x2,_x3){return _readLine.apply(this,arguments)}return readLine}()}])}()})(beep8||({},_readOnlyError("beep8")));(function(beep8){beep8.menu.add=function(){var _ref=_asyncToGenerator(_regeneratorRuntime().mark(function _callee4(choices,options){var startCol,startRow,promptSize,prompt01,border01,choicesCols,choicesRows,totalCols,totalRows,t,selIndex,k;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:options=options||{};beep8.utilities.checkArray("choices",choices);beep8.utilities.checkObject("options",options);options=Object.assign({title:"",prompt:"",selBgColor:beep8.core.drawState.fgColor,selFgColor:beep8.core.drawState.bgColor,bgChar:32,borderChar:128,center:false,centerH:false,centerV:false,padding:1,selIndex:0,cancelable:false},options);startCol=beep8.core.drawState.cursorCol;startRow=beep8.core.drawState.cursorRow;promptSize=beep8.core.textRenderer.measure(options.prompt);prompt01=options.prompt?1:0;border01=options.borderChar?1:0;choicesCols=0;choicesRows=choices.length;choices.forEach(function(choice){return choicesCols=Math.max(choicesCols,choice.length)});totalCols=Math.max(promptSize.cols,choicesCols)+2*options.padding+2*border01;totalRows=prompt01*(promptSize.rows+1)+choicesRows+2*options.padding+2*border01;if(options.centerH||options.center){startCol=Math.round((CONFIG.SCREEN_COLS-totalCols)/2)}if(options.centerV||options.center){startRow=Math.round((CONFIG.SCREEN_ROWS-totalRows)/2)}beep8.core.drawState.cursorCol=startCol;beep8.core.drawState.cursorRow=startRow;beep8.core.textRenderer.printRect(totalCols,totalRows,options.bgChar);if(options.borderChar){beep8.core.textRenderer.printBox(totalCols,totalRows,false,options.borderChar);if(options.title){t=" "+options.title+" ";beep8.core.drawState.cursorCol=startCol+Math.round((totalCols-t.length)/2);beep8.core.textRenderer.print(t)}}if(options.prompt){beep8.core.drawState.cursorCol=promptSize.cols<=totalCols?startCol+border01+options.padding:startCol+Math.round((totalCols-promptSize.cols)/2);beep8.core.drawState.cursorRow=startRow+border01+options.padding;beep8.core.textRenderer.print(options.prompt)}selIndex=options.selIndex;case 22:if(!true){_context4.next=45;break}beep8.core.drawState.cursorRow=startRow+border01+options.padding+prompt01*(promptSize.rows+1);beep8.core.drawState.cursorCol=promptSize.cols<=choicesCols?startCol+border01+options.padding:startCol+Math.round((totalCols-choicesCols)/2);printChoices(choices,selIndex,options);_context4.next=28;return beep8.core.inputSys.readKeyAsync();case 28:k=_context4.sent;if(!(k==="ArrowUp")){_context4.next=33;break}selIndex=selIndex>0?selIndex-1:choices.length-1;_context4.next=43;break;case 33:if(!(k==="ArrowDown")){_context4.next=37;break}selIndex=(selIndex+1)%choices.length;_context4.next=43;break;case 37:if(!(k==="Enter"||k==="ButtonA")){_context4.next=41;break}return _context4.abrupt("return",selIndex);case 41:if(!((k==="Escape"||k==="ButtonB")&&options.cancelable)){_context4.next=43;break}return _context4.abrupt("return",-1);case 43:_context4.next=22;break;case 45:case"end":return _context4.stop()}},_callee4)}));return function(_x4,_x5){return _ref.apply(this,arguments)}}();beep8.menu.printChoices=function(choices,selIndex,options){var origBg=beep8.core.drawState.bgColor;var origFg=beep8.core.drawState.fgColor;for(var i=0;i<choices.length;i++){var isSel=i===selIndex;beep8.core.setColor(isSel?options.selFgColor:origFg,isSel?options.selBgColor:origBg);beep8.core.textRenderer.print(choices[i]+"\n")}beep8.core.setColor(origFg,origBg)}})(beep8||({},_readOnlyError("beep8")));(function(beep8){beep8.TextRenderer=function(){function _class3(){_classCallCheck(this,_class3);this.fonts_={};this.curFont_=null}return _createClass(_class3,[{key:"initAsync",value:function(){var _initAsync=_asyncToGenerator(_regeneratorRuntime().mark(function _callee5(){var defaultFont,actualCharWidth,actualCharHeight;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:beep8.utilities.log("TextRenderer init.");defaultFont=new TextRendererFont("default",CONFIG.CHR_FILE);_context5.next=4;return defaultFont.initAsync();case 4:actualCharWidth=defaultFont.getCharWidth();actualCharHeight=defaultFont.getCharHeight();beep8.utilities.assert(actualCharWidth===defaultFont.getCharWidth()&&actualCharHeight===defaultFont.getCharHeight(),"The character image ".concat(CONFIG.CHR_FILE," should be a 16x16 grid of characters with ")+"dimensions 16 * CONFIG.CHR_WIDTH, 16 * CONFIG.CHR_HEIGHT = "+"".concat(16*CONFIG.CHR_WIDTH," x ").concat(16*CONFIG.CHR_HEIGHT));this.fonts_["default"]=defaultFont;this.curFont_=defaultFont;case 9:case"end":return _context5.stop()}},_callee5,this)}));function initAsync(){return _initAsync.apply(this,arguments)}return initAsync}()},{key:"loadFontAsync",value:function(){var _loadFontAsync=_asyncToGenerator(_regeneratorRuntime().mark(function _callee6(fontName,fontImageFile){var font;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:beep8.utilities.checkString("fontName",fontName);beep8.utilities.checkString("fontImageFile",fontImageFile);font=new TextRendererFont(fontName,fontImageFile);_context6.next=5;return font.initAsync();case 5:this.fonts_[fontName]=font;case 6:case"end":return _context6.stop()}},_callee6,this)}));function loadFontAsync(_x6,_x7){return _loadFontAsync.apply(this,arguments)}return loadFontAsync}()},{key:"setFont",value:function setFont(fontName){beep8.utilities.checkString("fontName",fontName);var font=this.fonts_[fontName];if(!font){beep8.utilities.fatal("setFont(): font not found: ".concat(fontName));return}var cw=font.getCharWidth();var ch=font.getCharHeight();if(cw%CONFIG.CHR_WIDTH!==0||ch%CONFIG.CHR_HEIGHT!==0){beep8.utilities.fatal("setFont(): font ".concat(fontName," has character size ").concat(cw,"x").concat(ch,", ")+"which is not an integer multiple of CONFIG.CHR_WIDTH x CONFIG.CHR_HEIGHT = "+"".concat(CONFIG.CHR_WIDTH,"x").concat(CONFIG.CHR_HEIGHT,", so it can't be set as the ")+"current font due to the row,column system. However, you can still use it "+"directly with drawText() by passing it as a parameter to that function.");return}this.curFont_=font}},{key:"print",value:function print(text){beep8.utilities.checkString("text",text);var col=beep8.core.drawState.cursorCol;var row=beep8.core.drawState.cursorRow;this.origFgColor_=beep8.core.drawState.fgColor;this.origBgColor_=beep8.core.drawState.bgColor;var colInc=Math.floor(this.curFont_.getCharWidth()/CONFIG.CHR_WIDTH);var rowInc=Math.floor(this.curFont_.getCharHeight()/CONFIG.CHR_HEIGHT);var initialCol=col;for(var i=0;i<text.length;i++){i=this.processEscapeSeq_(text,i);var ch=text.charCodeAt(i);if(ch===10){col=initialCol;row+=rowInc}else{this.put_(ch,col,row,beep8.core.drawState.fgColor,beep8.core.drawState.bgColor);col+=colInc}}beep8.core.drawState.cursorCol=col;beep8.core.drawState.cursorRow=row;beep8.core.drawState.fgColor=this.origFgColor_;beep8.core.drawState.bgColor=this.origBgColor_;beep8.core.markDirty()}},{key:"printCentered",value:function printCentered(text,width){beep8.utilities.checkString("text",text);beep8.utilities.checkNumber("width",width);text=text.split("\n")[0];if(!text)return;var textWidth=this.measure(text).cols;var col=Math.floor(beep8.core.drawState.cursorCol+(width-textWidth)/2);beep8.core.drawState.cursorCol=col;this.print(text)}},{key:"printChar",value:function printChar(ch,n){if(n===undefined||isNaN(n))n=1;beep8.utilities.checkNumber("ch",ch);beep8.utilities.checkNumber("n",n);while(n-- >0){this.put_(ch,beep8.core.drawState.cursorCol,beep8.core.drawState.cursorRow,beep8.core.drawState.fgColor,beep8.core.drawState.bgColor);beep8.core.drawState.cursorCol++}beep8.core.markDirty()}},{key:"spr",value:function spr(ch,x,y){beep8.utilities.checkNumber("ch",ch);beep8.utilities.checkNumber("x",x);beep8.utilities.checkNumber("y",y);this.putxy_(ch,x,y,beep8.core.drawState.fgColor,beep8.core.drawState.bgColor)}},{key:"drawText",value:function drawText(x,y,text,fontName){beep8.utilities.checkNumber("x",x);beep8.utilities.checkNumber("y",y);beep8.utilities.checkString("text",text);if(fontName)beep8.utilities.checkString("fontName",fontName);var x0=x;var font=fontName?this.fonts_[fontName]||this.curFont_:this.curFont_;if(!font){beep8.utilities.warn("Requested font '".concat(fontName,"' not found: not drawing text."));return}for(var i=0;i<text.length;i++){var ch=text.charCodeAt(i);if(ch===10){x=x0;y+=font.getCharHeight()}else{this.putxy_(ch,x,y,beep8.core.drawState.fgColor,beep8.core.drawState.bgColor,font);x+=font.getCharWidth()}}}},{key:"measure",value:function measure(text){beep8.utilities.checkString("text",text);if(text==="")return{cols:0,rows:0};var rows=1;var thisLineWidth=0;var cols=0;for(var i=0;i<text.length;i++){i=this.processEscapeSeq_(text,i,true);var ch=text.charCodeAt(i);if(ch===10){rows++;thisLineWidth=0}else{++thisLineWidth;cols=Math.max(cols,thisLineWidth)}}return{cols:cols,rows:rows}}},{key:"printRect",value:function printRect(width,height,ch){beep8.utilities.checkNumber("width",width);beep8.utilities.checkNumber("height",height);beep8.utilities.checkNumber("ch",ch);var startCol=beep8.core.drawState.cursorCol;var startRow=beep8.core.drawState.cursorRow;for(var i=0;i<height;i++){beep8.core.drawState.cursorCol=startCol;beep8.core.drawState.cursorRow=startRow+i;this.printChar(ch,width)}beep8.core.drawState.cursorCol=startCol;beep8.core.drawState.cursorRow=startRow}},{key:"printBox",value:function printBox(width,height,fill,borderCh){var borderNW=borderCh;var borderNE=borderCh+1;var borderSW=borderCh+2;var borderSE=borderCh+3;var borderV=borderCh+4;var borderH=borderCh+5;beep8.utilities.checkNumber("width",width);beep8.utilities.checkNumber("height",height);beep8.utilities.checkBoolean("fill",fill);beep8.utilities.checkNumber("borderCh",borderCh);var startCol=beep8.core.drawState.cursorCol;var startRow=beep8.core.drawState.cursorRow;for(var i=0;i<height;i++){beep8.core.drawState.cursorCol=startCol;beep8.core.drawState.cursorRow=startRow+i;if(i===0){this.printChar(borderNW);this.printChar(borderH,width-2);this.printChar(borderNE)}else if(i===height-1){this.printChar(borderSW);this.printChar(borderH,width-2);this.printChar(borderSE)}else{this.printChar(borderV);beep8.core.drawState.cursorCol=startCol+width-1;this.printChar(borderV)}}if(fill&&width>2&&height>2){beep8.core.drawState.cursorCol=startCol+1;beep8.core.drawState.cursorRow=startRow+1;this.printRect(width-2,height-2,32)}beep8.core.drawState.cursorCol=startCol;beep8.core.drawState.cursorRow=startRow}},{key:"put_",value:function put_(ch,col,row,fgColor,bgColor){var chrW=CONFIG.CHR_WIDTH;var chrH=CONFIG.CHR_HEIGHT;var x=Math.round(col*chrW);var y=Math.round(row*chrH);this.putxy_(ch,x,y,fgColor,bgColor)}},{key:"putxy_",value:function putxy_(ch,x,y,fgColor,bgColor){var font=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;font=font||this.curFont_;var chrW=font.getCharWidth();var chrH=font.getCharHeight();var fontRow=Math.floor(ch/16);var fontCol=ch%16;x=Math.round(x);y=Math.round(y);if(bgColor>=0){beep8.core.ctx.fillStyle=beep8.core.getColorHex(bgColor);beep8.core.ctx.fillRect(x,y,chrW,chrH)}var color=beep8.utilities.clamp(fgColor,0,CONFIG.COLORS.length-1);var img=font.getImageForColor(color);beep8.core.ctx.drawImage(img,fontCol*chrW,fontRow*chrH,chrW,chrH,x,y,chrW,chrH);beep8.core.markDirty()}},{key:"processEscapeSeq_",value:function processEscapeSeq_(text,startPos){var pretend=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var startSeq=CONFIG.PRINT_ESCAPE_START;var endSeq=CONFIG.PRINT_ESCAPE_END;if(!startSeq||!endSeq)return startPos;if(text.substring(startPos,startPos+startSeq.length)!=startSeq){return startPos}var endPos=text.indexOf(endSeq,startPos+startSeq.length);if(!pretend){var command=text.substring(startPos+startSeq.length,endPos);this.runEscapeCommand_(command)}return endPos+endSeq.length}},{key:"runEscapeCommand_",value:function runEscapeCommand_(command){if(command.indexOf(",")>0){var parts=command.split(",");var _iterator2=_createForOfIteratorHelper(parts),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var part=_step2.value;this.runEscapeCommand_(part)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return}command=command.trim();if(command==="")return;var verb=command[0].toLowerCase();var arg=command.substring(1);var argNum=1*arg;switch(verb){case"f":case"c":beep8.core.drawState.fgColor=arg!==""?argNum:this.origFgColor_;break;case"b":beep8.core.drawState.bgColor=arg!==""?argNum:this.origBgColor_;break;case"z":beep8.core.drawState.fgColor=this.origFgColor_;beep8.core.drawState.bgColor=this.origBgColor_;break;default:console.warn("Unknown beep8 print escape command: "+command)}}},{key:"regenColors",value:function regenColors(){Object.values(this.fonts_).forEach(function(f){return f.regenColors()})}}])}();beep8.TextRenderer=TextRenderer})(beep8||({},_readOnlyError("beep8")));(function(beep8){beep8.TextRendererFont=function(){function _class4(fontName,fontImageFile){_classCallCheck(this,_class4);beep8.utilities.checkString("fontName",fontName);beep8.utilities.checkString("fontImageFile",fontImageFile);this.fontName_=fontName;this.fontImageFile_=fontImageFile;this.origImg_=null;this.chrImages_=[];this.charWidth_=0;this.charHeight_=0;this.origFgColor_=0;this.origBgColor_=0}return _createClass(_class4,[{key:"getCharWidth",value:function getCharWidth(){return this.charWidth_}},{key:"getCharHeight",value:function getCharHeight(){return this.charHeight_}},{key:"getImageForColor",value:function getImageForColor(colorNumber){return this.chrImages_[colorNumber]}},{key:"initAsync",value:function(){var _initAsync2=_asyncToGenerator(_regeneratorRuntime().mark(function _callee7(){return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:beep8.utilities.log("Building font ".concat(this.fontName_," from image ").concat(this.fontImageFile_));_context7.next=3;return beep8.utilities.loadImageAsync(this.fontImageFile_);case 3:this.origImg_=_context7.sent;beep8.utilities.assert(this.origImg_.width%16===0&&this.origImg_.height%16===0,"Font ".concat(this.fontName_,": image ").concat(this.fontImageFile_," has dimensions ")+"".concat(this.origImg_.width,"x").concat(this.origImg_.height,". It must ")+"have dimensions that are multiples of 16 (16x16 grid of characters).");this.charWidth_=Math.floor(this.origImg_.width/16);this.charHeight_=Math.floor(this.origImg_.height/16);this.regenColors();case 8:case"end":return _context7.stop()}},_callee7,this)}));function initAsync(){return _initAsync2.apply(this,arguments)}return initAsync}()},{key:"regenColors",value:function regenColors(){var tempCanvas=document.createElement("canvas");tempCanvas.width=this.origImg_.width;tempCanvas.height=this.origImg_.height;var ctx=tempCanvas.getContext("2d");this.chrImages_=[];for(var c=0;c<CONFIG.COLORS.length;c++){beep8.utilities.log("Initializing font ".concat(this.fontName_,", color ").concat(c," = ").concat(CONFIG.COLORS[c]));ctx.clearRect(0,0,this.origImg_.width,this.origImg_.height);ctx.globalCompositeOperation="source-over";ctx.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height);ctx.globalCompositeOperation="source-in";ctx.fillStyle=CONFIG.COLORS[c];ctx.fillRect(0,0,this.origImg_.width,this.origImg_.height);var thisImg=new Image;thisImg.src=tempCanvas.toDataURL();this.chrImages_.push(thisImg)}}}])}()})(beep8||({},_readOnlyError("beep8")));(function(beep8){beep8.utilities.fatal=function(error){console.error("Fatal error: "+error);try{beep8.core.handleCrash(error)}catch(e){console.error("Error in beep8.core.handleCrash: "+e+" while handling error "+error)}throw new Error("Error: "+error)};beep8.utilities.assert=function(cond,msg){if(!cond){fatal(msg||"Assertion Failed")}return cond};beep8.utilities.assertDebug=function(cond,msg){if(!cond){if(CONFIG.DEBUG){warn("DEBUG ASSERT failed: "+msg)}else{fatal(msg)}}return cond};beep8.utilities.assertEquals=function(expected,actual,what){if(expected!==actual){fatal("".concat(what,": expected ").concat(expected," but got ").concat(actual))}return actual};beep8.utilities.checkType=function(varName,varValue,varType){assert(varName,"checkType: varName must be provided.");assert(varType,"checkType: varType must be provided.");assert(_typeof(varValue)===varType,"".concat(varName," should be of type ").concat(varType," but was ").concat(_typeof(varValue),": ").concat(varValue));return varValue};beep8.utilities.checkNumber=function(varName,varValue,optMin,optMax){checkType(varName,varValue,"number");if(isNaN(varValue)){fatal("".concat(varName," should be a number but is NaN"))}if(!isFinite(varValue)){fatal("".concat(varName," should be a number but is infinite: ").concat(varValue))}if(optMin!==undefined){assert(varValue>=optMin,"".concat(varName," should be >= ").concat(optMin," but is ").concat(varValue))}if(optMax!==undefined){assert(varValue<=optMax,"".concat(varName," should be <= ").concat(optMax," but is ").concat(varValue))}return varValue};beep8.utilities.checkString=function(varName,varValue){return checkType(varName,varValue,"string")};beep8.utilities.checkBoolean=function(varName,varValue){return checkType(varName,varValue,"boolean")};beep8.utilities.checkFunction=function(varName,varValue){return checkType(varName,varValue,"function")};beep8.utilities.checkObject=function(varName,varValue){if(varValue===null){fatal("".concat(varName," should be an object, but was null"))}return checkType(varName,varValue,"object")};beep8.utilities.checkInstanceOf=function(varName,varValue,expectedClass){assert(varValue instanceof expectedClass,"".concat(varName," should be an instance of ").concat(expectedClass.name," but was not, it's: ").concat(varValue));return varValue};beep8.utilities.checkArray=function(varName,varValue){assert(Array.isArray(varValue),"".concat(varName," should be an array, but was: ").concat(varValue));return varValue};var log=CONFIG.DEBUG?console.log:function(){};var warn=console.warn;var error=console.error;beep8.utilities.loadImageAsync=function(){var _ref2=_asyncToGenerator(_regeneratorRuntime().mark(function _callee8(src){return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:return _context8.abrupt("return",new Promise(function(resolver){var img=new Image;img.onload=function(){return resolver(img)};img.src=src}));case 1:case"end":return _context8.stop()}},_callee8)}));return function(_x8){return _ref2.apply(this,arguments)}}();beep8.utilities.loadFileAsync=function(url){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.addEventListener("load",function(){if(xhr.status<200||xhr.status>299){reject("HTTP request finished with status "+xhr.status)}else{resolve(xhr.responseText)}});xhr.addEventListener("error",function(e){return reject(e)});xhr.open("GET",url);xhr.send()})};beep8.utilities.clamp=function(x,lo,hi){return Math.min(Math.max(x,lo),hi)};beep8.utilities.randomInt=function(lowInclusive,highInclusive){checkNumber("lowInclusive",lowInclusive);checkNumber("highInclusive",highInclusive);lowInclusive=Math.round(lowInclusive);highInclusive=Math.round(highInclusive);if(highInclusive<=lowInclusive)return lowInclusive;return clamp(Math.floor(Math.random()*(highInclusive-lowInclusive+1))+lowInclusive,lowInclusive,highInclusive)};beep8.utilities.randomPick=function(array){checkArray("array",array);return array.length>0?array[randomInt(0,array.length-1)]:null};beep8.utilities.shuffleArray=function(array){checkArray("array",array);array=array.slice();for(var i=0;i<array.length;i++){var j=randomInt(0,array.length-1);var tmp=array[i];array[i]=array[j];array[j]=tmp}return array};beep8.utilities.dist2d=function(x0,y0,x1,y1){checkNumber("x0",x0);checkNumber("y0",y0);checkNumber("x1",x1);checkNumber("y1",y1);var dx=x0-x1;var dy=y0-y1;return Math.sqrt(dx*dx+dy*dy)};beep8.utilities.intersectIntervals=function(as,ae,bs,be){var result=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;checkNumber("as",as);checkNumber("ae",ae);checkNumber("bs",bs);checkNumber("be",be);if(result)checkObject("result",result);var start=Math.max(as,bs);var end=Math.min(ae,be);if(end>=start){if(result){result.start=start;result.end=end}return true}return false};beep8.utilities.intersectRects=function(r1,r2){var dx1=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var dy1=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var dx2=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var dy2=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var result=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;checkObject("r1",r1);checkObject("r2",r2);checkNumber("r1.x",r1.x);checkNumber("r1.y",r1.y);checkNumber("r1.w",r1.w);checkNumber("r1.h",r1.h);checkNumber("r2.x",r2.x);checkNumber("r2.y",r2.y);checkNumber("r2.w",r2.w);checkNumber("r2.h",r2.h);checkNumber("dx1",dx1);checkNumber("dx2",dx2);checkNumber("dy1",dy1);checkNumber("dy2",dy2);if(result)checkObject("result",result);var xint=intersectRects_xint;var yint=intersectRects_yint;if(!intersectIntervals(r1.x+dx1,r1.x+dx1+r1.w-1,r2.x+dx2,r2.x+dx2+r2.w-1,xint)){return false}if(!intersectIntervals(r1.y+dy1,r1.y+dy1+r1.h-1,r2.y+dy2,r2.y+dy2+r2.h-1,yint)){return false}if(result){result.x=xint.start;result.w=xint.end-xint.start+1;result.y=yint.start;result.h=yint.end-yint.start+1}return true};var intersectRects_xint={};var intersectRects_yint={};beep8.utilities={fatal:fatal,assert:assert,assertDebug:assertDebug,assertEquals:assertEquals,checkType:checkType,checkNumber:checkNumber,checkString:checkString,checkBoolean:checkBoolean,checkFunction:checkFunction,checkObject:checkObject,checkInstanceOf:checkInstanceOf,checkArray:checkArray,log:log,warn:warn,error:error,loadImageAsync:loadImageAsync,loadFileAsync:loadFileAsync,clamp:clamp,randomInt:randomInt,randomPick:randomPick,shuffleArray:shuffleArray,dist2d:dist2d,intersectIntervals:intersectIntervals,intersectRects:intersectRects}})(beep8||({},_readOnlyError("beep8")));(function(beep8){var LEFT_VJOY_HTML="\n\t\t<div id='vjoy-button-up' class='vjoy-button'></div>\n\t\t<div id='vjoy-button-down' class='vjoy-button'></div>\n\t\t<div id='vjoy-button-left' class='vjoy-button'></div>\n\t\t<div id='vjoy-button-right' class='vjoy-button'></div>\n\t";var RIGHT_VJOY_HTML="\n\t\t<div id='vjoy-button-pri' class='vjoy-button'>A</div>\n\t\t<div id='vjoy-button-sec' class='vjoy-button'>B</div>\n\t\t<div id='vjoy-button-ter' class='vjoy-button'>=</div>\n\t";var VJOY_CSS="\n\t\t* {\n\t\t\tuser-select: none;\n\t\t\t-webkit-user-select: none;\n\t\t\t-webkit-touch-callout: none;\n\t\t}\n\n\t\t#vjoy-scrim {\n\t\t\tposition: fixed;\n\t\t\tleft: 0;\n\t\t\tright: 0;\n\t\t\tbottom: 0;\n\t\t\ttop: 0;\n\t\t\tpointer-events: all;\n\t\t}\n\n\t\t#vjoy-container-left {\n\t\t\tbox-sizing: border-box;\n\t\t\tposition: fixed;\n\t\t\tbottom: 16px;\n\t\t\tleft: 16px;\n\t\t\twidth: 40vmin;\n\t\t\theight: 40vmin;\n\t\t\tuser-select: none;\n\t\t\ttouch-callout: none;\n\t\t\t-webkit-user-select: none;\n\t\t\t-webkit-touch-callout: none;\n\t\t}\n\n\t\t#vjoy-container-right {\n\t\t\tbox-sizing: border-box;\n\t\t\tposition: fixed;\n\t\t\tbottom: 16px;\n\t\t\tright: 16px;\n\t\t\twidth: 40vmin;\n\t\t\theight: 40vmin;\n\t\t\tuser-select: none;\n\t\t\ttouch-callout: none;\n\t\t\t-webkit-user-select: none;\n\t\t\t-webkit-touch-callout: none;\n\t\t}\n\n\t\t.vjoy-button {\n\t\t\tdisplay: flex;\n\t\t\tflex-direction: row;\n\t\t\talign-items: center;\n\t\t\tjustify-content: center;\n\t\t\tbackground: #444;\n\t\t\tborder: none;\n\t\t\tfont: bold 14px monospace;\n\t\t\tcolor: #888;\n\t\t\tuser-select: none;\n\t\t\ttouch-callout: none;\n\t\t\t-webkit-user-select: none;\n\t\t\t-webkit-touch-callout: none;\n\t\t}\n\t\t.vjoy-button:active {\n\t\t\tbackground: #888;\n\t\t}\n\n\t\t#vjoy-button-up {\n\t\t\tposition: absolute;\n\t\t\tleft: 30%;\n\t\t\ttop: 0px;\n\t\t\twidth: 40%;\n\t\t\theight: 45%;\n\t\t\tborder-radius: 0px 0px 50% 50%;\n\t\t}\n\n\t\t#vjoy-button-down {\n\t\t\tposition: absolute;\n\t\t\tleft: 30%;\n\t\t\tbottom: 0px;\n\t\t\twidth: 40%;\n\t\t\theight: 45%;\n\t\t\tborder-radius: 50% 50% 0px 0px;\n\t\t}\n\n\t\t#vjoy-button-left {\n\t\t\tposition: absolute;\n\t\t\tleft: 0px;\n\t\t\tbottom: 30%;\n\t\t\twidth: 45%;\n\t\t\theight: 40%;\n\t\t\tborder-radius: 0px 50% 50% 0px;\n\t\t}\n\n\t\t#vjoy-button-right {\n\t\t\tposition: absolute;\n\t\t\tright: 0px;\n\t\t\tbottom: 30%;\n\t\t\twidth: 45%;\n\t\t\theight: 40%;\n\t\t\tborder-radius: 50% 0px 0px 50%;\n\t\t}\n\n\t\t#vjoy-button-pri {\n\t\t\tposition: absolute;\n\t\t\tright: 0px;\n\t\t\ttop: 30%;\n\t\t\twidth: 50%;\n\t\t\theight: 50%;\n\t\t\tborder-radius: 50%;\n\t\t}\n\n\t\t#vjoy-button-sec {\n\t\t\tposition: absolute;\n\t\t\tleft: 0px;\n\t\t\ttop: 30%;\n\t\t\twidth: 50%;\n\t\t\theight: 50%;\n\t\t\tborder-radius: 50%;\n\t\t}\n\n\t\t#vjoy-button-ter {\n\t\t\tposition: fixed;\n\t\t\tright: 0px;\n\t\t\tbottom: 0px;\n\t\t\twidth: 10vw;\n\t\t\theight: 8vmin;\n\t\t\tborder-radius: 8px;\n\t\t\topacity: 0.5;\n\t\t}\n\t";beep.joystick.setup=function(){beep8.utilities.log("Setting up virtual joystick...");var styleEl=document.createElement("style");styleEl.setAttribute("type","text/css");styleEl.innerText=VJOY_CSS;document.body.appendChild(styleEl);var scrim=document.createElement("div");scrim.setAttribute("id","vjoy-scrim");scrim.addEventListener("touchstart",function(e){return e.preventDefault()});document.body.appendChild(scrim);var leftContainer=document.createElement("div");leftContainer.setAttribute("id","vjoy-container-left");leftContainer.innerHTML=LEFT_VJOY_HTML;document.body.appendChild(leftContainer);var rightContainer=document.createElement("div");rightContainer.setAttribute("id","vjoy-container-right");rightContainer.innerHTML=RIGHT_VJOY_HTML;document.body.appendChild(rightContainer);setTimeout(continueSetup,10)};beep.joystick.continueSetup=function(){setUpButton("vjoy-button-up","ArrowUp");setUpButton("vjoy-button-down","ArrowDown");setUpButton("vjoy-button-left","ArrowLeft");setUpButton("vjoy-button-right","ArrowRight");setUpButton("vjoy-button-pri","ButtonA");setUpButton("vjoy-button-sec","ButtonB");setUpButton("vjoy-button-ter","Escape");document.body.addEventListener("touchstart",function(e){return e.preventDefault()})};beep8.joystick.setUpButton=function(buttonId,buttonKeyName){var button=beep8.utilities.assert(document.getElementById(buttonId),"Could not find button ID "+buttonId);if(buttonKeyName===null){button.style.display="none";return}button.addEventListener("mousedown",function(e){return handleButtonEvent(buttonKeyName,true,e)});button.addEventListener("touchstart",function(e){return handleButtonEvent(buttonKeyName,true,e)});button.addEventListener("mouseup",function(e){return handleButtonEvent(buttonKeyName,false,e)});button.addEventListener("touchend",function(e){return handleButtonEvent(buttonKeyName,false,e)});button.addEventListener("contextmenu",function(e){return e.preventDefault()})};beep.joystick.handleButtonEvent=function(buttonKeyName,down,evt){if(down){inputSys.onKeyDown({key:buttonKeyName})}else{inputSys.onKeyUp({key:buttonKeyName})}evt.preventDefault()}})(beep8||({},_readOnlyError("beep8")));