/*!
 * beep8.js - A Retro Game Library
 *
 * ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
 * ░░░░       ░░        ░        ░       ░░░     ░░░░░        ░░      ░░░░░
 * ▒▒▒▒  ▒▒▒▒  ▒  ▒▒▒▒▒▒▒  ▒▒▒▒▒▒▒  ▒▒▒▒  ▒  ▒▒▒  ▒▒▒▒▒▒▒▒▒▒  ▒  ▒▒▒▒▒▒▒▒▒▒
 * ▓▓▓▓       ▓▓      ▓▓▓      ▓▓▓       ▓▓▓     ▓▓▓▓▓▓▓▓▓▓▓  ▓▓      ▓▓▓▓▓
 * ████  ████  █  ███████  ███████  ███████  ███  ████  ████  ███████  ████
 * ████       ██        █        █  ████████     ██  ██      ███      █████
 * ████████████████████████████████████████████████████████████████████████
 *
 * beep8.js is a retro game library designed to bring
 * the charm and simplicity of classic games to modern
 * web development. A fork of qx82, beep8.js retains
 * the original's elegance while enhancing its features
 * for today's developers.
 *
 * ---
 *
 * Website: https://beep8.com
 * Games: https://beepmini.com
 * Github: https://github.com/BinaryMoon/beep8
 * BlueSky: https://bsky.app/profile/binarymoon.bsky.social
 *
 * ---
 *
 * MIT License
 *
 * Copyright (c) 2024 - 2025 BinaryMoon
 *
 * Permission is hereby granted, free of charge, to any
 * person obtaining a copy of this software and associated
 * documentation files (the "Software"), to deal in the
 * Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall
 * be included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */const beep8={};(function(t){t.CONFIG={DEBUG:!0,NAME:"beep8 Project",VERSION:"1.0.0-dev",CANVAS_SETTINGS:{CANVAS_ID:"beep8-canvas",CANVAS_CLASSES:[],CONTAINER:null},SFX:{TYPING:"ui/click/003",MENU_UP:"tone/beep/002",MENU_DOWN:"tone/beep/001",MENU_SELECT:"tone/beep/003"},FONT_DEFAULT:"../assets/font-default-thin.png",FONT_TILES:"../assets/font-tiles.png",FONT_ACTORS:"../assets/font-actors.png",CHRS:`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*+=-<>_#&@%^~$\xA3\u20AC\xA5\xA2!?:;'"/\\()[]{}.,\xA9\xAE\u2122\u2022\u2026| `,CHR_WIDTH:12,CHR_HEIGHT:12,SCREEN_ROWS:25,SCREEN_COLS:20,SCREEN_COLORS:1,CRT_ENABLE:!0,CRT_VIGNETTE:!0,COLORS:["#0A0C1F","#263264","#A0ABB6","#B2EFEB","#3FB0F1","#3548A3","#420241","#6A3E49","#C22D44","#E08355","#FFC763","#A7D171","#30AB62","#1E7F82","#FF76D7","#F4F4F4"],PASSKEY:"beep8IsAwesome",TOUCH_VJOY:!0,CURSOR:{BLINK_INTERVAL:400},PRINT_ESCAPE_START:"{{",PRINT_ESCAPE_END:"}}",BORDER_CHAR:54}})(beep8),(function(t){t.init=function(s,a={}){return t.Utilities.checkFunction("callback",s),t.Utilities.checkObject("options",a),a!==null&&(t.CONFIG=t.Utilities.deepMerge(t.CONFIG,a)),t.Core.init(s)},t.frame=function(s=null,a=null,i=30){return t.Core.preflight("beep8.frame"),s!==null&&t.Utilities.checkFunction("render handler",s),a!==null&&t.Utilities.checkFunction("update handler",a),t.Utilities.checkNumber("fps",i),t.Core.setFrameHandlers(s,a,i)},t.render=function(){return t.Core.preflight("beep8.render"),t.Renderer.render()},t.color=function(s,a=void 0){t.Core.preflight("beep8.color"),t.Utilities.checkNumber("fg",s),a!==void 0&&t.Utilities.checkNumber("bg",a),t.Core.setColor(s,a)},t.getFgColor=function(){return t.Core.preflight("getFgColor"),t.Core.drawState.fgColor},t.getBgColor=function(){return t.Core.preflight("beep8.getBgColor"),t.Core.drawState.bgColor},t.cls=function(s=void 0){t.Core.preflight("beep8.Core.cls"),s!==void 0&&t.Utilities.checkNumber("bg",s),t.Core.cls(s)},t.locate=function(s,a){t.Core.preflight("beep8.locate"),t.Utilities.checkNumber("col",s),a!==void 0&&t.Utilities.checkNumber("row",a),t.Core.setCursorLocation(s,a)},t.col=function(){return t.Core.preflight("col"),t.Core.drawState.cursorCol},t.row=function(){return t.Core.preflight("row"),t.Core.drawState.cursorRow},t.cursor=function(s){t.Core.preflight("cursor"),t.Utilities.checkBoolean("visible",s),t.CursorRenderer.setCursorVisible(s)},t.print=function(s,a=-1,i=null){t.Core.preflight("beep8.text"),t.Utilities.checkString("text",s),t.Utilities.checkNumber("maxWidth",a);let n=i;n!==null&&(t.Utilities.checkString("fontName",i),n=t.TextRenderer.getFontByName(i)),t.TextRenderer.print(s,n,a)},t.printCentered=function(s,a=t.CONFIG.SCREEN_COLS,i=null){t.Core.preflight("beep8.printCentered"),t.Utilities.checkString("text",s),t.Utilities.checkNumber("width",a);let n=i;n!==null&&(t.Utilities.checkString("fontName",i),n=t.TextRenderer.getFontByName(i)),t.TextRenderer.printCentered(s,a,n)},t.printRight=function(s,a=t.CONFIG.SCREEN_COLS,i=null){t.Core.preflight("beep8.printRight"),t.Utilities.checkString("text",s),t.Utilities.checkNumber("width",a);let n=i;n!==null&&(t.Utilities.checkString("fontName",i),n=t.TextRenderer.getFontByName(i)),t.TextRenderer.printRight(s,a,n)},t.drawText=function(s,a,i,n=null){t.Core.preflight("beep8.drawText"),t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",a),t.Utilities.checkString("text",i),n&&t.Utilities.checkString("fontName",n),t.TextRenderer.drawText(s,a,i,n)},t.measure=function(s){return t.Core.preflight("measure"),t.Utilities.checkString("text",s),t.TextRenderer.measure(s)},t.printChar=function(s,a=1,i=null){if(t.Core.preflight("beep8.printChar"),s=t.convChar(s),t.Utilities.checkInt("charCode",s),t.Utilities.checkInt("numTimes",a),a<0&&t.Utilities.fatal("[beep8.printChar] numTimes must be a positive integer"),a===0)return;let n=i;n!==null&&(t.Utilities.checkString("fontName",i),n=t.TextRenderer.getFontByName(i)),t.TextRenderer.printChar(s,a,n)},t.printRect=function(s,a,i=8){t.Core.preflight("beep8.printRect"),i=t.convChar(i),t.Utilities.checkNumber("widthCols",s),t.Utilities.checkNumber("heightRows",a),t.Utilities.checkNumber("charCode",i),t.TextRenderer.printRect(s,a,i)},t.printBox=function(s,a,i=!0,n=t.CONFIG.BORDER_CHAR){t.Core.preflight("beep8.printBox"),n=t.convChar(n),t.Utilities.checkNumber("widthCols",s),t.Utilities.checkNumber("heightRows",a),t.Utilities.checkBoolean("fill",i),t.Utilities.checkNumber("borderChar",n),t.TextRenderer.printBox(s,a,i,n)},t.drawImage=function(s,a,i){t.Utilities.checkInstanceOf("image",i,HTMLImageElement),t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",a),t.Core.drawImage(i,s,a)},t.drawImageRect=function(s,a,i,n,o,r,e){t.Utilities.checkInstanceOf("image",i,HTMLImageElement),t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",a),t.Utilities.checkNumber("srcX",n),t.Utilities.checkNumber("srcY",o),t.Utilities.checkNumber("width",r),t.Utilities.checkNumber("height",e),t.Core.drawImage(i,s,a,n,o,r,e)},t.drawRect=function(s,a,i,n,o=1){t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",a),t.Utilities.checkNumber("width",i),t.Utilities.checkNumber("height",n),t.Utilities.checkNumber("lineWidth",o),t.Core.drawRect(s,a,i,n,o)},t.fillRect=function(s,a,i,n){t.Utilities.checkNumber("x",s),t.Utilities.checkNumber("y",a),t.Utilities.checkNumber("width",i),t.Utilities.checkNumber("height",n),t.Core.fillRect(s,a,i,n)},t.playSound=function(s,a=1,i=!1){t.Utilities.checkInstanceOf("sfx",s,HTMLAudioElement),s.currentTime=0,s.volume=a,s.loop=i,s.play()},t.spr=function(s,a,i){s=t.convChar(s),t.Utilities.checkNumber("ch",s),t.Utilities.checkNumber("x",a),t.Utilities.checkNumber("y",i),t.TextRenderer.spr(s,a,i)},t.drawActor=function(s,a){s=t.convChar(s),t.Utilities.checkInt("ch",s),t.Utilities.checkString("animation",a),t.Actors.draw(s,a)},t.sprActor=function(s,a,i,n,o=null){return s=t.convChar(s),t.Utilities.checkInt("ch",s),t.Utilities.checkString("animation",a),t.Utilities.checkNumber("x",i),t.Utilities.checkNumber("y",n),o!==null&&t.Utilities.checkNumber("startTime",o),t.Actors.spr(s,a,i,n,o)},t.key=function(s){return t.Core.preflight("beep8.key"),t.Utilities.checkString("keyName",s),t.Input.keyHeld(s)},t.keyp=function(s){return t.Core.preflight("beep8.keyp"),t.Utilities.checkString("keyName",s),t.Input.keyJustPressed(s)},t.playSong=function(s){t.Utilities.checkString("song",s),t.Sound.playSong(s)},t.playSfx=function(s){t.Utilities.checkString("sfx",s),t.Sfx.play(s)},t.redefineColors=function(s){t.Core.preflight("beep8.redefineColors"),t.Utilities.checkArray("colors",s),t.Core.defineColors(s)},t.setFont=function(s){t.Core.preflight("beep8.setFont"),s=s||"default-thin",t.Utilities.checkString("fontName",s),t.TextRenderer.setFont(s)},t.getFont=function(){t.Core.preflight("beep8.getFont"),t.TextRenderer.getFont()},t.getFontByName=function(s){return t.Utilities.checkString("fontName",s),t.TextRenderer.getFontByName(s)},t.setTileFont=function(s){t.Core.preflight("beep8.setTileFont"),s=s||"tiles",t.Utilities.checkString("fontName",s),t.TextRenderer.setTileFont(s)},t.convChar=function(s){return typeof s=="string"&&s.length>0?s.charCodeAt(0):s},t.stopSound=function(s){t.Utilities.checkInstanceOf("sfx",s,HTMLAudioElement),s.currentTime=0,s.pause()},t.getContext=function(){return t.Core.getContext()},t.saveScreen=function(){return t.Core.saveScreen()},t.screenShake=function(s){return t.Utilities.checkNumber("duration",s),t.Renderer.shakeScreen(s)},t.restoreScreen=function(s){return t.Core.restoreScreen(s)},t.wrapText=function(s,a){return t.Utilities.checkString("text",s),t.Utilities.checkNumber("maxWidth",a),t.TextRenderer.wrapText(s,a)},t.addScene=function(s,a={}){t.Scene.add(s,a)},t.switchScene=function(s){t.Scene.set(s)},t.getScene=function(){return t.Scene.get()},t.speak=function(s,a={}){if(!window.speechSynthesis)return;t.Utilities.checkString("text",s),t.Utilities.checkObject("options",a);const i=new SpeechSynthesisUtterance(s);i.pitch=a.pitch??1,i.rate=a.rate??1,i.volume=a.volume??1,speechSynthesis.speak(i)}})(beep8),(function(t){t._asyncActive=!1,t.Async=t.Async||{},t.Async=new Proxy(t.Async,{get(s,a,i){const n=Reflect.get(s,a,i);return typeof n=="function"?async function(...o){let r=!t._asyncActive;r&&(t._asyncActive=!0,t.Scene.pause());try{return t.Core.preflight(`beep8.Async.${a}`),await n.apply(this,o)}finally{r&&(t.Scene.resume(),t._asyncActive=!1)}}:n}}),t.Async.key=async function(){return await t.Input.readKeyAsync()},t.Async.pointer=async function(){return await t.Input.readPointerAsync()},t.Async.readLine=async function(s="Enter text:",a="",i=-1,n=-1){return t.Utilities.checkString("initString",a),t.Utilities.checkString("prompt",s),t.Utilities.checkNumber("maxLen",i),t.Utilities.checkNumber("maxWidth",n),await t.Input.readLine(s,a,i,n)},t.Async.menu=async function(s,a={}){return t.Utilities.checkArray("choices",s),t.Utilities.checkObject("options",a),await t.Menu.display(s,a)},t.Async.dialog=async function(s,a=["OK"],i={}){return t.Utilities.checkString("prompt",s),t.Utilities.checkArray("choices",a),t.Async.menu(a,{prompt:s,center:!0,...i})},t.Async.dialogTypewriter=async function(s,a=["OK"],i=-1,n=.05,o={}){return t.Utilities.checkString("prompt",s),t.Utilities.checkArray("choices",a),t.Utilities.checkNumber("delay",n),i>0&&(s=t.TextRenderer.wrapText(s,i)),await t.Async.menu(a,{prompt:s,typewriter:!0,center:!0,...o})},t.Async.typewriter=async function(s,a=-1,i=.035,n=null){t.Utilities.checkString("text",s),t.Utilities.checkNumber("wrapWidth",a),t.Utilities.checkNumber("delay",i);let o=n;o!==null&&(t.Utilities.checkString("fontName",n),o=t.TextRenderer.getFontByName(n)),await t.TextRenderer.printTypewriter(s,a,i,o)},t.Async.loadImage=async function(s){return t.Utilities.checkString("url",s),await t.Core.loadImage(s)},t.Async.loadSound=async function(s){return new Promise(a=>{const i=new Audio;i.oncanplaythrough=()=>a(i),i.src=s,i.load()})},t.Async.loadFont=async function(s,a=1,i=1){t.Utilities.checkString("fontImageFile",s),t.Utilities.checkNumber("tileSizeWidthMultiplier",a),t.Utilities.checkNumber("tileSizeHeightMultiplier",i);const n="FONT@"+t.Utilities.makeUrlPretty(s);return await t.TextRenderer.loadFontAsync(n,s,a,i),n},t.Async.wait=async function(s){return t.Utilities.checkNumber("seconds",s),t.Renderer.render(),await new Promise(a=>setTimeout(a,Math.round(s*1e3)))},t.Async.waitForContinue=async function(){for(;;){const s=await t.Async.key();if(s.includes("Enter")||s.includes("ButtonA")||s.includes(" "))break}}})(beep8),(function(t){t.Hooks={};const s={},a={};function i(n,o,r,e=10){n[o]||(n[o]=[]),n[o].push({callback:r,priority:e}),n[o].sort((l,u)=>l.priority-u.priority)}t.Hooks.addAction=function(n,o,r=10){i(s,n,o,r)},t.Hooks.doAction=function(n,...o){if(s[n])for(const{callback:r}of s[n])r(...o)},t.Hooks.addFilter=function(n,o,r=10){i(a,n,o,r)},t.Hooks.applyFilters=function(n,o,...r){if(!a[n])return o;let e=o;for(const{callback:l}of a[n])e=l(e,...r);return e},t.Hooks.removeAction=function(n,o){s[n]=(s[n]||[]).filter(r=>r.callback!==o)},t.Hooks.removeFilter=function(n,o){a[n]=(a[n]||[]).filter(r=>r.callback!==o)}})(beep8),(function(t){t.Joystick={};let s=null;const a=`
<div class="vjoy-options">
	<button id='vjoy-button-ter' class='vjoy-button'>Start</button>
	<button id='vjoy-button-screenshot' class='vjoy-button'>Snap</button>
</div>
<div class="vjoy-controls">
	<div class="vjoy-dpad">
	<button id='vjoy-button-up' class='vjoy-button'><span>U</span></button>
	<button id='vjoy-button-right' class='vjoy-button'><span>R</span></button>
	<button id='vjoy-button-left' class='vjoy-button'><span>L</span></button>
	<button id='vjoy-button-down' class='vjoy-button'><span>D</span></button>
	</div>
	<div class="vjoy-buttons">
	<button id='vjoy-button-pri' class='vjoy-button'><span>A</span></button>
	<button id='vjoy-button-sec' class='vjoy-button'><span>B</span></button>
	</div>
</div>`,i=`
:root {
	--b8-vjoy-button-color: #333;
	--b8-vjoy-button-size: 14vw;
	--b8-vjoy-button-dpad-size: calc(var(--b8-vjoy-button-size) * 2);
	--b8-console-radius: 2rem;
	--b8-border-radius: calc(var(--b8-vjoy-button-dpad-size) / 5);
}

.vjoy-container,
.vjoy-container * {
	box-sizing: border-box;
	user-select: none;
	-webkit-user-select: none;
	-webkit-touch-callout: none;
	touch-action: none;
}

.vjoy-container {
	position: relative;
	width: 100%;
	padding: 8vw 4vw 8vw 6vw;
	background: deeppink;
	border-radius: 0 0 var(--b8-console-radius) var(--b8-console-radius);
}

.vjoy-options {
	border-radius: 5rem;
	position: absolute;
	display: flex;
	gap: 2vw;
	align-items: center;
	padding: 2vw;
	border-radius: 2rem;
	background: inherit;
	top: -4vw;
	left: 50%;
	transform: translateX(-50%);
}

.vjoy-controls {
	display: flex;
	gap: 5vw;
	justify-content: space-between;
	align-items: center;
}

.vjoy-dpad {
	aspect-ratio: 1;
	max-width: 10rem;
	width: var(--b8-vjoy-button-dpad-size);
	display: grid;
	grid-template-columns: 1fr 1fr;
	grid-template-rows: 1fr 1fr;
	flex-wrap: wrap;
	transform: rotate(45deg);
	border-radius: var(--b8-border-radius);
	background:black;
	gap: 1px;
	border: 2px solid black;
}

.vjoy-dpad button {
	width: 100%;
	height: 100%;
	position: relative;
}
.vjoy-dpad button span {
	transform: rotate(-45deg);
}
.vjoy-dpad button:after {
	position: absolute;
	content: '';
	display: block;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0);
	transform: rotate(-45deg);
}

#vjoy-button-up {
	border-radius: var(--b8-border-radius) 0 0 0;
}
#vjoy-button-down {
	border-radius: 0 0 var(--b8-border-radius) 0;
}
#vjoy-button-left {
	border-radius: 0 0 0 var(--b8-border-radius);
}
#vjoy-button-right {
	border-radius: 0 var(--b8-border-radius) 0 0;
}

#vjoy-button-up:after {
	transform: rotate(-45deg) translateY(-30%) scale(1.1);
}
#vjoy-button-down:after {
	transform: rotate(-45deg) translateY(30%) scale(1.1);
}
#vjoy-button-left:after {
	transform: rotate(-45deg) translateX(-30%) scale(1.1);
}
#vjoy-button-right:after {
	transform: rotate(-45deg) translateX(30%) scale(1.1);
}

.vjoy-buttons {
	display: flex;
	gap: 2vw;
	transform: rotate(-45deg);
	border: 0.8vw solid rgba(0,0,0,0.2);
	border-radius: calc( var(--b8-border-radius) + 1vw );
	padding: 1vw;
}

.vjoy-buttons button {
	width: var(--b8-vjoy-button-size);
	max-width: 5rem;
	max-height: 5rem;
	height: var(--b8-vjoy-button-size);
	border-radius: var(--b8-border-radius);
	touch-action: none;
	border: 2px solid black;
	position: relative;
}

.vjoy-buttons button:after {
	position: absolute;
	content: '';
	display: block;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0);
	transform: scale(1.2);
}

.vjoy-buttons button span {
	transform: rotate(45deg);
}

.vjoy-button {
	background: var(--b8-vjoy-button-color) !important;
	border: none;
	font-family: arial, sans-serif;
	font-size: 12px;
	font-weight: 600;
	color: #aaa !important;
	user-select: none;
	touch-callout: none;
	-webkit-user-select: none;
	-webkit-touch-callout: none;
	text-shadow: 0 -2px 0 black;
	padding: 0;
	display: flex;
	justify-content: center;
	align-items: center;
	letter-spacing: 0.1em;
	text-transform: uppercase;
}

.vjoy-button:hover,
.vjoy-button:focus,
.vjoy-button:active {
	background: black;
	outline: none;
}

#vjoy-button-screenshot,
#vjoy-button-ter {
	width: calc(var(--b8-vjoy-button-size) * 1.4);
	padding: 1vw;
	border-radius: 1rem;
}
`;t.Joystick.setup=function(){t.Utilities.log("Setting up virtual joystick...");const n=document.createElement("style");n.setAttribute("type","text/css"),n.innerText=i,document.body.appendChild(n);const o=document.createElement("div");o.className="vjoy-container",o.innerHTML=a,t.Core.getBeepContainerEl().appendChild(o),setTimeout(t.Joystick.continueSetup,10)},t.Joystick.continueSetup=function(){t.Joystick.setUpButton("vjoy-button-up","ArrowUp"),t.Joystick.setUpButton("vjoy-button-down","ArrowDown"),t.Joystick.setUpButton("vjoy-button-left","ArrowLeft"),t.Joystick.setUpButton("vjoy-button-right","ArrowRight"),t.Joystick.setUpButton("vjoy-button-pri","ButtonA"),t.Joystick.setUpButton("vjoy-button-sec","ButtonB"),t.Joystick.setUpButton("vjoy-button-ter","Enter"),t.Joystick.setUpButton("vjoy-button-screenshot","0"),document.body.addEventListener("touchstart",n=>n.preventDefault())},t.Joystick.setUpButton=function(n,o){const r=t.Utilities.assert(document.getElementById(n),"Could not find button ID "+n);if(o===null){r.style.display="none";return}["pointerdown","pointerstart"].forEach(e=>{r.addEventListener(e,l=>{l.preventDefault(),t.Joystick.handleButtonEvent(o,!0,l)},{passive:!1})}),["pointerout","pointerup","pointerleave"].forEach(e=>{r.addEventListener(e,l=>t.Joystick.handleButtonEvent(o,!1,l))}),r.addEventListener("pointermove",e=>{e.preventDefault()},{passive:!1}),r.addEventListener("contextmenu",e=>e.preventDefault())},t.Joystick.handleButtonEvent=function(n,o,r){r.key=n,s||(s={}),o?(t.Input.onKeyDown(r),s[n]||(s[n]={},s[n].initialTimeout=setTimeout(function(){s[n].interval=setInterval(function(){t.Input.onKeyDown(r)},150)},150))):(s[n]&&(s[n].initialTimeout&&clearTimeout(s[n].initialTimeout),s[n].interval&&clearInterval(s[n].interval),delete s[n]),t.Input.onKeyUp(r)),r.preventDefault()}})(beep8),(function(t){t.Utilities={},t.Utilities.fatal=function(n){t.Utilities.error("Fatal error: "+n);try{t.Core.handleCrash(n)}catch(o){t.Utilities.error("Error in beep8.Core.handleCrash: "+o+" while handling error "+n)}throw new Error(n)},t.Utilities.assert=function(n,o){return n||t.Utilities.fatal(o||"Assertion Failed"),n},t.Utilities.assertDebug=function(n,o){return n||(t.CONFIG.DEBUG?warn("DEBUG ASSERT failed: "+o):t.Utilities.fatal(o)),n},t.Utilities.assertEquals=function(n,o,r){return n!==o&&t.Utilities.fatal(`${r}: expected ${n} but got ${o}`),o},t.Utilities.checkType=function(n,o,r){return t.Utilities.assert(n,"checkType: varName must be provided."),t.Utilities.assert(r,"checkType: varType must be provided."),t.Utilities.assert(typeof o===r,`${n} should be of type ${r} but was ${typeof o}: ${o}`),o},t.Utilities.checkNumber=function(n,o,r=void 0,e=void 0){return t.Utilities.checkType(n,o,"number"),isNaN(o)&&t.Utilities.fatal(`${n} should be a number but is NaN`),isFinite(o)||t.Utilities.fatal(`${n} should be a number but is infinite: ${o}`),r!==void 0&&t.Utilities.assert(o>=r,`${n} should be >= ${r} but is ${o}`),e!==void 0&&t.Utilities.assert(o<=e,`${n} should be <= ${e} but is ${o}`),o},t.Utilities.checkInt=function(n,o,r,e){return t.Utilities.checkNumber(n,o,r,e),o!==Math.round(o)&&t.Utilities.fatal(`${n} should be an integer but is ${o}`),o},t.Utilities.checkString=function(n,o){return t.Utilities.checkType(n,o,"string")},t.Utilities.checkBoolean=function(n,o){return t.Utilities.checkType(n,o,"boolean")},t.Utilities.checkFunction=function(n,o){return o===null&&t.Utilities.fatal(`${n} should be a function, but was null`),t.Utilities.checkType(n,o,"function")},t.Utilities.checkObject=function(n,o){return o===null&&t.Utilities.fatal(`${n} should be an object, but was null`),t.Utilities.checkType(n,o,"object")},t.Utilities.checkInstanceOf=function(n,o,r){return t.Utilities.assert(o instanceof r,`${n} should be an instance of ${r.name} but was not, it's: ${o}`),o},t.Utilities.checkIsSet=function(n,o){return t.Utilities.assert(o!=null,`${n} should be set but was: ${o}`),o},t.Utilities.checkArray=function(n,o){return t.Utilities.assert(Array.isArray(o),`${n} should be an array, but was: ${o}`),o},t.Utilities.log=function(n){t.CONFIG.DEBUG&&console.log(n)},t.Utilities.warn=function(n){console.warn(n)},t.Utilities.error=function(n){console.error(n)},t.Utilities.loadImageAsync=async function(n){return new Promise(o=>{const r=new Image;r.src=n,r.onload=()=>o(r)})},t.Utilities.makeColorTransparent=async function(n,o=[255,0,255],r=5){const e=document.createElement("canvas"),l=e.getContext("2d");e.width=n.width,e.height=n.height,l.drawImage(n,0,0);const u=l.getImageData(0,0,e.width,e.height),f=u.data;for(let C=0;C<f.length;C+=4){const h=f[C],w=f[C+1],d=f[C+2];Math.abs(h-o[0])<=r&&Math.abs(w-o[1])<=r&&Math.abs(d-o[2])<=r&&(f[C+3]=0)}return l.putImageData(u,0,0),e},t.Utilities.loadFileAsync=function(n){return new Promise((o,r)=>{const e=new XMLHttpRequest;e.addEventListener("load",()=>{e.status<200||e.status>299?r("HTTP request finished with status "+e.status):o(e.responseText)}),e.addEventListener("error",l=>r(l)),e.open("GET",n),e.send()})},t.Utilities.clamp=function(n,o,r){return Math.min(Math.max(n,o),r)},t.Utilities.hexToRgb=function(n){n=n.replace("#","");const o=parseInt(n,16);return{r:o>>16&255,g:o>>8&255,b:o&255}},t.Utilities.intersectIntervals=function(n,o,r,e,l=null){t.Utilities.checkNumber("as",n),t.Utilities.checkNumber("ae",o),t.Utilities.checkNumber("bs",r),t.Utilities.checkNumber("be",e),l&&t.Utilities.checkObject("result",l);const u=Math.max(n,r),f=Math.min(o,e);return f>=u?(l&&(l.start=u,l.end=f),!0):!1},t.Utilities.intersectRects=function(n,o,r=0,e=0,l=0,u=0,f=null){t.Utilities.checkObject("r1",n),t.Utilities.checkObject("r2",o),t.Utilities.checkNumber("r1.x",n.x),t.Utilities.checkNumber("r1.y",n.y),t.Utilities.checkNumber("r1.w",n.w),t.Utilities.checkNumber("r1.h",n.h),t.Utilities.checkNumber("r2.x",o.x),t.Utilities.checkNumber("r2.y",o.y),t.Utilities.checkNumber("r2.w",o.w),t.Utilities.checkNumber("r2.h",o.h),t.Utilities.checkNumber("dx1",r),t.Utilities.checkNumber("dx2",l),t.Utilities.checkNumber("dy1",e),t.Utilities.checkNumber("dy2",u),f&&checkObject("result",f);const C=s,h=a;return!t.Utilities.intersectIntervals(n.x+r,n.x+r+n.w-1,o.x+l,o.x+l+o.w-1,C)||!t.Utilities.intersectIntervals(n.y+e,n.y+e+n.h-1,o.y+u,o.y+u+o.h-1,h)?!1:(f&&(f.x=C.start,f.w=C.end-C.start+1,f.y=h.start,f.h=h.end-h.start+1),!0)};const s={},a={};t.Utilities.makeUrlPretty=function(n){t.Utilities.checkString("uglyStr",n);let o=n;return o=o.toLowerCase(),o=o.replace(/[\s/]+/g,"-"),o=o.replace(/[^a-z0-9\-]+/g,""),o=o.replace(/-+/g,"-"),o=o.replace(/^-+|-+$/g,""),o},t.Utilities.deepMerge=function(...n){const o=r=>r&&typeof r=="object";return n.reduce((r,e)=>(Object.keys(e).forEach(l=>{const u=r[l],f=e[l];Array.isArray(u)&&Array.isArray(f)?r[l]=u.concat(...f):o(u)&&o(f)?r[l]=t.Utilities.deepMerge(u,f):r[l]=f}),r),{})},t.Utilities.deepMergeByIndex=function(...n){const o=r=>r&&typeof r=="object";return n.reduce((r,e)=>(Object.keys(e).forEach(l=>{const u=r[l],f=e[l];Array.isArray(u)&&Array.isArray(f)?r[l]=i(u,f):o(u)&&o(f)?r[l]=t.Utilities.deepMergeByIndex(u,f):r[l]=f}),r),{})},t.Utilities.padWithZeros=function(n,o){return t.Utilities.checkNumber("number",n),t.Utilities.checkInt("length",o),n<0&&t.Utilities.fatal("padWithZeros does not support negative numbers"),n.toString().padStart(o,"0")},t.Utilities.event=function(n,o={},r=document){t.Utilities.checkString("eventName",n),t.Utilities.checkObject("detail",o),t.Utilities.checkObject("target",r),n=`beep8.${n}`;const e=new CustomEvent(n,{detail:o});r.dispatchEvent(e)},t.Utilities.repeatArray=function(n,o){return t.Utilities.checkArray("array",n),t.Utilities.checkInt("times",o,0),Array(o).fill().flatMap(()=>n)},t.Utilities.downloadFile=function(n="",o=""){t.Utilities.checkString("filename",n),t.Utilities.checkString("src",o);const r=document.createElement("a");r.setAttribute("href",o),r.setAttribute("download",n),document.body.appendChild(r),r.click(),document.body.removeChild(r)},t.Utilities.encodeData=function(n){const o=CBOR.encode(n);return btoa(String.fromCharCode.apply(null,new Uint8Array(o)))},t.Utilities.decodeData=function(n){const o=atob(n),r=new Uint8Array(o.length);for(let l=0;l<o.length;l++)r[l]=o.charCodeAt(l);const e=r.buffer;return CBOR.decode(e)};function i(n,o){for(let r=0;r<o.length;r++)n[r]=o[r];return n}})(beep8),(function(t){t.Tilemap={},t.Tilemap.MAP_CHAR=0,t.Tilemap.MAP_FG=1,t.Tilemap.MAP_BG=2,t.Tilemap.MAP_COLLISION=3,t.Tilemap.MAP_DATA=4;const s={solid:{0:1,1:1,2:1,3:36,4:1,5:1,6:18,7:1,8:1,9:37,10:1,11:1,12:19,13:1,14:1,15:1},rounded:{0:1,1:42,2:23,3:36,4:41,5:1,6:18,7:1,8:24,9:37,10:1,11:1,12:19,13:1,14:1,15:1},half:{0:128,1:75,2:58,3:93,4:75,5:75,6:57,7:129,8:58,9:95,10:58,11:111,12:59,13:130,14:112,15:113},half_rounded:{0:128,1:148,2:166,3:93,4:149,5:75,6:57,7:129,8:167,9:95,10:58,11:111,12:59,13:130,14:112,15:113},pipe:{0:128,1:148,2:166,3:93,4:149,5:[75,77],6:57,7:129,8:167,9:95,10:[58,94],11:111,12:59,13:130,14:112,15:[113,131,76]},thin:{0:110,1:173,2:172,3:164,4:154,5:72,6:146,7:126,8:155,9:165,10:55,11:108,12:147,13:127,14:109,15:73}};t.Tilemap.save=function(i){return t.Utilities.checkArray("tilemap",i),t.Utilities.encodeData(i)},t.Tilemap.load=function(i){return t.Utilities.checkString("data",i),t.Utilities.decodeData(i)},t.Tilemap.draw=function(i,n=0,o=0,r=null,e=null){t.Utilities.checkArray("tilemap",i),r||(r=i[0].length),e||(e=i.length),t.Utilities.checkInt("width",r),t.Utilities.checkInt("height",e);const l=t.Core.drawState.cursorRow,u=t.Core.drawState.cursorCol;for(let f=o;f<o+e;f++){const C=0+u,h=f-o+l;t.locate(C,h);for(let w=n;w<n+r;w++){if(!i[f]||i[f][w]==null)continue;const d=i[f][w];d&&d.length>=3&&(t.color(d[t.Tilemap.MAP_FG],d[t.Tilemap.MAP_BG]),t.printChar(d[t.Tilemap.MAP_CHAR]))}}},t.Tilemap.createEmptyTilemap=function(i,n){let o=[];for(let r=0;r<n;r++){o[r]=[];for(let e=0;e<i;e++)o[r][e]=t.Tilemap.getDefaultTile()}return o},t.Tilemap.shift=function(i,n,o){t.Utilities.checkArray("tilemap",i),t.Utilities.checkNumber("dx",n),t.Utilities.checkNumber("dy",o);const r=i[0].length,e=i.length,l=t.Tilemap.createEmptyTilemap(r,e);for(let u=0;u<e;u++)for(let f=0;f<r;f++){const C=(f+n+r)%r,h=(u+o+e)%e;l[h][C]=[...i[u][f]]}return l},t.Tilemap.resize=function(i,n,o){t.Utilities.checkArray("tilemap",i),t.Utilities.checkNumber("width",n),t.Utilities.checkNumber("height",o);const r=t.Tilemap.createEmptyTilemap(n,o);for(let e=0;e<o;e++)for(let l=0;l<n;l++)i[e]&&i[e][l]&&(r[e][l]=[...i[e][l]]);return r},t.Tilemap.getDefaultTile=function(){return[0,15,0,0,{}]},t.Tilemap.convertFromText=function(i){t.Utilities.checkString("text",i);const o=i.split(`
`).filter(e=>e.trim()!=="");return o.length===0&&t.Utilities.fatal("No valid lines found in the map text."),o.map(e=>e.split(""))},t.Tilemap.validateTilemap=function(i){t.Utilities.checkString("text",i);const n=t.Tilemap.load(i);return!(!Array.isArray(n)||!Array.isArray(n[0])||!Array.isArray(n[0][0])||n[0][0].length<=3)},t.Tilemap.createFromArray=function(i,n,o=null){t.Utilities.checkArray("grid",i),t.Utilities.checkObject("tilePattern",n),o!==null&&t.Utilities.checkObject("defaultTilePattern",o),o===null&&(o=t.Tilemap.getDefaultTile());const r=[];for(let e=0;e<i.length;e++){r[e]=[];for(let l=0;l<i[e].length;l++){if(r[e][l]=[...o],!n[i[e][l]])continue;const u=n[i[e][l]];let f=u.t;typeof f=="string"&&f.startsWith("wall_")&&(f=t.Tilemap.wallTile(l,e,i,f)),Array.isArray(f)&&(f=t.Random.pickWeighted(f));let C=u.fg||15;Array.isArray(C)&&(C=t.Random.pickWeighted(C));let h=u.bg||0;Array.isArray(h)&&(h=t.Random.pickWeighted(h)),r[e][l]=[f,C,h,u.coll||0,u.data||{}]}}return r},t.Tilemap.wallTile=function(i,n,o,r=null){t.Utilities.checkNumber("col",i),t.Utilities.checkNumber("row",n),t.Utilities.checkArray("grid",o),t.Utilities.checkString("name",r),r===null&&t.Utilities.fatal("Wall tile name not given: "+r);const e=r.substring(5);s[e]||t.Utilities.fatal("Wall tile type not found: "+e);const l=a(o,i,n);return s[e][l]};function a(i,n,o){let r=0;const e=i[o][n];return o>0&&i[o-1][n]===e&&(r+=1),n<i[o].length-1&&i[o][n+1]===e&&(r+=2),o<i.length-1&&i[o+1][n]===e&&(r+=4),n>0&&i[o][n-1]===e&&(r+=8),r}})(beep8),(function(t){t.TextRenderer={};const s=[];t.TextRenderer.fonts_={},t.TextRenderer.curFont_=null,t.TextRenderer.curTiles_=null,t.TextRenderer.prepareCharMap=function(){let r=[...t.CONFIG.CHRS];for(let e=0;e<r.length;e++)s.push(r[e].charCodeAt(0))},t.TextRenderer.initAsync=async function(){t.Utilities.log("beep8.TextRenderer init."),t.TextRenderer.curFont_=await t.TextRenderer.loadFontAsync("default-thin",t.CONFIG.FONT_DEFAULT,.5,1),t.TextRenderer.curTiles_=await t.TextRenderer.loadFontAsync("tiles",t.CONFIG.FONT_TILES),t.TextRenderer.curActors_=await t.TextRenderer.loadFontAsync("actors",t.CONFIG.FONT_ACTORS),t.TextRenderer.prepareCharMap()},t.TextRenderer.loadFontAsync=async function(r,e,l=1,u=1){t.Utilities.checkString("fontName",r),t.Utilities.checkString("fontImageFile",e);const f=new t.TextRendererFont(r,e,l,u);return await f.initAsync(),t.TextRenderer.fonts_[r]=f,f},t.TextRenderer.setFont=function(r){const e=t.TextRenderer.getFontByName(r);e&&(t.TextRenderer.curFont_=e)},t.TextRenderer.getFont=function(){return t.TextRenderer.curFont_},t.TextRenderer.setTileFont=function(r){const e=t.TextRenderer.getFontByName(r);e&&(t.TextRenderer.curTiles_=e)},t.TextRenderer.getFontByName=function(r){t.Utilities.checkString("fontName",r);const e=t.TextRenderer.fonts_[r];if(!e){t.Utilities.fatal(`setFont(): font not found: ${r}`);return}return e},t.TextRenderer.print=function(r,e=null,l=-1){t.TextRenderer.printFont_=e||t.TextRenderer.curFont_,t.Utilities.checkString("text",r),t.Utilities.checkNumber("maxWidth",l),e!==null&&t.Utilities.checkObject("font",e),r=t.TextRenderer.wrapText(r,l,e);let u=t.Core.drawState.cursorCol,f=t.Core.drawState.cursorRow;t.TextRenderer.origFgColor_=t.Core.drawState.fgColor,t.TextRenderer.origBgColor_=t.Core.drawState.bgColor,t.TextRenderer.origFont_=t.TextRenderer.printFont_;const C=t.TextRenderer.printFont_.getCharColCount(),h=t.TextRenderer.printFont_.getCharRowCount(),w=u;for(let d=0;d<r.length;d++){d=n(r,d);const A=r.charCodeAt(d);if(A===10)u=w,f+=h;else{const S=s.indexOf(A);S>=0&&(a(S,u,f,t.Core.drawState.fgColor,t.Core.drawState.bgColor,t.TextRenderer.printFont_),u+=C)}}t.Core.drawState.cursorCol=u,t.Core.drawState.cursorRow=f,t.Core.drawState.fgColor=t.TextRenderer.origFgColor_,t.Core.drawState.bgColor=t.TextRenderer.origBgColor_,t.Renderer.markDirty()},t.TextRenderer.printTypewriter=async function(r,e=-1,l=.05,u=null){t.Utilities.checkString("text",r),t.Utilities.checkNumber("maxWidth",e),t.Utilities.checkNumber("delay",l);const f=t.col(),C=t.row();r=t.TextRenderer.wrapText(r,e);for(let h=0;h<=r.length;h++){if(t.CONFIG.PRINT_ESCAPE_START&&r.substring(h,h+t.CONFIG.PRINT_ESCAPE_START.length)===t.CONFIG.PRINT_ESCAPE_START){const d=r.indexOf(t.CONFIG.PRINT_ESCAPE_END,h+t.CONFIG.PRINT_ESCAPE_START.length);d>=0&&(h=d+t.CONFIG.PRINT_ESCAPE_END.length)}const w=r.charCodeAt(h);t.Core.setCursorLocation(f,C),t.TextRenderer.print(r.substring(0,h),u),w!==32&&await t.Async.wait(l)}},t.TextRenderer.printCentered=function(r,e,l=null){if(t.TextRenderer.printFont_=l||t.TextRenderer.curFont_,t.Utilities.checkString("text",r),t.Utilities.checkNumber("width",e),!r)return;const u=t.Core.drawState.cursorCol,f=t.TextRenderer.printFont_.getCharRowCount();r=r.split(`
`),r[r.length-1]===""&&r.pop();for(let C=0;C<r.length;C++){const h=t.TextRenderer.measure(r[C]).cols,w=u+(e-h)/2;t.Core.drawState.cursorCol=w,t.TextRenderer.print(r[C],l,e),t.Core.drawState.cursorRow+=f}t.Core.drawState.cursorCol=u},t.TextRenderer.printRight=function(r,e,l=null){if(t.TextRenderer.printFont_=l||t.TextRenderer.curFont_,t.Utilities.checkString("text",r),t.Utilities.checkNumber("width",e),!r)return;const u=t.Core.drawState.cursorCol,f=t.TextRenderer.printFont_.getCharRowCount();r=t.TextRenderer.wrapText(r,e),r=r.split(`
`),r[r.length-1]===""&&r.pop();for(let C=0;C<r.length;C++){let h=t.TextRenderer.measure(r[C]).cols;const w=u+e-h;t.Core.drawState.cursorCol=w,t.TextRenderer.print(r[C],l,e),t.Core.drawState.cursorRow+=f}t.Core.drawState.cursorCol=u},t.TextRenderer.printChar=function(r,e,l=null){if((e===void 0||isNaN(e))&&(e=1),t.Utilities.checkNumber("ch",r),t.Utilities.checkNumber("n",e),!(t.Core.drawState.cursorCol<0||t.Core.drawState.cursorRow<0||t.Core.drawState.cursorCol>=t.CONFIG.SCREEN_COLS||t.Core.drawState.cursorRow>=t.CONFIG.SCREEN_ROWS)){for(;e-- >0;)a(r,t.Core.drawState.cursorCol,t.Core.drawState.cursorRow,t.Core.drawState.fgColor,t.Core.drawState.bgColor,l),t.Core.drawState.cursorCol++;t.Renderer.markDirty()}},t.TextRenderer.spr=function(r,e,l,u=null,f=0){t.Utilities.checkNumber("ch",r),t.Utilities.checkNumber("x",e),t.Utilities.checkNumber("y",l),t.Utilities.checkInt("direction",f),u!==null&&t.Utilities.checkObject("font",u),i(r,e,l,t.Core.drawState.fgColor,t.Core.drawState.bgColor,u,f)},t.TextRenderer.drawText=function(r,e,l,u){t.Utilities.checkNumber("x",r),t.Utilities.checkNumber("y",e),t.Utilities.checkString("text",l),u&&t.Utilities.checkString("fontName",u);const f=r,C=u&&t.TextRenderer.fonts_[u]||t.TextRenderer.curFont_;if(!C){t.Utilities.warn(`Requested font '${u}' not found: not drawing text.`);return}for(let h=0;h<l.length;h++){const w=l.charCodeAt(h);w===10?(r=f,e+=C.getCharHeight()):(i(w,r,e,t.Core.drawState.fgColor,t.Core.drawState.bgColor,C),r+=C.getCharWidth())}},t.TextRenderer.measure=function(r,e=null){if(t.Utilities.checkString("text",r),e=e||t.TextRenderer.curFont_,r==="")return{cols:0,rows:0};let l=1,u=0,f=0;for(let C=0;C<r.length;C++)C=n(r,C,!0),r.charCodeAt(C)===10?(l++,u=0):(++u,f=Math.max(f,u));return f=f*e.getCharColCount(),l=l*e.getCharRowCount(),{cols:f,rows:l}},t.TextRenderer.printRect=function(r,e,l){t.Utilities.checkNumber("width",r),t.Utilities.checkNumber("height",e),t.Utilities.checkNumber("ch",l);const u=t.Core.drawState.cursorCol,f=t.Core.drawState.cursorRow;for(let C=0;C<e;C++)t.Core.drawState.cursorCol=u,t.Core.drawState.cursorRow=f+C,t.TextRenderer.printChar(l,r);t.Core.drawState.cursorCol=u,t.Core.drawState.cursorRow=f},t.TextRenderer.printBox=function(r,e,l=!0,u=t.CONFIG.BORDER_CHAR){t.Utilities.checkNumber("width",r),t.Utilities.checkNumber("height",e),t.Utilities.checkBoolean("fill",l),t.Utilities.checkNumber("borderChar",u);const f=t.TextRenderer.curTiles_.getColCount(),C={NW:u,NE:u+2,SW:u+f+f,SE:u+f+f+2,V:u+f,H:u+1};t.TextRenderer.drawBox(r,e,l,C)},t.TextRenderer.drawBox=function(r,e,l=!0,u={}){const f=t.Core.drawState.cursorCol,C=t.Core.drawState.cursorRow;for(let h=0;h<e;h++)t.Core.drawState.cursorCol=f,t.Core.drawState.cursorRow=C+h,h===0?(t.TextRenderer.printChar(u.NW),t.TextRenderer.printChar(u.H,r-2),t.TextRenderer.printChar(u.NE)):h===e-1?(t.TextRenderer.printChar(u.SW),t.TextRenderer.printChar(u.H,r-2),t.TextRenderer.printChar(u.SE)):(t.TextRenderer.printChar(u.V),t.Core.drawState.cursorCol=f+r-1,t.TextRenderer.printChar(u.V));l&&r>2&&e>2&&(t.Core.drawState.cursorCol=f+1,t.Core.drawState.cursorRow=C+1,t.TextRenderer.printRect(r-2,e-2,0)),t.Core.drawState.cursorCol=f,t.Core.drawState.cursorRow=C},t.TextRenderer.wrapText=function(r,e,l=null){if(l=l||t.TextRenderer.curFont_,e<=0)return r;const u=r.split(`
`),f=[];for(const C of u){const h=C.split(" ");let w="";for(const d of h)t.TextRenderer.measure((w+d).trim()).cols>e&&(f.push(w.trim()),w=""),w+=d+" ";f.push(w.trim())}return f.join(`
`)};const a=function(r,e,l,u,f,C=null,h=0){const w=Math.round(e*t.CONFIG.CHR_WIDTH),d=Math.round(l*t.CONFIG.CHR_HEIGHT);i(r,w,d,u,f,C,h)},i=function(r,e,l,u,f,C=null,h=0){C=C||t.TextRenderer.curTiles_;const w=C.getColCount(),d=C.getCharWidth(),A=C.getCharHeight(),S=Math.floor(r/w),R=r%w;if(e=Math.round(e),l=Math.round(l),f>=0&&(t.Core.offCtx.fillStyle=t.Core.getColorHex(f),t.Core.offCtx.fillRect(e,l,d,A)),t.CONFIG.SCREEN_COLORS===1&&f===u)return;if(h>0){t.Core.offCtx.save();const N=(h&1)!==0,E=(h&2)!==0,x=N?d:0,y=E?A:0;t.Core.offCtx.translate(e+x,l+y);const v=N?-1:1,D=E?-1:1;t.Core.offCtx.scale(v,D),e=0,l=0}const M=t.Utilities.clamp(u,0,t.CONFIG.COLORS.length-1),F=C.getImageForColor(M);t.Core.offCtx.drawImage(F,R*d,S*A,d,A,e,l,d,A),h>0&&t.Core.offCtx.restore(),t.Renderer.markDirty()},n=function(r,e,l=!1){const u=t.CONFIG.PRINT_ESCAPE_START,f=t.CONFIG.PRINT_ESCAPE_END;if(!u||!f||r.substring(e,e+u.length)!=u)return e;const C=r.indexOf(f,e+u.length);if(!l){const h=r.substring(e+u.length,C);o(h)}return C+f.length},o=function(r){if(r.indexOf(",")>0){const f=r.split(",");for(const C of f)o(C);return}if(r=r.trim(),r==="")return;const e=r[0].toLowerCase(),l=r.substring(1),u=1*l;switch(e){case"f":case"c":t.Core.drawState.fgColor=l!==""?u:t.TextRenderer.origFgColor_;break;case"b":t.Core.drawState.bgColor=l!==""?u:t.TextRenderer.origBgColor_;break;case"t":t.TextRenderer.printFont_=t.TextRenderer.getFontByName(l);break;case"z":t.Core.drawState.fgColor=t.TextRenderer.origFgColor_,t.Core.drawState.bgColor=t.TextRenderer.origBgColor_,t.TextRenderer.printFont_=t.TextRenderer.origFont_||t.TextRenderer.fonts_.default;break;default:t.Utilities.warn("Unknown beep8 print escape command: "+r)}};t.TextRenderer.regenColors=function(){Object.values(t.TextRenderer.fonts_).forEach(r=>r.regenColors())}})(beep8),(function(t){t.Textmode={},t.Textmode.load=async function(s){return t.Tilemap.load(s)},t.Textmode.draw=async function(s,a=0,i=0,n=null,o=null){return t.Tilemap.draw(s,a,i,n,o)}})(beep8),(function(t){t.TextRendererFont=class{constructor(s,a,i=1,n=1){t.Utilities.checkString("fontName",s),t.Utilities.checkString("fontImageFile",a),this.fontName_=s,this.fontImageFile_=a,this.origImg_=null,this.chrImages_=[],this.imageWidth_=0,this.imageHeight_=0,this.colCount_=0,this.rowCount_=0,this.charWidth_=0,this.charHeight_=0,this.charColCount_=0,this.charRowCount_=0,this.tileWidthMultiplier_=i,this.tileHeightMultiplier_=n}async initAsync(){this.origImg_=await t.Utilities.loadImageAsync(this.fontImageFile_);const s=t.CONFIG.CHR_WIDTH*this.tileWidthMultiplier_,a=t.CONFIG.CHR_HEIGHT*this.tileHeightMultiplier_;t.Utilities.assert(this.origImg_.width%s===0&&this.origImg_.height%a===0,`Font ${this.fontName_}: image ${this.fontImageFile_} has dimensions ${this.origImg_.width}x${this.origImg_.height}.`),this.origImg_=await t.Utilities.makeColorTransparent(this.origImg_),this.charWidth_=s,this.charHeight_=a,this.imageWidth_=this.origImg_.width,this.imageHeight_=this.origImg_.height,this.colCount_=this.imageWidth_/this.charWidth_,this.rowCount_=this.imageHeight_/this.charHeight_,this.charColCount_=this.tileWidthMultiplier_,this.charRowCount_=this.tileHeightMultiplier_,await this.regenColors()}getCharWidth(){return this.charWidth_}getCharHeight(){return this.charHeight_}getCharColCount(){return this.charColCount_}getCharRowCount(){return this.charRowCount_}getRowCount(){return this.rowCount_}getColCount(){return this.colCount_}getImageForColor(s){return this.chrImages_[s]}async regenColors(){this.chrImages_=[];for(let s=0;s<t.CONFIG.COLORS.length;s++){const a=document.createElement("canvas");a.width=this.origImg_.width,a.height=this.origImg_.height;const i=a.getContext("2d");i.clearRect(0,0,this.origImg_.width,this.origImg_.height),i.globalCompositeOperation="source-over",i.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height),i.globalCompositeOperation="source-in",i.fillStyle=t.CONFIG.COLORS[s],i.fillRect(0,0,this.origImg_.width,this.origImg_.height),t.CONFIG.SCREEN_COLORS===2&&(i.globalCompositeOperation="multiply",i.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height)),this.chrImages_.push(a)}}}})(beep8),(function(t){t.State=t.State||{};let s="";document.addEventListener("beep8.initComplete",function(){s=`beep8.${t.Utilities.makeUrlPretty(t.CONFIG.NAME)}.state`},{once:!0});function a(i){return new Proxy(i,{get(n,o){const r=n[o];return typeof r=="object"&&r!==null?a(r):r},set(n,o,r){return n[o]=r,t.Utilities.event("stateChange",{prop:o,value:r}),!0}})}t.State.save=function(i=s){const n=t.Utilities.encodeData({time:Date.now(),data:t.data});localStorage.setItem(i,n),t.State.lastSave=Date.now()},t.State.load=function(i=s){const n=localStorage.getItem(i);if(!n){t.Utilities.log("No state found for the given key.");return}const o=t.Utilities.decodeData(n);o.data&&(t.data=a(o.data)),o.time&&(t.State.lastSave=o.time)},t.State.init=function(i){t.data||(t.data=a({})),localStorage.getItem(s)&&t.State.load(),t.data=t.Utilities.deepMergeByIndex(i,t.data),t.Utilities.log("State initialized:",t.data)},t.State.clear=function(i=s){t.Utilities.log("Clearing state..."),localStorage.removeItem(i),t.data=a({})},t.data=a({})})(beep8),(function(t){t.Sfx={},t.Sfx.library={"fx/action/drag":[,0,293.6648,.1,,,4,6,32,,,,,1,1.4,.1,,.7,.1],"fx/break/001":[2.1,,339,.02,.07,.09,4,.2,-7,,,,.05,1,,.1,.16,.45,.02,.03],"fx/break/002":[1.5,,157,.16,,0,,.35,-24,28,,,,.1,,.6,,.19,.01],"fx/break/003":[2,,180,.05,.03,.04,,2.42,.6,,,,,,,,.15,.39,.04],"fx/fight/dodge":[1.2,.3,150,.05,,.05,,,-1,,,,,4,,,,,.02],"fx/fight/hit":[5,,185,,,,3,1.6,-7,,,,,,,.2,.19,.1,,.38,985],"fx/robot/001":[1.13,,172,.04,.18,.09,,.06,-38,-2.6,-99,,,,35,,.08],"fx/robot/002":[1.42,,61,.01,.02,0,1,.21,,,816,.01,.05,,-40,,.05,.71,.11],"fx/robot/003":[.9,,164,.04,.03,.14,,.8,46,66,,,,,,,,.71,.08,,217],"fx/robot/004":[,.02,1638,,.05,.17,1,,,,490,.09,,,,.1,.05,.5,.03],"fx/sci-fi/radioactive":[1,0,130,.02,.9,.39,2,.8,,,,,.13,.2,,.1,,.93,.06,.28],"fx/sci-fi/robot":[1,0,847,.02,.3,.9,1,1.67,,,-294,.04,.13,,,,.1],"fx/sci-fi/teleport":[1,,85,.08,.1,.01,1,4,,-11,1,.07,,.1,101,,.05,.68,.4,.12,1],"fx/sci-fi/warp":[3,0,713,.16,.09,.24,,.6,-29,-16,,,.09,.5,,,.23,.75,.15,.48],"fx/sci-fi/beam":[1,0,662,.82,.11,.33,1,0,,-.2,,,,1.2,,.26,.01],"fx/sci-fi/hover":[2,0,262.63,.1,.12,.3,0,2.4,-.1,0,0,0,.24,0,0,.1,.05,.98,.07,.17,0],"fx/thud/001":[1.5,,90,,.01,.03,4,,,,,,,9,50,.2,,.2,.01],"fx/thud/002":[1,,129,.01,,.15,,,,,,,,5],"fx/machine/buzz":[1,0,130.8128,.1,.1,.34,3,1.88,,,,,,,,.1,,.5,.04],"fx/machine/hum":[1,0,63,,1,,1,1.5,,,,,,,,3.69,.08],"fx/machine/humm":[1,,110,.03,.25,.15,2,1.32,,,,,.07,,-.1,,.11,.77],"fx/machine/warp":[2,,128,,.12,.26,,4.7,,-1,-62,.06,.07,,52,,,.66,.08],"fx/noise/001":[1.27,,390,.01,.04,.02,4,.71,4.8,,,,,,,,.01,.6,.06],"fx/noise/002":[.4,,60,,.01,0,4,.55,62,89,-88,.06,,,173,.6,,,.05],"fx/noise/003":[.2,,523.2511,.1,3,3,4,0,,,2250,,.04,,10,.01,,.82,1,,30],"fx/random/tone":[2,.8,999,,,,1,2,,,,,1,,,.1,.2],"fx/swoosh/001":[1,,1500,.02,,.02,4,.68,5,,,,.01,.7,136,,,,,.11],"fx/swoosh/002":[1.2,,585,,.02,.16,4,.25,,,,,,,,,,.55,.03],"fx/swoosh/003":[.2,,836,.11,,0,4,.91,13,,,,.09,.1,-39,,,.06,.07],"fx/swoosh/004":[1.2,,9220,.01,,,,5,,,,,,9],"fx/swoosh/005":[1.5,0,150,.05,,.05,,1.3,,,,,,3],"fx/swoosh/006":[2,,12,,,.008,,1.2,23,-7,,,.05,.4,,,.15,.82,.03,.28],"fx/vehicle/engine":[1.2,0,25,.05,.3,.5,3,9,-.01,,,,,,13,.1,.2],"fx/vehicle/carhorn":[1.8,0,250,.02,.02,.2,2,2,,,,,.02,,,.02,.01,,,.1],"fx/vehicle/horn":[2,,688,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.03,.11,-818],"fx/vehicle/truckhorn":[1.5,,1376,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.8,.11,-818],"fx/vehicle/siren":[1.3,0,960,,1,.01,,.8,-.01,,-190,.5,,.05,,,1],"fx/vehicle/submarine":[1.2,0,1975,.08,.56,.02,,,-.4,,-322,.56,.41,,,,.25],"fx/vehicle/rocket":[1.5,0,941,.8,,.8,4,.74,-222,,,,,.8,,1],"game/coin/001":[1.2,0,1675,,.06,.24,1,1.82,,,837,.06],"game/coin/002":[1.2,0,523.2511,.01,.06,.3,1,1.82,,,837,.06],"game/coin/003":[.6,0,1874,,.01,.25,2,.76,,,622,.1],"game/coin/004":[1,0,277,.03,.04,.06,1,1.8,1,,140,.06,.04,,,.1,,.99,.03],"game/collect/001":[1.1,0,450,,.01,.13,,2.7,,-9.5,500,.08,,,,,,.89],"game/collect/002":[1.05,,10,.08,.07,.24,2,1.03,,,-374,.04,.09,,,,,.72,.15,.18],"game/die/001":[1.5,0,537,.02,.02,.22,1,1.59,-6.98,4.97],"game/die/002":[1,,321,.01,.06,.06,1,3.8,,-49,,,,.3,,,,.79,.09],"game/die/003":[1,0,344,.01,.02,.28,1,1.4,,,50,,,,.3,.2,.15,.6,.06],"game/die/004":[.5,0,43,.01,,1,2,,,,,,,,,.02,.01],"game/jump/001":[1,.1,75,.03,.08,.17,1,1.88,7.83,,,,,.4],"game/jump/002":[1.2,,311,.03,.05,.05,,2.2,,9,,,.02,,2.7,,,.97,.05,,101],"game/jump/003":[1.5,,65,.04,.1,.13,1,1.5,,-31,,,,.3,,,,.99,.03],"game/jump/004":[,0,500,,.01,.13,,.2,1.7,,-400],"game/jump/005":[1,,341,,.14,.23,1,1.01,.9,,-132,.03,,.1,,.1,,.52,.22],"game/jump/006":[.7,,1496,.09,.09,.01,3,.14,,,-870,,,,3.2,.2,,.31,.02],"game/powerup/001":[,,188,.03,.09,.12,1,2.4,,95,,,,,,,,.63,.08],"game/powerup/002":[.8,0,413,.03,.05,.05,,1.8,,19,177,.05,,,,,,.83,.02],"game/powerup/003":[.5,,643,,.1,.12,1,.1,,99,,,,,,,,.6,.02,,-732],"game/powerup/004":[1.18,,143,.05,.08,.06,,.09,25,4.1,,,,,,,.01,.52,.09],"game/powerup/005":[1,,18,.01,.01,.21,1,.49,9.9,,,,,,,,.04,.95,.02],"game/powerup/006":[.5,,426,.01,,.05,,2.54,49,,9,.1,,,,,,.46,.15],"game/powerup/007":[1,,158,.09,.18,.03,,2.53,11,-58,63,.02,.01,.5,,,,.16],"game/powerup/008":[1.2,0,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04],"instrument/bass/001":[2,0,65,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/002":[2,0,73,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/003":[2,0,82,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/004":[2,0,87,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/005":[2,0,97,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/006":[2,0,110,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/007":[2,0,123,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/008":[2,0,130,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/drum/001":[1.5,0,86,,,,,.7,,,,.5,,6.7,1,.05],"instrument/drum/002":[.7,0,270,,,.12,3,1.65,-2,,,,,4.5,,.02],"tone/beep/001":[2,0,130,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/002":[2,0,146,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/003":[2,0,164,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/004":[2,0,174,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/005":[2,0,195,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/006":[2,0,220,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/007":[2,0,246,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/008":[2,0,261,,.1,,1,1.5,,,,,,,,.1,.01],"tone/bell/001":[2,0,999,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22],"tone/bell/002":[,0,1600,.13,.52,.61,1,1.1,,,,,,.1,,.14],"tone/bell/random":[2,.1,999,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22],"tone/blip/001":[5,0,130,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/002":[3,0,146,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/003":[3,0,164,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/004":[3,0,174,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/005":[3,0,195,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/006":[3,0,220,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/007":[3,0,246,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/008":[3,0,261,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/bloop/001":[1,,110,.02,,.09,1,.61,,,556,.12,,,,.3,,,.02],"tone/bloop/002":[1,0,521.25,,.02,.03,2,0,,.1,700,.01,,,1,.1],"tone/bloop/003":[1.12,,73,,.02,.11,2,1.18,,-.1,,,,,,.3,,.55,.05,.23],"tone/bloop/004":[.5,,1368,.09,,0,,1.11,-76,9.1,-490,,,,,,,.56],"tone/bloop/005":[2.03,,413,,,.24,2,.12,,,,,.11,,317,.1,.13,,,.01],"tone/bloop/006":[,0,,.01,.02,.09,,.6,17,-3,,,.1,,,,,.76,.08],"tone/bloop/007":[.3,,10,.06,,0,2,2.3,,,621,,,,,,,,.21,.26],"tone/bloop/008":[1.5,.05,24,.01,.02,.01,1,3.9,-33,0,0,0,0,0,355,0,0,.65,0,0,0],"tone/bloop/009":[2,.05,226,0,.08,.13,0,3.1,0,0,0,0,0,0,0,.1,.02,.76,.04,0,105],"tone/bloop/010":[4,0,224,.02,.02,.08,1,1.7,-13.9,,,,,,6.7],"tone/bloop/011":[1,,283,.02,,.11,,.38,,,,,.07,,,.1,.08,.63,.02],"tone/bloop/012":[1,0,288,.05,.01,,,2,-10,,,,,,,,,.5,.1],"tone/bloop/013":[2,0,700,.01,,0,,,,,,,,,,,,.1,.01],"tone/bloop/014":[2.21,,107,.02,.04,.07,,2.22,2,.9,,,,.4,,.5,.15,.42,.04],"tone/bloop/015":[.6,0,2200,,,.04,3,2,,,800,.02,,4.8,,.01,.1],"tone/jingle/001":[1.4,,183,.07,.13,.34,,3.3,,,35,.06,.07,,,,.13,.95,.27,.11],"tone/jingle/002":[.8,,208,.02,.21,.13,3,.2,,,40,.06,.1,,,,,.91,.2,.27],"tone/jingle/003":[.9,,56,.15,.46,.08,,1.6,-2,,-137,.01,.06,,,,.09,.77,.37,.13],"tone/jingle/004":[.6,,269,.03,.17,.41,,.2,,1,239,.08,.04,,,,,.72,.19,.43,-720],"tone/jingle/005":[1.3,0,130.81,.32,.35,.5,3,5.2,0,1,50,0,.14,0,0,0,0,.37,.04,.24,0],"tone/jingle/006":[1,,525,.18,.28,.17,1,1.24,8.3,-9.7,-151,.03,.06,,,,,.93,.02,.14],"tone/jingle/007":[.6,,934,.12,.38,.93,1,.27,,.4,-434,.08,.2,.1,,.1,.17,.55,1,.46],"tone/jingle/008":[1.4,0,20,.04,,.6,,1.31,,,-990,.06,.17,,,.04,.07],"tone/jingle/009":[1.2,0,80,.3,.4,.7,2,.1,-.73,3.42,-430,.09,.17,,,,.19],"tone/jingle/010":[.5,,392,.06,.22,.5,1,1.85,-.1,-.9,61,.05,.07,,,.1,,.96,.12],"tone/jingle/011":[.5,,146,.04,.23,.46,,.56,,-3.7,658,.02,.15,.1,,,,.82,.13,.2],"tone/jingle/012":[1,,284,.08,.2,.25,1,3,,,50,.09,.06,,,,,.6,.28,.03,-1391],"tone/jingle/013":[1.5,,430,.02,.12,.5,,.89,,-3.6,-133,.07,.13,,,.1,,.83,.23,.26],"tone/jingle/014":[.4,,22,.08,.22,.02,1,.52,-4.2,-9.8,,,.14,,-18,.2,,,.05],"tone/jingle/015":[,,193,.04,.27,.42,1,1.71,2.8,4.9,,,.1,.2,,.1,,.55,.27,.47],"tone/jingle/016":[1.1,,250,.07,.24,.26,,2,,164,211,.07,.08,,,.1,,.75,.12,.09,115],"tone/jingle/017":[,,103,.04,.11,.43,1,.77,,,57,.19,.05,,,.1,,.68,.24],"ui/click/001":[1.5,0,900,,.01,0,1,,-10,,-31,.02,,,,,,1.2,,.16,-1448],"ui/click/002":[2.5,,783,,.03,.02,1,2,,,940,.03,,,,,.2,.6,,.06],"ui/click/003":[1.5,.01,300,,,.02,3,.22,,,-9,.2,,,,,,.5],"ui/click/004":[1,0,685,.01,.03,.17,1,1.4,,,,,,,,,,.63,.01,,420],"ui/click/005":[6,,205,,.02,0,,1.03,,,,,,,,,.12,.32],"weapon/explode/001":[1.5,0,333,.01,0,.9,4,1.9,,,,,,.5,,.6],"weapon/explode/002":[1.1,0,418,0,.02,.2,4,1.15,-8.5,,,,,.7,,.1],"weapon/explode/003":[1.2,0,82,.02,,.2,4,4,,,,,,.8,,.2,,.8,.09],"weapon/explode/004":[2,.2,72,.01,.01,.2,4,,,,,,,1,,.5,.1,.5,.02],"weapon/explode/005":[2,,1e3,.02,,.2,1,3,.1,,,,,1,-30,.5,,.5],"weapon/explode/006":[1,,485,.02,.2,.2,4,.11,-3,.1,,,.05,1.1,,.4,,.57,.5],"weapon/explode/007":[.8,,372,.02,.02,.5,4,2.29,.2,,,,,.6,,.6,,.7,.04,.19],"weapon/explode/008":[1.05,,591,.03,.13,.51,4,3.02,.6,.1,,,.04,1.6,,1,,.46,.13],"weapon/explode/009":[1.99,,770,.03,.19,.35,,.26,,,,,,2,-50,.1,.27,.48,.06],"weapon/explode/010":[1.5,,98,.08,.18,.02,2,2.47,36,.5,,,.04,.1,,.9,.44,,.04],"weapon/explode/011":[1,,400,,.03,.21,3,.85,.5,,,,,1.8,,.5,,.97,.05],"weapon/explode/012":[1,,485,.02,.07,.03,4,.11,-3,.1,,,.05,1.1,,.4,,.57,.09],"weapon/explode/013":[,,30,.09,.12,.35,4,3,4,,,,,1.3,,.6,,.36,.21],"weapon/lazer/001":[1.5,0,515,.05,.07,.09,1,2.8,,,302,.06,.1,,3.5,.1,.08,.75,.04],"weapon/lazer/002":[,0,925,.04,.3,.6,1,.3,,6.27,-184,.09,.17],"weapon/lazer/003":[1,,375,.01,.06,,2,2.3,18,-10,,,,,18,,,.56,.14],"weapon/lazer/004":[.5,,2e3,,.05,0,,1.11,-17,,197,.01,,.2,,,,,.16],"weapon/lazer/005":[.9,,752,.03,.01,.02,,1.4,,,-10,.01,,,3.4,,,.68,.03,,106],"weapon/lazer/006":[1.9,,221,.01,.05,.06,1,3.9,-2,,116,.05,,,,,,.65,.02,,452],"weapon/lazer/007":[1,,659,.01,.04,,1,.4,,-75,179,.06,,,.2,,,.57],"world/footstep/001":[1.1,.05,157,.03,.04,.04,4,4.9,78,-13,0,0,.07,0,0,0,0,.91,.02,.33,0],"world/footstep/002":[.1,1,300,.05,.1,.05,4,.2,-100,,-50,.07,,.5,,.4,,,,.05],"world/footstep/003":[3,,5,,.06,.01,2,2.25,-19,-79,409,.01,,,6.6,,.2,.57,,.8],"world/nature/frog":[.5,,160,.03,.03,.02,,1.52,-23,93,662,.02,,,,.1,,,.07,.01],"world/nature/dolphin":[.5,0,448,.01,.1,.3,3,.39,-.5,,,,,,.2,.1,.08],"world/nature/whale":[1.2,0,1306,.8,.08,.02,1,,,,,,.48,,-.1,.11,.25],"world/nature/mouse":[1.2,0,1e3,.02,,.01,2,,18,,475,.01,.01],"world/nature/small-dog":[1,,759,.01,,.01,1,.97,15,,,,,,3.1,,,.76,.04],"world/nature/tweet":[.7,,1305,,,.03,1,.75,,23,694,.01,,,3.9,,,,.01],"world/water/splash":[2,,94,.07,.1,.33,4,.6,1,,,,,.1,1,.1,.1,.45,.15],"world/water/wave":[1,0,40,.5,,1.5,,11,,,,,,199],"world/water/pop":[1,0,103,,.02,.06,,1.24,-18,4.4,,,,.7,,.1,,.95,.03],"world/weather/thunder":[1.2,0,471,,.09,.47,4,1.06,-6.7,,,,,.9,61,.1,,.82,.09,.13]},t.Sfx.play=function(s=""){s&&(t.Utilities.checkString("sfx",s),t.Sfx.library[s]||t.Utilities.fatal(`SFX ${s} not found.`),t.Sfx.playFromArray(t.Sfx.library[s]))},t.Sfx.playFromArray=function(s=[]){t.Utilities.checkArray("sfxArray",s),zzfx(...s)},t.Sfx.add=function(s,a){t.Utilities.checkString("sfxName",s),t.Utilities.checkArray("sfxArray",a),t.Sfx.library[s]=a},t.Sfx.get=function(){return Object.keys(t.Sfx.library)}})(beep8),(function(t){t.Scene={};let s=null;const a={};t.Scene.add=function(i,n=null,o=30){t.Utilities.checkString("name",i),n!==null&&t.Utilities.checkObject("gameObject",n),t.Utilities.checkInt("frameRate",o);const r=n.init||null,e=n.update||null,l=n.render||null;a[i]={init:r,update:e,render:l,frameRate:o}},t.Scene.set=function(i){t.Utilities.checkString("name",i),a[i]||t.Utilities.fatal(`Scene "${i}" does not exist.`),t.Core.stopFrame(),s=i,t.Input&&typeof t.Input.onEndFrame=="function"&&t.Input.onEndFrame();const n=a[i];n.init&&n.init(),(n.update||n.render)&&t.frame(n.render,n.update,n.frameRate)},t.Scene.pause=function(){t.frame(null)},t.Scene.resume=function(){if(!s)return;const i=a[s];(i.update||i.render)&&t.frame(i.render||(()=>{}),i.update||(()=>{}),i.frameRate||30)},t.Scene.get=function(){return s},t.Scene.getAll=function(){return a}})(beep8),(function(t){t.Renderer={};let s=!1,a=0,i=null,n=null;const o=()=>{if(!t.Core.realCtx){setTimeout(o,10);return}i=t.Core.realCtx.createRadialGradient(t.Core.realCanvas.width/2,t.Core.realCanvas.height/2,Math.max(t.Core.realCanvas.width,t.Core.realCanvas.height)*.4,t.Core.realCanvas.width/2,t.Core.realCanvas.height/2,Math.max(t.Core.realCanvas.width,t.Core.realCanvas.height)*.9),i.addColorStop(0,"rgba(255,255,255,0)"),i.addColorStop(.7,"rgba(0,0,0,0.5)"),i.addColorStop(1,"rgba(0,0,0,1)");const l=new OffscreenCanvas(1,2),u=l.getContext("2d");u.fillStyle="rgba(0,0,0,0.15)",u.fillRect(0,1,1,1),u.fillStyle="rgba(255,255,255,0.0)",u.fillRect(0,0,1,1),n=t.Core.realCtx.createPattern(l,"repeat")};document.addEventListener("beep8.initComplete",o),t.Renderer.render=function(){if(t.Core.crashed)return;t.Core.realCtx.imageSmoothingEnabled=!1;let l=0,u=0;if(a>0){let f=a*t.CONFIG.CHR_WIDTH;l=Math.round(Math.random()*f-f/2),u=Math.round(Math.random()*f-f/2),l=t.Utilities.clamp(l,-6,6),u=t.Utilities.clamp(u,-6,6),a-=t.Core.deltaTime}t.Core.realCtx.globalCompositeOperation="source-over",t.Core.realCtx.clearRect(0,0,t.Core.realCanvas.width,t.Core.realCanvas.height),t.Core.realCtx.drawImage(t.Core.offCanvas,l,u,t.Core.realCanvas.width,t.Core.realCanvas.height),s=!1,t.CursorRenderer.draw(t.Core.realCtx),e(),r()};const r=()=>{i&&t.CONFIG.CRT_ENABLE&&(t.Core.realCtx.save(),t.Core.realCtx.globalCompositeOperation="multiply",t.Core.realCtx.fillStyle=i,t.Core.realCtx.fillRect(0,0,t.Core.realCanvas.width,t.Core.realCanvas.height),t.Core.realCtx.restore())},e=()=>{n&&t.CONFIG.CRT_ENABLE&&(t.Core.realCtx.save(),t.Core.realCtx.globalCompositeOperation="soft-light",t.Core.realCtx.fillStyle=n,t.Core.realCtx.fillRect(0,0,t.Core.realCanvas.width,t.Core.realCanvas.height),t.Core.realCtx.restore())};t.Renderer.shakeScreen=function(l=.25){return t.Utilities.checkNumber("duration",l),l<=0?(t.Utilities.warn(`Screenshake duration must be positive. Currently: ${l}`),!1):(a=l,!0)},t.Renderer.markDirty=function(){s||(s=!0,setTimeout(t.Renderer.render,1))}})(beep8),(function(t){t.Random={};let s=null;t.Random.setSeed=function(i=null){i===null&&(i=Date.now()),typeof i=="string"&&(i=i.split("").reduce((n,o)=>n+o.charCodeAt(0),0)),i^=i<<13,i^=i>>17,i^=i<<5,i>>>=0,s=i;for(let n=0;n<10;n++)t.Random.num()},t.Random.getSeed=function(){return s},t.Random.num=function(){return s=(s*1664525+1013904223)%4294967296,s/4294967296},t.Random.range=function(i,n){return t.Utilities.checkNumber("min",i),t.Utilities.checkNumber("max",n),i+t.Random.num()*(n-i)},t.Random.int=function(i,n){if(t.Utilities.checkInt("min",i),t.Utilities.checkInt("max",n),n<=i){const r=n;n=i,i=r}const o=t.Random.range(i,n);return Math.round(o)},t.Random.pick=function(i){t.Utilities.checkArray("array",i);const n=t.Random.int(0,i.length-1);return i[n]};const a=new Map;t.Random.pickWeighted=function(i,n=.2){t.Utilities.checkArray("array",i);const o=JSON.stringify(i)+`|${n}`;let r=a.get(o);return r||(r=t.Random.weightedArray(i,n),a.set(o,r)),t.Random.pick(r)},t.Random.shuffleArray=function(i){t.Utilities.checkArray("array",i),i=i.slice();for(let n=0;n<i.length;n++){const o=t.Random.int(0,i.length-1),r=i[n];i[n]=i[o],i[o]=r}return i},t.Random.chance=function(i){return t.Utilities.checkNumber("probability",i),t.Random.num()<=i/100},t.Random.weightedArray=function(i,n=.2){t.Utilities.checkArray("array",i);const o=[];for(let r=0;r<i.length;r++){const e=Math.pow(n,r)*10;for(let l=0;l<e;l++)o.push(i[r])}return o},t.Random.coord2D=function(i,n,o){let r=2166136261^o;return r=Math.imul(r^i,16777619),r=Math.imul(r^n,16777619),r^=r>>>13,r=Math.imul(r,2246822507),r^=r>>>16,(r>>>0)/4294967296},t.Random.smooth2D=function(i,n,o=0,r=1){i*=r,n*=r;const e=Math.floor(i),l=Math.floor(n),u=i-e,f=n-l,C=t.Random.coord2D(e,l,o),h=t.Random.coord2D(e+1,l,o),w=t.Random.coord2D(e,l+1,o),d=t.Random.coord2D(e+1,l+1,o),A=t.Math.fade(u),S=t.Math.fade(f),R=t.Math.lerp(C,h,A),M=t.Math.lerp(w,d,A);return t.Math.lerp(R,M,S)},t.Random.setSeed()})(beep8),(function(t){t.Passcodes={},t.Passcodes.codeLength=4,t.Passcodes.getCode=function(a){t.Utilities.checkIsSet("id",a);const i=a+t.CONFIG.PASSKEY;let n=s(i);return n=n.replace(/[^a-zA-Z]/g,""),n=n.toUpperCase(),n.substring(0,t.Passcodes.codeLength)},t.Passcodes.checkCode=function(a,i){return t.Utilities.checkIsSet("id",a),t.Utilities.checkString("code",i),t.Passcodes.getCode(a)===i},t.Passcodes.getId=function(a){for(t.Utilities.checkString("code",a),a=a.toUpperCase(),c=1;c<999;c++)if(t.Passcodes.checkCode(c,a))return c;return null},t.Passcodes.input=async function(){const a="Enter code:",i=a.length+2+2,n=6;let o=Math.round((t.CONFIG.SCREEN_COLS-i)/2),r=Math.round((t.CONFIG.SCREEN_ROWS-n)/2);t.Core.setCursorLocation(o,r),t.TextRenderer.printBox(i,n),t.Core.setCursorLocation(o+2,r+2);const e=await t.Async.readLine(a,"",t.Passcodes.codeLength);return t.Passcodes.getId(e)};function s(a){a=btoa(a);let i=0,n="";for(let o=0;o<a.length;o++)i=(i<<5)-i+a.charCodeAt(o),i=i&i;for(let o=0;o<5;o++)i=(i<<5)-i+t.CONFIG.PASSKEY.charCodeAt(o%t.CONFIG.PASSKEY.length),n+=Math.abs(i).toString(36);return n}})(beep8),(function(t){t.Particles={};let s=[];t.Particles.add=function(a,i,n){t.Utilities.checkNumber("x",a),t.Utilities.checkNumber("y",i),t.Utilities.checkObject("props",n);const r=Object.assign({},{x:a,y:i,vx:0,vy:0,life:1,size:1,color:15,gravity:0},n);Array.isArray(r.color)&&(r.color=t.Random.pick(r.color)),Array.isArray(r.size)&&(r.size=t.Random.pick(r.size)),s.push(r)},t.Particles.createExplosion=function(a,i,n=10,o={}){t.Utilities.checkNumber("x",a),t.Utilities.checkNumber("y",i),t.Utilities.checkNumber("count",n),t.Utilities.checkObject("props",o);const r={size:1,color:t.Core.drawState.fgColor,life:2,speed:25,gravity:0},e=Object.assign({},r,o);for(let l=0;l<n;l++){const u=t.Random.range(0,Math.PI*2),f=t.Random.range(e.speed/2,e.speed);t.Particles.add(a,i,{size:e.size,color:e.color,life:e.life,vx:Math.cos(u)*f,vy:Math.sin(u)*f,g:e.gravity})}},t.Particles.update=function(a){for(let i=s.length-1;i>=0;i--){const n=s[i];n.vy+=n.g*a,n.x+=n.vx*a,n.y+=n.vy*a,n.life-=a,n.life<=0&&s.splice(i,1)}},t.Particles.render=function(){for(let a=0;a<s.length;a++){const i=s[a],n=i.size/2;t.Core.offCtx.fillStyle=t.Core.getColorHex(i.color),t.Core.offCtx.fillRect(Math.round(i.x-n),Math.round(i.y-n),Math.round(i.size),Math.round(i.size))}},t.Particles.clearAll=function(){s=[]},t.Particles.getParticles=function(){return[...s]},t.Particles.setParticles=function(a){t.Utilities.checkArray("particles",a),s=a}})(beep8),(function(t){let s=0,a=!1;function i(){a||(a=!0,s=Date.now(),t.Utilities.event("pageVisibility.sleep"))}function n(){if(!a||(a=!1,s===0))return;const o=Date.now()-s;t.Utilities.log("Time asleep:",(o/1e3).toFixed(3)),t.Utilities.event("pageVisibility.wake",{time:o}),s=0}document.addEventListener("visibilitychange",function(){document.hidden?i():n()}),window.addEventListener("blur",()=>i()),window.addEventListener("focus",()=>n())})(beep8),(function(t){t.Music={};function s(E,x){for(var y=[],v=0;v<E;v++)y.push(x(v));return y}const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function i(E){var x=/^([A-Ga-g])([#b]?)(\d)$/,y=E.match(x);if(!y)return null;var v=y[1].toUpperCase(),D=y[2],I=parseInt(y[3],10),g={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[v];return D==="#"?g+=1:D==="b"&&(g-=1),(I+1)*12+g}function n(E){let x=i(E);return x===null?"?":(x=t.Utilities.clamp(x,36,87),a.charAt(x-36))}function o(E){if(E.length===0)return"";for(var x=E[0],y=1;y<E.length;y++)E[y]===E[y-1]&&E[y]!==" "&&E[y]!=="|"?x+="-":x+=E[y];return x}function r(E,x,y,v){for(var D=s(E,function(){return!1}),I=0;I<v&&!(y>E);I++)D=e(D,y,x),y*=2;return D}function e(E,x,y){for(var v=s(x,function(){return!1}),D=0;D<y;D++)v[t.Random.int(0,x-1)]=!0;return E.map(function(I,g){return v[g%x]?!I:I})}const l=[["I","IIIm","VIm"],["IV","IIm"],["V","VIIm"]],u=[[0,1,2],[1,2,0],[2,0]],f={I:["C4","E4","G4","B4"],IIIm:["E4","G4","B4","D5"],VIm:["A3","C4","E4","G4"],IV:["F4","A4","C5","E5"],IIm:["D4","F4","A4","C5"],V:["G3","B3","D4","F4"],VIIm:["B3","D4","F4","A4"]},C={C:0,D:2,Eb:3,F:5,G:7,A:9,Bb:10},h=[0,1,2,3,4,5],w=[6,7];function d(E,x){const y=f[x]||f.I,v=C[E]||0;return y.map(function(D){return A(D,v)})}function A(E,x){var y=i(E);if(y===null)return E;y+=x;var v=Math.floor(y/12)-1,D=y%12,I=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return I[D]+v}function S(E){for(var x=["C","D","Eb","F","G","A","Bb"],y=t.Random.pick(x),v=4,D=null,I=0,g=[],m=0;m<E;m++){if(m%v===0){m===0?(I=t.Random.int(0,l.length-1),D=t.Random.pick(l[I])):t.Random.num()<.8-m/v%2*.5&&(I=t.Random.pick(u[I]),D=t.Random.pick(l[I]));var B=d(y,D)}g.push(B)}return g}function R(E,x){for(var y=[t.Random.pick(h),"|"],v=r(E,4,8,3),D=t.Random.int(-1,1),I=0;I<E;I++){if(t.Random.chance(10)&&(D+=t.Random.int(-1,1)),!v[I]){y.push(" ");continue}var g=x[I],m=g[t.Random.int(0,g.length-1)],B=parseInt(m.slice(-1),10),T=t.Utilities.clamp(B+D,3,6),k=m.slice(0,-1).toUpperCase(),U=k+T,Q=n(U);y.push(Q)}return y.push("|"),o(y)}function M(E,x){const y=[t.Random.pick(h),"|"];for(var v=t.Random.chance(30),D=t.Random.pick([4,8,16]),I=s(D,function(){return t.Random.int(0,3)}),g=t.Random.pick([2,4,8]),m=v?s(E,function(){return!0}):r(E,t.Random.pick([1,1,g/2]),g,2),B=t.Random.int(-1,1),T=t.Random.chance(v?30:80),k=0,U=0;U<E;U++){if(T&&U%g===0&&(k=(k+1)%2),!m[U]){y.push(" ");continue}var Q=x[U],_=v?I[U%D]:0,H=Q[_],G=parseInt(H.slice(-1),10),L=t.Utilities.clamp(G+B+k,3,6),O=H.slice(0,-1).toUpperCase(),P=O+L,j=n(P);y.push(j)}return y.push("|"),o(y)}function F(E){const x=[t.Random.pick(w),"|"],y=r(E,t.Random.int(1,3),t.Random.pick([4,8]),3);for(var v=n("C4"),D=0;D<E;D++)x.push(y[D]?v:" ");return x.push("|"),o(x)}t.Music.generate=function(E){E&&E.seed&&t.Random.setSeed(E.seed);const x={seed:t.Random.int(1e4,99999),noteCount:t.Random.pick([16,32,48,64]),channelCount:t.Random.int(2,5),drumPartRatio:.3,tempo:t.Random.pick([70,100,140,170,200,240,280]),hold:t.Random.pick([40,50,60,60,70,70,70,80,80,80,80,90,90,90,100,110,120,130,140,150])},y=Object.assign({},x,E);t.Music.currentSongProperties=y,t.Random.setSeed(y.seed);var v=S(y.noteCount),D=s(y.channelCount,function(){var g=t.Random.num()<y.drumPartRatio;return g?F(y.noteCount):t.Random.num()<.5?R(y.noteCount,v):M(y.noteCount,v)});if(y.tempo!==null){var I=String(y.tempo);y.hold!==null&&(I+="."+String(y.hold)),D[0]=I+`
`+D[0]}return D.join(`
`)};let N=null;t.Music.play=function(E){p1(E),E&&(N=E)},t.Music.stop=function(E=!0){t.Utilities.checkBoolean("clearCurrentSong",E),E&&(N=null),t.Music.play("")},t.Music.pause=function(){t.Music.isPlaying()&&t.Music.stop(!1)},t.Music.resume=function(){N&&!t.Music.isPlaying()&&t.Music.play(N)},t.Music.setVolume=function(E){t.Utilities.checkNumber("volume",E),p1.setVolume(E)},t.Music.setTempo=function(E){t.Utilities.checkInt("tempo",E),E<50&&(E=50),p1.setTempo(E)},t.Music.isPlaying=function(){return p1.isPlaying()},document.addEventListener("beep8.pageVisibility.wake",t.Music.resume),document.addEventListener("beep8.pageVisibility.sleep",t.Music.pause)})(beep8),(function(t){t.Menu={},t.Menu.display=async function(a,i){i=i||{},t.Utilities.checkArray("choices",a),t.Utilities.checkObject("options",i),i=Object.assign({title:"",prompt:"",selBgColor:t.Core.drawState.fgColor,selFgColor:t.Core.drawState.bgColor,border:!0,borderChar:t.CONFIG.BORDER_CHAR,center:!1,centerH:!1,centerV:!1,padding:1,selIndex:0,typewriter:!1},i);let n=t.Core.drawState.cursorCol,o=t.Core.drawState.cursorRow;const r=t.TextRenderer.measure(i.prompt),e=i.prompt?1:0,l=i.borderChar?1:0;let u=0;const f=a.length;a.forEach(d=>{u=Math.ceil(Math.max(u,t.TextRenderer.measure(d).cols))});let C=Math.ceil(Math.max(r.cols,u))+2*i.padding+2*l;C=Math.min(C,t.CONFIG.SCREEN_COLS);const h=e*(r.rows+1)+f+2*i.padding+2*l;if((i.centerH||i.center)&&(n=Math.round((t.CONFIG.SCREEN_COLS-C)/2)),(i.centerV||i.center)&&(o=Math.round((t.CONFIG.SCREEN_ROWS-h)/2)),t.Core.drawState.cursorCol=n,t.Core.drawState.cursorRow=o,i.border&&(t.TextRenderer.printBox(C,h,!0,i.borderChar),i.title)){const d=" "+i.title+" ";t.Core.drawState.cursorCol=n+Math.round((C-d.length)/2),t.TextRenderer.print(d)}i.prompt&&(t.Core.drawState.cursorCol=r.cols<=C?n+l+i.padding:n+Math.round((C-r.cols)/2),t.Core.drawState.cursorRow=o+l+i.padding,i.typewriter?await t.Async.typewriter(i.prompt):t.TextRenderer.print(i.prompt));let w=i.selIndex;for(;;){t.Core.drawState.cursorRow=o+l+i.padding+e*(r.rows+1),t.Core.drawState.cursorCol=r.cols<=u?n+l+i.padding:n+Math.round((C-u)/2),s(a,w,i);const d=await t.Input.readKeyAsync();if(d.includes("ArrowUp"))w=w>0?w-1:a.length-1,a.length>1&&t.Sfx.play(t.CONFIG.SFX.MENU_UP);else if(d.includes("ArrowDown"))w=(w+1)%a.length,a.length>1&&t.Sfx.play(t.CONFIG.SFX.MENU_DOWN);else if(d.includes("Enter")||d.includes("ButtonA")||d.includes("ButtonB")||d.includes(" "))return t.Sfx.play(t.CONFIG.SFX.MENU_SELECT),w}};const s=function(a,i,n){const o=t.Core.drawState.bgColor,r=t.Core.drawState.fgColor;for(let e=0;e<a.length;e++){const l=e===i;t.Core.setColor(l?n.selFgColor:r,l?n.selBgColor:o),t.TextRenderer.print(a[e]+`
`)}t.Core.setColor(r,o)}})(beep8),(function(t){t.Math={},t.Math.dist2D=function(a,i,n,o){t.Utilities.checkNumber("x0",a),t.Utilities.checkNumber("y0",i),t.Utilities.checkNumber("x1",n),t.Utilities.checkNumber("y1",o);const r=a-n,e=i-o;return Math.sqrt(r*r+e*e)},t.Math.lerp=function(a,i,n){return a+(i-a)*n},t.Math.fade=function(a){return a*a*a*(a*(a*6-15)+10)},t.Math.smoothstep=function(a){return a*a*(3-2*a)};function s(a){return a*a*a*(a*(a*6-15)+10)}})(beep8),(function(t){t.Inventory={},document.addEventListener("beep8.initComplete",()=>{t.Inventory.reset()},{once:!0}),t.Inventory.reset=function(){t.data.inventory={counts:{},flags:{}}},t.Inventory.getCount=function(s){return t.data.inventory.counts[s]??0},t.Inventory.add=function(s,a=1,i=1/0){const n=t.Inventory.getCount(s);t.data.inventory.counts[s]=Math.min(n+a,i)},t.Inventory.remove=function(s,a=1){const i=t.Inventory.getCount(s);t.data.inventory.counts[s]=Math.max(i-a,0)},t.Inventory.has=function(s,a=1){return t.Inventory.getCount(s)>=a},t.Inventory.setFlag=function(s,a=!0){t.data.inventory.flags[s]=a},t.Inventory.getFlag=function(s){return t.Utilities.checkString("flag",s),!!t.data.inventory.flags[s]},t.Inventory.filter=function(s){const a=[],i=t.data.inventory.counts,n=s instanceof RegExp;n||t.Utilities.checkString("match",s);for(const o in i){if(!Object.hasOwn(i,o))continue;const r=i[o];r<=0||(n&&s.test(o)||!n&&o.includes(s))&&a.push({id:o,count:r})}return a}})(beep8),(function(t){t.Intro={},t.Intro.loading=async function(){t.color(0,4),t.cls(),t.locate(1,1),t.print(`8> beep8 Loading...
`),await t.Async.wait(.4)},t.Intro.splash=async function(){const s=t.Tilemap.load("mBqYHoMBBACDAAMEgwADBIMBBACDAQQAgxh6AwSDGJkDBIMBBACDAQQAgwEEAIMDAwSDAwMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwADBIMAAwSDAAMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwMDBIMDAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAAQEgwAEBIMABAQADwAADwCYHoMBBACDGJIDBIMYNwMEgxhbAwSDGDcDBIMYNwMEgxg3AwSDGQEEAwSDGDcDBIMYNwMEgxg3AwSDGDcDBIMYNwMEgxg3AwSDGDcDBIMZARYDBIMYNwMEgxg4AwSDAQQAgwEEAIMBBACDAAQEgwMDBIMBBAAADwAADwCYHoMPBQSDGEgDBIMCDwSDAQ8AgxMPBIMBBACDGQGIDwSDGQGHDwSDGQGJDwSDGE4FBIMZAVMPBIMZAVQPBIMZAVUPBIMYTgUEgwEPBIMBDwCDEw8EgxhKAwSDAQQAgwEEAIMBBACDDwUEgwEEAIMBBAAADwAADwCYHoMBBACDGEgDBIMBDwCDGHIFBIMBDwCDGE4FBIMZAZkPBIMYcgUEgxg9BQSDGK8FBIMZAVMPBIMYcgUEgxg9BQSDGK8FBIMLDwSDGHIFBIMLDwSDGEgDBIMBBACDAQQAgwEEAIMABASDAQQAgw8FBAAPAAAPAJgegwEEAIMYSgMEgwEPAIMBDwCDFwQPgwEEAIMZAZ0PBIMBDwSDGE4FBIMBBACDGQFUDwSDGQFTDwSDGE4BBIMBBACDAQ8EgwEPAIMYJQ8FgxhuDwSDGG4PBIMYlw8EgwAPBIMABASDAQQAgwEEAAAPAAAPAJgegwEEAIMYSAMEgwkPBIMYcgUEgwEPAIMYTgEEgxkBnQ8EgxhyBQSDGK8FBIMBBACDGQFTDwSDGHIFBIMYrwUEgwEEAIMBDwSDGHIFBIMYPQUEgxhIAwSDAQQAgwEEAIMBBACDAAQEgwAEBIMABAQADwAADwCYHoMBBACDGEgDBIMYTw8EgwEPAIMYJQ8FgxhOBQSDGQGaDwSDEgoPgxgcBQqDGBkFCoMYHQUKgxMKD4MYHQUPgxhOBQSDBg8EgxhOBQSDDwMEgxhIAwSDDgUEgwEEAIMBBACDAQQAgwEEAIMBBAAADwAADwCYHoMBBACDGFoDBIMYNwMEgxg3AwSDGDcDBIMYNwMEgxg3AwSDAQoEgxgrCgWDGDcDBIMYKwQKgwEKBIMYKwUEgxg3AwSDGFsDBIMYNwMEgxg3AwSDGKUDBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMYJAoEgxguBQqDGBkKBIMYLwQKgxglCgWDGCsBBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgxgpAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMSCgSDGBwFCoMYGQEKgxgdBQqDEwoFgxgiBQSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegxiXDwODGJcPA4MYGAMEgwEEAIMBBACDAQQAgw0FBIMLBAqDGCsKBYMABASDGCsECoMBCgSDGDIFBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMDAwSDAwMEgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgxgkCgSDGC4FCoMYGQoEgxgvBAqDGCUKBYMYKwUEgwAFCoMYHQEEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAQQAgwEEAIMACgSDAAoEgwAKBIMYLgUEgxgZBAWDGBkEAYMYGQQFgxgvBQSDGC4FBIMYLwUEgwEEAIMBBACDAQQAgwEEAIMYrAMEgxg3AwSDGDcDBIMYWwMEgxg3AwQADwAADwCYHoMYNwMEgxg3AwSDGJsDBIMBBACDAQQAgwEEAIMBBACDAQQEgwEEBIMBBASDAQQEgwEEBIMBBACDAQQAgwEEAIMBBACDGQHlAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAQQAgwEEAIMYbgMEgxhuAwSDGG4DBIMYbgMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAA8EgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwADBIMYegMEgxiZAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMAAwSDAAMEgwADBAAPAAAPAJgegxgcCgSDGB0KBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgxgpAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DGC4KBIMYLwoEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgxgpAwSDGCkDBIMBBACDAQQAgwEEAIMBBACDAQQAgxcDBIMBAwSDGBgDBIMAAwSDAQQAgxh0AwSDGIYDBIMABQSDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDAA8EgwEEAIMBBACDAQQAgxcDBIMCAwSDAQMEgxgYAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAAMEgwADBIMYdAMEgxkBbAUEgwEEAIMZAUYFBIMBBAAADwAADwCYHoMWAwSDGCgDBIMBBACDAQQAgxh0AwSDEAMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDFgMEgxgoAwSDGHQDBIMYhgMEgxkBbAUEgwAFBIMABQWDAQUEgwEFBIMBBQQADwAADwCYHoMYKAUDgwAFA4MYKAMEgxh0AwSDAQQAgwEEAIMNBQSDAQQAgwEEAIMYdAMEgxiGAwSDFgMEgxgoAwSDFgMEgwEDBIMBAwSDEAMEgxi0BQSDAAEFgwMBBYMABQWDAQUEgwEFBIMBBQQADwAADwCYHoMBBQSDGCgFA4MABQODGCgDBIMYuAUEgwEEAIMBBACDGIYDBIMYdAMEgxi4BQSDDwMEgwsDBIMBAwSDAQMEgxkBagUDgwEDBIMYnAUDgwADBYMAAQWDAQUEgwAFBYMPAQWDAQUEgwEFBAAPAAAPAJgegwMBBYMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgw8BBYMRAQWDDwEFgwMFAYMBBQSDAQUEAA8AAA8AloMRAQWDEQEFgwMBBYMDAQWDAwEFgwMBBYMADwWDAwEFgwMBBYMADwWDAA8FgwAPBYMDAQWDAA8FgwAPBYMADwWDDwEFgwsBBYMRAQWDCwEFgxhYBQGDAA8BloMADwGDEAEFgwAPBYMADwWDAA8FgwAPBYMADwWDAQEFgxABBYMADwWDAA8FgwAPBYMADwWDAA8FgwkBBYMADwWDAA8FgwQBBYMADwGDAA8BgwAPAYMABQE=");t.locate(0,0),t.Tilemap.draw(s);let a="Click to start";t.Core.isTouchDevice()&&(a="Tap to start"),t.color(4,5),t.locate(0,t.CONFIG.SCREEN_ROWS-2),t.printCentered(a,t.CONFIG.SCREEN_COLS),await t.Input.readPointerAsync(),t.color(15,0),t.cls()}})(beep8),(function(t){t.Input={};let s=null,a=null;t.Input.init=function(){s=new Set,a=new Set,window.addEventListener("keydown",n=>t.Input.onKeyDown(n)),window.addEventListener("keyup",n=>t.Input.onKeyUp(n)),window.addEventListener("pointerdown",n=>t.Input.onPointerDown(n))},t.Input.keyHeld=function(n){return s.has(n.toUpperCase())},t.Input.keyJustPressed=function(n){return a.has(n.toUpperCase())},t.Input.onEndFrame=function(){a.clear()},t.Input.onKeyDown=function(n){const o=n.key,r=t.Input.getKeys(o);["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(o)&&n.preventDefault();for(const e of r)a.add(e.toUpperCase()),s.add(e.toUpperCase());t.Core.hasPendingAsync("beep8.Async.key")&&t.Core.resolveAsync("beep8.Async.key",r)},t.Input.onPointerDown=function(n){t.Core.hasPendingAsync("beep8.Async.pointer")&&t.Core.resolveAsync("beep8.Async.pointer",{x:n.clientX,y:n.clientY})},t.Input.onKeyUp=function(n){if(!n.key)return;const o=n.key.toUpperCase(),r=t.Input.getKeys(o);for(const e of r)s.delete(e.toUpperCase())},t.Input.readKeyAsync=function(){return new Promise((n,o)=>{t.Core.startAsync("beep8.Async.key",n,o)})},t.Input.readPointerAsync=function(){return new Promise((n,o)=>{t.Core.startAsync("beep8.Async.pointer",n,o)})},t.Input.getKeys=function(n){let o=[n];switch(n.toUpperCase()){case"W":o.push("ArrowUp");break;case"A":o.push("ArrowLeft");break;case"S":o.push("ArrowDown");break;case"D":o.push("ArrowRight");break;case"Enter":o.push("Escape");break;case"Z":case"N":o.push("ButtonA");break;case"X":case"M":o.push("ButtonB");break}return o},t.Input.readLine=async function(n="Enter text:",o="",r=100,e=-1){if(n&&n.length>0&&t.print(n+`
> `),t.Core.isMobile()){const A=await i(n,o,r,e);return t.print(A+`
`),await t.Async.wait(.2),A}const l=t.Core.drawState.cursorCol,u=t.Core.drawState.cursorRow;let f=l,C=u,h=[o],w=0;const d=t.Core.drawState.cursorVisible;for(t.CursorRenderer.setCursorVisible(!0);;){t.Core.setCursorLocation(f,C),t.TextRenderer.print(h[w]||"");const A=await t.Input.readKeyAsync();for(const S of A)if(S==="Backspace"){if(h[w].length===0){if(w===0)continue;w--,C--}h[w]=h[w].length>0?h[w].substring(0,h[w].length-1):h[w],t.Core.setCursorLocation(f+t.TextRenderer.measure(h[w]).cols,C),t.TextRenderer.print(" "),t.Sfx.play(t.CONFIG.SFX.TYPING)}else{if(S==="Enter")return t.CursorRenderer.setCursorVisible(d),t.Sfx.play(t.CONFIG.SFX.TYPING),h.join("");S.length===1&&((h.join("").length<r||r===-1)&&(h[w]+=S,e!==-1&&h[w].length>=e&&(t.TextRenderer.print(h[w].charAt(h[w].length-1)),f=l,w++,h[w]="",C++)),t.Sfx.play(t.CONFIG.SFX.TYPING))}}};const i=async function(n="Enter text:",o="",r=100,e=-1){let l=!1,u="";const f=t.CONFIG.CHRS;do await t.Async.wait(.333),u=prompt(n,o),u=u.trim(),u=u.split("").filter(C=>f.includes(C)).join(""),r!==-1&&(u=u.substring(0,r)),l=u.length>0;while(l===!1);return u}})(beep8),(function(t){"use strict";t.ECS={};let s=0,a=new Map,i=[],n=new Map;function o(){return s++}function r(e){return a.has(e)||a.set(e,new Map),a.get(e)}t.ECS.entitiesAt=function(e,l){return i[l]?.[e]??[]},t.ECS.addSystem=function(e,l,u=0){t.Utilities.checkFunction("fn",l),t.Utilities.checkString("name",e),t.Utilities.checkInt("order",u),n.has(e)&&t.Utilities.warn(`ECS: overwriting existing system "${e}"`),n.set(e,{fn:l,order:u})},t.ECS.addSystemOnce=function(e,l,u=0){t.Utilities.checkFunction("fn",e),t.Utilities.checkString("name",l),t.Utilities.checkInt("order",u),!n.has(l)&&t.ECS.addSystem(e,l,u)},t.ECS.removeSystem=function(e){n.delete(e)},t.ECS.run=function(e,l=()=>!0){[...n.entries()].sort((u,f)=>u[1].order-f[1].order).forEach(([u,{fn:f}])=>{l(u)&&f(e)})},t.ECS.add=function(e,l=null,u={}){t.Utilities.checkInt("id",e),t.Utilities.checkString("name",l),t.Utilities.checkObject("data",u),r(l).set(e,u),l==="Loc"&&t.ECS.setLoc(e,u.col,u.row)},t.ECS.set=function(e,l,u){t.ECS.add(e,l,u)},t.ECS.setLoc=function(e,l,u){t.Utilities.checkInt("id",e),t.Utilities.checkInt("col",l),t.Utilities.checkInt("row",u);const f=this.getComponent(e,"Loc"),C=i[f.row];if(C){const h=C[f.col];if(h){const w=h.indexOf(e);w!==-1&&h.splice(w,1)}}f.col=l,f.row=u,i[u]||(i[u]=[]),i[u][l]||(i[u][l]=[]),i[u][l].push(e)},t.ECS.getComponents=function(e){return t.Utilities.checkString("name",e),a.get(e)??new Map},t.ECS.getEntity=function(e){t.Utilities.checkInt("id",e);const l=new Map;for(const[u,f]of a)f.has(e)&&l.set(u,f.get(e));return l},t.ECS.getComponent=function(e,l){return t.Utilities.checkInt("id",e),t.Utilities.checkString("name",l),a.get(l)?.get(e)},t.ECS.hasComponent=function(e,l){return t.Utilities.checkInt("id",e),t.Utilities.checkString("name",l),a.get(l)?.has(e)??!1},t.ECS.removeComponent=function(e,l){if(t.Utilities.checkInt("id",e),t.Utilities.checkString("name",l),a.get(l)?.delete(e),l==="Loc"){const u=this.getComponent(e,"Loc");if(u){const f=i[u.row]?.[u.col];f&&f.splice(f.indexOf(e),1)}}},t.ECS.removeEntity=function(e){const l=this.getComponent(e,"Loc");if(l){const u=i[l.row]?.[l.col];u&&u.splice(u.indexOf(e),1)}for(const u of a.values())u.delete(e)},t.ECS.create=function(e){t.Utilities.checkObject("bundle",e);const l=o();for(const[u,f]of Object.entries(e))t.ECS.add(l,u,f);return l},t.ECS.query=function(...e){if(e.length===0)return[];const l=a.get(e[0]);return l?[...l.keys()].filter(u=>e.every(f=>a.get(f)?.has(u))):[]},t.ECS.countByType=function(e){const l=this.get("Type");if(!l)return 0;let u=0;for(const f of l.values())f.name===e&&u++;return u},t.ECS.reset=function(){a=new Map,n=new Map,i=[],s=0}})(beep8),(function(t){t.CursorRenderer={};let s=0,a=null;t.CursorRenderer.setCursorVisible=function(n){t.Utilities.checkBoolean("visible",n),t.Core.drawState.cursorVisible!==n&&(t.Core.drawState.cursorVisible=n,s=0,t.Renderer.render(),a!==null&&(clearInterval(a),a=null),n&&(a=setInterval(()=>i(),t.CONFIG.CURSOR.BLINK_INTERVAL)))},t.CursorRenderer.draw=function(n){if(t.Utilities.checkInstanceOf("targetCtx",n,CanvasRenderingContext2D),!t.Core.drawState.cursorVisible||s<=0)return;const o=t.TextRenderer.getFont(),r=t.Core.drawState.cursorCol*t.CONFIG.CHR_WIDTH,e=t.Core.drawState.cursorRow*t.CONFIG.CHR_HEIGHT;n.fillStyle=t.Core.getColorHex(t.Core.drawState.fgColor),n.fillRect(r+1,e+1,o.charWidth_-2,o.charHeight_-2)};function i(){s=(s+1)%2,t.Renderer.render()}})(beep8),(function(t){t.Core={},t.Core.realCanvas=null,t.Core.realCtx=null,t.Core.offCanvas=null,t.Core.offCtx=null,t.Core.container=null,t.Core.startTime=0,t.Core.deltaTime=0,t.Core.crashed=!1,t.Core.crashing=!1,t.Core.drawState={fgColor:7,bgColor:0,cursorCol:0,cursorRow:0,cursorVisible:!1};let s=null,a=!1,i=null,n=null,o=0,r=0,e=null;t.Core.init=function(d,A={}){t.Utilities.checkFunction("callback",d),A&&t.Utilities.checkObject("options",A),t.CONFIG={...t.CONFIG,...A},t.Hooks.doAction("beforeInit"),t.Core.initScreenshot(),t.Core.asyncInit(d),t.Core.startTime=t.Core.getNow(),t.Hooks.doAction("afterInit"),t.Utilities.event("initComplete")},t.Core.initialized=function(){return a},t.Core.asyncInit=async function(d=null){if(t.Utilities.log("beep8 System initializing"),t.CONFIG.SCREEN_WIDTH=t.CONFIG.SCREEN_COLS*t.CONFIG.CHR_WIDTH,t.CONFIG.SCREEN_HEIGHT=t.CONFIG.SCREEN_ROWS*t.CONFIG.CHR_HEIGHT,t.Core.realCanvas=document.createElement("canvas"),t.CONFIG.CANVAS_SETTINGS&&t.CONFIG.CANVAS_SETTINGS.CANVAS_ID&&t.Core.realCanvas.setAttribute("id",t.CONFIG.CANVAS_SETTINGS.CANVAS_ID),t.CONFIG.CANVAS_SETTINGS&&t.CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES)for(const A of t.CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES)t.Core.realCanvas.classList.add(A);t.Core.realCanvas.style.touchAction="none",t.Core.realCanvas.style.userSelect="none",t.Core.realCanvas.style.imageRendering="pixelated",t.Core.realCanvas.addEventListener("touchstart",A=>A.preventDefault()),t.Core.container=document.createElement("div"),t.Core.container.setAttribute("style",""),t.Core.container.id="beep8",t.Core.container.style.display="block",t.Core.container.style.lineHeight="0",t.Core.container.style.position="relative",t.Core.container.appendChild(t.Core.realCanvas),t.Core.getBeepContainerEl().appendChild(t.Core.container),t.Core.offCanvas=new OffscreenCanvas(t.CONFIG.SCREEN_WIDTH,t.CONFIG.SCREEN_HEIGHT),t.Core.offCtx=t.Core.offCanvas.getContext("2d",{alpha:!1,colorSpace:"srgb",desynchronized:!0}),t.Core.offCtx.imageSmoothingEnabled=!1,await t.TextRenderer.initAsync(),t.Input.init(),t.Core.updateLayout(!1),window.addEventListener("resize",()=>t.Core.updateLayout(!0)),t.Core.isMobile()&&t.Joystick.setup(),a=!0,t.Utilities.log("beep8 System initialized"),await t.Intro.loading(),await t.Intro.splash(),d&&await d()},t.Core.getBeepContainerEl=function(){let d=document.body;if(t.CONFIG.CANVAS_SETTINGS&&t.CONFIG.CANVAS_SETTINGS.CONTAINER){const A=t.CONFIG.CANVAS_SETTINGS.CONTAINER;typeof A=="string"?(d=document.getElementById(A.replace("#","")),d||t.Utilities.fatal("beep8: Could not find container element with ID: "+A)):A instanceof HTMLElement?d=A:(t.Utilities.error("beep8: beep8.CONFIG.CANVAS_SETTINGS.CONTAINER must be either an ID of an HTMLElement."),d=document.body)}return d},t.Core.preflight=function(d){if(t.Core.crashed)throw new Error(`Can't call API method ${d}() because the engine has crashed.`);a||t.Utilities.fatal(`Can't call API method ${d}(): API not initialized. Call initAsync() wait until it finishes before calling API methods.`),e&&t.Utilities.fatal(`Can't call API method ${d}() because there is a pending async call to ${e.name}() that hasn't finished running yet. Are you missing an 'await' keyword to wait for the async method? Use 'await ${e.name}()',not just '${e.name}()'`)},t.Core.startAsync=function(d,A,S){if(e)throw new Error("Internal bug: startAsync called while pendingAsync is not null. Missing preflight() call?");e={name:d,resolve:A,reject:S},t.Renderer.render()},t.Core.hasPendingAsync=function(d=null){return d===null?!!e:e&&e.name===d},t.Core.endAsyncImpl=function(d,A,S){if(!e)throw new Error(`Internal bug: endAsync(${d}) called with no pendingAsync`);if(e.name!==d)throw new Error(`Internal bug: endAsync(${d}) called but pendingAsync.name is ${e.name}`);const R=A?e.reject:e.resolve;e=null,R(S)},t.Core.resolveAsync=function(d,A){t.Core.endAsyncImpl(d,!1,A)},t.Core.failAsync=function(d,A){t.Core.endAsyncImpl(d,!0,A)};let l=!1,u=null;t.Core.setFrameHandlers=function(d=null,A=null,S=30){i=A||(()=>{}),n=d||(()=>{}),o=1/S,r=0,s=t.Core.getNow(),u&&(window.cancelAnimationFrame(u),u=null),l=!0,u=window.requestAnimationFrame(t.Core.doFrame)},t.Core.doFrame=async function(){if(!l)return;const d=t.Core.getNow();let A=(d-s)/1e3;s=d,t.Core.deltaTime=A,A=Math.min(A,.05),r+=A;let S=Math.floor(r/o);const R=10;S>R&&(S=R,r=0);for(let M=0;M<S;M++)i&&i(o),t.Input&&typeof t.Input.onEndFrame=="function"&&t.Input.onEndFrame(),t.Particles.update(o);r%=o,n&&n(),t.Renderer.render(),u=window.requestAnimationFrame(t.Core.doFrame)},t.Core.stopFrame=function(){l=!1,u&&(window.cancelAnimationFrame(u),u=null)},t.Core.cls=function(d=void 0){d=d||t.Core.drawState.bgColor,t.Utilities.checkNumber("bgColor",d),t.Core.offCtx.fillStyle=t.Core.getColorHex(d),t.Core.offCtx.fillRect(0,0,t.Core.offCanvas.width,t.Core.offCanvas.height),t.Core.setCursorLocation(0,0),t.Renderer.markDirty()},t.Core.defineColors=function(d){t.Utilities.checkArray("colors",d),t.CONFIG.COLORS=d.slice(),t.TextRenderer.regenColors()},t.Core.setColor=function(d,A=void 0){t.Utilities.checkNumber("fg",d),t.Core.drawState.fgColor=Math.round(d),A!==void 0&&(t.Utilities.checkNumber("bg",A),t.Core.drawState.bgColor=Math.round(A))},t.Core.setCursorLocation=function(d,A){t.Utilities.checkNumber("col",d),t.Core.drawState.cursorCol=Math.round(d*2)/2,A!==void 0&&(t.Utilities.checkNumber("row",A),t.Core.drawState.cursorRow=Math.round(A*2)/2)},t.Core.nextCursorLocation=function(){let d=t.Core.drawState.cursorCol,A=t.Core.drawState.cursorRow;t.Core.setCursorLocation(d+1,A)},t.Core.getColorHex=function(d){return typeof d!="number"?"#f0f":d<0?"#000":(d=t.Utilities.clamp(Math.round(d),0,t.CONFIG.COLORS.length-1),t.CONFIG.COLORS[d])},t.Core.getNow=function(){return window.performance&&window.performance.now?window.performance.now():new Date().getTime()},t.Core.drawImage=function(d,A,S,R,M,F,N){t.Utilities.checkInstanceOf("img",d,HTMLImageElement),t.Utilities.checkNumber("x",A),t.Utilities.checkNumber("y",S),R!==void 0&&t.Utilities.checkNumber("srcX",R),M!==void 0&&t.Utilities.checkNumber("srcY",M),F!==void 0&&t.Utilities.checkNumber("width",F),N!==void 0&&t.Utilities.checkNumber("height",N),R!==void 0&&M!==void 0&&F!==void 0&&N!==void 0?t.Core.offCtx.drawImage(d,R,M,F,N,A,S,F,N):t.Core.offCtx.drawImage(d,A,S)},t.Core.loadImage=async function(d){return t.Utilities.log("load image",d),new Promise(A=>{const S=new Image;S.crossOrigin="Anonymous",S.onload=()=>{const R=document.createElement("canvas"),M=R.getContext("2d");R.width=S.width,R.height=S.height,M.drawImage(S,0,0);const F=M.getImageData(0,0,R.width,R.height),N=F.data,E=h(t.CONFIG.COLORS);for(let y=0;y<N.length;y+=4){const v=N[y],D=N[y+1],I=N[y+2],g=f(v,D,I,E),{r:m,g:B,b:T}=g;N[y]=m,N[y+1]=B,N[y+2]=T}M.putImageData(F,0,0);const x=new Image;x.onload=()=>A(x),x.src=R.toDataURL()},S.src=d})},t.Core.drawRect=function(d,A,S,R,M=1){t.Utilities.checkNumber("x",d),t.Utilities.checkNumber("y",A),t.Utilities.checkNumber("width",S),t.Utilities.checkNumber("height",R),t.Utilities.checkNumber("lineWidth",M);const F=t.Core.offCtx.strokeStyle,N=t.Core.offCtx.lineWidth;t.Core.offCtx.strokeStyle=t.Core.getColorHex(t.Core.drawState.fgColor),t.Core.offCtx.lineWidth=M,t.Core.offCtx.strokeRect(Math.round(d),Math.round(A),Math.round(S),Math.round(R)),t.Core.offCtx.strokeStyle=F,t.Core.offCtx.lineWidth=N},t.Core.fillRect=function(d,A,S,R){t.Utilities.checkNumber("x",d),t.Utilities.checkNumber("y",A),t.Utilities.checkNumber("width",S),t.Utilities.checkNumber("height",R),t.Core.offCtx.fillStyle=t.Core.getColorHex(t.Core.drawState.fgColor),t.Core.offCtx.fillRect(Math.round(d)+.5,Math.round(A)+.5,Math.round(S)-1,Math.round(R)-1)},t.Core.initScreenshot=function(){if(t.Core.initialized())return;const d=A=>{A.key==="0"&&t.Core.downloadScreenshot()};document.addEventListener("pointerup",d),document.addEventListener("keyup",d)},t.Core.saveScreen=function(){return t.Core.offCtx.getImageData(0,0,t.Core.offCanvas.width,t.Core.offCanvas.height)},t.Core.downloadScreenshot=function(){const d=t.Core.getHighResDataURL(t.Core.realCanvas);t.Utilities.downloadFile("beep8-screenshot.png",d)},t.Core.getHighResDataURL=function(d,A=4,S="image/png",R=1){const M=new OffscreenCanvas(d.width*A,d.height*A),F=M.getContext("2d");return F.imageSmoothingEnabled=!1,F.scale(A,A),F.drawImage(d,0,0),M.toDataURL(S,R)},t.Core.restoreScreen=function(d){t.Utilities.checkInstanceOf("screenData",d,ImageData),t.Core.offCtx.putImageData(d,0,0)},t.Core.updateLayout=function(d){t.Core.updateLayout2d(),d&&t.Renderer.render()},t.Core.updateLayout2d=function(){t.Core.realCtx=t.Core.realCanvas.getContext("2d",{alpha:!1,desynchronized:!0}),t.Core.realCtx.imageSmoothingEnabled=!1,t.Core.realCtx.imageSmoothingQuality="pixelated",t.CONFIG.SCREEN_EL_WIDTH=t.CONFIG.SCREEN_WIDTH,t.CONFIG.SCREEN_EL_HEIGHT=t.CONFIG.SCREEN_HEIGHT,t.CONFIG.SCREEN_REAL_WIDTH=t.CONFIG.SCREEN_WIDTH,t.CONFIG.SCREEN_REAL_HEIGHT=t.CONFIG.SCREEN_HEIGHT,t.Core.realCanvas.style.width="100%",t.Core.realCanvas.style.height="100%",t.Core.realCanvas.style.filter="blur(0.5px)",t.Core.realCanvas.width=t.CONFIG.SCREEN_REAL_WIDTH,t.Core.realCanvas.height=t.CONFIG.SCREEN_REAL_HEIGHT,t.Core.container.style.aspectRatio=`${t.CONFIG.SCREEN_COLS} / ${t.CONFIG.SCREEN_ROWS}`},t.Core.handleCrash=function(d="Fatal error"){t.Core.crashed||t.Core.crashing||(t.Core.crashing=!0,t.Core.setColor(t.CONFIG.COLORS.length-1,0),t.Core.cls(),t.Core.setCursorLocation(1,1),t.TextRenderer.print(`*** CRASH ***:
`+d,null,t.CONFIG.SCREEN_COLS-2),t.Renderer.render(),t.Core.crashing=!1,t.Core.crashed=!0)},t.Core.isTouchDevice=function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},t.Core.isMobile=function(){return t.Core.isIOS()||t.Core.isAndroid()||t.Core.isTouchDevice()},t.Core.isIOS=function(){return/(ipad|ipod|iphone)/i.test(navigator.userAgent)},t.Core.isAndroid=function(){return/android/i.test(navigator.userAgent)};function f(d,A,S,R,M=4){const F=Math.floor(d/M)*M,N=Math.floor(A/M)*M,E=Math.floor(S/M)*M,x=`${F},${N},${E}`;return R[x]}const C={};function h(d,A=4){if(Object.keys(C).length!==0)return C;const S=d.map(R=>t.Utilities.hexToRgb(R));for(let R=0;R<256;R+=A)for(let M=0;M<256;M+=A)for(let F=0;F<256;F+=A){const N=`${R},${M},${F}`;C[N]=w(R,M,F,S)}return C}function w(d,A,S,R){let M=null,F=1/0;for(const N of R){const E=Math.pow(N.r-d,2)+Math.pow(N.g-A,2)+Math.pow(N.b-S,2);E<F&&(F=E,M=N)}return M}})(beep8),(function(t){t.Collision={},t.COLLISION={},t.COLLISION.NONE=0,t.COLLISION.N=1,t.COLLISION.E=2,t.COLLISION.S=4,t.COLLISION.W=8,t.COLLISION.NE=t.COLLISION.N+t.COLLISION.E,t.COLLISION.NS=t.COLLISION.N+t.COLLISION.S,t.COLLISION.NW=t.COLLISION.N+t.COLLISION.W,t.COLLISION.SE=t.COLLISION.S+t.COLLISION.E,t.COLLISION.SW=t.COLLISION.S+t.COLLISION.W,t.COLLISION.WE=t.COLLISION.W+t.COLLISION.E,t.COLLISION.WNE=t.COLLISION.W+t.COLLISION.N+t.COLLISION.E,t.COLLISION.WES=t.COLLISION.W+t.COLLISION.E+t.COLLISION.S,t.COLLISION.NES=t.COLLISION.N+t.COLLISION.E+t.COLLISION.S,t.COLLISION.ALL=t.COLLISION.N+t.COLLISION.E+t.COLLISION.S+t.COLLISION.W})(beep8),(function(t){t.Cart={};const s="BEEP8",a=new TextEncoder().encode(s),i=1;t.Cart.save=async function(u,f,C="cart.png"){t.Utilities.checkInstanceOf("canvas",u,HTMLCanvasElement),t.Utilities.checkString("data",f),t.Utilities.checkString("filename",C);const h=await new Promise(d=>u.toBlob(d,"image/png")),w=await n(h,f);saveAs(w,C)},t.Cart.load=async function(u){const f=await(typeof u=="string"?(await fetch(u)).arrayBuffer():u.arrayBuffer()),C=new Uint8Array(f),h=o(C,s);h<0&&t.Utilities.fatal("Error Loading Cart: No BEEP8 trailer found");const w=C[h+5];w!==i&&t.Utilities.fatal(`Error Loading Cart: Unsupported version ${w}`);const d=r(C,h+6),A=h+10,S=A+d;S+4>C.length&&t.Utilities.fatal("Error Loading Cart: Trailer length out of range");const R=C.subarray(A,S),M=r(C,S);return l(R)!==M&&t.Utilities.fatal("Error Loading Cart: Bad payload CRC"),JSON.parse(new TextDecoder().decode(R))};async function n(u,f){const C=new TextEncoder().encode(JSON.stringify(f)),h=a.length+1+4+C.length+4,w=new Uint8Array(h);let d=0;w.set(a,d),d+=a.length,w[d++]=i,e(w,d,C.length),d+=4,w.set(C,d),d+=C.length,e(w,d,l(C)),d+=4;const A=new Uint8Array(await u.arrayBuffer());return new Blob([A,w],{type:"image/png"})}function o(u,f){const C=new TextEncoder().encode(f);for(let h=u.length-C.length;h>=0;h--){let w=!0;for(let d=0;d<C.length;d++)if(u[h+d]!==C[d]){w=!1;break}if(w)return h}return-1}function r(u,f){const C=u[f],h=u[f+1],w=u[f+2],d=u[f+3];return(C<<24|h<<16|w<<8|d)>>>0}function e(u,f,C){u[f]=C>>>24&255,u[f+1]=C>>>16&255,u[f+2]=C>>>8&255,u[f+3]=C&255}function l(u){let f=4294967295;for(let C=0;C<u.length;C++){f^=u[C];for(let h=0;h<8;h++)f&1?f=f>>>1^3988292384:f>>>=1}return~f>>>0}})(beep8),(function(t){t.Actors={},t.Actors.animations={idle:{frames:[0],fps:1},"idle-right":{frames:[1],fps:1},"idle-left":{frames:[-1],fps:1},"idle-up":{frames:[4],fps:1},"move-right":{frames:[1,2],fps:4,loop:!0},"move-left":{frames:[-1,-2],fps:4,loop:!0},"move-up":{frames:[5,-5],fps:4,loop:!0},"move-down":{frames:[3,-3],fps:4,loop:!0},"jump-right":{frames:[5],fps:1,loop:!1},"jump-left":{frames:[-5],fps:1,loop:!1},"spin-left":{frames:[0,1,4,-1],fps:4,loop:!0},"spin-right":{frames:[0,-1,4,1],fps:4,loop:!0}};const s=function(n,o,r,e,l){const u=t.TextRenderer.curActors_,f=n*u.getColCount()+Math.abs(a(o));t.TextRenderer.spr(f,r,e,u,l||0)};t.Actors.draw=function(n,o){t.Utilities.checkInt("ch",n),t.Utilities.checkString("animation",o);const e=a(o)>=0?0:1;s(n,o,t.Core.drawState.cursorCol*t.CONFIG.CHR_WIDTH,t.Core.drawState.cursorRow*t.CONFIG.CHR_HEIGHT,e||0)},t.Actors.spr=function(n,o,r,e,l=null){t.Utilities.checkInt("ch",n),t.Utilities.checkString("animation",o),t.Utilities.checkNumber("x",r),t.Utilities.checkNumber("y",e),l!==null&&t.Utilities.checkNumber("startTime",l);const u=a(o,l),f=t.Actors.animations[o],C=u>=0?0:1;return i(f,l)?(s(n,o,r,e,C||0),!0):!1};const a=function(n,o=null){t.Actors.animations[n]===void 0&&t.Utilities.fatal("Invalid animation: "+n),o===null&&(o=t.Core.startTime);const r=t.Actors.animations[n];let e=0;if(r.frames.length===1&&(e=r.frames[0]),r.frames.length>1){const l=t.Core.getNow()-o,u=r.frames.length,f=1/r.fps,C=Math.floor(l/1e3/f%u);e=r.frames[C]}return e},i=function(n,o){if(o===null||n.loop===!0)return!0;const r=n.frames.length*(1e3/n.fps);return!(t.Core.getNow()-o>=r)}})(beep8);const zzfx=(...t)=>zzfxP(zzfxG(...t)),zzfxV=.3,zzfxR=44100,zzfxX=new AudioContext,zzfxP=(...t)=>{let s=zzfxX.createBuffer(t.length,t[0].length,zzfxR),a=zzfxX.createBufferSource();return t.map((i,n)=>s.getChannelData(n).set(i)),a.buffer=s,a.connect(zzfxX.destination),a.start(),a},zzfxG=(t=1,s=.05,a=220,i=0,n=0,o=.1,r=0,e=1,l=0,u=0,f=0,C=0,h=0,w=0,d=0,A=0,S=0,R=1,M=0,F=0,N=0)=>{let E=Math.PI*2,x=X=>X<0?-1:1,y=l*=500*E/zzfxR/zzfxR,v=a*=(1+s*2*Math.random()-s)*E/zzfxR,D=[],I=0,g=0,m=0,B=1,T=0,k=0,U=0,Q,_,H=2,G=E*Math.abs(N)*2/zzfxR,L=Math.cos(G),O=Math.sin(G)/2/H,P=1+O,j=-2*L/P,Y=(1-O)/P,W=(1+x(N)*L)/2/P,$=-(x(N)+L)/P,V=W,z=0,J=0,K=0,q=0;for(i=i*zzfxR+9,M*=zzfxR,n*=zzfxR,o*=zzfxR,S*=zzfxR,u*=500*E/zzfxR**3,d*=E/zzfxR,f*=E/zzfxR,C*=zzfxR,h=h*zzfxR|0,t*=zzfxV,_=i+M+n+o+S|0;m<_;D[m++]=U*t)++k%(A*100|0)||(U=r?r>1?r>2?r>3?Math.sin(I**3):Math.max(Math.min(Math.tan(I),1),-1):1-(2*I/E%2+2)%2:1-4*Math.abs(Math.round(I/E)-I/E):Math.sin(I),U=(h?1-F+F*Math.sin(E*m/h):1)*x(U)*Math.abs(U)**e*(m<i?m/i:m<i+M?1-(m-i)/M*(1-R):m<i+M+n?R:m<_-S?(_-m-S)/o*R:0),U=S?U/2+(S>m?0:(m<_-S?1:(_-m)/S)*D[m-S|0]/2/t):U,N&&(U=q=V*z+$*(z=J)+W*(J=U)-Y*K-j*(K=q))),Q=(a+=l+=u)*Math.cos(d*g++),I+=Q+Q*w*Math.sin(m**5),B&&++B>C&&(a+=f,v+=f,B=0),h&&!(++T%h)&&(a=v,l=y,B=B||1);return D};(function(){const t=new AudioContext,s=t.createGain();s.gain.value=1,s.connect(t.destination);let a={},i=null,n=[],o=[],r=0,e=125;const l=.5,u=50,f=.1;let C=!1;const h=(g,m)=>Math.sin(g*6.28+m),E=[g=>h(g,Math.pow(h(g,0),2)+h(g,.25)*.75+h(g,.5)*.1)*f,g=>Math.sin(g*6.28)*Math.sin(g*3.14)*f,g=>Math.sin(2*Math.PI*g)*f,g=>(2*(g-Math.floor(g))-1)*f,g=>(Math.sin(2*Math.PI*g)>=0?1:-1)*f,g=>{let m=g-Math.floor(g);return(2*Math.abs(2*m-1)-1)*f},g=>(Math.random()*2-1)*Math.exp(-g/10)*f,g=>(Math.sin(g*2)+.3*(Math.random()-.5))*Math.exp(-g/15)*f*2];function x(g){if(Array.isArray(g)&&(g=g[0]),!g||g.trim()===""){x.stop();return}a.length>200&&(console.warn("Beep8.Music: Note buffers exceeded limit, clearing old buffers."),a={}),e=125;let m=.5;n=[];const B=g.split(`
`).map(U=>U.trim());let T=e/1e3;const k=/^([0-9])\|(.*)\|$/;B.forEach(U=>{if(!U)return;if(U.startsWith("[")&&U.endsWith("]")||/^\d+(\.\d+)?$/.test(U)){const O=U.replace(/[\[\]]/g,"").split(".");e=parseFloat(O[0])||e,m=(parseFloat(O[1])||50)/100,T=e/1e3;return}if(!k.test(U)){console.error("Track lines must be in the format 'instrument|track data|': "+U);return}const Q=U.match(k),_=parseInt(Q[1],10),H=E[_]||E[0],G=Q[2].trim();let L=[];for(let O=0;O<G.length;O++){const P=G[O];let j=1;for(;O+j<G.length&&G[O+j]==="-";)j++;let Y=O*T;if(P===" "){L.push({startTime:Y,noteBuffer:null}),O+=j-1;continue}let W=P.charCodeAt(0);W-=W>90?71:65;let $=j*m*(e/125),V=v(W,$,44100,H);L.push({startTime:Y,noteBuffer:V}),O+=j-1}n.push(L)}),o=n.map(()=>0),r=t.currentTime+.1,x.stop(),i=setInterval(y,u)}function y(){const g=t.currentTime,m=e/1e3,B=Math.max(l,m);n.forEach((T,k)=>{let U=o[k];const Q=T.length;if(Q===0)return;const _=U%Q,H=Math.floor(U/Q),G=r+_*m+H*Q*m;if(G<g+B){const L=T[_];L.noteBuffer&&I(L.noteBuffer,t,G),o[k]++}}),x.loop||n.every((k,U)=>o[U]>=k.length)&&x.stop()}x.stop=function(){i!==null&&(clearInterval(i),i=null),D.forEach(g=>g.stop()),D=[]},x.isPlaying=function(){return i!==null},x.setTempo=function(g){g<50&&(g=50);const m=e/1e3,B=g/1e3,k=(t.currentTime-r)/m;r=t.currentTime-k*B,e=g},x.setVolume=function(g){s.gain.value=Math.min(1,Math.max(0,g))},x.clearCache=function(){a={}},x.loop=!0;const v=(g,m,B,T)=>{const k=g+"-"+m+"-"+T.name;let U=a[k];if(g>=0&&!U){const Q=65.406*Math.pow(1.06,g)/B,_=Math.floor(B*m),H=88,G=B*(m-.002);U=a[k]=t.createBuffer(1,_,B);const L=U.getChannelData(0);for(let O=0;O<_;O++){let P;O<H?P=O/(H+.2):P=Math.pow(1-(O-H)/G,Math.pow(Math.log(1e4*Q)/2,2)),L[O]=P*T(O*Q)}C||(I(U,t,t.currentTime,!0),C=!0)}return U};let D=[];const I=(g,m,B,T=!1)=>{const k=m.createBufferSource();k.buffer=g,k.connect(s),k.start(B),D.push(k),T&&k.stop(),k.onended=()=>{const U=D.indexOf(k);U!==-1&&D.splice(U,1)}};window.p1=x})(),(function(t,s){"use strict";var a=Math.pow(2,-24),i=Math.pow(2,32),n=Math.pow(2,53);function o(l){var u=new ArrayBuffer(256),f=new DataView(u),C,h=0;function w(I){for(var g=u.byteLength,m=h+I;g<m;)g*=2;if(g!==u.byteLength){var B=f;u=new ArrayBuffer(g),f=new DataView(u);for(var T=h+3>>2,k=0;k<T;++k)f.setUint32(k*4,B.getUint32(k*4))}return C=I,f}function d(){h+=C}function A(I){d(w(8).setFloat64(h,I))}function S(I){d(w(1).setUint8(h,I))}function R(I){for(var g=w(I.length),m=0;m<I.length;++m)g.setUint8(h+m,I[m]);d()}function M(I){d(w(2).setUint16(h,I))}function F(I){d(w(4).setUint32(h,I))}function N(I){var g=I%i,m=(I-g)/i,B=w(8);B.setUint32(h,m),B.setUint32(h+4,g),d()}function E(I,g){g<24?S(I<<5|g):g<256?(S(I<<5|24),S(g)):g<65536?(S(I<<5|25),M(g)):g<4294967296?(S(I<<5|26),F(g)):(S(I<<5|27),N(g))}function x(I){var g;if(I===!1)return S(244);if(I===!0)return S(245);if(I===null)return S(246);if(I===s)return S(247);switch(typeof I){case"number":if(Math.floor(I)===I){if(0<=I&&I<=n)return E(0,I);if(-n<=I&&I<0)return E(1,-(I+1))}return S(251),A(I);case"string":var m=[];for(g=0;g<I.length;++g){var B=I.charCodeAt(g);B<128?m.push(B):B<2048?(m.push(192|B>>6),m.push(128|B&63)):B<55296?(m.push(224|B>>12),m.push(128|B>>6&63),m.push(128|B&63)):(B=(B&1023)<<10,B|=I.charCodeAt(++g)&1023,B+=65536,m.push(240|B>>18),m.push(128|B>>12&63),m.push(128|B>>6&63),m.push(128|B&63))}return E(3,m.length),R(m);default:var T;if(Array.isArray(I))for(T=I.length,E(4,T),g=0;g<T;++g)x(I[g]);else if(I instanceof Uint8Array)E(2,I.length),R(I);else{var k=Object.keys(I);for(T=k.length,E(5,T),g=0;g<T;++g){var U=k[g];x(U),x(I[U])}}}}if(x(l),"slice"in u)return u.slice(0,h);for(var y=new ArrayBuffer(h),v=new DataView(y),D=0;D<h;++D)v.setUint8(D,f.getUint8(D));return y}function r(l,u,f){var C=new DataView(l),h=0;typeof u!="function"&&(u=function(m){return m}),typeof f!="function"&&(f=function(){return s});function w(m,B){return h+=B,m}function d(m){return w(new Uint8Array(l,h,m),m)}function A(){var m=new ArrayBuffer(4),B=new DataView(m),T=F(),k=T&32768,U=T&31744,Q=T&1023;if(U===31744)U=261120;else if(U!==0)U+=114688;else if(Q!==0)return Q*a;return B.setUint32(0,k<<16|U<<13|Q<<13),B.getFloat32(0)}function S(){return w(C.getFloat32(h),4)}function R(){return w(C.getFloat64(h),8)}function M(){return w(C.getUint8(h),1)}function F(){return w(C.getUint16(h),2)}function N(){return w(C.getUint32(h),4)}function E(){return N()*i+N()}function x(){return C.getUint8(h)!==255?!1:(h+=1,!0)}function y(m){if(m<24)return m;if(m===24)return M();if(m===25)return F();if(m===26)return N();if(m===27)return E();if(m===31)return-1;throw"Invalid length encoding"}function v(m){var B=M();if(B===255)return-1;var T=y(B&31);if(T<0||B>>5!==m)throw"Invalid indefinite length element";return T}function D(m,B){for(var T=0;T<B;++T){var k=M();k&128&&(k<224?(k=(k&31)<<6|M()&63,B-=1):k<240?(k=(k&15)<<12|(M()&63)<<6|M()&63,B-=2):(k=(k&15)<<18|(M()&63)<<12|(M()&63)<<6|M()&63,B-=3)),k<65536?m.push(k):(k-=65536,m.push(55296|k>>10),m.push(56320|k&1023))}}function I(){var m=M(),B=m>>5,T=m&31,k,U;if(B===7)switch(T){case 25:return A();case 26:return S();case 27:return R()}if(U=y(T),U<0&&(B<2||6<B))throw"Invalid length";switch(B){case 0:return U;case 1:return-1-U;case 2:if(U<0){for(var Q=[],_=0;(U=v(B))>=0;)_+=U,Q.push(d(U));var H=new Uint8Array(_),G=0;for(k=0;k<Q.length;++k)H.set(Q[k],G),G+=Q[k].length;return H}return d(U);case 3:var L=[];if(U<0)for(;(U=v(B))>=0;)D(L,U);else D(L,U);return String.fromCharCode.apply(null,L);case 4:var O;if(U<0)for(O=[];!x();)O.push(I());else for(O=new Array(U),k=0;k<U;++k)O[k]=I();return O;case 5:var P={};for(k=0;k<U||U<0&&!x();++k){var j=I();P[j]=I()}return P;case 6:return u(I(),U);case 7:switch(U){case 20:return!1;case 21:return!0;case 22:return null;case 23:return s;default:return f(U)}}}var g=I();if(h!==l.byteLength)throw"Remaining bytes";return g}var e={encode:o,decode:r};typeof define=="function"&&define.amd?define("cbor/cbor",e):t.CBOR||(t.CBOR=e)})(this);
