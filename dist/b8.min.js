/*!
 * b8.js - A Retro Game Library
 *
 * ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
 * ░░░░       ░░        ░        ░       ░░░     ░░░░░        ░░      ░░░░░
 * ▒▒▒▒  ▒▒▒▒  ▒  ▒▒▒▒▒▒▒  ▒▒▒▒▒▒▒  ▒▒▒▒  ▒  ▒▒▒  ▒▒▒▒▒▒▒▒▒▒  ▒  ▒▒▒▒▒▒▒▒▒▒
 * ▓▓▓▓       ▓▓      ▓▓▓      ▓▓▓       ▓▓▓     ▓▓▓▓▓▓▓▓▓▓▓  ▓▓      ▓▓▓▓▓
 * ████  ████  █  ███████  ███████  ███████  ███  ████  ████  ███████  ████
 * ████       ██        █        █  ████████     ██  ██      ███      █████
 * ████████████████████████████████████████████████████████████████████████
 *
 * b8.js is a retro game library designed to bring
 * the charm and simplicity of classic games to modern
 * web development. A fork of qx82, b8.js retains
 * the original's elegance while enhancing its features
 * for today's developers.
 *
 * ---
 *
 * Website: https://beepmini.com
 * Github: https://github.com/BinaryMoon/beepmini
 * BlueSky: https://bsky.app/profile/binarymoon.bsky.social
 *
 * ---
 *
 * MIT License
 *
 * Copyright (c) 2024 - 2025 BinaryMoon
 *
 * Permission is hereby granted, free of charge, to any
 * person obtaining a copy of this software and associated
 * documentation files (the "Software"), to deal in the
 * Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall
 * be included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */const b8={};(function(e){e.CONFIG={DEBUG:!0,NAME:"b8 Project",VERSION:"1.0.0-dev",CANVAS_SETTINGS:{CANVAS_ID:"b8-canvas",CANVAS_CLASSES:[],CONTAINER:null},SFX:{TYPING:"ui/click/003",MENU_UP:"tone/beep/002",MENU_DOWN:"tone/beep/001",MENU_SELECT:"tone/beep/003"},FONT_DEFAULT:"../assets/font-default-thin.png",FONT_TILES:"../assets/font-tiles.png",FONT_ACTORS:"../assets/font-actors.png",FONT_VFX:"../assets/font-vfx.png",CHRS:`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*+=-<>_#&@%^~$\xA3\u20AC\xA5\xA2!?:;'"/\\()[]{}.,\xA9\xAE\u2122\u2022\u2026| `,CHR_WIDTH:12,CHR_HEIGHT:12,SCREEN_ROWS:25,SCREEN_COLS:20,SCREEN_COLORS:1,CRT_ENABLE:!0,CRT_VIGNETTE:!0,COLORS:["#0A0C1F","#263264","#A0ABB6","#B2EFEB","#3FB0F1","#3548A3","#420241","#6A3E49","#C22D44","#E08355","#FFC763","#A7D171","#30AB62","#1E7F82","#FF76D7","#F4F4F4"],PASSKEY:"b8IsAwesome",TOUCH_VJOY:!0,CURSOR:{BLINK_INTERVAL:400},PRINT_ESCAPE_START:"{{",PRINT_ESCAPE_END:"}}",BORDER_CHAR:54}})(b8),(function(e){e.init=function(s,a={}){return e.Utilities.checkFunction("callback",s),e.Utilities.checkObject("options",a),a!==null&&(e.CONFIG=e.Utilities.deepMerge(e.CONFIG,a)),e.Core.init(s)},e.frame=function(s=null,a=null,r=30){return e.Core.preflight("b8.frame"),s!==null&&e.Utilities.checkFunction("render handler",s),a!==null&&e.Utilities.checkFunction("update handler",a),e.Utilities.checkNumber("fps",r),e.Core.setFrameHandlers(s,a,r)},e.render=function(){return e.Core.preflight("b8.render"),e.Renderer.render()},e.color=function(s,a=void 0){e.Core.preflight("b8.color"),e.Utilities.checkNumber("fg",s),a!==void 0&&e.Utilities.checkNumber("bg",a),e.Core.setColor(s,a)},e.getFgColor=function(){return e.Core.preflight("getFgColor"),e.Core.drawState.fgColor},e.getBgColor=function(){return e.Core.preflight("b8.getBgColor"),e.Core.drawState.bgColor},e.cls=function(s=void 0){if(e.Core.preflight("b8.Core.cls"),s!==void 0){e.Utilities.checkNumber("bg",s),e.Core.cls(s);return}e.Core.cls()},e.locate=function(s,a){e.Core.preflight("b8.locate"),e.Utilities.checkNumber("col",s),a!==void 0&&e.Utilities.checkNumber("row",a),e.Core.setCursorLocation(s,a)},e.col=function(){return e.Core.preflight("col"),e.Core.drawState.cursorCol},e.row=function(){return e.Core.preflight("row"),e.Core.drawState.cursorRow},e.cursor=function(s){e.Core.preflight("cursor"),e.Utilities.checkBoolean("visible",s),e.CursorRenderer.setCursorVisible(s)},e.print=function(s,a=-1,r=null){e.Core.preflight("b8.text"),e.Utilities.checkString("text",s),e.Utilities.checkNumber("maxWidth",a);let t=r;t!==null&&(e.Utilities.checkString("fontName",r),t=e.TextRenderer.getFontByName(r)),e.TextRenderer.print(s,t,a)},e.printCentered=function(s,a=e.CONFIG.SCREEN_COLS,r=null){e.Core.preflight("b8.printCentered"),e.Utilities.checkString("text",s),e.Utilities.checkNumber("width",a);let t=r;t!==null&&(e.Utilities.checkString("fontName",r),t=e.TextRenderer.getFontByName(r)),e.TextRenderer.printCentered(s,a,t)},e.printRight=function(s,a=e.CONFIG.SCREEN_COLS,r=null){e.Core.preflight("b8.printRight"),e.Utilities.checkString("text",s),e.Utilities.checkNumber("width",a);let t=r;t!==null&&(e.Utilities.checkString("fontName",r),t=e.TextRenderer.getFontByName(r)),e.TextRenderer.printRight(s,a,t)},e.drawText=function(s,a,r,t=null){e.Core.preflight("b8.drawText"),e.Utilities.checkNumber("x",s),e.Utilities.checkNumber("y",a),e.Utilities.checkString("text",r),t&&e.Utilities.checkString("fontName",t),e.TextRenderer.drawText(s,a,r,t)},e.measure=function(s){return e.Core.preflight("measure"),e.Utilities.checkString("text",s),e.TextRenderer.measure(s)},e.printChar=function(s,a=1,r=null){if(e.Core.preflight("b8.printChar"),s=e.convChar(s),e.Utilities.checkInt("charCode",s),e.Utilities.checkInt("numTimes",a),a<0&&e.Utilities.fatal("[b8.printChar] numTimes must be a positive integer"),a===0)return;let t=r;t!==null&&(e.Utilities.checkString("fontName",r),t=e.TextRenderer.getFontByName(r)),e.TextRenderer.printChar(s,a,t)},e.printRect=function(s,a,r=8){e.Core.preflight("b8.printRect"),r=e.convChar(r),e.Utilities.checkNumber("widthCols",s),e.Utilities.checkNumber("heightRows",a),e.Utilities.checkNumber("charCode",r),e.TextRenderer.printRect(s,a,r)},e.printBox=function(s,a,r=!0,t=e.CONFIG.BORDER_CHAR){e.Core.preflight("b8.printBox"),t=e.convChar(t),e.Utilities.checkNumber("widthCols",s),e.Utilities.checkNumber("heightRows",a),e.Utilities.checkBoolean("fill",r),e.Utilities.checkNumber("borderChar",t),e.TextRenderer.printBox(s,a,r,t)},e.drawImage=function(s,a,r){e.Utilities.checkInstanceOf("image",r,HTMLImageElement),e.Utilities.checkNumber("x",s),e.Utilities.checkNumber("y",a),e.Core.drawImage(r,s,a)},e.drawImageRect=function(s,a,r,t,i,n,o){e.Utilities.checkInstanceOf("image",r,HTMLImageElement),e.Utilities.checkNumber("x",s),e.Utilities.checkNumber("y",a),e.Utilities.checkNumber("srcX",t),e.Utilities.checkNumber("srcY",i),e.Utilities.checkNumber("width",n),e.Utilities.checkNumber("height",o),e.Core.drawImage(r,s,a,t,i,n,o)},e.drawRect=function(s,a,r,t,i=1){e.Utilities.checkNumber("x",s),e.Utilities.checkNumber("y",a),e.Utilities.checkNumber("width",r),e.Utilities.checkNumber("height",t),e.Utilities.checkNumber("lineWidth",i),e.Core.drawRect(s,a,r,t,i)},e.fillRect=function(s,a,r,t){e.Utilities.checkNumber("x",s),e.Utilities.checkNumber("y",a),e.Utilities.checkNumber("width",r),e.Utilities.checkNumber("height",t),e.Core.fillRect(s,a,r,t)},e.playSound=function(s,a=1,r=!1){e.Utilities.checkInstanceOf("sfx",s,HTMLAudioElement),s.currentTime=0,s.volume=a,s.loop=r,s.play()},e.spr=function(s,a,r){s=e.convChar(s),e.Utilities.checkNumber("ch",s),e.Utilities.checkNumber("x",a),e.Utilities.checkNumber("y",r),e.TextRenderer.spr(s,a,r)},e.drawActor=function(s,a,r=0,t=0){s=e.convChar(s),e.Utilities.checkInt("ch",s),e.Utilities.checkString("animation",a),e.Actors.draw(s,a,r,t)},e.sprActor=function(s,a,r,t,i=null){return s=e.convChar(s),e.Utilities.checkInt("ch",s),e.Utilities.checkString("animation",a),e.Utilities.checkNumber("x",r),e.Utilities.checkNumber("y",t),i!==null&&e.Utilities.checkNumber("startTime",i),e.Actors.spr(s,a,r,t,i)},e.key=function(s){return e.Core.preflight("b8.key"),e.Utilities.checkString("keyName",s),e.Input.keyHeld(s)},e.keyp=function(s){return e.Core.preflight("b8.keyp"),e.Utilities.checkString("keyName",s),e.Input.keyJustPressed(s)},e.playSong=function(s){e.Utilities.checkString("song",s),e.Sound.playSong(s)},e.playSfx=function(s){e.Utilities.checkString("sfx",s),e.Sfx.play(s)},e.redefineColors=function(s){e.Core.preflight("b8.redefineColors"),e.Utilities.checkArray("colors",s),e.Core.defineColors(s)},e.setFont=function(s){e.Core.preflight("b8.setFont"),s=s||"default-thin",e.Utilities.checkString("fontName",s),e.TextRenderer.setFont(s)},e.getFont=function(){e.Core.preflight("b8.getFont"),e.TextRenderer.getFont()},e.getFontByName=function(s){return e.Utilities.checkString("fontName",s),e.TextRenderer.getFontByName(s)},e.setTileFont=function(s){e.Core.preflight("b8.setTileFont"),s=s||"tiles",e.Utilities.checkString("fontName",s),e.TextRenderer.setTileFont(s)},e.convChar=function(s){return typeof s=="string"&&s.length>0?s.charCodeAt(0):s},e.stopSound=function(s){e.Utilities.checkInstanceOf("sfx",s,HTMLAudioElement),s.currentTime=0,s.pause()},e.getContext=function(){return e.Core.getContext()},e.saveScreen=function(){return e.Core.saveScreen()},e.screenShake=function(s){return e.Utilities.checkNumber("duration",s),e.Renderer.shakeScreen(s)},e.restoreScreen=function(s){return e.Core.restoreScreen(s)},e.wrapText=function(s,a){return e.Utilities.checkString("text",s),e.Utilities.checkNumber("maxWidth",a),e.TextRenderer.wrapText(s,a)},e.addScene=function(s,a={}){e.Scene.add(s,a)},e.switchScene=function(s){e.Scene.set(s)},e.getScene=function(){return e.Scene.get()},e.speak=function(s,a={}){if(!window.speechSynthesis)return;e.Utilities.checkString("text",s),e.Utilities.checkObject("options",a);const r=new SpeechSynthesisUtterance(s);r.pitch=a.pitch??1,r.rate=a.rate??1,r.volume=a.volume??1,speechSynthesis.speak(r)},e.reset=function(){e.Core.resetAll()}})(b8),(function(e){e._asyncActive=!1,e.Async=e.Async||{},e.Async=new Proxy(e.Async,{get(s,a,r){const t=Reflect.get(s,a,r);return typeof t=="function"?async function(...i){let n=!e._asyncActive;n&&(e._asyncActive=!0,e.Scene.pause());try{return e.Core.preflight(`b8.Async.${a}`),await t.apply(this,i)}finally{n&&(e.Scene.resume(),e._asyncActive=!1)}}:t}}),e.Async.key=async function(){return await e.Input.readKeyAsync()},e.Async.pointer=async function(){return await e.Input.readPointerAsync()},e.Async.readLine=async function(s="Enter text:",a="",r=-1,t=-1){return e.Utilities.checkString("initString",a),e.Utilities.checkString("prompt",s),e.Utilities.checkNumber("maxLen",r),e.Utilities.checkNumber("maxWidth",t),await e.Input.readLine(s,a,r,t)},e.Async.menu=async function(s,a={}){return e.Utilities.checkArray("choices",s),e.Utilities.checkObject("options",a),await e.Menu.display(s,a)},e.Async.dialog=async function(s,a=["OK"],r={}){return e.Utilities.checkString("prompt",s),e.Utilities.checkArray("choices",a),e.Async.menu(a,{prompt:s,center:!0,...r})},e.Async.dialogTypewriter=async function(s,a=["OK"],r=-1,t=.05,i={}){return e.Utilities.checkString("prompt",s),e.Utilities.checkArray("choices",a),e.Utilities.checkNumber("delay",t),r>0&&(s=e.TextRenderer.wrapText(s,r)),await e.Async.menu(a,{prompt:s,typewriter:!0,center:!0,...i})},e.Async.typewriter=async function(s,a=-1,r=.035,t=null){e.Utilities.checkString("text",s),e.Utilities.checkNumber("wrapWidth",a),e.Utilities.checkNumber("delay",r);let i=t;i!==null&&(e.Utilities.checkString("fontName",t),i=e.TextRenderer.getFontByName(t)),await e.TextRenderer.printTypewriter(s,a,r,i)},e.Async.loadImage=async function(s){return e.Utilities.checkString("url",s),await e.Core.loadImage(s)},e.Async.loadSound=async function(s){return new Promise(a=>{const r=new Audio;r.oncanplaythrough=()=>a(r),r.src=s,r.load()})},e.Async.loadFont=async function(s,a=1,r=1){e.Utilities.checkString("fontImageFile",s),e.Utilities.checkNumber("tileSizeWidthMultiplier",a),e.Utilities.checkNumber("tileSizeHeightMultiplier",r);const t="FONT@"+e.Utilities.makeUrlPretty(s);return await e.TextRenderer.loadFontAsync(t,s,a,r),t},e.Async.wait=async function(s){return e.Utilities.checkNumber("seconds",s),e.Renderer.render(),await new Promise(a=>setTimeout(a,Math.round(s*1e3)))},e.Async.waitForContinue=async function(){for(;;){const s=await e.Async.key();if(s.includes("Enter")||s.includes("ButtonA")||s.includes(" "))break}}})(b8),(function(e){e.Hooks={};const s={},a={};function r(t,i,n,o=10){t[i]||(t[i]=[]),t[i].push({callback:n,priority:o}),t[i].sort((l,u)=>l.priority-u.priority)}e.Hooks.reset=function(){for(const t in s)delete s[t];for(const t in a)delete a[t]},e.Hooks.addAction=function(t,i,n=10){r(s,t,i,n)},e.Hooks.doAction=function(t,...i){if(s[t])for(const{callback:n}of s[t])n(...i)},e.Hooks.addFilter=function(t,i,n=10){r(a,t,i,n)},e.Hooks.applyFilters=function(t,i,...n){if(!a[t])return i;let o=i;for(const{callback:l}of a[t])o=l(o,...n);return o},e.Hooks.removeAction=function(t,i){s[t]=(s[t]||[]).filter(n=>n.callback!==i)},e.Hooks.removeFilter=function(t,i){a[t]=(a[t]||[]).filter(n=>n.callback!==i)}})(b8),(function(e){e.Joystick={};let s=null;const a=`
<div class="vjoy-options">
	<button id='vjoy-button-ter' class='vjoy-button'>Start</button>
	<button id='vjoy-button-screenshot' class='vjoy-button'>Snap</button>
</div>
<div class="vjoy-controls">
	<div class="vjoy-dpad">
	<button id='vjoy-button-up' class='vjoy-button'><span>U</span></button>
	<button id='vjoy-button-right' class='vjoy-button'><span>R</span></button>
	<button id='vjoy-button-left' class='vjoy-button'><span>L</span></button>
	<button id='vjoy-button-down' class='vjoy-button'><span>D</span></button>
	</div>
	<div class="vjoy-buttons">
	<button id='vjoy-button-pri' class='vjoy-button'><span>A</span></button>
	<button id='vjoy-button-sec' class='vjoy-button'><span>B</span></button>
	</div>
</div>`,r=`
:root {
	--b8-vjoy-button-color: #333;
	--b8-vjoy-button-size: 14vw;
	--b8-vjoy-button-dpad-size: calc(var(--b8-vjoy-button-size) * 2);
	--b8-console-radius: 2rem;
	--b8-border-radius: calc(var(--b8-vjoy-button-dpad-size) / 5);
}

.vjoy-container,
.vjoy-container * {
	box-sizing: border-box;
	user-select: none;
	-webkit-user-select: none;
	-webkit-touch-callout: none;
	touch-action: none;
}

.vjoy-container {
	position: relative;
	width: 100%;
	padding: 8vw 4vw 8vw 6vw;
	background: deeppink;
	border-radius: 0 0 var(--b8-console-radius) var(--b8-console-radius);
}

.vjoy-options {
	border-radius: 5rem;
	position: absolute;
	display: flex;
	gap: 2vw;
	align-items: center;
	padding: 2vw;
	border-radius: 2rem;
	background: inherit;
	top: -4vw;
	left: 50%;
	transform: translateX(-50%);
}

.vjoy-controls {
	display: flex;
	gap: 5vw;
	justify-content: space-between;
	align-items: center;
}

.vjoy-dpad {
	aspect-ratio: 1;
	max-width: 10rem;
	width: var(--b8-vjoy-button-dpad-size);
	display: grid;
	grid-template-columns: 1fr 1fr;
	grid-template-rows: 1fr 1fr;
	flex-wrap: wrap;
	transform: rotate(45deg);
	border-radius: var(--b8-border-radius);
	background:black;
	gap: 1px;
	border: 2px solid black;
}

.vjoy-dpad button {
	width: 100%;
	height: 100%;
	position: relative;
}
.vjoy-dpad button span {
	transform: rotate(-45deg);
}
.vjoy-dpad button:after {
	position: absolute;
	content: '';
	display: block;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0);
	transform: rotate(-45deg);
}

#vjoy-button-up {
	border-radius: var(--b8-border-radius) 0 0 0;
}
#vjoy-button-down {
	border-radius: 0 0 var(--b8-border-radius) 0;
}
#vjoy-button-left {
	border-radius: 0 0 0 var(--b8-border-radius);
}
#vjoy-button-right {
	border-radius: 0 var(--b8-border-radius) 0 0;
}

#vjoy-button-up:after {
	transform: rotate(-45deg) translateY(-30%) scale(1.1);
}
#vjoy-button-down:after {
	transform: rotate(-45deg) translateY(30%) scale(1.1);
}
#vjoy-button-left:after {
	transform: rotate(-45deg) translateX(-30%) scale(1.1);
}
#vjoy-button-right:after {
	transform: rotate(-45deg) translateX(30%) scale(1.1);
}

.vjoy-buttons {
	display: flex;
	gap: 2vw;
	transform: rotate(-45deg);
	border: 0.8vw solid rgba(0,0,0,0.2);
	border-radius: calc( var(--b8-border-radius) + 1vw );
	padding: 1vw;
}

.vjoy-buttons button {
	width: var(--b8-vjoy-button-size);
	max-width: 5rem;
	max-height: 5rem;
	height: var(--b8-vjoy-button-size);
	border-radius: var(--b8-border-radius);
	touch-action: none;
	border: 2px solid black;
	position: relative;
}

.vjoy-buttons button:after {
	position: absolute;
	content: '';
	display: block;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0);
	transform: scale(1.2);
}

.vjoy-buttons button span {
	transform: rotate(45deg);
}

.vjoy-button {
	background: var(--b8-vjoy-button-color) !important;
	border: none;
	font-family: arial, sans-serif;
	font-size: 12px;
	font-weight: 600;
	color: #aaa !important;
	user-select: none;
	touch-callout: none;
	-webkit-user-select: none;
	-webkit-touch-callout: none;
	text-shadow: 0 -2px 0 black;
	padding: 0;
	display: flex;
	justify-content: center;
	align-items: center;
	letter-spacing: 0.1em;
	text-transform: uppercase;
}

.vjoy-button:hover,
.vjoy-button:focus,
.vjoy-button:active {
	background: black;
	outline: none;
}

#vjoy-button-screenshot,
#vjoy-button-ter {
	width: calc(var(--b8-vjoy-button-size) * 1.4);
	padding: 1vw;
	border-radius: 1rem;
}
`;e.Joystick.setup=function(){e.Utilities.log("Setting up virtual joystick...");const t=document.createElement("style");t.setAttribute("type","text/css"),t.innerText=r,document.body.appendChild(t);const i=document.createElement("div");i.className="vjoy-container",i.innerHTML=a,e.Core.getBeepContainerEl().appendChild(i),setTimeout(e.Joystick.continueSetup,10)},e.Joystick.continueSetup=function(){e.Joystick.setUpButton("vjoy-button-up","ArrowUp"),e.Joystick.setUpButton("vjoy-button-down","ArrowDown"),e.Joystick.setUpButton("vjoy-button-left","ArrowLeft"),e.Joystick.setUpButton("vjoy-button-right","ArrowRight"),e.Joystick.setUpButton("vjoy-button-pri","ButtonA"),e.Joystick.setUpButton("vjoy-button-sec","ButtonB"),e.Joystick.setUpButton("vjoy-button-ter","Enter"),e.Joystick.setUpButton("vjoy-button-screenshot","0"),document.body.addEventListener("touchstart",t=>t.preventDefault())},e.Joystick.setUpButton=function(t,i){const n=e.Utilities.assert(document.getElementById(t),"Could not find button ID "+t);if(i===null){n.style.display="none";return}["pointerdown","pointerstart"].forEach(o=>{n.addEventListener(o,l=>{l.preventDefault(),e.Joystick.handleButtonEvent(i,!0,l)},{passive:!1})}),["pointerout","pointerup","pointerleave"].forEach(o=>{n.addEventListener(o,l=>e.Joystick.handleButtonEvent(i,!1,l))}),n.addEventListener("pointermove",o=>{o.preventDefault()},{passive:!1}),n.addEventListener("contextmenu",o=>o.preventDefault())},e.Joystick.handleButtonEvent=function(t,i,n){n.key=t,s||(s={}),i?(e.Input.onKeyDown(n),s[t]||(s[t]={},s[t].initialTimeout=setTimeout(function(){s[t].interval=setInterval(function(){e.Input.onKeyDown(n)},150)},150))):(s[t]&&(s[t].initialTimeout&&clearTimeout(s[t].initialTimeout),s[t].interval&&clearInterval(s[t].interval),delete s[t]),e.Input.onKeyUp(n)),n.preventDefault()}})(b8),(function(e){e.Vfx={},e.Vfx.animations={fire:{frames:[0,1,2,3],loop:!0},explosion:{frames:[6,7,8,9,10],fps:8},portal:{frames:[12,13],loop:!0},cursor:{frames:[14,15,16,15],loop:!0,fps:6},swipe:{frames:[18,19,20,20,20,21,22],fps:24},skull:{frames:[24,24,24,25,26,27,28,28,29],fps:12},"fire-small":{frames:[30,31,32,33],loop:!0},"fire-stand":{frames:[36,37,38,39],loop:!0},shrink:{frames:[34,35,40,41],fps:18}};const s=[[-1,-1],[1,1],[1,-1],[-1,1],[-1,0],[1,0],[0,-1],[0,1]];for(const t in e.Vfx.animations){const i=e.Vfx.animations[t];i.fps===void 0&&(i.fps=4),i.loop===void 0&&(i.loop=!1)}const a=function(t,i,n,o){const l=e.TextRenderer.curVfx_,u=Math.abs(e.Animation.frame(t,o)),f=u>=0?0:1;e.TextRenderer.spr(u,i,n,l,f||0),e.Core.drawState.cursorCol++},r=function(t,i,n,o){const l=e.TextRenderer.curVfx_,u=Math.abs(e.Animation.frame(t,o)),f=u>=0?0:1,h=e.Core.drawState.fgColor,C=e.Core.drawState.bgColor;e.Core.setColor(C,-1);for(const g of s)e.TextRenderer.spr(u,i+g[0],n+g[1],l,f||0);e.Core.setColor(h,-1),e.TextRenderer.spr(u,i,n,l,f||0),e.Core.setColor(h,C),e.Core.drawState.cursorCol++};e.Vfx.draw=function(t,i,n=0,o=0){return i!==null&&e.Utilities.checkNumber("startTime",i),e.Utilities.checkNumber("offsetCol",n),e.Utilities.checkNumber("offsetRow",o),e.Vfx.spr(t,i,(e.Core.drawState.cursorCol+n)*e.CONFIG.CHR_WIDTH,(e.Core.drawState.cursorRow+o)*e.CONFIG.CHR_HEIGHT)},e.Vfx.drawOutline=function(t,i,n=0,o=0){return i!==null&&e.Utilities.checkNumber("startTime",i),e.Utilities.checkNumber("offsetCol",n),e.Utilities.checkNumber("offsetRow",o),e.Vfx.sprOutline(t,i,(e.Core.drawState.cursorCol+n)*e.CONFIG.CHR_WIDTH,(e.Core.drawState.cursorRow+o)*e.CONFIG.CHR_HEIGHT)},e.Vfx.spr=function(t,i,n,o){if(i!==null&&e.Utilities.checkNumber("startTime",i),e.Utilities.checkNumber("x",n),e.Utilities.checkNumber("y",o),i>e.Core.getNow())return!0;const l=e.Vfx.get(t);return e.Animation.shouldLoop(l,i)?(a(l,n,o,i),!0):!1},e.Vfx.sprOutline=function(t,i,n,o){if(i!==null&&e.Utilities.checkNumber("startTime",i),e.Utilities.checkNumber("x",n),e.Utilities.checkNumber("y",o),i>e.Core.getNow())return!0;const l=e.Vfx.get(t);return e.Animation.shouldLoop(l,i)?(r(l,n,o,i),!0):!1},e.Vfx.get=function(t){return e.Utilities.checkString("animation",t),e.Vfx.animations[t]===void 0&&e.Utilities.fatal("Invalid Vfx animation: "+t),e.Vfx.animations[t]},e.Vfx.shouldLoop=function(t,i){return typeof t=="string"&&(t=e.Vfx.get(t)),e.Utilities.checkObject("anim",t),e.Utilities.checkNumber("startTime",i),e.Animation.shouldLoop(t,i)}})(b8),(function(e){e.Utilities={},e.Utilities.fatal=function(t){const i=t instanceof Error?t:new Error(String(t));e.Utilities.error("Fatal error: "+i.message);try{e.Core.handleCrash(i)}catch(n){e.Utilities.error("Error in b8.Core.handleCrash: "+n+" while handling error "+i.message)}throw new Error(i)},e.Utilities.assert=function(t,i){return t||e.Utilities.fatal(i||"Assertion Failed"),t},e.Utilities.assertDebug=function(t,i){return t||(e.CONFIG.DEBUG?warn("DEBUG ASSERT failed: "+i):e.Utilities.fatal(i)),t},e.Utilities.assertEquals=function(t,i,n){return t!==i&&e.Utilities.fatal(`${n}: expected ${t} but got ${i}`),i},e.Utilities.checkType=function(t,i,n){return e.Utilities.assert(t,"checkType: varName must be provided."),e.Utilities.assert(n,"checkType: varType must be provided."),e.Utilities.assert(typeof i===n,`${t} should be of type ${n} but was ${typeof i}: ${i}`),i},e.Utilities.checkNumber=function(t,i,n=void 0,o=void 0){return e.Utilities.checkType(t,i,"number"),isNaN(i)&&e.Utilities.fatal(`${t} should be a number but is NaN`),isFinite(i)||e.Utilities.fatal(`${t} should be a number but is infinite: ${i}`),n!==void 0&&e.Utilities.assert(i>=n,`${t} should be >= ${n} but is ${i}`),o!==void 0&&e.Utilities.assert(i<=o,`${t} should be <= ${o} but is ${i}`),i},e.Utilities.checkInt=function(t,i,n,o){return e.Utilities.checkNumber(t,i,n,o),Number.isInteger(i)||e.Utilities.fatal(`${t} should be an integer but is ${i}`),i},e.Utilities.checkString=function(t,i){return e.Utilities.checkType(t,i,"string")},e.Utilities.checkBoolean=function(t,i){return e.Utilities.checkType(t,i,"boolean")},e.Utilities.checkFunction=function(t,i){return i===null&&e.Utilities.fatal(`${t} should be a function, but was null`),e.Utilities.checkType(t,i,"function")},e.Utilities.checkObject=function(t,i){return i===null&&e.Utilities.fatal(`${t} should be an object, but was null`),e.Utilities.checkType(t,i,"object")},e.Utilities.checkInstanceOf=function(t,i,n){return e.Utilities.assert(i instanceof n,`${t} should be an instance of ${n.name} but was not, it's: ${i}`),i},e.Utilities.checkIsSet=function(t,i){return e.Utilities.assert(i!=null,`${t} should be set but was: ${i}`),i},e.Utilities.checkArray=function(t,i){return e.Utilities.assert(Array.isArray(i),`${t} should be an array, but was: ${i}`),i},e.Utilities.log=function(t){e.CONFIG.DEBUG&&console.log(t)},e.Utilities.warn=function(t){console.warn(t)},e.Utilities.error=function(t){console.error(t)},e.Utilities.makeColorTransparent=async function(t,i=[255,0,255],n=5){const o=document.createElement("canvas"),l=o.getContext("2d");o.width=t.width,o.height=t.height,l.drawImage(t,0,0);const u=l.getImageData(0,0,o.width,o.height),f=u.data;for(let h=0;h<f.length;h+=4){const C=f[h],g=f[h+1],d=f[h+2];Math.abs(C-i[0])<=n&&Math.abs(g-i[1])<=n&&Math.abs(d-i[2])<=n&&(f[h+3]=0)}return l.putImageData(u,0,0),o},e.Utilities.loadFileAsync=function(t){return new Promise((i,n)=>{const o=new XMLHttpRequest;o.addEventListener("load",()=>{o.status<200||o.status>299?n("HTTP request finished with status "+o.status):i(o.responseText)}),o.addEventListener("error",l=>n(l)),o.open("GET",t),o.send()})},e.Utilities.clamp=function(t,i,n){return Math.min(Math.max(t,i),n)},e.Utilities.hexToRgb=function(t){t=t.replace("#","");const i=parseInt(t,16);return{r:i>>16&255,g:i>>8&255,b:i&255}},e.Utilities.intersectIntervals=function(t,i,n,o,l=null){e.Utilities.checkNumber("as",t),e.Utilities.checkNumber("ae",i),e.Utilities.checkNumber("bs",n),e.Utilities.checkNumber("be",o),l&&e.Utilities.checkObject("result",l);const u=Math.max(t,n),f=Math.min(i,o);return f>=u?(l&&(l.start=u,l.end=f),!0):!1},e.Utilities.intersectRects=function(t,i,n=0,o=0,l=0,u=0,f=null){e.Utilities.checkObject("r1",t),e.Utilities.checkObject("r2",i),e.Utilities.checkNumber("r1.x",t.x),e.Utilities.checkNumber("r1.y",t.y),e.Utilities.checkNumber("r1.w",t.w),e.Utilities.checkNumber("r1.h",t.h),e.Utilities.checkNumber("r2.x",i.x),e.Utilities.checkNumber("r2.y",i.y),e.Utilities.checkNumber("r2.w",i.w),e.Utilities.checkNumber("r2.h",i.h),e.Utilities.checkNumber("dx1",n),e.Utilities.checkNumber("dx2",l),e.Utilities.checkNumber("dy1",o),e.Utilities.checkNumber("dy2",u),f&&checkObject("result",f);const h=s,C=a;return!e.Utilities.intersectIntervals(t.x+n,t.x+n+t.w-1,i.x+l,i.x+l+i.w-1,h)||!e.Utilities.intersectIntervals(t.y+o,t.y+o+t.h-1,i.y+u,i.y+u+i.h-1,C)?!1:(f&&(f.x=h.start,f.w=h.end-h.start+1,f.y=C.start,f.h=C.end-C.start+1),!0)};const s={},a={};e.Utilities.makeUrlPretty=function(t){e.Utilities.checkString("uglyStr",t);let i=t;return i=i.toLowerCase(),i=i.replace(/[\s/]+/g,"-"),i=i.replace(/[^a-z0-9\-]+/g,""),i=i.replace(/-+/g,"-"),i=i.replace(/^-+|-+$/g,""),i},e.Utilities.deepMerge=function(...t){const i=n=>n&&typeof n=="object";return t.reduce((n,o)=>(Object.keys(o).forEach(l=>{const u=n[l],f=o[l];Array.isArray(u)&&Array.isArray(f)?n[l]=u.concat(...f):i(u)&&i(f)?n[l]=e.Utilities.deepMerge(u,f):n[l]=f}),n),{})},e.Utilities.deepMergeByIndex=function(...t){const i=n=>n&&typeof n=="object";return t.reduce((n,o)=>(Object.keys(o).forEach(l=>{const u=n[l],f=o[l];Array.isArray(u)&&Array.isArray(f)?n[l]=r(u,f):i(u)&&i(f)?n[l]=e.Utilities.deepMergeByIndex(u,f):n[l]=f}),n),{})},e.Utilities.padWithZeros=function(t,i){return e.Utilities.checkNumber("number",t),e.Utilities.checkInt("length",i),t<0&&e.Utilities.fatal("padWithZeros does not support negative numbers"),t.toString().padStart(i,"0")},e.Utilities.event=function(t,i={},n=document){e.Utilities.checkString("eventName",t),e.Utilities.checkObject("detail",i),e.Utilities.checkObject("target",n),t=`b8.${t}`;const o=new CustomEvent(t,{detail:i});n.dispatchEvent(o)},e.Utilities.repeatArray=function(t,i){return e.Utilities.checkArray("array",t),e.Utilities.checkInt("times",i,0),Array(i).fill().flatMap(()=>t)},e.Utilities.downloadFile=function(t="",i=""){e.Utilities.checkString("filename",t),e.Utilities.checkString("src",i);const n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download",t),document.body.appendChild(n),n.click(),document.body.removeChild(n)},e.Utilities.encodeData=function(t){const i=CBOR.encode(t);return btoa(String.fromCharCode.apply(null,new Uint8Array(i)))},e.Utilities.decodeData=function(t){const i=atob(t),n=new Uint8Array(i.length);for(let l=0;l<i.length;l++)n[l]=i.charCodeAt(l);const o=n.buffer;return CBOR.decode(o)};function r(t,i){for(let n=0;n<i.length;n++)t[n]=i[n];return t}})(b8),(function(e){e.Tilemap={},e.Tilemap.MAP_CHAR=0,e.Tilemap.MAP_FG=1,e.Tilemap.MAP_BG=2,e.Tilemap.MAP_COLLISION=3,e.Tilemap.MAP_DATA=4;const s={solid:{0:1,1:1,2:1,3:36,4:1,5:1,6:18,7:1,8:1,9:37,10:1,11:1,12:19,13:1,14:1,15:1},rounded:{0:1,1:42,2:23,3:36,4:41,5:1,6:18,7:1,8:24,9:37,10:1,11:1,12:19,13:1,14:1,15:1},half:{0:128,1:75,2:58,3:93,4:75,5:75,6:57,7:129,8:58,9:95,10:58,11:111,12:59,13:130,14:112,15:113},half_rounded:{0:128,1:148,2:166,3:93,4:149,5:75,6:57,7:129,8:167,9:95,10:58,11:111,12:59,13:130,14:112,15:113},pipe:{0:128,1:148,2:166,3:93,4:149,5:[75,77],6:57,7:129,8:167,9:95,10:[58,94],11:111,12:59,13:130,14:112,15:[113,131,76]},thin:{0:110,1:173,2:172,3:164,4:154,5:72,6:146,7:126,8:155,9:165,10:55,11:108,12:147,13:127,14:109,15:73}};e.Tilemap.save=function(r){return e.Utilities.checkArray("tilemap",r),e.Utilities.encodeData(r)},e.Tilemap.load=function(r){return e.Utilities.checkString("data",r),e.Utilities.decodeData(r)},e.Tilemap.draw=function(r,t=0,i=0,n=null,o=null){e.Utilities.checkArray("tilemap",r),e.Utilities.checkInt("tileXOffset",t),e.Utilities.checkInt("tileYOffset",i),n||(n=r[0].length),o||(o=r.length),e.Utilities.checkInt("width",n),e.Utilities.checkInt("height",o);const l=e.Core.drawState.cursorRow,u=e.Core.drawState.cursorCol;for(let f=i;f<i+o;f++){const h=0+u,C=f-i+l;e.locate(h,C);for(let g=t;g<t+n;g++){if(!r[f]||r[f][g]==null)continue;const d=r[f][g];if(d&&d.length>=3){e.color(d[e.Tilemap.MAP_FG],d[e.Tilemap.MAP_BG]);const A=d[e.Tilemap.MAP_CHAR];if(typeof A=="string"&&A.startsWith("vfx:")){const p=A.substring(4);e.Vfx.draw(p,e.Core.startTime);continue}e.printChar(A)}}}},e.Tilemap.createEmptyTilemap=function(r,t){let i=[];for(let n=0;n<t;n++){i[n]=[];for(let o=0;o<r;o++)i[n][o]=e.Tilemap.getDefaultTile()}return i},e.Tilemap.shift=function(r,t,i){e.Utilities.checkArray("tilemap",r),e.Utilities.checkNumber("dx",t),e.Utilities.checkNumber("dy",i);const n=r[0].length,o=r.length,l=e.Tilemap.createEmptyTilemap(n,o);for(let u=0;u<o;u++)for(let f=0;f<n;f++){const h=(f+t+n)%n,C=(u+i+o)%o;l[C][h]=[...r[u][f]]}return l},e.Tilemap.resize=function(r,t,i){e.Utilities.checkArray("tilemap",r),e.Utilities.checkInt("width",t),e.Utilities.checkInt("height",i);const n=e.Tilemap.createEmptyTilemap(t,i);for(let o=0;o<i;o++)for(let l=0;l<t;l++)r[o]&&r[o][l]&&(n[o][l]=[...r[o][l]]);return n},e.Tilemap.getDefaultTile=function(){return[0,15,0,!1,{}]},e.Tilemap.convertFromText=function(r){e.Utilities.checkString("text",r);const i=r.split(`
`).filter(o=>o!=="");return i.length===0&&e.Utilities.fatal("No valid lines found in the map text."),i.map(o=>o.split(""))},e.Tilemap.validateTilemap=function(r){e.Utilities.checkString("text",r);const t=e.Tilemap.load(r);return!(!Array.isArray(t)||!Array.isArray(t[0])||!Array.isArray(t[0][0])||t[0][0].length<=3)},e.Tilemap.createFromArray=function(r,t,i=null){e.Utilities.checkArray("grid",r),e.Utilities.checkObject("tilePattern",t),i!==null&&e.Utilities.checkObject("defaultTilePattern",i),i===null&&(i=e.Tilemap.getDefaultTile());const n=[];e.Random.setSeed(r[0].join(""));for(let o=0;o<r.length;o++){n[o]=[];for(let l=0;l<r[o].length;l++){if(n[o][l]=[...i],!t[r[o][l]])continue;const u=t[r[o][l]];let f=u.t;typeof f=="string"&&f.startsWith("wall:")&&(f=e.Tilemap.wallTile(l,o,r,f)),Array.isArray(f)&&(f=e.Random.pickWeighted(f)),typeof u.fg>"u"&&(u.fg=15);let h=u.fg;Array.isArray(h)&&(h=e.Random.pickWeighted(h)),typeof u.bg>"u"&&(u.bg=0);let C=u.bg;Array.isArray(C)&&(C=e.Random.pickWeighted(C)),n[o][l]=[f,h,C,u.coll||!1,u.data||{}]}}return n},e.Tilemap.wallTile=function(r,t,i,n=null){e.Utilities.checkInt("col",r),e.Utilities.checkInt("row",t),e.Utilities.checkArray("grid",i),e.Utilities.checkString("name",n),n===null&&e.Utilities.fatal("Wall tile name not given: "+n);const o=n.substring(5);s[o]||e.Utilities.fatal("Wall tile type not found: "+o);const l=a(i,r,t);return s[o][l]};function a(r,t,i){let n=0;const o=r[i][t];return i>0&&r[i-1][t]===o&&(n+=1),t<r[i].length-1&&r[i][t+1]===o&&(n+=2),i<r.length-1&&r[i+1][t]===o&&(n+=4),t>0&&r[i][t-1]===o&&(n+=8),n}})(b8),(function(e){e.TextRenderer={};const s=[];e.TextRenderer.fonts_={},e.TextRenderer.curFont_=null,e.TextRenderer.curTiles_=null,e.TextRenderer.curVfx_=null,e.TextRenderer.prepareCharMap=function(){let n=[...e.CONFIG.CHRS];for(let o=0;o<n.length;o++)s.push(n[o].charCodeAt(0))},e.TextRenderer.initAsync=async function(){e.Utilities.log("b8.TextRenderer init."),e.TextRenderer.curFont_=await e.TextRenderer.loadFontAsync("default-thin",e.CONFIG.FONT_DEFAULT,.5,1),e.TextRenderer.curTiles_=await e.TextRenderer.loadFontAsync("tiles",e.CONFIG.FONT_TILES),e.TextRenderer.curActors_=await e.TextRenderer.loadFontAsync("actors",e.CONFIG.FONT_ACTORS),e.TextRenderer.curVfx_=await e.TextRenderer.loadFontAsync("vfx",e.CONFIG.FONT_VFX),e.TextRenderer.prepareCharMap()},e.TextRenderer.loadFontAsync=async function(n,o,l=1,u=1){e.Utilities.checkString("fontName",n),e.Utilities.checkString("fontImageFile",o);const f=new e.TextRendererFont(n,o,l,u);return await f.initAsync(),e.TextRenderer.fonts_[n]=f,f},e.TextRenderer.setFont=function(n){const o=e.TextRenderer.getFontByName(n);o&&(e.TextRenderer.curFont_=o)},e.TextRenderer.getFont=function(){return e.TextRenderer.curFont_},e.TextRenderer.setTileFont=function(n){const o=e.TextRenderer.getFontByName(n);o&&(e.TextRenderer.curTiles_=o)},e.TextRenderer.getFontByName=function(n){e.Utilities.checkString("fontName",n);const o=e.TextRenderer.fonts_[n];if(!o){e.Utilities.fatal(`setFont(): font not found: ${n}`);return}return o},e.TextRenderer.print=function(n,o=null,l=-1){e.TextRenderer.printFont_=o||e.TextRenderer.curFont_,e.Utilities.checkString("text",n),e.Utilities.checkNumber("maxWidth",l),o!==null&&e.Utilities.checkObject("font",o),n=e.TextRenderer.wrapText(n,l,o);let u=e.Core.drawState.cursorCol,f=e.Core.drawState.cursorRow;e.TextRenderer.origFgColor_=e.Core.drawState.fgColor,e.TextRenderer.origBgColor_=e.Core.drawState.bgColor,e.TextRenderer.origFont_=e.TextRenderer.printFont_;const h=e.TextRenderer.printFont_.getCharColCount(),C=e.TextRenderer.printFont_.getCharRowCount(),g=u;for(let d=0;d<n.length;d++){d=t(n,d);const A=n.charCodeAt(d);if(A===10)u=g,f+=C;else{const p=s.indexOf(A);p>=0&&(a(p,u,f,e.Core.drawState.fgColor,e.Core.drawState.bgColor,e.TextRenderer.printFont_),u+=h)}}e.Core.drawState.cursorCol=u,e.Core.drawState.cursorRow=f,e.Core.drawState.fgColor=e.TextRenderer.origFgColor_,e.Core.drawState.bgColor=e.TextRenderer.origBgColor_,e.Renderer.markDirty()},e.TextRenderer.printTypewriter=async function(n,o=-1,l=.05,u=null){e.Utilities.checkString("text",n),e.Utilities.checkNumber("maxWidth",o),e.Utilities.checkNumber("delay",l);const f=e.col(),h=e.row();n=e.TextRenderer.wrapText(n,o);for(let C=0;C<=n.length;C++){if(e.CONFIG.PRINT_ESCAPE_START&&n.substring(C,C+e.CONFIG.PRINT_ESCAPE_START.length)===e.CONFIG.PRINT_ESCAPE_START){const d=n.indexOf(e.CONFIG.PRINT_ESCAPE_END,C+e.CONFIG.PRINT_ESCAPE_START.length);d>=0&&(C=d+e.CONFIG.PRINT_ESCAPE_END.length)}const g=n.charCodeAt(C);e.Core.setCursorLocation(f,h),e.TextRenderer.print(n.substring(0,C),u),g!==32&&await e.Async.wait(l)}},e.TextRenderer.printCentered=function(n,o,l=null){if(e.TextRenderer.printFont_=l||e.TextRenderer.curFont_,e.Utilities.checkString("text",n),e.Utilities.checkNumber("width",o),!n)return;const u=e.Core.drawState.cursorCol,f=e.TextRenderer.printFont_.getCharRowCount();n=n.split(`
`),n[n.length-1]===""&&n.pop();for(let h=0;h<n.length;h++){const C=e.TextRenderer.measure(n[h]).cols,g=u+(o-C)/2;e.Core.drawState.cursorCol=g,e.TextRenderer.print(n[h],l,o),e.Core.drawState.cursorRow+=f}e.Core.drawState.cursorCol=u},e.TextRenderer.printRight=function(n,o,l=null){if(e.TextRenderer.printFont_=l||e.TextRenderer.curFont_,e.Utilities.checkString("text",n),e.Utilities.checkNumber("width",o),!n)return;const u=e.Core.drawState.cursorCol,f=e.TextRenderer.printFont_.getCharRowCount();n=e.TextRenderer.wrapText(n,o),n=n.split(`
`),n[n.length-1]===""&&n.pop();for(let h=0;h<n.length;h++){let C=e.TextRenderer.measure(n[h]).cols;const g=u+o-C;e.Core.drawState.cursorCol=g,e.TextRenderer.print(n[h],l,o),e.Core.drawState.cursorRow+=f}e.Core.drawState.cursorCol=u},e.TextRenderer.printChar=function(n,o,l=null){if((o===void 0||isNaN(o))&&(o=1),e.Utilities.checkNumber("ch",n),e.Utilities.checkNumber("n",o),!(e.Core.drawState.cursorCol<0||e.Core.drawState.cursorRow<0||e.Core.drawState.cursorCol>=e.CONFIG.SCREEN_COLS||e.Core.drawState.cursorRow>=e.CONFIG.SCREEN_ROWS)){for(;o-- >0;)a(n,e.Core.drawState.cursorCol,e.Core.drawState.cursorRow,e.Core.drawState.fgColor,e.Core.drawState.bgColor,l),e.Core.drawState.cursorCol++;e.Renderer.markDirty()}},e.TextRenderer.spr=function(n,o,l,u=null,f=0){e.Utilities.checkNumber("ch",n),e.Utilities.checkNumber("x",o),e.Utilities.checkNumber("y",l),e.Utilities.checkInt("direction",f),u!==null&&e.Utilities.checkObject("font",u),r(n,o,l,e.Core.drawState.fgColor,e.Core.drawState.bgColor,u,f)},e.TextRenderer.drawText=function(n,o,l,u){e.Utilities.checkNumber("x",n),e.Utilities.checkNumber("y",o),e.Utilities.checkString("text",l),u&&e.Utilities.checkString("fontName",u);const f=n,h=u&&e.TextRenderer.fonts_[u]||e.TextRenderer.curFont_;if(!h){e.Utilities.warn(`Requested font '${u}' not found: not drawing text.`);return}for(let C=0;C<l.length;C++){const g=l.charCodeAt(C);g===10?(n=f,o+=h.getCharHeight()):(r(g,n,o,e.Core.drawState.fgColor,e.Core.drawState.bgColor,h),n+=h.getCharWidth())}},e.TextRenderer.measure=function(n,o=null){if(e.Utilities.checkString("text",n),o=o||e.TextRenderer.curFont_,n==="")return{cols:0,rows:0};let l=1,u=0,f=0;for(let h=0;h<n.length;h++)h=t(n,h,!0),n.charCodeAt(h)===10?(l++,u=0):(++u,f=Math.max(f,u));return f=f*o.getCharColCount(),l=l*o.getCharRowCount(),{cols:f,rows:l}},e.TextRenderer.printRect=function(n,o,l){e.Utilities.checkNumber("width",n),e.Utilities.checkNumber("height",o),e.Utilities.checkNumber("ch",l);const u=e.Core.drawState.cursorCol,f=e.Core.drawState.cursorRow;for(let h=0;h<o;h++)e.Core.drawState.cursorCol=u,e.Core.drawState.cursorRow=f+h,e.TextRenderer.printChar(l,n);e.Core.drawState.cursorCol=u,e.Core.drawState.cursorRow=f},e.TextRenderer.printBox=function(n,o,l=!0,u=e.CONFIG.BORDER_CHAR){e.Utilities.checkNumber("width",n),e.Utilities.checkNumber("height",o),e.Utilities.checkBoolean("fill",l),e.Utilities.checkNumber("borderChar",u);const f=e.TextRenderer.curTiles_.getColCount(),h={NW:u,NE:u+2,SW:u+f+f,SE:u+f+f+2,V:u+f,H:u+1};e.TextRenderer.drawBox(n,o,l,h)},e.TextRenderer.drawBox=function(n,o,l=!0,u={}){const f=e.Core.drawState.cursorCol,h=e.Core.drawState.cursorRow;for(let C=0;C<o;C++)e.Core.drawState.cursorCol=f,e.Core.drawState.cursorRow=h+C,C===0?(e.TextRenderer.printChar(u.NW),e.TextRenderer.printChar(u.H,n-2),e.TextRenderer.printChar(u.NE)):C===o-1?(e.TextRenderer.printChar(u.SW),e.TextRenderer.printChar(u.H,n-2),e.TextRenderer.printChar(u.SE)):(e.TextRenderer.printChar(u.V),e.Core.drawState.cursorCol=f+n-1,e.TextRenderer.printChar(u.V));l&&n>2&&o>2&&(e.Core.drawState.cursorCol=f+1,e.Core.drawState.cursorRow=h+1,e.TextRenderer.printRect(n-2,o-2,0)),e.Core.drawState.cursorCol=f,e.Core.drawState.cursorRow=h},e.TextRenderer.wrapText=function(n,o,l=null){if(l=l||e.TextRenderer.curFont_,o<=0)return n;const u=n.split(`
`),f=[];for(const h of u){const C=h.split(" ");let g="";for(const d of C)e.TextRenderer.measure((g+d).trim()).cols>o&&(f.push(g.trim()),g=""),g+=d+" ";f.push(g.trim())}return f.join(`
`)};const a=function(n,o,l,u,f,h=null,C=0){const g=Math.round(o*e.CONFIG.CHR_WIDTH),d=Math.round(l*e.CONFIG.CHR_HEIGHT);r(n,g,d,u,f,h,C)},r=function(n,o,l,u,f,h=null,C=0){h=h||e.TextRenderer.curTiles_;const g=h.getColCount(),d=h.getCharWidth(),A=h.getCharHeight(),p=Math.floor(n/g),S=n%g;if(o=Math.round(o),l=Math.round(l),f>=0&&(e.Core.offCtx.fillStyle=e.Core.getColorHex(f),e.Core.offCtx.fillRect(o,l,d,A)),e.CONFIG.SCREEN_COLORS===1&&f===u)return;if(C>0){e.Core.offCtx.save();const T=(C&1)!==0,E=(C&2)!==0,R=T?d:0,y=E?A:0;e.Core.offCtx.translate(o+R,l+y);const N=T?-1:1,M=E?-1:1;e.Core.offCtx.scale(N,M),o=0,l=0}const x=e.Utilities.clamp(u,0,e.CONFIG.COLORS.length-1),D=h.getImageForColor(x);e.Core.offCtx.drawImage(D,S*d,p*A,d,A,o,l,d,A),C>0&&e.Core.offCtx.restore(),e.Renderer.markDirty()},t=function(n,o,l=!1){const u=e.CONFIG.PRINT_ESCAPE_START,f=e.CONFIG.PRINT_ESCAPE_END;if(!u||!f||n.substring(o,o+u.length)!=u)return o;const h=n.indexOf(f,o+u.length);if(!l){const C=n.substring(o+u.length,h);i(C)}return h+f.length},i=function(n){if(n.indexOf(",")>0){const f=n.split(",");for(const h of f)i(h);return}if(n=n.trim(),n==="")return;const o=n[0].toLowerCase(),l=n.substring(1),u=1*l;switch(o){case"f":case"c":e.Core.drawState.fgColor=l!==""?u:e.TextRenderer.origFgColor_;break;case"b":e.Core.drawState.bgColor=l!==""?u:e.TextRenderer.origBgColor_;break;case"t":e.TextRenderer.printFont_=e.TextRenderer.getFontByName(l);break;case"z":e.Core.drawState.fgColor=e.TextRenderer.origFgColor_,e.Core.drawState.bgColor=e.TextRenderer.origBgColor_,e.TextRenderer.printFont_=e.TextRenderer.origFont_||e.TextRenderer.fonts_.default;break;default:e.Utilities.warn("Unknown b8 print escape command: "+n)}};e.TextRenderer.regenColors=function(){Object.values(e.TextRenderer.fonts_).forEach(n=>n.regenColors())}})(b8),(function(e){e.Textmode={},e.Textmode.load=async function(s){return e.Tilemap.load(s)},e.Textmode.draw=async function(s,a=0,r=0,t=null,i=null){return e.Tilemap.draw(s,a,r,t,i)}})(b8),(function(e){e.TextRendererFont=class{constructor(s,a,r=1,t=1){e.Utilities.checkString("fontName",s),e.Utilities.checkString("fontImageFile",a),this.fontName_=s,this.fontImageFile_=a,this.origImg_=null,this.chrImages_=[],this.imageWidth_=0,this.imageHeight_=0,this.colCount_=0,this.rowCount_=0,this.charWidth_=0,this.charHeight_=0,this.charColCount_=0,this.charRowCount_=0,this.tileWidthMultiplier_=r,this.tileHeightMultiplier_=t}async initAsync(){this.origImg_=await e.Image.loadImageAsync(this.fontImageFile_);const s=e.CONFIG.CHR_WIDTH*this.tileWidthMultiplier_,a=e.CONFIG.CHR_HEIGHT*this.tileHeightMultiplier_;e.Utilities.assert(this.origImg_.width%s===0&&this.origImg_.height%a===0,`Font ${this.fontName_}: image ${this.fontImageFile_} has dimensions ${this.origImg_.width}x${this.origImg_.height}.`),this.origImg_=await e.Utilities.makeColorTransparent(this.origImg_),this.charWidth_=s,this.charHeight_=a,this.imageWidth_=this.origImg_.width,this.imageHeight_=this.origImg_.height,this.colCount_=this.imageWidth_/this.charWidth_,this.rowCount_=this.imageHeight_/this.charHeight_,this.charColCount_=this.tileWidthMultiplier_,this.charRowCount_=this.tileHeightMultiplier_,await this.regenColors()}getCharWidth(){return this.charWidth_}getCharHeight(){return this.charHeight_}getCharColCount(){return this.charColCount_}getCharRowCount(){return this.charRowCount_}getRowCount(){return this.rowCount_}getColCount(){return this.colCount_}getImageForColor(s){return this.chrImages_[s]}async regenColors(){this.chrImages_=[];for(let s=0;s<e.CONFIG.COLORS.length;s++){const a=document.createElement("canvas");a.width=this.origImg_.width,a.height=this.origImg_.height;const r=a.getContext("2d");r.clearRect(0,0,this.origImg_.width,this.origImg_.height),r.globalCompositeOperation="source-over",r.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height),r.globalCompositeOperation="source-in",r.fillStyle=e.CONFIG.COLORS[s],r.fillRect(0,0,this.origImg_.width,this.origImg_.height),e.CONFIG.SCREEN_COLORS===2&&(r.globalCompositeOperation="multiply",r.drawImage(this.origImg_,0,0,this.origImg_.width,this.origImg_.height)),this.chrImages_.push(a)}}}})(b8),(function(e){e.State=e.State||{};let s="";document.addEventListener("b8.initComplete",function(){a()},{once:!0});function a(){s=`b8.${e.Utilities.makeUrlPretty(e.CONFIG.NAME)}.state`}function r(t){return new Proxy(t,{get(i,n){const o=i[n];return typeof o=="object"&&o!==null?r(o):o},set(i,n,o){return i[n]=o,e.Utilities.event("stateChange",{prop:n,value:o}),!0}})}e.State.save=function(t=s){const i=e.Utilities.encodeData({time:Date.now(),data:e.data});localStorage.setItem(t,i),e.State.lastSave=Date.now()},e.State.reset=function(){a(),e.data=null,e.State.init({})},e.State.load=function(t=s){const i=localStorage.getItem(t);if(!i){e.Utilities.log("No state found for the given key.");return}const n=e.Utilities.decodeData(i);n.data&&(e.data=r(n.data)),n.time&&(e.State.lastSave=n.time)},e.State.init=function(t){e.data||(e.data=r({})),localStorage.getItem(s)&&e.State.load(),e.data=e.Utilities.deepMergeByIndex(t,e.data),e.Utilities.log("State initialized:",e.data)},e.State.clear=function(t=s){e.Utilities.log("Clearing state..."),localStorage.removeItem(t),e.data=r({})}})(b8),(function(e){e.Sfx={},e.Sfx.library={"fx/action/drag":[,0,293.6648,.1,,,4,6,32,,,,,1,1.4,.1,,.7,.1],"fx/break/001":[2.1,,339,.02,.07,.09,4,.2,-7,,,,.05,1,,.1,.16,.45,.02,.03],"fx/break/002":[1.5,,157,.16,,0,,.35,-24,28,,,,.1,,.6,,.19,.01],"fx/break/003":[2,,180,.05,.03,.04,,2.42,.6,,,,,,,,.15,.39,.04],"fx/fight/dodge":[1.2,.3,150,.05,,.05,,,-1,,,,,4,,,,,.02],"fx/fight/hit":[5,,185,,,,3,1.6,-7,,,,,,,.2,.19,.1,,.38,985],"fx/robot/001":[1.13,,172,.04,.18,.09,,.06,-38,-2.6,-99,,,,35,,.08],"fx/robot/002":[1.42,,61,.01,.02,0,1,.21,,,816,.01,.05,,-40,,.05,.71,.11],"fx/robot/003":[.9,,164,.04,.03,.14,,.8,46,66,,,,,,,,.71,.08,,217],"fx/robot/004":[,.02,1638,,.05,.17,1,,,,490,.09,,,,.1,.05,.5,.03],"fx/sci-fi/radioactive":[1,0,130,.02,.9,.39,2,.8,,,,,.13,.2,,.1,,.93,.06,.28],"fx/sci-fi/robot":[1,0,847,.02,.3,.9,1,1.67,,,-294,.04,.13,,,,.1],"fx/sci-fi/teleport":[1,,85,.08,.1,.01,1,4,,-11,1,.07,,.1,101,,.05,.68,.4,.12,1],"fx/sci-fi/warp":[3,0,713,.16,.09,.24,,.6,-29,-16,,,.09,.5,,,.23,.75,.15,.48],"fx/sci-fi/beam":[1,0,662,.82,.11,.33,1,0,,-.2,,,,1.2,,.26,.01],"fx/sci-fi/hover":[2,0,262.63,.1,.12,.3,0,2.4,-.1,0,0,0,.24,0,0,.1,.05,.98,.07,.17,0],"fx/thud/001":[1.5,,90,,.01,.03,4,,,,,,,9,50,.2,,.2,.01],"fx/thud/002":[1,,129,.01,,.15,,,,,,,,5],"fx/machine/buzz":[1,0,130.8128,.1,.1,.34,3,1.88,,,,,,,,.1,,.5,.04],"fx/machine/hum":[1,0,63,,1,,1,1.5,,,,,,,,3.69,.08],"fx/machine/humm":[1,,110,.03,.25,.15,2,1.32,,,,,.07,,-.1,,.11,.77],"fx/machine/warp":[2,,128,,.12,.26,,4.7,,-1,-62,.06,.07,,52,,,.66,.08],"fx/noise/001":[1.27,,390,.01,.04,.02,4,.71,4.8,,,,,,,,.01,.6,.06],"fx/noise/002":[.4,,60,,.01,0,4,.55,62,89,-88,.06,,,173,.6,,,.05],"fx/noise/003":[.2,,523.2511,.1,3,3,4,0,,,2250,,.04,,10,.01,,.82,1,,30],"fx/random/tone":[2,.8,999,,,,1,2,,,,,1,,,.1,.2],"fx/swoosh/001":[1,,1500,.02,,.02,4,.68,5,,,,.01,.7,136,,,,,.11],"fx/swoosh/002":[1.2,,585,,.02,.16,4,.25,,,,,,,,,,.55,.03],"fx/swoosh/003":[.2,,836,.11,,0,4,.91,13,,,,.09,.1,-39,,,.06,.07],"fx/swoosh/004":[1.2,,9220,.01,,,,5,,,,,,9],"fx/swoosh/005":[1.5,0,150,.05,,.05,,1.3,,,,,,3],"fx/swoosh/006":[2,,12,,,.008,,1.2,23,-7,,,.05,.4,,,.15,.82,.03,.28],"fx/vehicle/engine":[1.2,0,25,.05,.3,.5,3,9,-.01,,,,,,13,.1,.2],"fx/vehicle/carhorn":[1.8,0,250,.02,.02,.2,2,2,,,,,.02,,,.02,.01,,,.1],"fx/vehicle/horn":[2,,688,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.03,.11,-818],"fx/vehicle/truckhorn":[1.5,,1376,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.8,.11,-818],"fx/vehicle/siren":[1.3,0,960,,1,.01,,.8,-.01,,-190,.5,,.05,,,1],"fx/vehicle/submarine":[1.2,0,1975,.08,.56,.02,,,-.4,,-322,.56,.41,,,,.25],"fx/vehicle/rocket":[1.5,0,941,.8,,.8,4,.74,-222,,,,,.8,,1],"game/coin/001":[1.2,0,1675,,.06,.24,1,1.82,,,837,.06],"game/coin/002":[1.2,0,523.2511,.01,.06,.3,1,1.82,,,837,.06],"game/coin/003":[.6,0,1874,,.01,.25,2,.76,,,622,.1],"game/coin/004":[1,0,277,.03,.04,.06,1,1.8,1,,140,.06,.04,,,.1,,.99,.03],"game/collect/001":[1.1,0,450,,.01,.13,,2.7,,-9.5,500,.08,,,,,,.89],"game/collect/002":[1.05,,10,.08,.07,.24,2,1.03,,,-374,.04,.09,,,,,.72,.15,.18],"game/die/001":[1.5,0,537,.02,.02,.22,1,1.59,-6.98,4.97],"game/die/002":[1,,321,.01,.06,.06,1,3.8,,-49,,,,.3,,,,.79,.09],"game/die/003":[1,0,344,.01,.02,.28,1,1.4,,,50,,,,.3,.2,.15,.6,.06],"game/die/004":[.5,0,43,.01,,1,2,,,,,,,,,.02,.01],"game/jump/001":[1,.1,75,.03,.08,.17,1,1.88,7.83,,,,,.4],"game/jump/002":[1.2,,311,.03,.05,.05,,2.2,,9,,,.02,,2.7,,,.97,.05,,101],"game/jump/003":[1.5,,65,.04,.1,.13,1,1.5,,-31,,,,.3,,,,.99,.03],"game/jump/004":[,0,500,,.01,.13,,.2,1.7,,-400],"game/jump/005":[1,,341,,.14,.23,1,1.01,.9,,-132,.03,,.1,,.1,,.52,.22],"game/jump/006":[.7,,1496,.09,.09,.01,3,.14,,,-870,,,,3.2,.2,,.31,.02],"game/powerup/001":[,,188,.03,.09,.12,1,2.4,,95,,,,,,,,.63,.08],"game/powerup/002":[.8,0,413,.03,.05,.05,,1.8,,19,177,.05,,,,,,.83,.02],"game/powerup/003":[.5,,643,,.1,.12,1,.1,,99,,,,,,,,.6,.02,,-732],"game/powerup/004":[1.18,,143,.05,.08,.06,,.09,25,4.1,,,,,,,.01,.52,.09],"game/powerup/005":[1,,18,.01,.01,.21,1,.49,9.9,,,,,,,,.04,.95,.02],"game/powerup/006":[.5,,426,.01,,.05,,2.54,49,,9,.1,,,,,,.46,.15],"game/powerup/007":[1,,158,.09,.18,.03,,2.53,11,-58,63,.02,.01,.5,,,,.16],"game/powerup/008":[1.2,0,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04],"instrument/bass/001":[2,0,65,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/002":[2,0,73,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/003":[2,0,82,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/004":[2,0,87,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/005":[2,0,97,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/006":[2,0,110,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/007":[2,0,123,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/bass/008":[2,0,130,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],"instrument/drum/001":[1.5,0,86,,,,,.7,,,,.5,,6.7,1,.05],"instrument/drum/002":[.7,0,270,,,.12,3,1.65,-2,,,,,4.5,,.02],"tone/beep/001":[2,0,130,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/002":[2,0,146,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/003":[2,0,164,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/004":[2,0,174,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/005":[2,0,195,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/006":[2,0,220,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/007":[2,0,246,,.1,,1,1.5,,,,,,,,.1,.01],"tone/beep/008":[2,0,261,,.1,,1,1.5,,,,,,,,.1,.01],"tone/bell/001":[2,0,999,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22],"tone/bell/002":[,0,1600,.13,.52,.61,1,1.1,,,,,,.1,,.14],"tone/bell/random":[2,.1,999,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22],"tone/blip/001":[5,0,130,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/002":[3,0,146,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/003":[3,0,164,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/004":[3,0,174,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/005":[3,0,195,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/006":[3,0,220,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/007":[3,0,246,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/blip/008":[3,0,261,.02,.03,.02,,2.8,,,,,,,,,,.7,.02],"tone/bloop/001":[1,,110,.02,,.09,1,.61,,,556,.12,,,,.3,,,.02],"tone/bloop/002":[1,0,521.25,,.02,.03,2,0,,.1,700,.01,,,1,.1],"tone/bloop/003":[1.12,,73,,.02,.11,2,1.18,,-.1,,,,,,.3,,.55,.05,.23],"tone/bloop/004":[.5,,1368,.09,,0,,1.11,-76,9.1,-490,,,,,,,.56],"tone/bloop/005":[2.03,,413,,,.24,2,.12,,,,,.11,,317,.1,.13,,,.01],"tone/bloop/006":[,0,,.01,.02,.09,,.6,17,-3,,,.1,,,,,.76,.08],"tone/bloop/007":[.3,,10,.06,,0,2,2.3,,,621,,,,,,,,.21,.26],"tone/bloop/008":[1.5,.05,24,.01,.02,.01,1,3.9,-33,0,0,0,0,0,355,0,0,.65,0,0,0],"tone/bloop/009":[2,.05,226,0,.08,.13,0,3.1,0,0,0,0,0,0,0,.1,.02,.76,.04,0,105],"tone/bloop/010":[4,0,224,.02,.02,.08,1,1.7,-13.9,,,,,,6.7],"tone/bloop/011":[1,,283,.02,,.11,,.38,,,,,.07,,,.1,.08,.63,.02],"tone/bloop/012":[1,0,288,.05,.01,,,2,-10,,,,,,,,,.5,.1],"tone/bloop/013":[2,0,700,.01,,0,,,,,,,,,,,,.1,.01],"tone/bloop/014":[2.21,,107,.02,.04,.07,,2.22,2,.9,,,,.4,,.5,.15,.42,.04],"tone/bloop/015":[.6,0,2200,,,.04,3,2,,,800,.02,,4.8,,.01,.1],"tone/jingle/001":[1.4,,183,.07,.13,.34,,3.3,,,35,.06,.07,,,,.13,.95,.27,.11],"tone/jingle/002":[.8,,208,.02,.21,.13,3,.2,,,40,.06,.1,,,,,.91,.2,.27],"tone/jingle/003":[.9,,56,.15,.46,.08,,1.6,-2,,-137,.01,.06,,,,.09,.77,.37,.13],"tone/jingle/004":[.6,,269,.03,.17,.41,,.2,,1,239,.08,.04,,,,,.72,.19,.43,-720],"tone/jingle/005":[1.3,0,130.81,.32,.35,.5,3,5.2,0,1,50,0,.14,0,0,0,0,.37,.04,.24,0],"tone/jingle/006":[1,,525,.18,.28,.17,1,1.24,8.3,-9.7,-151,.03,.06,,,,,.93,.02,.14],"tone/jingle/007":[.6,,934,.12,.38,.93,1,.27,,.4,-434,.08,.2,.1,,.1,.17,.55,1,.46],"tone/jingle/008":[1.4,0,20,.04,,.6,,1.31,,,-990,.06,.17,,,.04,.07],"tone/jingle/009":[1.2,0,80,.3,.4,.7,2,.1,-.73,3.42,-430,.09,.17,,,,.19],"tone/jingle/010":[.5,,392,.06,.22,.5,1,1.85,-.1,-.9,61,.05,.07,,,.1,,.96,.12],"tone/jingle/011":[.5,,146,.04,.23,.46,,.56,,-3.7,658,.02,.15,.1,,,,.82,.13,.2],"tone/jingle/012":[1,,284,.08,.2,.25,1,3,,,50,.09,.06,,,,,.6,.28,.03,-1391],"tone/jingle/013":[1.5,,430,.02,.12,.5,,.89,,-3.6,-133,.07,.13,,,.1,,.83,.23,.26],"tone/jingle/014":[.4,,22,.08,.22,.02,1,.52,-4.2,-9.8,,,.14,,-18,.2,,,.05],"tone/jingle/015":[,,193,.04,.27,.42,1,1.71,2.8,4.9,,,.1,.2,,.1,,.55,.27,.47],"tone/jingle/016":[1.1,,250,.07,.24,.26,,2,,164,211,.07,.08,,,.1,,.75,.12,.09,115],"tone/jingle/017":[,,103,.04,.11,.43,1,.77,,,57,.19,.05,,,.1,,.68,.24],"ui/click/001":[1.5,0,900,,.01,0,1,,-10,,-31,.02,,,,,,1.2,,.16,-1448],"ui/click/002":[2.5,,783,,.03,.02,1,2,,,940,.03,,,,,.2,.6,,.06],"ui/click/003":[1.5,.01,300,,,.02,3,.22,,,-9,.2,,,,,,.5],"ui/click/004":[1,0,685,.01,.03,.17,1,1.4,,,,,,,,,,.63,.01,,420],"ui/click/005":[6,,205,,.02,0,,1.03,,,,,,,,,.12,.32],"weapon/explode/001":[1.5,0,333,.01,0,.9,4,1.9,,,,,,.5,,.6],"weapon/explode/002":[1.1,0,418,0,.02,.2,4,1.15,-8.5,,,,,.7,,.1],"weapon/explode/003":[1.2,0,82,.02,,.2,4,4,,,,,,.8,,.2,,.8,.09],"weapon/explode/004":[2,.2,72,.01,.01,.2,4,,,,,,,1,,.5,.1,.5,.02],"weapon/explode/005":[2,,1e3,.02,,.2,1,3,.1,,,,,1,-30,.5,,.5],"weapon/explode/006":[1,,485,.02,.2,.2,4,.11,-3,.1,,,.05,1.1,,.4,,.57,.5],"weapon/explode/007":[.8,,372,.02,.02,.5,4,2.29,.2,,,,,.6,,.6,,.7,.04,.19],"weapon/explode/008":[1.05,,591,.03,.13,.51,4,3.02,.6,.1,,,.04,1.6,,1,,.46,.13],"weapon/explode/009":[1.99,,770,.03,.19,.35,,.26,,,,,,2,-50,.1,.27,.48,.06],"weapon/explode/010":[1.5,,98,.08,.18,.02,2,2.47,36,.5,,,.04,.1,,.9,.44,,.04],"weapon/explode/011":[1,,400,,.03,.21,3,.85,.5,,,,,1.8,,.5,,.97,.05],"weapon/explode/012":[1,,485,.02,.07,.03,4,.11,-3,.1,,,.05,1.1,,.4,,.57,.09],"weapon/explode/013":[,,30,.09,.12,.35,4,3,4,,,,,1.3,,.6,,.36,.21],"weapon/lazer/001":[1.5,0,515,.05,.07,.09,1,2.8,,,302,.06,.1,,3.5,.1,.08,.75,.04],"weapon/lazer/002":[,0,925,.04,.3,.6,1,.3,,6.27,-184,.09,.17],"weapon/lazer/003":[1,,375,.01,.06,,2,2.3,18,-10,,,,,18,,,.56,.14],"weapon/lazer/004":[.5,,2e3,,.05,0,,1.11,-17,,197,.01,,.2,,,,,.16],"weapon/lazer/005":[.9,,752,.03,.01,.02,,1.4,,,-10,.01,,,3.4,,,.68,.03,,106],"weapon/lazer/006":[1.9,,221,.01,.05,.06,1,3.9,-2,,116,.05,,,,,,.65,.02,,452],"weapon/lazer/007":[1,,659,.01,.04,,1,.4,,-75,179,.06,,,.2,,,.57],"world/footstep/001":[1.1,.05,157,.03,.04,.04,4,4.9,78,-13,0,0,.07,0,0,0,0,.91,.02,.33,0],"world/footstep/002":[.1,1,300,.05,.1,.05,4,.2,-100,,-50,.07,,.5,,.4,,,,.05],"world/footstep/003":[3,,5,,.06,.01,2,2.25,-19,-79,409,.01,,,6.6,,.2,.57,,.8],"world/nature/frog":[.5,,160,.03,.03,.02,,1.52,-23,93,662,.02,,,,.1,,,.07,.01],"world/nature/dolphin":[.5,0,448,.01,.1,.3,3,.39,-.5,,,,,,.2,.1,.08],"world/nature/whale":[1.2,0,1306,.8,.08,.02,1,,,,,,.48,,-.1,.11,.25],"world/nature/mouse":[1.2,0,1e3,.02,,.01,2,,18,,475,.01,.01],"world/nature/small-dog":[1,,759,.01,,.01,1,.97,15,,,,,,3.1,,,.76,.04],"world/nature/tweet":[.7,,1305,,,.03,1,.75,,23,694,.01,,,3.9,,,,.01],"world/water/splash":[2,,94,.07,.1,.33,4,.6,1,,,,,.1,1,.1,.1,.45,.15],"world/water/wave":[1,0,40,.5,,1.5,,11,,,,,,199],"world/water/pop":[1,0,103,,.02,.06,,1.24,-18,4.4,,,,.7,,.1,,.95,.03],"world/weather/thunder":[1.2,0,471,,.09,.47,4,1.06,-6.7,,,,,.9,61,.1,,.82,.09,.13]},e.Sfx.play=function(s=""){s&&(e.Utilities.checkString("sfx",s),e.Sfx.library[s]||e.Utilities.fatal(`SFX ${s} not found.`),e.Sfx.playFromArray(e.Sfx.library[s]))},e.Sfx.playFromArray=function(s=[]){e.Utilities.checkArray("sfxArray",s),zzfx(...s)},e.Sfx.add=function(s,a){e.Utilities.checkString("sfxName",s),e.Utilities.checkArray("sfxArray",a),e.Sfx.library[s]=a},e.Sfx.get=function(){return Object.keys(e.Sfx.library)}})(b8),(function(e){e.Scene={};let s=null;const a={};e.Scene.add=function(r,t=null,i=30){e.Utilities.checkString("name",r),t!==null&&e.Utilities.checkObject("gameObject",t),e.Utilities.checkInt("frameRate",i);const n=t.init||null,o=t.update||null,l=t.render||null;a[r]={init:n,update:o,render:l,frameRate:i}},e.Scene.reset=function(){for(const r in a)Object.prototype.hasOwnProperty.call(a,r)&&delete a[r];s=null},e.Scene.set=function(r){e.Utilities.checkString("name",r),a[r]||e.Utilities.fatal(`Scene "${r}" does not exist.`),e.Core.stopFrame(),s=r,e.Input&&typeof e.Input.onEndFrame=="function"&&e.Input.onEndFrame();const t=a[r];t.init&&t.init(),(t.update||t.render)&&e.frame(t.render,t.update,t.frameRate)},e.Scene.pause=function(){e.frame(null)},e.Scene.resume=function(){if(!s)return;const r=a[s];(r.update||r.render)&&e.frame(r.render||(()=>{}),r.update||(()=>{}),r.frameRate||30)},e.Scene.get=function(){return s},e.Scene.getAll=function(){return a}})(b8),(function(e){e.Renderer={};let s=!1,a=0,r=null,t=null;const i=()=>{if(!e.Core.realCtx){setTimeout(i,10);return}if(r||(r=e.Core.realCtx.createRadialGradient(e.Core.realCanvas.width/2,e.Core.realCanvas.height/2,Math.max(e.Core.realCanvas.width,e.Core.realCanvas.height)*.4,e.Core.realCanvas.width/2,e.Core.realCanvas.height/2,Math.max(e.Core.realCanvas.width,e.Core.realCanvas.height)*.9),r.addColorStop(0,"rgba(255,255,255,0)"),r.addColorStop(.7,"rgba(0,0,0,0.5)"),r.addColorStop(1,"rgba(0,0,0,1)")),!t){const l=new OffscreenCanvas(1,2),u=l.getContext("2d");u.fillStyle="rgba(0,0,0,0.15)",u.fillRect(0,1,1,1),u.fillStyle="rgba(255,255,255,0.0)",u.fillRect(0,0,1,1),t=e.Core.realCtx.createPattern(l,"repeat")}};document.addEventListener("b8.initComplete",i),e.Renderer.render=function(){if(e.Core.crashed)return;e.Core.realCtx.imageSmoothingEnabled=!1;let l=0,u=0;if(a>0){let f=a*e.CONFIG.CHR_WIDTH;l=Math.round(Math.random()*f-f/2),u=Math.round(Math.random()*f-f/2),l=e.Utilities.clamp(l,-6,6),u=e.Utilities.clamp(u,-6,6),a-=e.Core.deltaTime}e.Core.realCtx.globalCompositeOperation="source-over",e.Core.realCtx.clearRect(0,0,e.Core.realCanvas.width,e.Core.realCanvas.height),e.Core.realCtx.drawImage(e.Core.offCanvas,l,u,e.Core.realCanvas.width,e.Core.realCanvas.height),s=!1,e.CursorRenderer.draw(e.Core.realCtx),o(),n()},e.Renderer.reset=function(){s=!1,a=0};const n=()=>{r&&e.CONFIG.CRT_ENABLE&&(e.Core.realCtx.save(),e.Core.realCtx.globalCompositeOperation="multiply",e.Core.realCtx.fillStyle=r,e.Core.realCtx.fillRect(0,0,e.Core.realCanvas.width,e.Core.realCanvas.height),e.Core.realCtx.restore())},o=()=>{t&&e.CONFIG.CRT_ENABLE&&(e.Core.realCtx.save(),e.Core.realCtx.globalCompositeOperation="soft-light",e.Core.realCtx.fillStyle=t,e.Core.realCtx.fillRect(0,0,e.Core.realCanvas.width,e.Core.realCanvas.height),e.Core.realCtx.restore())};e.Renderer.shakeScreen=function(l=.25){return e.Utilities.checkNumber("duration",l),l<=0?(e.Utilities.warn(`Screenshake duration must be positive. Currently: ${l}`),!1):(a=l,!0)},e.Renderer.markDirty=function(){s||(s=!0,setTimeout(e.Renderer.render,1))}})(b8),(function(e){e.Random={};let s=null;e.Random.setSeed=function(r=null){r===null&&(r=Date.now()),typeof r=="string"&&(r=r.split("").reduce((t,i)=>t+i.charCodeAt(0),0)),r^=r<<13,r^=r>>17,r^=r<<5,r>>>=0,s=r;for(let t=0;t<10;t++)e.Random.num()},e.Random.getSeed=function(){return s},e.Random.num=function(){return s=(s*1664525+1013904223)%4294967296,s/4294967296},e.Random.range=function(r,t){if(e.Utilities.checkNumber("min",r),e.Utilities.checkNumber("max",t),t<=r){const i=t;t=r,r=i}return r+e.Random.num()*(t-r)},e.Random.int=function(r,t){e.Utilities.checkInt("min",r),e.Utilities.checkInt("max",t);const i=e.Random.range(r,t);return Math.round(i)},e.Random.pick=function(r){e.Utilities.checkArray("array",r);const t=e.Random.int(0,r.length-1);return r[t]};const a=new Map;e.Random.pickWeighted=function(r,t=.2){e.Utilities.checkArray("array",r);const i=JSON.stringify(r)+`|${t}`;let n=a.get(i);return n||(n=e.Random.weightedArray(r,t),a.set(i,n)),e.Random.pick(n)},e.Random.shuffleArray=function(r){e.Utilities.checkArray("array",r),r=r.slice();for(let t=0;t<r.length;t++){const i=e.Random.int(0,r.length-1),n=r[t];r[t]=r[i],r[i]=n}return r},e.Random.chance=function(r){return e.Utilities.checkNumber("probability",r),e.Random.num()<=r/100},e.Random.weightedArray=function(r,t=.2){e.Utilities.checkArray("array",r);const i=[];for(let n=0;n<r.length;n++){const o=Math.pow(t,n)*10;for(let l=0;l<o;l++)i.push(r[n])}return i},e.Random.coord2D=function(r,t,i){let n=2166136261^i;return n=Math.imul(n^r,16777619),n=Math.imul(n^t,16777619),n^=n>>>13,n=Math.imul(n,2246822507),n^=n>>>16,(n>>>0)/4294967296},e.Random.smooth2D=function(r,t,i=0,n=1){r*=n,t*=n;const o=Math.floor(r),l=Math.floor(t),u=r-o,f=t-l,h=e.Random.coord2D(o,l,i),C=e.Random.coord2D(o+1,l,i),g=e.Random.coord2D(o,l+1,i),d=e.Random.coord2D(o+1,l+1,i),A=e.Math.fade(u),p=e.Math.fade(f),S=e.Math.lerp(h,C,A),x=e.Math.lerp(g,d,A);return e.Math.lerp(S,x,p)},e.Random.reset=function(){s=null,a.clear(),e.Random.setSeed()}})(b8),(function(e){e.Path={},e.Path.AnimationMode={LOOP:"loop",PINGPONG:"pingpong",ONCE:"once"};const s={U:{dx:0,dy:-1},D:{dx:0,dy:1},L:{dx:-1,dy:0},R:{dx:1,dy:0}};e.Path.parseCode=function(t,i=0,n=0,o="D"){e.Utilities.checkString("code",t),e.Utilities.checkNumber("startRow",n),e.Utilities.checkNumber("startCol",i),e.Utilities.checkString("initialDir",o),"UDLR".includes(o)||e.Utilities.fatal("Path.parseCode: initialDir must be one of U, D, L, R");let l=i,u=n,f=o;const h=[],C=t.replace(/\s+/g,"").toUpperCase();let g=0;for(;g<C.length;){const d=C[g];if("UDLR".includes(d)){g++;const{count:A,index:p}=a(C,g);g=p;for(let S=0;S<A;S++)l+=s[d].dx,u+=s[d].dy,r(h,l,u,d);continue}if(d==="P"){g++;const{count:A,index:p}=a(C,g);g=p,r(h,l,u,f,A);continue}if(d==="F"){g++;const A=C[g];"UDLR".includes(A)||e.Utilities.fatal("F must be followed by U/D/L/R, got: "+A),g++;const{count:p,index:S}=a(C,g);g=S,r(h,l,u,d+A,p);continue}e.Utilities.fatal(`Invalid path command: ${d} in path code: ${t}`)}return h},e.Path.validPathSyntax=function(t){const i="UDLRFP";return!(typeof t!="string"||t.trim().length===0||!new RegExp(`^[\\d\\s${i}]+$`).test(t)||!new RegExp(`[${i}]`).test(t)||!new RegExp(`^[${i}]`).test(t))};function a(t,i){let n="";for(;i<t.length&&/[0-9]/.test(t[i]);)n+=t[i++];return{count:n?parseInt(n,10):1,index:i}}function r(t,i,n,o=null,l=1){for(let u=0;u<l;u++)t.push({col:i,row:n,dir:o})}})(b8),(function(e){e.Passcodes={},e.Passcodes.codeLength=4,e.Passcodes.getCode=function(a){e.Utilities.checkIsSet("id",a);const r=a+e.CONFIG.PASSKEY;let t=s(r);return t=t.replace(/[^a-zA-Z]/g,""),t=t.toUpperCase(),t.substring(0,e.Passcodes.codeLength)},e.Passcodes.checkCode=function(a,r){return e.Utilities.checkIsSet("id",a),e.Utilities.checkString("code",r),e.Passcodes.getCode(a)===r},e.Passcodes.getId=function(a){for(e.Utilities.checkString("code",a),a=a.toUpperCase(),c=1;c<999;c++)if(e.Passcodes.checkCode(c,a))return c;return null},e.Passcodes.input=async function(){const a="Enter code:",r=a.length+2+2,t=6;let i=Math.round((e.CONFIG.SCREEN_COLS-r)/2),n=Math.round((e.CONFIG.SCREEN_ROWS-t)/2);e.Core.setCursorLocation(i,n),e.TextRenderer.printBox(r,t),e.Core.setCursorLocation(i+2,n+2);const o=await e.Async.readLine(a,"",e.Passcodes.codeLength);return e.Passcodes.getId(o)};function s(a){a=btoa(a);let r=0,t="";for(let i=0;i<a.length;i++)r=(r<<5)-r+a.charCodeAt(i),r=r&r;for(let i=0;i<5;i++)r=(r<<5)-r+e.CONFIG.PASSKEY.charCodeAt(i%e.CONFIG.PASSKEY.length),t+=Math.abs(r).toString(36);return t}})(b8),(function(e){e.Particles={};let s=[];e.Particles.add=function(a,r,t){e.Utilities.checkNumber("x",a),e.Utilities.checkNumber("y",r),e.Utilities.checkObject("props",t);const n=Object.assign({},{x:a,y:r,vx:0,vy:0,life:1,size:1,color:15,gravity:0},t);Array.isArray(n.color)&&(n.color=e.Random.pick(n.color)),Array.isArray(n.size)&&(n.size=e.Random.pick(n.size)),s.push(n)},e.Particles.reset=function(){e.Particles.clearAll()},e.Particles.createExplosion=function(a,r,t=10,i={}){e.Utilities.checkNumber("x",a),e.Utilities.checkNumber("y",r),e.Utilities.checkNumber("count",t),e.Utilities.checkObject("props",i);const n={size:1,color:e.Core.drawState.fgColor,life:2,speed:25,gravity:0},o=Object.assign({},n,i);for(let l=0;l<t;l++){const u=e.Random.range(0,Math.PI*2),f=e.Random.range(o.speed/2,o.speed);e.Particles.add(a,r,{size:o.size,color:o.color,life:o.life,vx:Math.cos(u)*f,vy:Math.sin(u)*f,g:o.gravity})}},e.Particles.update=function(a){for(let r=s.length-1;r>=0;r--){const t=s[r];t.vy+=t.g*a,t.x+=t.vx*a,t.y+=t.vy*a,t.life-=a,t.life<=0&&s.splice(r,1)}},e.Particles.render=function(){for(let a=0;a<s.length;a++){const r=s[a],t=r.size/2;e.Core.offCtx.fillStyle=e.Core.getColorHex(r.color),e.Core.offCtx.fillRect(Math.round(r.x-t),Math.round(r.y-t),Math.round(r.size),Math.round(r.size))}},e.Particles.clearAll=function(){s=[]},e.Particles.getParticles=function(){return[...s]},e.Particles.setParticles=function(a){e.Utilities.checkArray("particles",a),s=a}})(b8),(function(e){let s=0,a=!1;function r(){a||(a=!0,s=Date.now(),e.Utilities.event("pageVisibility.sleep"))}function t(){if(!a||(a=!1,s===0))return;const i=Date.now()-s;e.Utilities.log("Time asleep:",(i/1e3).toFixed(3)),e.Utilities.event("pageVisibility.wake",{time:i}),s=0}document.addEventListener("visibilitychange",function(){document.hidden?r():t()}),window.addEventListener("blur",()=>r()),window.addEventListener("focus",()=>t())})(b8),(function(e){e.Music={};function s(E,R){for(var y=[],N=0;N<E;N++)y.push(R(N));return y}const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function r(E){var R=/^([A-Ga-g])([#b]?)(\d)$/,y=E.match(R);if(!y)return null;var N=y[1].toUpperCase(),M=y[2],m=parseInt(y[3],10),w={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[N];return M==="#"?w+=1:M==="b"&&(w-=1),(m+1)*12+w}function t(E){let R=r(E);return R===null?"?":(R=e.Utilities.clamp(R,36,87),a.charAt(R-36))}function i(E){if(E.length===0)return"";for(var R=E[0],y=1;y<E.length;y++)E[y]===E[y-1]&&E[y]!==" "&&E[y]!=="|"?R+="-":R+=E[y];return R}function n(E,R,y,N){for(var M=s(E,function(){return!1}),m=0;m<N&&!(y>E);m++)M=o(M,y,R),y*=2;return M}function o(E,R,y){for(var N=s(R,function(){return!1}),M=0;M<y;M++)N[e.Random.int(0,R-1)]=!0;return E.map(function(m,w){return N[w%R]?!m:m})}const l=[["I","IIIm","VIm"],["IV","IIm"],["V","VIIm"]],u=[[0,1,2],[1,2,0],[2,0]],f={I:["C4","E4","G4","B4"],IIIm:["E4","G4","B4","D5"],VIm:["A3","C4","E4","G4"],IV:["F4","A4","C5","E5"],IIm:["D4","F4","A4","C5"],V:["G3","B3","D4","F4"],VIIm:["B3","D4","F4","A4"]},h={C:0,D:2,Eb:3,F:5,G:7,A:9,Bb:10},C=[0,1,2,3,4,5],g=[6,7];function d(E,R){const y=f[R]||f.I,N=h[E]||0;return y.map(function(M){return A(M,N)})}function A(E,R){var y=r(E);if(y===null)return E;y+=R;var N=Math.floor(y/12)-1,M=y%12,m=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return m[M]+N}function p(E){for(var R=["C","D","Eb","F","G","A","Bb"],y=e.Random.pick(R),N=4,M=null,m=0,w=[],I=0;I<E;I++){if(I%N===0){I===0?(m=e.Random.int(0,l.length-1),M=e.Random.pick(l[m])):e.Random.num()<.8-I/N%2*.5&&(m=e.Random.pick(u[m]),M=e.Random.pick(l[m]));var k=d(y,M)}w.push(k)}return w}function S(E,R){for(var y=[e.Random.pick(C),"|"],N=n(E,4,8,3),M=e.Random.int(-1,1),m=0;m<E;m++){if(e.Random.chance(10)&&(M+=e.Random.int(-1,1)),!N[m]){y.push(" ");continue}var w=R[m],I=w[e.Random.int(0,w.length-1)],k=parseInt(I.slice(-1),10),v=e.Utilities.clamp(k+M,3,6),B=I.slice(0,-1).toUpperCase(),U=B+v,F=t(U);y.push(F)}return y.push("|"),i(y)}function x(E,R){const y=[e.Random.pick(C),"|"];for(var N=e.Random.chance(30),M=e.Random.pick([4,8,16]),m=s(M,function(){return e.Random.int(0,3)}),w=e.Random.pick([2,4,8]),I=N?s(E,function(){return!0}):n(E,e.Random.pick([1,1,w/2]),w,2),k=e.Random.int(-1,1),v=e.Random.chance(N?30:80),B=0,U=0;U<E;U++){if(v&&U%w===0&&(B=(B+1)%2),!I[U]){y.push(" ");continue}var F=R[U],_=N?m[U%M]:0,P=F[_],L=parseInt(P.slice(-1),10),Q=e.Utilities.clamp(L+k+B,3,6),O=P.slice(0,-1).toUpperCase(),G=O+Q,H=t(G);y.push(H)}return y.push("|"),i(y)}function D(E){const R=[e.Random.pick(g),"|"],y=n(E,e.Random.int(1,3),e.Random.pick([4,8]),3);for(var N=t("C4"),M=0;M<E;M++)R.push(y[M]?N:" ");return R.push("|"),i(R)}e.Music.generate=function(E){E&&E.seed&&e.Random.setSeed(E.seed);const R={seed:e.Random.int(1e4,99999),noteCount:e.Random.pick([16,32,48,64]),channelCount:e.Random.int(2,5),drumPartRatio:.3,tempo:e.Random.pick([70,100,140,170,200,240,280]),hold:e.Random.pick([40,50,60,60,70,70,70,80,80,80,80,90,90,90,100,110,120,130,140,150])},y=Object.assign({},R,E);e.Music.currentSongProperties=y,e.Random.setSeed(y.seed);var N=p(y.noteCount),M=s(y.channelCount,function(){var w=e.Random.num()<y.drumPartRatio;return w?D(y.noteCount):e.Random.num()<.5?S(y.noteCount,N):x(y.noteCount,N)});if(y.tempo!==null){var m=String(y.tempo);y.hold!==null&&(m+="."+String(y.hold)),M[0]=m+`
`+M[0]}return M.join(`
`)};let T=null;e.Music.play=function(E){p1(E),E&&(T=E)},e.Music.stop=function(E=!0){e.Utilities.checkBoolean("clearCurrentSong",E),E&&(T=null),e.Music.play("")},e.Music.pause=function(){e.Music.isPlaying()&&e.Music.stop(!1)},e.Music.resume=function(){T&&!e.Music.isPlaying()&&e.Music.play(T)},e.Music.setVolume=function(E){e.Utilities.checkNumber("volume",E),p1.setVolume(E)},e.Music.setTempo=function(E){e.Utilities.checkInt("tempo",E),E<50&&(E=50),p1.setTempo(E)},e.Music.isPlaying=function(){return p1.isPlaying()},e.Music.reset=function(){e.Music.stop(),T=null},document.addEventListener("b8.pageVisibility.wake",e.Music.resume),document.addEventListener("b8.pageVisibility.sleep",e.Music.pause)})(b8),(function(e){e.Menu={},e.Menu.display=async function(a,r){r=r||{},e.Utilities.checkArray("choices",a),e.Utilities.checkObject("options",r),r=Object.assign({title:"",prompt:"",selBgColor:e.Core.drawState.fgColor,selFgColor:e.Core.drawState.bgColor,border:!0,borderChar:e.CONFIG.BORDER_CHAR,center:!1,centerH:!1,centerV:!1,padding:1,selIndex:0,typewriter:!1},r);let t=e.Core.drawState.cursorCol,i=e.Core.drawState.cursorRow;const n=e.TextRenderer.measure(r.prompt),o=r.prompt?1:0,l=r.borderChar?1:0;let u=0;const f=a.length;a.forEach(d=>{u=Math.ceil(Math.max(u,e.TextRenderer.measure(d).cols))});let h=Math.ceil(Math.max(n.cols,u))+2*r.padding+2*l;h=Math.min(h,e.CONFIG.SCREEN_COLS);const C=o*(n.rows+1)+f+2*r.padding+2*l;if((r.centerH||r.center)&&(t=Math.round((e.CONFIG.SCREEN_COLS-h)/2)),(r.centerV||r.center)&&(i=Math.round((e.CONFIG.SCREEN_ROWS-C)/2)),e.Core.drawState.cursorCol=t,e.Core.drawState.cursorRow=i,r.border&&(e.TextRenderer.printBox(h,C,!0,r.borderChar),r.title)){const d=" "+r.title+" ";e.Core.drawState.cursorCol=t+Math.round((h-d.length)/2),e.TextRenderer.print(d)}r.prompt&&(e.Core.drawState.cursorCol=n.cols<=h?t+l+r.padding:t+Math.round((h-n.cols)/2),e.Core.drawState.cursorRow=i+l+r.padding,r.typewriter?await e.Async.typewriter(r.prompt):e.TextRenderer.print(r.prompt));let g=r.selIndex;for(;;){e.Core.drawState.cursorRow=i+l+r.padding+o*(n.rows+1),e.Core.drawState.cursorCol=n.cols<=u?t+l+r.padding:t+Math.round((h-u)/2),s(a,g,r);const d=await e.Input.readKeyAsync();if(d.includes("ArrowUp"))g=g>0?g-1:a.length-1,a.length>1&&e.Sfx.play(e.CONFIG.SFX.MENU_UP);else if(d.includes("ArrowDown"))g=(g+1)%a.length,a.length>1&&e.Sfx.play(e.CONFIG.SFX.MENU_DOWN);else if(d.includes("Enter")||d.includes("ButtonA")||d.includes("ButtonB")||d.includes(" "))return e.Sfx.play(e.CONFIG.SFX.MENU_SELECT),g}};const s=function(a,r,t){const i=e.Core.drawState.bgColor,n=e.Core.drawState.fgColor;for(let o=0;o<a.length;o++){const l=o===r;e.Core.setColor(l?t.selFgColor:n,l?t.selBgColor:i),e.TextRenderer.print(a[o]+`
`)}e.Core.setColor(n,i)}})(b8),(function(e){e.Math={},e.Math.dist2D=function(a,r,t,i){e.Utilities.checkNumber("x0",a),e.Utilities.checkNumber("y0",r),e.Utilities.checkNumber("x1",t),e.Utilities.checkNumber("y1",i);const n=a-t,o=r-i;return Math.sqrt(n*n+o*o)},e.Math.dist2d=e.Math.dist2D,e.Math.distManhattan=function(a,r){return Math.abs(a.col-r.col)+Math.abs(a.row-r.row)},e.Math.lerp=function(a,r,t){return a+(r-a)*t},e.Math.fade=function(a){return a*a*a*(a*(a*6-15)+10)},e.Math.smoothstep=function(a){return a*a*(3-2*a)};function s(a){return a*a*a*(a*(a*6-15)+10)}})(b8),(function(e){e.Inventory={},document.addEventListener("b8.initComplete",()=>{e.Inventory.reset()},{once:!0}),e.Inventory.reset=function(){e.data.inventory={counts:{},flags:{}}},e.Inventory.getCount=function(s){return e.data.inventory.counts[s]??0},e.Inventory.add=function(s,a=1,r=1/0){const t=e.Inventory.getCount(s);e.data.inventory.counts[s]=Math.min(t+a,r)},e.Inventory.remove=function(s,a=1){const r=e.Inventory.getCount(s);e.data.inventory.counts[s]=Math.max(r-a,0)},e.Inventory.has=function(s,a=1){return e.Inventory.getCount(s)>=a},e.Inventory.setFlag=function(s,a=!0){e.data.inventory.flags[s]=a},e.Inventory.getFlag=function(s){return e.Utilities.checkString("flag",s),!!e.data.inventory.flags[s]},e.Inventory.filter=function(s){const a=[],r=e.data.inventory.counts,t=s instanceof RegExp;t||e.Utilities.checkString("match",s);for(const i in r){if(!Object.hasOwn(r,i))continue;const n=r[i];n<=0||(t&&s.test(i)||!t&&i.includes(s))&&a.push({id:i,count:n})}return a}})(b8),(function(e){e.Intro={};const s="mBqYHoMBBACDAAMEgwADBIMBBACDAQQAgwADBIMAAwSDAQQAgwEEAIMBBACDAw8EgwMPBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwEEAIMAAwSDAAMEgwADBIMBBACDGHoDBIMYmQMEgwEEAIMBBACDAQQAgwMDBIMDAwSDAQQAgwEEAIMYKQMEgxgpAwSDAQQAgwEEAIMBBACDAQQAgwEEAIMABASDAAQEgwAEBAAPAAAPAJgegwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMXAwSDAQMEgxiXDwODGBgDBIMBBACDAQQAgwEEAIMBBACDAAQEgwMDBIMBBAAADwAADwCYHoMPBQSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMPBQSDAQQAgwEEAAAPAAAPAJgegwEEAIMBBACDAQQAgxhyAwSDGD0DBIMYPQMEgxg9AwSDGD0DBIMYPQMEgxg9AwSDGD0DBIMYPQMEgxg9AwSDGD0DBIMYPQMEgxhzAwSDGB0FBIMBBACDEQMEgxEDBIMBBACDAAQEgwEEAIMPBQQADwAADwCYHoMBBACDAQQAgwEEAIMYTgMEgxicBA+DEw8EgwAPBIMBDwSDGGEED4MADwSDAQ8EgxhhBA+DAA8EgxicBA+DEw8EgxhQAwSDGCsFBIMBBACDEQMEgxEDBIMADwSDAAQEgwEEAIMBBAAADwAADwCYHoMBBACDAQQAgwEEAIMYTgMEgwEPBIMYpgQPgwAPBIMBDwSDGGEED4MADwSDAwQPgxhhBA+DAA8EgxiuBA+DGCUPBIMYUAMEgxgrBQSDAQQAgwEEAIMBBACDAQQAgwAEBIMABASDAAQEAA8AAA8AmB6DAQQAgxEDBIMRAwSDGE4DBIMYrgQPgxglDwSDAA8EgwMED4MBDwSDAA8EgwEPBIMBDwSDAA8EgwMED4MADwSDGFADBIMYKwEEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwEEAIMRAwSDEQMEgxhOAwSDAQQAgwEEAIMADwSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMYUAMEgxgrAQSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDGE4DBIMBCgSDGCwECoMBCgSDAQQAgwMECoMBBACDAQoEgxgoCgSDAQoEgwEEAIMBCgSDGFADBIMYKwUEgxAFBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwEEAIMYKQMEgwEEAIMYTgMEgwEKBIMBCgSDAQoEgwEEAIMBCgSDAQQAgwEKBIMDBAqDAwQKgwEEAIMBCgSDGFADBIMYKwUEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegxiXDwODGJcPA4MYGAMEgxhOAwSDAwQKgxgsCgSDAQoEgwEEAIMBCgSDAQQAgwEKBIMYKAQKgwEKBIMBBACDAwQKgxhQAwSDGCsBBIMBBACDAQQAgwMDBIMDAwSDAQQAgwEEAIMBBAAADwAADwCYHoMBBACDAQQAgwEEAIMYhAMEgxhhAwSDGGEDBIMYYQMEgxhhAwSDGGEDBIMYYQMEgxhhAwSDGGEDBIMYYQMEgxhhAwSDGGEDBIMYhQMEgxgrBQSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAAA8AAA8AmB6DAQQAgwEEAIMBBACDGC4FBIMYGQQFgxgZBAWDGBkEAYMYGQQBgxgZBAWDGBkEBYMYGQQFgxgZBAGDGBkEBYMYGQQBgxgZBAWDGBkEBYMYLwUEgwEEAIMBBACDGKwDBIMYNwMEgxg3AwSDGFsDBIMYNwMEAA8AAA8AmB6DGDcDBIMYNwMEgxg4AwSDAQQAgwEEAIMBBACDAQQAgwEEBIMBBASDAQQEgwEEBIMBBASDAQQAgwEEAIMBBACDAQQAgxkB5QMEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwEEAIMBBACDGEoDBIMBBACDAQQAgwAFBIMABQSDAAUEgwAFBIMDAwSDAwMEgwMDBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAAAPAAAPAJgegwAPBIMBBACDGFoDBIMYNwMEgxibAwSDAQQAgwEEAIMBBACDAQQAgwMPBIMDAwSDAwMEgwAFBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwADBIMAAwSDAAMEAA8AAA8AmB6DGBwKBIMYHQoEgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDGCkDBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMBBAAADwAADwCYHoMYLgoEgxgvCgSDAQQAgwEEAIMBBACDAQQAgwEEAIMBBACDGCkDBIMYKQMEgwEEAIMBBACDAQQAgwEEAIMBBACDFwMEgwEDBIMYGAMEgwADBIMBBACDGHQDBIMYhgMEgwAFBIMBBAAADwAADwCYHoMBBACDAQQAgwEEAIMADwSDAAMEgwADBIMBBACDFwMEgwIDBIMBAwSDGBgDBIMBBACDAQQAgwEEAIMBBACDAQQAgwEEAIMAAwSDAAMEgxh0AwSDGQFsBQSDAQQAgxkBRgUEgwEEAAAPAAAPAJgegxYDBIMYKAMEgwEEAIMBBACDGHQDBIMQAwSDAQQAgwEEAIMBBACDAAMEgwADBIMBBACDAQQAgwEEAIMWAwSDGCgDBIMYdAMEgxiGAwSDGQFsBQSDAAUEgwAFBYMBBQSDAQUEgwEFBAAPAAAPAJgegxgoBQODAAUDgxgoAwSDGHQDBIMBBACDAQQAgw0FBIMBBACDAQQAgxh0AwSDGIYDBIMWAwSDGCgDBIMWAwSDAQMEgwEDBIMQAwSDGLQFBIMAAQWDAwEFgwAFBYMBBQSDAQUEgwEFBAAPAAAPAJgegwEFBIMYKAUDgwAFA4MYKAMEgxi4BQSDAQQAgwEEAIMYhgMEgxh0AwSDGLgFBIMPAwSDCwMEgwEDBIMBAwSDGQFqBQODAQMEgxicBQODAAMFgwABBYMBBQSDAAUFgw8BBYMBBQSDAQUEAA8AAA8AmB6DAwEFgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDAQUEgwEFBIMBBQSDDwEFgxEBBYMPAQWDAwUBgwEFBIMBBQQADwAADwCWgxEBBYMRAQWDAwEFgwMBBYMDAQWDAwEFgwAPBYMDAQWDAwEFgwAPBYMADwWDAA8FgwMBBYMADwWDAA8FgwAPBYMPAQWDCwEFgxEBBYMLAQWDGFgFAYMADwGWgwAPAYMQAQWDAA8FgwAPBYMADwWDAA8FgwAPBYMBAQWDEAEFgwAPBYMADwWDAA8FgwAPBYMADwWDCQEFgwAPBYMADwWDBAEFgwAPAYMADwGDAA8BgwAFAQ==";e.Intro.loading=async function(){e.color(0,4),e.cls(),e.locate(1,1),e.print(`8> b8 Loading...
`),await e.Async.wait(.4)},e.Intro.splash=async function(){const a=e.Tilemap.load(s);e.locate(0,0),e.Tilemap.draw(a);let r="Click to start";e.Core.isTouchDevice()&&(r="Tap to start"),e.color(4,5),e.locate(0,e.CONFIG.SCREEN_ROWS-2),e.printCentered(r,e.CONFIG.SCREEN_COLS),await e.Input.readPointerAsync(),e.color(15,0),e.cls()}})(b8),(function(e){e.Input={};let s=new Set,a=new Set;const r=()=>t[t.length-1];let t=[{name:"game",capture:!1,passthrough:!0,queue:[]}];e.Input.pushContext=function(l,u={}){t.push({name:l,capture:!!u.capture,passthrough:u.passthrough??!1,queue:[]})},e.Input.popContext=function(){t.length>1&&t.pop()},e.Input.withContext=async function(l,u,f){e.Input.pushContext(l,u);try{return await f()}finally{e.Input.popContext()}},e.Input.reset=function(){s=new Set,a=new Set,window.removeEventListener("keydown",e.Input.onKeyDown),window.removeEventListener("keyup",e.Input.onKeyUp),window.removeEventListener("pointerdown",e.Input.onPointerDown)},e.Input.init=function(){e.Input.reset(),window.addEventListener("keydown",e.Input.onKeyDown),window.addEventListener("keyup",e.Input.onKeyUp),window.addEventListener("pointerdown",e.Input.onPointerDown)},e.Input.keyHeld=function(l){return s.has(l.toUpperCase())},e.Input.keyJustPressed=function(l){const u=r(),f=l.toUpperCase();return u.capture&&!u.passthrough?!1:a.has(f)},e.Input.onEndFrame=function(){a.clear()},e.Input.onKeyDown=function(l){const u=l.key,f=e.Input.getKeys(u);["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(u)&&l.preventDefault();for(const C of f)s.add(C.toUpperCase());const h=r();if(!h.capture||h.passthrough)for(const C of f)a.add(C.toUpperCase());if(h.capture){if(h.queue.push(f),e.Core.hasPendingAsync("b8.Async.key")){const C=h.queue.shift();e.Core.resolveAsync("b8.Async.key",C)}return}e.Core.hasPendingAsync("b8.Async.key")&&e.Core.resolveAsync("b8.Async.key",f)},e.Input.onPointerDown=function(l){e.Core.hasPendingAsync("b8.Async.pointer")&&e.Core.resolveAsync("b8.Async.pointer",{x:l.clientX,y:l.clientY})},e.Input.onKeyUp=function(l){if(!l.key)return;const u=e.Input.getKeys(l.key);for(const f of u)s.delete(f.toUpperCase())},e.Input.readKeyAsync=function(){const l=r();return l.capture&&l.queue.length>0?Promise.resolve(l.queue.shift()):new Promise((u,f)=>{e.Core.startAsync("b8.Async.key",u,f)})},e.Input.readPointerAsync=function(){return new Promise((l,u)=>{e.Core.startAsync("b8.Async.pointer",l,u)})},e.Input.getKeys=function(l){let u=[l];switch(l.toUpperCase()){case"W":u.push("ArrowUp");break;case"A":u.push("ArrowLeft");break;case"S":u.push("ArrowDown");break;case"D":u.push("ArrowRight");break;case"Enter":u.push("Escape");break;case"Z":case"N":u.push("ButtonA");break;case"X":case"M":u.push("ButtonB");break}return u},e.Input.readLine=async function(l="Enter text:",u="",f=100,h=-1){return e.Input.withContext("text",{capture:!0},async()=>(l&&l.length>0&&e.print(l+`
> `),e.Core.isMobile()?await i(l,u,f,h):await n(u,f,h)))};async function i(l,u,f,h){const C=await o(l,u,f,h);return e.print(C+`
`),await e.Async.wait(.2),C}async function n(l,u,f){const h=e.Core.drawState.cursorCol,C=e.Core.drawState.cursorRow;let g=h,d=C,A=[l],p=0;const S=e.Core.drawState.cursorVisible;for(e.CursorRenderer.setCursorVisible(!0);;){e.Core.setCursorLocation(g,d),e.TextRenderer.print(A[p]||"");const x=await e.Input.readKeyAsync();for(const D of x)if(D==="Backspace"){if(A[p].length===0){if(p===0)continue;p--,d--}A[p]=A[p].length>0?A[p].substring(0,A[p].length-1):A[p],e.Core.setCursorLocation(g+e.TextRenderer.measure(A[p]).cols,d),e.TextRenderer.print(" "),e.Sfx.play(e.CONFIG.SFX.TYPING)}else{if(D==="Enter")return e.CursorRenderer.setCursorVisible(S),e.Sfx.play(e.CONFIG.SFX.TYPING),A.join("");D.length===1&&((A.join("").length<u||u===-1)&&(A[p]+=D,f!==-1&&A[p].length>=f&&(e.TextRenderer.print(A[p].charAt(A[p].length-1)),g=h,p++,A[p]="",d++)),e.Sfx.play(e.CONFIG.SFX.TYPING))}}}const o=async function(l="Enter text:",u="",f=100,h=-1){let C=!1,g="";const d=e.CONFIG.CHRS;do await e.Async.wait(.333),g=prompt(l,u),g=g.trim(),g=g.split("").filter(A=>d.includes(A)).join(""),f!==-1&&(g=g.substring(0,f)),C=g.length>0;while(C===!1);return g}})(b8),(function(e){e.Image=e.Image||{},e.Image.quantiseImageData=function(t,i){const n=t.data;for(let o=0;o<n.length;o+=4){const l=n[o],u=n[o+1],f=n[o+2],{r:h,g:C,b:g}=e.Image.findClosestColorUsingLookup(l,u,f,i);n[o]=h,n[o+1]=C,n[o+2]=g}return t},e.Image.loadImageAsync=async function(t){return new Promise(i=>{const n=new Image;n.crossOrigin="anonymous",n.src=t,n.onload=()=>i(n)})},e.Image.findClosestColorUsingLookup=function(t,i,n,o,l=4){const u=Math.floor(t/l)*l,f=Math.floor(i/l)*l,h=Math.floor(n/l)*l,C=`${u},${f},${h}`;return o[C]};const s={};e.Image.generateColorLookupTable=function(t,i=4){if(Object.keys(s).length!==0)return s;const n=t.map(o=>e.Utilities.hexToRgb(o));for(let o=0;o<256;o+=i)for(let l=0;l<256;l+=i)for(let u=0;u<256;u+=i){const f=`${o},${l},${u}`;s[f]=a(o,l,u,n)}return s};function a(t,i,n,o){let l=null,u=1/0;for(const f of o){const h=Math.pow(f.r-t,2)+Math.pow(f.g-i,2)+Math.pow(f.b-n,2);h<u&&(u=h,l=f)}return l}const r={2:[-.375,.125,.375,-.125],4:[-.46875,.03125,-.34375,.15625,.28125,-.21875,.40625,-.09375,-.28125,.21875,-.40625,.09375,.46875,-.03125,.34375,-.15625],8:(()=>{const t=[[0,48,12,60,3,51,15,63],[32,16,44,28,35,19,47,31],[8,56,4,52,11,59,7,55],[40,24,36,20,43,27,39,23],[2,50,14,62,1,49,13,61],[34,18,46,30,33,17,45,29],[10,58,6,54,9,57,5,53],[42,26,38,22,41,25,37,21]],i=[];for(let n=0;n<8;n++)for(let o=0;o<8;o++){const l=t[n][o]/64;i.push(l-.5)}return i})()};e.Image.ditherOrdered=function(t,i,n={}){const o=n.size||4,l=n.strength??.5,u=n.amplitude??24,f=r[o];if(!f)throw new Error("Unsupported Bayer size. Use 2, 4, or 8.");const h=t.data,C=t.width,g=t.height,d=(p,S)=>4*(S*C+p),A=u*l;for(let p=0;p<g;p++)for(let S=0;S<C;S++){const x=d(S,p),D=f[p%o*o+S%o],T=e.Utilities.clamp(h[x]+D*A,0,255),E=e.Utilities.clamp(h[x+1]+D*A,0,255),R=e.Utilities.clamp(h[x+2]+D*A,0,255),y=i(T,E,R);h[x]=y.r,h[x+1]=y.g,h[x+2]=y.b}return t}})(b8),(function(e){"use strict";e.ECS={};let s=1,a=new Map,r=[],t=new Map;function i(){return s++}function n(o){return a.has(o)||a.set(o,new Map),a.get(o)}e.ECS.entitiesAt=function(o,l){return r[l]?.[o]??[]},e.ECS.addSystem=function(o,l,u=100){e.Utilities.checkFunction("fn",l),e.Utilities.checkString("name",o),e.Utilities.checkInt("order",u),t.has(o)&&e.Utilities.warn(`ECS: overwriting existing system "${o}"`),t.set(o,{fn:l,order:u})},e.ECS.addSystemOnce=function(o,l,u=0){e.Utilities.checkFunction("fn",o),e.Utilities.checkString("name",l),e.Utilities.checkInt("order",u),!t.has(l)&&e.ECS.addSystem(o,l,u)},e.ECS.removeSystem=function(o){t.delete(o)},e.ECS.run=function(o,l=()=>!0){[...t.entries()].sort((u,f)=>u[1].order-f[1].order).forEach(([u,{fn:f}])=>{l(u)&&f(o)})},e.ECS.addComponent=function(o,l=null,u={}){e.Utilities.checkInt("id",o),e.Utilities.checkString("name",l),e.Utilities.checkObject("data",u),n(l).set(o,u),l==="Loc"&&e.ECS.setLoc(o,u.col,u.row)},e.ECS.setComponent=function(o,l,u){e.ECS.addComponent(o,l,u)},e.ECS.setLoc=function(o,l,u){e.Utilities.checkInt("id",o),e.Utilities.checkInt("col",l),e.Utilities.checkInt("row",u);const f=this.getComponent(o,"Loc"),h=r[f.row];if(h){const C=h[f.col];if(C){const g=C.indexOf(o);g!==-1&&C.splice(g,1)}}f.col=l,f.row=u,r[u]||(r[u]=[]),r[u][l]||(r[u][l]=[]),r[u][l].push(o)},e.ECS.getComponents=function(o){return e.Utilities.checkString("name",o),a.get(o)??new Map},e.ECS.getEntity=function(o){e.Utilities.checkInt("id",o);const l={};for(const[u,f]of a){const h=f.get(o);h&&(l[u]=h)}return l},e.ECS.get=e.ECS.getEntity,e.ECS.getAllEntities=function(){const o=new Set;for(const l of a.values())for(const u of l.keys())o.add(u);return[...o]},e.ECS.getComponent=function(o,l){return e.Utilities.checkInt("id",o),e.Utilities.checkString("name",l),a.get(l)?.get(o)},e.ECS.hasComponent=function(o,l){return e.Utilities.checkInt("id",o),e.Utilities.checkString("name",l),a.get(l)?.has(o)??!1},e.ECS.removeComponent=function(o,l){if(e.Utilities.checkInt("id",o),e.Utilities.checkString("name",l),a.get(l)?.delete(o),l==="Loc"){const u=this.getComponent(o,"Loc");if(u){const f=r[u.row]?.[u.col];f&&f.splice(f.indexOf(o),1)}}},e.ECS.removeEntity=function(o){const l=this.getComponent(o,"Loc");if(l){const u=r[l.row]?.[l.col];u&&u.splice(u.indexOf(o),1)}for(const u of a.values())u.delete(o)},e.ECS.create=function(o){e.Utilities.checkObject("bundle",o);const l=i();for(const[u,f]of Object.entries(o))e.ECS.addComponent(l,u,f);return l},e.ECS.query=function(...o){if(o.length===0)return[];o.length===1&&Array.isArray(o[0])&&(o=o[0]);const l=a.get(o[0]);return l?o.length===1?[...l.keys()]:[...l.keys()].filter(u=>o.every(f=>a.get(f)?.has(u))):[]},e.ECS.countByType=function(o){const l=a.get("Type");if(!l)return 0;let u=0;for(const f of l.values())f.name===o&&u++;return u},e.ECS.reset=function(){a=new Map,t=new Map,r=[],s=1}})(b8),(function(e){e.CursorRenderer={};let s=0,a=null;e.CursorRenderer.setCursorVisible=function(t){e.Utilities.checkBoolean("visible",t),e.Core.drawState.cursorVisible!==t&&(e.Core.drawState.cursorVisible=t,s=0,e.Renderer.render(),a!==null&&(clearInterval(a),a=null),t&&(a=setInterval(()=>r(),e.CONFIG.CURSOR.BLINK_INTERVAL)))},e.CursorRenderer.draw=function(t){if(e.Utilities.checkInstanceOf("targetCtx",t,CanvasRenderingContext2D),!e.Core.drawState.cursorVisible||s<=0)return;const i=e.TextRenderer.getFont(),n=e.Core.drawState.cursorCol*e.CONFIG.CHR_WIDTH,o=e.Core.drawState.cursorRow*e.CONFIG.CHR_HEIGHT;t.fillStyle=e.Core.getColorHex(e.Core.drawState.fgColor),t.fillRect(n+1,o+1,i.charWidth_-2,i.charHeight_-2)};function r(){s=(s+1)%2,e.Renderer.render()}})(b8),(function(e){e.Core={},e.Core.realCanvas=null,e.Core.realCtx=null,e.Core.offCanvas=null,e.Core.offCtx=null,e.Core.container=null,e.Core.startTime=0,e.Core.deltaTime=0,e.Core.crashed=!1,e.Core.crashing=!1,e.Core.drawState={fgColor:7,bgColor:0,cursorCol:0,cursorRow:0,cursorVisible:!1};let s=null,a=!1,r=null,t=null,i=0,n=0,o=null,l=!1,u=null;e.Core.init=function(d,A={}){e.Utilities.checkFunction("callback",d),A&&e.Utilities.checkObject("options",A),e.CONFIG={...e.CONFIG,...A},e.Hooks.doAction("beforeInit"),e.Core.resetAll(),e.Core.setColor(0,15),e.Core.initScreenshot(),e.Core.asyncInit(d),e.Core.startTime=e.Core.getNow(),e.Hooks.doAction("afterInit"),e.Utilities.event("initComplete")},e.Core.resetAll=function(){for(const d in e)e[d]&&typeof e[d].reset=="function"&&e[d].reset()},e.Core.reset=function(){e.Core.drawState.fgColor=7,e.Core.drawState.bgColor=0,e.Core.drawState.cursorCol=0,e.Core.drawState.cursorRow=0,e.Core.drawState.cursorVisible=!1,e.Core.crashed=!1,o=!1,s=null,window.removeEventListener("resize",e.Core.updateLayout),document.removeEventListener("pointerup",C),document.removeEventListener("keyup",C),e.Core.stopFrame()},e.Core.initialized=function(){return a},e.Core.asyncInit=async function(d=null){if(e.Utilities.log("b8 System initializing"),e.CONFIG.SCREEN_WIDTH=e.CONFIG.SCREEN_COLS*e.CONFIG.CHR_WIDTH,e.CONFIG.SCREEN_HEIGHT=e.CONFIG.SCREEN_ROWS*e.CONFIG.CHR_HEIGHT,e.Core.realCanvas=document.createElement("canvas"),e.CONFIG.CANVAS_SETTINGS&&e.CONFIG.CANVAS_SETTINGS.CANVAS_ID&&e.Core.realCanvas.setAttribute("id",e.CONFIG.CANVAS_SETTINGS.CANVAS_ID),e.CONFIG.CANVAS_SETTINGS&&e.CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES)for(const A of e.CONFIG.CANVAS_SETTINGS.CANVAS_CLASSES)e.Core.realCanvas.classList.add(A);e.Core.realCanvas.style.touchAction="none",e.Core.realCanvas.style.userSelect="none",e.Core.realCanvas.style.imageRendering="pixelated",e.Core.realCanvas.addEventListener("touchstart",A=>A.preventDefault()),e.Core.container=document.createElement("div"),e.Core.container.setAttribute("style",""),e.Core.container.id="b8",e.Core.container.style.display="block",e.Core.container.style.lineHeight="0",e.Core.container.style.position="relative",e.Core.container.appendChild(e.Core.realCanvas),e.Core.getBeepContainerEl().appendChild(e.Core.container),e.Core.offCanvas=new OffscreenCanvas(e.CONFIG.SCREEN_WIDTH,e.CONFIG.SCREEN_HEIGHT),e.Core.offCtx=e.Core.offCanvas.getContext("2d",{alpha:!1,colorSpace:"srgb",desynchronized:!0}),e.Core.offCtx.imageSmoothingEnabled=!1,await e.TextRenderer.initAsync(),e.Input.init(),e.Core.updateLayout(!1),window.addEventListener("resize",h),e.Core.isMobile()&&e.Joystick.setup(),a=!0,e.Utilities.log("b8 System initialized"),await e.Intro.loading(),await e.Intro.splash(),d&&await d()},e.Core.getBeepContainerEl=function(){let d=document.body;if(e.CONFIG.CANVAS_SETTINGS&&e.CONFIG.CANVAS_SETTINGS.CONTAINER){const A=e.CONFIG.CANVAS_SETTINGS.CONTAINER;typeof A=="string"?(d=document.getElementById(A.replace("#","")),d||e.Utilities.fatal("b8: Could not find container element with ID: "+A)):A instanceof HTMLElement?d=A:(e.Utilities.error("b8: b8.CONFIG.CANVAS_SETTINGS.CONTAINER must be either an ID of an HTMLElement."),d=document.body)}return d},e.Core.preflight=function(d){if(e.Core.crashed)throw new Error(`Can't call API method ${d}() because the engine has crashed.`);a||e.Utilities.fatal(`Can't call API method ${d}(): API not initialized. Call initAsync() wait until it finishes before calling API methods.`),o&&e.Utilities.fatal(`Can't call API method ${d}() because there is a pending async call to ${o.name}() that hasn't finished running yet. Are you missing an 'await' keyword to wait for the async method? Use 'await ${o.name}()',not just '${o.name}()'`)},e.Core.startAsync=function(d,A,p){if(o)throw new Error("Internal bug: startAsync called while pendingAsync is not null. Missing preflight() call?");o={name:d,resolve:A,reject:p},e.Renderer.render()},e.Core.hasPendingAsync=function(d=null){return d===null?!!o:o&&o.name===d},e.Core.endAsyncImpl=function(d,A,p){if(!o)throw new Error(`Internal bug: endAsync(${d}) called with no pendingAsync`);if(o.name!==d)throw new Error(`Internal bug: endAsync(${d}) called but pendingAsync.name is ${o.name}`);const S=A?o.reject:o.resolve;o=null,S(p)},e.Core.resolveAsync=function(d,A){e.Core.endAsyncImpl(d,!1,A)},e.Core.failAsync=function(d,A){e.Core.endAsyncImpl(d,!0,A)},e.Core.setFrameHandlers=function(d=null,A=null,p=30){r=A||(()=>{}),t=d||(()=>{}),i=1/p,n=0,s=e.Core.getNow(),e.Core.stopFrame(),l=!0,u=window.requestAnimationFrame(e.Core.doFrame)},e.Core.doFrame=async function(){if(!l)return;const d=e.Core.getNow();let A=(d-s)/1e3;s=d,e.Core.deltaTime=A,A=Math.min(A,.05),n+=A;let p=Math.floor(n/i);const S=10;p>S&&(p=S,n=0);for(let x=0;x<p;x++)r&&r(i),e.Input&&typeof e.Input.onEndFrame=="function"&&e.Input.onEndFrame(),e.Particles.update(i);n%=i,t&&t(),e.Renderer.render(),u=window.requestAnimationFrame(e.Core.doFrame)},e.Core.stopFrame=function(){l=!1,u&&(window.cancelAnimationFrame(u),u=null)},e.Core.cls=function(d=void 0){d=d||e.Core.drawState.bgColor,e.Utilities.checkNumber("bgColor",d),e.Core.offCtx.fillStyle=e.Core.getColorHex(d),e.Core.offCtx.fillRect(0,0,e.Core.offCanvas.width,e.Core.offCanvas.height),e.Core.setCursorLocation(0,0),e.Renderer.markDirty()},e.Core.defineColors=function(d){e.Utilities.checkArray("colors",d),e.CONFIG.COLORS=d.slice(),e.TextRenderer.regenColors()},e.Core.setColor=function(d,A=void 0){e.Utilities.checkNumber("fg",d),e.Core.drawState.fgColor=Math.round(d),A!==void 0&&(e.Utilities.checkNumber("bg",A),e.Core.drawState.bgColor=Math.round(A))},e.Core.setCursorLocation=function(d,A){e.Utilities.checkNumber("col",d),e.Core.drawState.cursorCol=Math.round(d*2)/2,A!==void 0&&(e.Utilities.checkNumber("row",A),e.Core.drawState.cursorRow=Math.round(A*2)/2)},e.Core.nextCursorLocation=function(){let d=e.Core.drawState.cursorCol,A=e.Core.drawState.cursorRow;e.Core.setCursorLocation(d+1,A)},e.Core.getColorHex=function(d){return typeof d!="number"?"#f0f":d<0?e.CONFIG.COLORS[0]:(d=e.Utilities.clamp(Math.round(d),0,e.CONFIG.COLORS.length-1),e.CONFIG.COLORS[d])},e.Core.getNow=function(){return window.performance&&window.performance.now?window.performance.now():new Date().getTime()},e.Core.drawImage=function(d,A,p,S,x,D,T){e.Utilities.checkInstanceOf("img",d,HTMLImageElement),e.Utilities.checkNumber("x",A),e.Utilities.checkNumber("y",p),S!==void 0&&e.Utilities.checkNumber("srcX",S),x!==void 0&&e.Utilities.checkNumber("srcY",x),D!==void 0&&e.Utilities.checkNumber("width",D),T!==void 0&&e.Utilities.checkNumber("height",T),S!==void 0&&x!==void 0&&D!==void 0&&T!==void 0?e.Core.offCtx.drawImage(d,S,x,D,T,A,p,D,T):e.Core.offCtx.drawImage(d,A,p)},e.Core.loadImage=async function(d,A={dither:"ordered"}){const p=A.dither||"none";e.Utilities.log("load image",d);const S=await e.Image.loadImageAsync(d),x=document.createElement("canvas"),D=x.getContext("2d");x.width=S.width,x.height=S.height,D.drawImage(S,0,0);const T=D.getImageData(0,0,x.width,x.height),E=e.Image.generateColorLookupTable(e.CONFIG.COLORS),R=(N,M,m)=>e.Image.findClosestColorUsingLookup(N,M,m,E);p==="ordered"?e.Image.ditherOrdered(T,R,{size:A.size||4,strength:A.strength||.5,amplitude:A.amplitude||16}):e.Image.quantiseImageData(T,E),D.putImageData(T,0,0);const y=new Image;return new Promise(N=>{y.onload=()=>N(y),y.src=x.toDataURL()})},e.Core.drawRect=function(d,A,p,S,x=1){e.Utilities.checkNumber("x",d),e.Utilities.checkNumber("y",A),e.Utilities.checkNumber("width",p),e.Utilities.checkNumber("height",S),e.Utilities.checkNumber("lineWidth",x);const D=e.Core.offCtx.strokeStyle,T=e.Core.offCtx.lineWidth;e.Core.offCtx.strokeStyle=e.Core.getColorHex(e.Core.drawState.fgColor),e.Core.offCtx.lineWidth=x,e.Core.offCtx.strokeRect(Math.round(d),Math.round(A),Math.round(p),Math.round(S)),e.Core.offCtx.strokeStyle=D,e.Core.offCtx.lineWidth=T},e.Core.fillRect=function(d,A,p,S){e.Utilities.checkNumber("x",d),e.Utilities.checkNumber("y",A),e.Utilities.checkNumber("width",p),e.Utilities.checkNumber("height",S),e.Core.offCtx.fillStyle=e.Core.getColorHex(e.Core.drawState.fgColor),e.Core.offCtx.fillRect(Math.round(d)+.5,Math.round(A)+.5,Math.round(p)-1,Math.round(S)-1)},e.Core.initScreenshot=function(){e.Core.initialized()||(document.addEventListener("pointerup",C),document.addEventListener("keyup",C))},e.Core.saveScreen=function(){return e.Core.offCtx.getImageData(0,0,e.Core.offCanvas.width,e.Core.offCanvas.height)},e.Core.downloadScreenshot=function(){const d=e.Core.getHighResDataURL(e.Core.realCanvas);e.Utilities.downloadFile("b8-screenshot.png",d)};let f=null;e.Core.getHighResDataURL=function(d,A=4,p="image/png",S=1){f||(f=document.createElement("canvas")),f.width=d.width*A,f.height=d.height*A;const x=f.getContext("2d");return x.imageSmoothingEnabled=!1,x.scale(A,A),x.drawImage(d,0,0),f.toDataURL(p,S)},e.Core.restoreScreen=function(d){e.Utilities.checkInstanceOf("screenData",d,ImageData),e.Core.offCtx.putImageData(d,0,0)},e.Core.updateLayout=function(d){e.Core.updateLayout2d(),d&&e.Renderer.render()},e.Core.updateLayout2d=function(){e.Core.realCtx=e.Core.realCanvas.getContext("2d",{alpha:!1,desynchronized:!0}),e.Core.realCtx.imageSmoothingEnabled=!1,e.Core.realCtx.imageSmoothingQuality="pixelated",e.CONFIG.SCREEN_EL_WIDTH=e.CONFIG.SCREEN_WIDTH,e.CONFIG.SCREEN_EL_HEIGHT=e.CONFIG.SCREEN_HEIGHT,e.CONFIG.SCREEN_REAL_WIDTH=e.CONFIG.SCREEN_WIDTH,e.CONFIG.SCREEN_REAL_HEIGHT=e.CONFIG.SCREEN_HEIGHT,e.Core.realCanvas.style.width="100%",e.Core.realCanvas.style.height="100%",e.Core.realCanvas.style.filter="blur(0.5px)",e.Core.realCanvas.width=e.CONFIG.SCREEN_REAL_WIDTH,e.Core.realCanvas.height=e.CONFIG.SCREEN_REAL_HEIGHT,e.Core.container.style.aspectRatio=`${e.CONFIG.SCREEN_COLS} / ${e.CONFIG.SCREEN_ROWS}`},e.Core.handleCrash=function(d="Fatal error"){if(e.Core.crashed||e.Core.crashing)return;e.Core.crashing=!0;const A=d instanceof Error?d:new Error(String(d)),p=g(String(A.stack||"")),S=`*** CRASH ***
`+(A.name?A.name+": ":"")+A.message+`
`+(p.length>0?`
Stack:
`+p.join(`
`):"");e.Core.setColor(e.CONFIG.COLORS.length-1,0),e.Core.cls(),e.Core.setCursorLocation(1,1),e.TextRenderer.print(S,null,e.CONFIG.SCREEN_COLS-2),e.Renderer.render(),e.Core.crashing=!1,e.Core.crashed=!0},e.Core.isTouchDevice=function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},e.Core.isMobile=function(){return e.Core.isIOS()||e.Core.isAndroid()||e.Core.isTouchDevice()},e.Core.isIOS=function(){return/(ipad|ipod|iphone)/i.test(navigator.userAgent)},e.Core.isAndroid=function(){return/android/i.test(navigator.userAgent)};function h(){e.Core.updateLayout(!0)}function C(d){d.key==="0"&&e.Core.downloadScreenshot()}function g(d){const A=String(d).split(`
`).map(S=>S.trim()),p=[];for(let S of A){if(S=S.replace(/^at\s+/,""),S=S.replace(/@.*/,""),S=S.trim(),S=S.replace(/^b8\d+\./,"b8."),S.length===0)continue;const x=S.includes("Utilities.fatal")||S.includes("Utilities.check")||S.includes("Utilities.assert")||S.includes("Core.doFrame")||S.includes("Core.handleCrash");console.log("stack line",S,"isInternal=",x),!x&&p.push(S.trim())}return p}})(b8),(function(e){e.Collision={},e.COLLISION={},e.COLLISION.NONE=0,e.COLLISION.N=1,e.COLLISION.E=2,e.COLLISION.S=4,e.COLLISION.W=8,e.COLLISION.NE=e.COLLISION.N+e.COLLISION.E,e.COLLISION.NS=e.COLLISION.N+e.COLLISION.S,e.COLLISION.NW=e.COLLISION.N+e.COLLISION.W,e.COLLISION.SE=e.COLLISION.S+e.COLLISION.E,e.COLLISION.SW=e.COLLISION.S+e.COLLISION.W,e.COLLISION.WE=e.COLLISION.W+e.COLLISION.E,e.COLLISION.WNE=e.COLLISION.W+e.COLLISION.N+e.COLLISION.E,e.COLLISION.WES=e.COLLISION.W+e.COLLISION.E+e.COLLISION.S,e.COLLISION.NES=e.COLLISION.N+e.COLLISION.E+e.COLLISION.S,e.COLLISION.ALL=e.COLLISION.N+e.COLLISION.E+e.COLLISION.S+e.COLLISION.W})(b8),(function(e){e.Cart={};const s="B8CART",a=new TextEncoder().encode(s),r=1;e.Cart.save=async function(u,f,h="cart.png"){e.Utilities.checkInstanceOf("canvas",u,HTMLCanvasElement),e.Utilities.checkString("data",f),e.Utilities.checkString("filename",h);const C=await new Promise(d=>u.toBlob(d,"image/png")),g=await t(C,f);saveAs(g,h)},e.Cart.load=async function(u){const f=await(typeof u=="string"?(await fetch(u)).arrayBuffer():u.arrayBuffer()),h=new Uint8Array(f),C=i(h,s);C<0&&e.Utilities.fatal("Error Loading Cart: No b8 trailer found");const g=C+a.length,d=g+1,A=d+4,p=h[g];p!==r&&e.Utilities.fatal(`Error Loading Cart: Unsupported version ${p}`);const S=n(h,d),x=A+S;x+4>h.length&&e.Utilities.fatal("Error Loading Cart: Trailer length out of range");const D=h.subarray(A,x),T=n(h,x);return l(D)!==T&&e.Utilities.fatal("Error Loading Cart: Bad payload CRC"),JSON.parse(new TextDecoder().decode(D))};async function t(u,f){const h=new TextEncoder().encode(JSON.stringify(f)),C=a.length+1+4+h.length+4,g=new Uint8Array(C);let d=0;g.set(a,d),d+=a.length,g[d++]=r,o(g,d,h.length),d+=4,g.set(h,d),d+=h.length,o(g,d,l(h)),d+=4;const A=new Uint8Array(await u.arrayBuffer());return new Blob([A,g],{type:"image/png"})}function i(u,f){const h=new TextEncoder().encode(f);for(let C=u.length-h.length;C>=0;C--){let g=!0;for(let d=0;d<h.length;d++)if(u[C+d]!==h[d]){g=!1;break}if(g)return C}return-1}function n(u,f){const h=u[f],C=u[f+1],g=u[f+2],d=u[f+3];return(h<<24|C<<16|g<<8|d)>>>0}function o(u,f,h){u[f]=h>>>24&255,u[f+1]=h>>>16&255,u[f+2]=h>>>8&255,u[f+3]=h&255}function l(u){let f=4294967295;for(let h=0;h<u.length;h++){f^=u[h];for(let C=0;C<8;C++)f&1?f=f>>>1^3988292384:f>>>=1}return~f>>>0}})(b8),(function(e){e.AStar={};function s(t,i){return`${t},${i}`}function a(t){let i=[],n=t;for(;n;)i.push({col:n.col,row:n.row}),n=n.parent;return i=i.reverse(),i.shift(),i}function r(t,i){return e.Math.distManhattan(t,i)}e.AStar.pathfind=function(t,i,n,o,l){if(e.Utilities.checkObject("start",t),e.Utilities.checkObject("goal",i),e.Utilities.checkInt("start.col",t.col),e.Utilities.checkInt("start.row",t.row),e.Utilities.checkInt("goal.col",i.col),e.Utilities.checkInt("goal.row",i.row),e.Utilities.checkFunction("isWalkable",n),e.Utilities.checkInt("gridWidth",o),e.Utilities.checkInt("gridHeight",l),t.col===i.col&&t.row===i.row)return[];const u=[],f=new Set,h={},C={col:t.col,row:t.row,g:0,h:r(t,i),f:r(t,i),parent:null};for(u.push(C),h[s(t.col,t.row)]=C;u.length>0;){u.sort((p,S)=>p.f-S.f);const g=u.shift(),d=s(g.col,g.row);if(f.add(d),g.col===i.col&&g.row===i.row)return a(g);const A=[{col:g.col-1,row:g.row},{col:g.col+1,row:g.row},{col:g.col,row:g.row-1},{col:g.col,row:g.row+1}];for(let p of A){if(p.col<0||p.col>=o||p.row<0||p.row>=l||!(p.col===t.col&&p.row===t.row)&&!(p.col===i.col&&p.row===i.row)&&!n(p.col,p.row))continue;const S=s(p.col,p.row);if(f.has(S))continue;const x=g.g+1;let D=h[S];if(D)x<D.g&&(D.g=x,D.f=x+D.h,D.parent=g);else{const T=r(p,i);D={col:p.col,row:p.row,g:x,h:T,f:x+T,parent:g},h[S]=D,u.push(D)}}}return null}})(b8),(function(e){e.Animation={},e.Animation.frame=function(s,a=null){s===void 0&&e.Utilities.fatal("Animation not found"),a===null&&(a=e.Core.startTime);let r=0;if((!s.frames||s.frames.length===0)&&e.Utilities.fatal("Animation has no frames"),s.frames.length===1&&(r=s.frames[0]),s.frames.length>1){const t=e.Core.getNow()-a,i=s.frames.length,o=1e3/(s.fps||1),l=Math.floor(t/o)%i;r=s.frames[l]}return r},e.Animation.get=function(s){return e.Utilities.checkString("animation",s),e.Animation.animations[s]===void 0&&e.Utilities.fatal("Invalid Animation: "+s),e.Animation.animations[s]},e.Animation.shouldLoop=function(s,a){if(typeof s=="string"&&(s=e.Animation.get(s)),e.Utilities.checkObject("anim",s),s===void 0&&e.Utilities.fatal("Animation not found"),a===null||s.loop===!0)return!0;const r=s.fps||1,t=s.frames.length*(1e3/r);return!(e.Core.getNow()-a>=t)}})(b8),(function(e){e.Actors={},e.Actors.animations={idle:{frames:[0],fps:1},"idle-down":{frames:[0],fps:1},"idle-right":{frames:[1],fps:1},"idle-left":{frames:[-1],fps:1},"idle-up":{frames:[4],fps:1},"move-right":{frames:[1,2],fps:4,loop:!0},"move-left":{frames:[-1,-2],fps:4,loop:!0},"move-up":{frames:[5,-5],fps:4,loop:!0},"move-down":{frames:[3,-3],fps:4,loop:!0},"jump-right":{frames:[5],fps:1,loop:!1},"jump-left":{frames:[-5],fps:1,loop:!1},"spin-left":{frames:[0,1,4,-1],fps:4,loop:!0},"spin-right":{frames:[0,-1,4,1],fps:4,loop:!0}};const s=function(a,r,t,i,n){const o=e.TextRenderer.curActors_,l=a*o.getColCount()+Math.abs(e.Animation.frame(r));e.TextRenderer.spr(l,t,i,o,n||0)};e.Actors.draw=function(a,r,t=0,i=0){e.Utilities.checkInt("ch",a),e.Utilities.checkString("animation",r),e.Actors.animations[r]===void 0&&e.Utilities.fatal("Invalid actor animation: "+r),e.Utilities.checkNumber("offsetCol",t),e.Utilities.checkNumber("offsetRow",i);const n=e.Actors.animations[r],l=e.Animation.frame(n)>=0?0:1;s(a,n,(e.Core.drawState.cursorCol+t)*e.CONFIG.CHR_WIDTH,(e.Core.drawState.cursorRow+i)*e.CONFIG.CHR_HEIGHT,l||0)},e.Actors.spr=function(a,r,t,i,n=null){e.Utilities.checkInt("ch",a),e.Utilities.checkString("animation",r),e.Actors.animations[r]===void 0&&e.Utilities.fatal("Invalid actor animation: "+r),e.Utilities.checkNumber("x",t),e.Utilities.checkNumber("y",i),n!==null&&e.Utilities.checkNumber("startTime",n);const o=e.Actors.animations[r],u=e.Animation.frame(o,n)>=0?0:1;return e.Animation.shouldLoop(o,n)?(s(a,o,t,i,u||0),!0):!1}})(b8);const zzfx=(...e)=>zzfxP(zzfxG(...e)),zzfxV=.3,zzfxR=44100,zzfxX=new AudioContext,zzfxP=(...e)=>{let s=zzfxX.createBuffer(e.length,e[0].length,zzfxR),a=zzfxX.createBufferSource();return e.map((r,t)=>s.getChannelData(t).set(r)),a.buffer=s,a.connect(zzfxX.destination),a.start(),a},zzfxG=(e=1,s=.05,a=220,r=0,t=0,i=.1,n=0,o=1,l=0,u=0,f=0,h=0,C=0,g=0,d=0,A=0,p=0,S=1,x=0,D=0,T=0)=>{let E=Math.PI*2,R=q=>q<0?-1:1,y=l*=500*E/zzfxR/zzfxR,N=a*=(1+s*2*Math.random()-s)*E/zzfxR,M=[],m=0,w=0,I=0,k=1,v=0,B=0,U=0,F,_,P=2,L=E*Math.abs(T)*2/zzfxR,Q=Math.cos(L),O=Math.sin(L)/2/P,G=1+O,H=-2*Q/G,W=(1-O)/G,j=(1+R(T)*Q)/2/G,Y=-(R(T)+Q)/G,V=j,$=0,z=0,K=0,J=0;for(r=r*zzfxR+9,x*=zzfxR,t*=zzfxR,i*=zzfxR,p*=zzfxR,u*=500*E/zzfxR**3,d*=E/zzfxR,f*=E/zzfxR,h*=zzfxR,C=C*zzfxR|0,e*=zzfxV,_=r+x+t+i+p|0;I<_;M[I++]=U*e)++B%(A*100|0)||(U=n?n>1?n>2?n>3?Math.sin(m**3):Math.max(Math.min(Math.tan(m),1),-1):1-(2*m/E%2+2)%2:1-4*Math.abs(Math.round(m/E)-m/E):Math.sin(m),U=(C?1-D+D*Math.sin(E*I/C):1)*R(U)*Math.abs(U)**o*(I<r?I/r:I<r+x?1-(I-r)/x*(1-S):I<r+x+t?S:I<_-p?(_-I-p)/i*S:0),U=p?U/2+(p>I?0:(I<_-p?1:(_-I)/p)*M[I-p|0]/2/e):U,T&&(U=J=V*$+Y*($=z)+j*(z=U)-W*K-H*(K=J))),F=(a+=l+=u)*Math.cos(d*w++),m+=F+F*g*Math.sin(I**5),k&&++k>h&&(a+=f,N+=f,k=0),C&&!(++v%C)&&(a=N,l=y,k=k||1);return M};(function(){const e=new AudioContext,s=e.createGain();s.gain.value=1,s.connect(e.destination);let a={},r=null,t=[],i=[],n=0,o=125;const l=.5,u=50,f=.1;let h=!1;const C=(w,I)=>Math.sin(w*6.28+I),E=[w=>C(w,Math.pow(C(w,0),2)+C(w,.25)*.75+C(w,.5)*.1)*f,w=>Math.sin(w*6.28)*Math.sin(w*3.14)*f,w=>Math.sin(2*Math.PI*w)*f,w=>(2*(w-Math.floor(w))-1)*f,w=>(Math.sin(2*Math.PI*w)>=0?1:-1)*f,w=>{let I=w-Math.floor(w);return(2*Math.abs(2*I-1)-1)*f},w=>(Math.random()*2-1)*Math.exp(-w/10)*f,w=>(Math.sin(w*2)+.3*(Math.random()-.5))*Math.exp(-w/15)*f*2];function R(w){if(Array.isArray(w)&&(w=w[0]),!w||w.trim()===""){R.stop();return}a.length>200&&(console.warn("b8.Music: Note buffers exceeded limit, clearing old buffers."),a={}),o=125;let I=.5;t=[];const k=w.split(`
`).map(U=>U.trim());let v=o/1e3;const B=/^([0-9])\|(.*)\|$/;k.forEach(U=>{if(!U)return;if(U.startsWith("[")&&U.endsWith("]")||/^\d+(\.\d+)?$/.test(U)){const O=U.replace(/[\[\]]/g,"").split(".");o=parseFloat(O[0])||o,I=(parseFloat(O[1])||50)/100,v=o/1e3;return}if(!B.test(U)){console.error("Track lines must be in the format 'instrument|track data|': "+U);return}const F=U.match(B),_=parseInt(F[1],10),P=E[_]||E[0],L=F[2].trim();let Q=[];for(let O=0;O<L.length;O++){const G=L[O];let H=1;for(;O+H<L.length&&L[O+H]==="-";)H++;let W=O*v;if(G===" "){Q.push({startTime:W,noteBuffer:null}),O+=H-1;continue}let j=G.charCodeAt(0);j-=j>90?71:65;let Y=H*I*(o/125),V=N(j,Y,44100,P);Q.push({startTime:W,noteBuffer:V}),O+=H-1}t.push(Q)}),i=t.map(()=>0),n=e.currentTime+.1,R.stop(),r=setInterval(y,u)}function y(){const w=e.currentTime,I=o/1e3,k=Math.max(l,I);t.forEach((v,B)=>{let U=i[B];const F=v.length;if(F===0)return;const _=U%F,P=Math.floor(U/F),L=n+_*I+P*F*I;if(L<w+k){const Q=v[_];Q.noteBuffer&&m(Q.noteBuffer,e,L),i[B]++}}),R.loop||t.every((B,U)=>i[U]>=B.length)&&R.stop()}R.stop=function(){r!==null&&(clearInterval(r),r=null),M.forEach(w=>w.stop()),M=[]},R.isPlaying=function(){return r!==null},R.setTempo=function(w){w<50&&(w=50);const I=o/1e3,k=w/1e3,B=(e.currentTime-n)/I;n=e.currentTime-B*k,o=w},R.setVolume=function(w){s.gain.value=Math.min(1,Math.max(0,w))},R.clearCache=function(){a={}},R.loop=!0;const N=(w,I,k,v)=>{const B=w+"-"+I+"-"+v.name;let U=a[B];if(w>=0&&!U){const F=65.406*Math.pow(1.06,w)/k,_=Math.floor(k*I),P=88,L=k*(I-.002);U=a[B]=e.createBuffer(1,_,k);const Q=U.getChannelData(0);for(let O=0;O<_;O++){let G;O<P?G=O/(P+.2):G=Math.pow(1-(O-P)/L,Math.pow(Math.log(1e4*F)/2,2)),Q[O]=G*v(O*F)}h||(m(U,e,e.currentTime,!0),h=!0)}return U};let M=[];const m=(w,I,k,v=!1)=>{const B=I.createBufferSource();B.buffer=w,B.connect(s),B.start(k),M.push(B),v&&B.stop(),B.onended=()=>{const U=M.indexOf(B);U!==-1&&M.splice(U,1)}};window.p1=R})();class MinHeap{constructor(){this.heap=[]}push(s){this.heap.push(s),this.bubbleUp(this.heap.length-1)}pop(){if(this.heap.length===1)return this.heap.pop();const s=this.heap[0];return this.heap[0]=this.heap.pop(),this.bubbleDown(0),s}get length(){return this.heap.length}bubbleUp(s){const a=Math.floor((s-1)/2);a>=0&&this.heap[s].f<this.heap[a].f&&([this.heap[s],this.heap[a]]=[this.heap[a],this.heap[s]],this.bubbleUp(a))}bubbleDown(s){const a=2*s+1,r=2*s+2;let t=s;a<this.heap.length&&this.heap[a].f<this.heap[t].f&&(t=a),r<this.heap.length&&this.heap[r].f<this.heap[t].f&&(t=r),t!==s&&([this.heap[s],this.heap[t]]=[this.heap[t],this.heap[s]],this.bubbleDown(t))}}(function(e,s){"use strict";var a=Math.pow(2,-24),r=Math.pow(2,32),t=Math.pow(2,53);function i(l){var u=new ArrayBuffer(256),f=new DataView(u),h,C=0;function g(m){for(var w=u.byteLength,I=C+m;w<I;)w*=2;if(w!==u.byteLength){var k=f;u=new ArrayBuffer(w),f=new DataView(u);for(var v=C+3>>2,B=0;B<v;++B)f.setUint32(B*4,k.getUint32(B*4))}return h=m,f}function d(){C+=h}function A(m){d(g(8).setFloat64(C,m))}function p(m){d(g(1).setUint8(C,m))}function S(m){for(var w=g(m.length),I=0;I<m.length;++I)w.setUint8(C+I,m[I]);d()}function x(m){d(g(2).setUint16(C,m))}function D(m){d(g(4).setUint32(C,m))}function T(m){var w=m%r,I=(m-w)/r,k=g(8);k.setUint32(C,I),k.setUint32(C+4,w),d()}function E(m,w){w<24?p(m<<5|w):w<256?(p(m<<5|24),p(w)):w<65536?(p(m<<5|25),x(w)):w<4294967296?(p(m<<5|26),D(w)):(p(m<<5|27),T(w))}function R(m){var w;if(m===!1)return p(244);if(m===!0)return p(245);if(m===null)return p(246);if(m===s)return p(247);switch(typeof m){case"number":if(Math.floor(m)===m){if(0<=m&&m<=t)return E(0,m);if(-t<=m&&m<0)return E(1,-(m+1))}return p(251),A(m);case"string":var I=[];for(w=0;w<m.length;++w){var k=m.charCodeAt(w);k<128?I.push(k):k<2048?(I.push(192|k>>6),I.push(128|k&63)):k<55296?(I.push(224|k>>12),I.push(128|k>>6&63),I.push(128|k&63)):(k=(k&1023)<<10,k|=m.charCodeAt(++w)&1023,k+=65536,I.push(240|k>>18),I.push(128|k>>12&63),I.push(128|k>>6&63),I.push(128|k&63))}return E(3,I.length),S(I);default:var v;if(Array.isArray(m))for(v=m.length,E(4,v),w=0;w<v;++w)R(m[w]);else if(m instanceof Uint8Array)E(2,m.length),S(m);else{var B=Object.keys(m);for(v=B.length,E(5,v),w=0;w<v;++w){var U=B[w];R(U),R(m[U])}}}}if(R(l),"slice"in u)return u.slice(0,C);for(var y=new ArrayBuffer(C),N=new DataView(y),M=0;M<C;++M)N.setUint8(M,f.getUint8(M));return y}function n(l,u,f){var h=new DataView(l),C=0;typeof u!="function"&&(u=function(I){return I}),typeof f!="function"&&(f=function(){return s});function g(I,k){return C+=k,I}function d(I){return g(new Uint8Array(l,C,I),I)}function A(){var I=new ArrayBuffer(4),k=new DataView(I),v=D(),B=v&32768,U=v&31744,F=v&1023;if(U===31744)U=261120;else if(U!==0)U+=114688;else if(F!==0)return F*a;return k.setUint32(0,B<<16|U<<13|F<<13),k.getFloat32(0)}function p(){return g(h.getFloat32(C),4)}function S(){return g(h.getFloat64(C),8)}function x(){return g(h.getUint8(C),1)}function D(){return g(h.getUint16(C),2)}function T(){return g(h.getUint32(C),4)}function E(){return T()*r+T()}function R(){return h.getUint8(C)!==255?!1:(C+=1,!0)}function y(I){if(I<24)return I;if(I===24)return x();if(I===25)return D();if(I===26)return T();if(I===27)return E();if(I===31)return-1;throw"Invalid length encoding"}function N(I){var k=x();if(k===255)return-1;var v=y(k&31);if(v<0||k>>5!==I)throw"Invalid indefinite length element";return v}function M(I,k){for(var v=0;v<k;++v){var B=x();B&128&&(B<224?(B=(B&31)<<6|x()&63,k-=1):B<240?(B=(B&15)<<12|(x()&63)<<6|x()&63,k-=2):(B=(B&15)<<18|(x()&63)<<12|(x()&63)<<6|x()&63,k-=3)),B<65536?I.push(B):(B-=65536,I.push(55296|B>>10),I.push(56320|B&1023))}}function m(){var I=x(),k=I>>5,v=I&31,B,U;if(k===7)switch(v){case 25:return A();case 26:return p();case 27:return S()}if(U=y(v),U<0&&(k<2||6<k))throw"Invalid length";switch(k){case 0:return U;case 1:return-1-U;case 2:if(U<0){for(var F=[],_=0;(U=N(k))>=0;)_+=U,F.push(d(U));var P=new Uint8Array(_),L=0;for(B=0;B<F.length;++B)P.set(F[B],L),L+=F[B].length;return P}return d(U);case 3:var Q=[];if(U<0)for(;(U=N(k))>=0;)M(Q,U);else M(Q,U);return String.fromCharCode.apply(null,Q);case 4:var O;if(U<0)for(O=[];!R();)O.push(m());else for(O=new Array(U),B=0;B<U;++B)O[B]=m();return O;case 5:var G={};for(B=0;B<U||U<0&&!R();++B){var H=m();G[H]=m()}return G;case 6:return u(m(),U);case 7:switch(U){case 20:return!1;case 21:return!0;case 22:return null;case 23:return s;default:return f(U)}}}var w=m();if(C!==l.byteLength)throw"Remaining bytes";return w}var o={encode:i,decode:n};typeof define=="function"&&define.amd?define("cbor/cbor",o):e.CBOR||(e.CBOR=o)})(this);
